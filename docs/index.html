<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>code.openark.org</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  
  <link rel="alternate" type="application/rss+xml" title="code.openark.org" href="/blog/index.xml" />
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/blogimg/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <a class="pure-menu-heading brand" href="/blog">openark.org</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/page/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="/blog/index.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a class="pure-menu-link">
        Shlomi Noach
        
          <div class="avatar-container">
        	  <div class="avatar-img-border">
                <img class="avatar-img" src="/blog/images/shlomi-noach.png" alt="code.openark.org" />
        	  </div>
        	</div>
        
      </a>
    </li>

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/shlomi-noach" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ShlomiNoach" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/shlominoach" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>





  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>code.openark.org</h1>
  <h2>Software musings by Shlomi Noach</h2>
</div>

<div class="content">
  
    <article>
  <header>
    <h2><a href="/blog/mysql/three-wishes-for-a-new-year-4">Three wishes for a new year</a></h2>

    <div class="post-meta">

  <div>

    <time>28 Sep 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/gh-ost">gh-ost</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/gtid">GTID</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/operations">operations</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/replication">replication</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/sql">SQL</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/opinions">Opinions</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  (Almost) another new year by Jewish calendar. What do I wish for the following year? World peace Good health to all Relaxed GTID constraints I'm still not using GTID, and still see operational issues with working with GTID. As a latest example, our new schema migration solution, gh-ost, allows us to test migrations in production, on replicas. The GTID catch? gh-ost&nbsp;has to write something to the binary log. Thus, it "corrupts" the replica with a bogus GTID entry that will never be met in another server, thus making said replica unsafe to promote.
  </p>

  
  <footer>
    <a href="/blog/mysql/three-wishes-for-a-new-year-4">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/gh-ost-1-0-17-hooks-sub-second-lag-control-amazon-rds-and-more">gh-ost 1.0.17: Hooks, Sub-second lag control, Amazon RDS and more</a></h2>

    <div class="post-meta">

  <div>

    <time>06 Sep 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/gh-ost">gh-ost</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/new-features">New Features</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p><a href="https://github.com/github/gh-ost">gh-ost</a> version <a href="https://github.com/github/gh-ost/releases/tag/v1.0.17">1.0.17</a> is now released, with various additions and fixes. Here are some notes of interest:</p>
<h3>Hooks</h3>
<p><code>gh-ost</code> now supports <a href="https://github.com/github/gh-ost/blob/master/doc/hooks.md">hooks</a>. These are your own executables that <code>gh-ost</code> will invoke at particular points of interest (validation pass, about to cut-over, success, failure, status, etc.)</p>
<p><code>gh-ost</code> will set various environment variables for your executables to pick up, passing along such information as migrated/<em>ghost</em> table name, elapsed time, processed rows, migrated host etc.</p>
<h3>Sub-second lag control</h3>
<p>At GitHub we&rsquo;re very strict about replication lag. We keep it well under <code>1</code> second at most times. <code>gh-ost</code> can now identify <a href="https://github.com/github/gh-ost/blob/master/doc/subsecond-lag.md">sub-second lag on replicas</a> (well, you need to supply with the right query). Our current production migrations are set by default with <code>&ndash;max-lag-millis=500</code> or less, and our most intensive migrations keep replication lag well below <code>1sec</code> or even below <code>500ms</code></p>
<h3>No SUPER</h3>
<p>The <code>SUPER</code> privilege is required to <code>set global binlog_format=&lsquo;ROW&rsquo;</code> and for <code>STOP SLAVE; START SLAVE;</code></p>
<p>If you <em>know</em> your replica has RBR, you can pass <code>&ndash;assume-rbr</code> and skips those steps.</p>
<h3>RDS</h3>
<p>Hooks + No Super = RDS, as seems to be the case. For <code>&ndash;test-on-replica</code> you will need to supply your own <code>gh-ost-on-stop-replication</code> hook, to stop your RDS replica at cut-over phase. See <a href="https://github.com/github/gh-ost/issues/163#issuecomment-244694616">this tracking issue</a></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/gh-ost-1-0-17-hooks-sub-second-lag-control-amazon-rds-and-more">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/08/11/mysql-vs-postgresql-gh-ost-perspective/">MySQL vs. PostgreSQL, gh-ost perspective</a></h2>

    <div class="post-meta">

  <div>

    <time>11 Aug 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Last week we released <a href="https://github.com/github/gh-ost">gh-ost</a>, <a href="http://githubengineering.com/gh-ost-github-s-online-migration-tool-for-mysql/">GitHub&rsquo;s online schema migration tool for MySQL</a>. As with other open source releases in the MySQL ecosystem, this release was echoed by several &ldquo;Why not PostgreSQL?&rdquo; comments. Having been active in open source since many years now, I&rsquo;m familiar with these responses, and I find this is a good time to share my thoughts. Why? <a href="https://xkcd.com/386/">XKCD</a> knows the answer:</p>
<blockquote><a href="https://xkcd.com/386/"><img class="alignnone" src="/blog/assets/duty_calls.png" alt="XKCD: Duty Calls" width="300" height="330" /></a></blockquote>
<p>I picked <a href="https://brandur.org/fragments/gh-ost">one post I wish to address</a> (latest commit: <a href="https://github.com/brandur/sorg/blob/3dfbd2cd3f5468f035ec86442d2c670a510118d8/content/fragments/gh-ost.md">3dfbd2cd3f5468f035ec86442d2c670a510118d8</a>). The author invested some time writing it. It nicely summarizes claims I&rsquo;ve heard over the years, as well as some prejudice. Through responding to this post I will be generalizing thoughts and impressions to address the common reactions. Dear @brandur, let&rsquo;s grab a beer some day; I fundamentally disagree with your post and with its claims.</p>
<p><strong>EDIT</strong>: linked post has been updated following this writing; I&rsquo;d like to thank the author for his consideration. Also see his <a href="https://gist.github.com/brandur/1374c9266c1d9dc32464695df84d9699">followup post</a>. The version I&rsquo;ve responded to in this post is <a href="https://github.com/brandur/sorg/blob/3dfbd2cd3f5468f035ec86442d2c670a510118d8/content/fragments/gh-ost.md">this commit</a>.</p>

  </p>

  
  <footer>
    <a href="/blog/2016/08/11/mysql-vs-postgresql-gh-ost-perspective/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/08/01/introducing-gh-ost-triggerless-online-schema-migrations/">Introducing gh-ost: triggerless online schema migrations</a></h2>

    <div class="post-meta">

  <div>

    <time>01 Aug 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/github">GitHub</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/operations">operations</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/performance">Performance</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/tools">tools</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  I'm thoroughly happy to introduce gh-ost: triggerless, controllable, auditable, testable, trusted online schema change tool released today by GitHub. gh-ost now powers our production schema migrations. We hit some serious limitations using pt-online-schema-change on our large volume, high traffic tables, to the effect of driving our database to a near grinding halt or even to the extent of causing outages. With gh-ost, we are now able to migrate our busiest tables at any time, peak hours and heavy workloads included, without causing impact to our service.
  </p>

  
  <footer>
    <a href="/blog/2016/08/01/introducing-gh-ost-triggerless-online-schema-migrations/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/07/07/solving-the-non-atomic-table-swap-take-iii-making-it-atomic/">Solving the non-atomic table swap, Take III: making it atomic</a></h2>

    <div class="post-meta">

  <div>

    <time>07 Jul 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/operations">operations</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>With the unintended impression of becoming live blogging, we now follow up on <a title="Link to Solving the non-atomic table swap, Take II" href="http://code.openark.org/blog/mysql/solving-the-non-atomic-table-swap-take-ii" rel="bookmark">Solving the non-atomic table swap, Take II</a> and <a title="Link to Solving the Facebook-OSC non-atomic table swap problem" href="http://code.openark.org/blog/mysql/solving-the-facebook-osc-non-atomic-table-swap-problem" rel="bookmark">Solving the Facebook-OSC non-atomic table swap problem</a> with a safe, blocking, <em>atomic</em> solution</p>
<h3>Why yet another iteration?</h3>
<p>The solution presented in <a title="Link to Solving the non-atomic table swap, Take II" href="http://code.openark.org/blog/mysql/solving-the-non-atomic-table-swap-take-ii" rel="bookmark">Solving the non-atomic table swap, Take II</a> was good, in that it was safe. No data corruption. Optimistic: if no connection is killed throughout the process, then completely blocking.</p>
<p>Two outstanding issues remained:</p>
<ul>
<li>If something did go wrong, the solution reverted to a table-outage</li>
<li>On replicas, the table swap is non atomic, non blocking. There&rsquo;s table-outage scenario on replica.</li>
</ul>
<p>As it turns out, there&rsquo;s a simpler solution which overcomes both the above. As with math and physics, the simpler solution is often the preferred one. But it took those previous iterations to gather a few ideas together. So, anyway:</p>
<h3>Safe, locking, atomic, asynchronous table swap</h3>
<p>Do read the aforementioned previous posts; the quick-quick recap is: we want to be able to <strong>LOCK</strong> a table <strong>tbl</strong>, then do some stuff, then swap it out and put some <strong>ghost</strong> table in its place. MySQL does not allow us to <strong>rename tbl to tbl_old, ghost to tbl</strong> if we have locks on <strong>tbl</strong> in that session.</p>
<p>The solution we offer is now based on two connections only (as opposed to three, in the <em>optimistic</em> approach). &ldquo;Our&rdquo; connections will be C10, C20. The &ldquo;normal&rdquo; app connections are C1..C9, C11..C19, C21..C29.</p>
<ul>
<li>Connections C1..C9 operate on <strong>tbl</strong> with normal DML: <strong>INSERT, UPDATE, DELETE</strong></li>
<li>Connection C10: <strong>CREATE TABLE tbl_old (id int primary key) COMMENT=&lsquo;magic-be-here&rsquo;</strong></li>
<li>Connection C10: <strong>LOCK TABLES tbl WRITE, tbl_old WRITE</strong></li>
<li>Connections C11..C19, newly incoming, issue queries on <strong>tbl</strong> but are blocked due to the <strong>LOCK</strong></li>
<li>Connection C20: <strong>RENAME TABLE tbl TO tbl_old, ghost TO tbl</strong><br />
This is blocked due to the <strong>LOCK</strong>, <em>but</em> gets prioritized on top connections C11..C19 and on top C1..C9 or any other connection that attempts DML on <strong>tbl</strong></li>
<li>Connections C21..C29, newly incoming, issue queries on <strong>tbl</strong> but are blocked due to the <strong>LOCK</strong> and due to the <strong>RENAME</strong>, waiting in queue</li>
<li>Connection C10: checks that C20&rsquo;s <strong>RENAME</strong> is applied (looks for the blocked <strong>RENAME</strong> in processlist)</li>
<li>Connection 10: <strong>DROP TABLE tbl_old</strong><br />
Nothing happens yet; <strong>tbl</strong> is still locked. All other connections still blocked.</li>
<li>Connection 10: <strong>UNLOCK TABLES<br />
BAM!</strong> The <strong>RENAME</strong> is first to execute, <strong>ghost</strong> table is swapped in place of <strong>tbl</strong>, then C1..C9, C11..C19, C21..C29 all get to operate on the new and shiny <strong>tbl</strong></li>
</ul>
<p>Some notes</p>

  </p>

  
  <footer>
    <a href="/blog/2016/07/07/solving-the-non-atomic-table-swap-take-iii-making-it-atomic/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/06/20/solving-the-non-atomic-table-swap-take-ii/">Solving the non-atomic table swap, Take II</a></h2>

    <div class="post-meta">

  <div>

    <time>20 Jun 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/operations">operations</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Following up and improving on <a title="Link to Solving the Facebook-OSC non-atomic table swap problem" href="http://code.openark.org/blog/mysql/solving-the-facebook-osc-non-atomic-table-swap-problem" rel="bookmark">Solving the Facebook-OSC non-atomic table swap problem</a>, we present a better, safe solution.</p>
<h3>Quick, quickest recap:</h3>
<p>We are working on a triggerless online schema migration solution. It is based on an asynchronous approach, similarly to the <a href="https://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932/">FB osc</a> and as opposed to the synchronous solution as used by <a href="https://www.percona.com/doc/percona-toolkit/2.2/pt-online-schema-change.html">pt-online-schema-change</a>.</p>
<p>We asynchronously synchronize (is that even a valid statement?) between some table <strong>tbl</strong> and a ghost table <strong>ghost</strong>, and at some time we want to cut-over: swap the two; kick out <strong>tbl</strong> and put <strong>ghost</strong> in its place and under its name.</p>
<p>However, we cannot use the single statement <strong>rename tbl to tbl_old, ghost to tbl</strong>, because we use the asynchronous approach, where at the time we lock <strong>tbl</strong> for writes, we still have some events we need to process and apply onto <strong>ghost</strong> before swapping the two.</p>
<p>And MySQL does not allow a <strong>lock tables tbl write; &hellip; ; </strong><strong>rename tbl to tbl_old, ghost to tbl</strong>.</p>
<p>In <a title="Link to Solving the Facebook-OSC non-atomic table swap problem" href="http://code.openark.org/blog/mysql/solving-the-facebook-osc-non-atomic-table-swap-problem" rel="bookmark">Solving the Facebook-OSC non-atomic table swap problem</a> we suggested a way that works, unless when it doesn&rsquo;t work. Read the caveat at the end of the post. Premature death of a connection that participates in the algorithm causes a chain reaction that leads to the premature execution of the <strong>rename</strong> statement, potentially before we&rsquo;ve applied those remaining events. This leads to data inconsistency between the old table and the new table, and is unacceptable.</p>
<p>To that effect, we were more inclined to go with the Facebook solution, which makes a two-step: <strong>lock tables tbl write; alter table tbl rename to tbl_old; &hellip; ; alter table ghost rename to tbl;</strong></p>
<p>This two-step solution is guaranteed not to have data inconsistency. Alas, it also implies an outage. There&rsquo;s a brief moment, in between the two <strong>rename</strong>s, and during that time where we apply those last changes, where the table <strong>tbl</strong> is simply not there.</p>
<p>Not all applications will fail gracefully on such a scenario.</p>

  </p>

  
  <footer>
    <a href="/blog/2016/06/20/solving-the-non-atomic-table-swap-take-ii/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/05/03/solving-the-facebook-osc-non-atomic-table-swap-problem/">Solving the Facebook-OSC non-atomic table swap problem</a></h2>

    <div class="post-meta">

  <div>

    <time>03 May 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>We present a way to use an atomic, blocking table swap in the Facebook Online-Schema-Change solution, as well as in a rumored, other Online-Schema-rumored-Change solution. <strong>Update</strong>: also a caveat.</p>
<h3>Quick recap (really quick)</h3>
<p><a href="https://www.percona.com/doc/percona-toolkit/2.2/pt-online-schema-change.html">pt-online-schema-change</a> and <a href="https://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932/">facebook-osc</a> are two popular online-schema-change solutions for MySQL. They both use triggers, but in different ways. While the Percona tool uses synchronous table updates, such that any <strong>INSERT|UPDATE|DELETE</strong> on the modified table causes an <strong>INSERT|UPDATE|DELETE</strong> on a ghost table, in the Facebook tool all cause an <strong>INSERT</strong> on a changelog table, which is then iterated, read, having entries applied on the ghost table.</p>
<p>The TL;DR is that DMLs on the table propagate synchronously, within same transaction in the Percona tool, and asynchronously, with lag, in the Facebook tool.</p>
<h3>What&rsquo;s the problem with the table swap?</h3>
<p>In the Percona tool, once the logic is satisfied the copy is complete, we issue this query:</p>
<blockquote>
<pre>RENAME TABLE tbl TO tbl_old, tbl_new TO tbl;</pre>
</blockquote>
<p>This is an atomic, two table <strong>RENAME</strong> operation.</p>
<p>However with the asynchronous nature of the Facebook tool, such a <strong>RENAME</strong> would be a mistake. We must first block writes to the modified table, then make sure we have iterated the changelog table to the point of lock, apply those changes onto the ghost table, and only then do the swap.</p>
<p>The problem is: you cannot <strong>RENAME TABLES</strong> while one of them is <strong>LOCK</strong>ed.</p>
<p>This is silly, and inconsistent, because:</p>
<blockquote>
<pre>&gt; LOCK TABLES tbl WRITE;
Query OK, 0 rows affected (0.00 sec)</p>

<p>&gt; RENAME TABLE tbl TO tbl_old, tbl_new TO tbl;
ERROR 1192 (HY000): Can&rsquo;t execute the given command because you have active locked tables or an active transaction</p>

<p>&gt; ALTER TABLE tbl RENAME TO tbl_old;
Query OK, 0 rows affected (0.00 sec)</pre>
</blockquote>
<p>Why would the <strong>RENAME</strong> fail where the <strong>ALTER</strong> works?</p>
<p>Small thing, but critical to the operation of the online-schema-change. From the <a href="https://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932/">Facebook OSC documentation</a>:</p>
<blockquote>Since alter table causes an implicit commit in innodb, innodb locks get released after the first alter table. So any transaction that sneaks in after the first alter table and before the second alter table gets a &lsquo;table not found&rsquo; error. The second alter table is expected to be very fast though because copytable is not visible to other transactions and so there is no need to wait.</blockquote>
<h3>What the FB solution means</h3>
<p>It means for a very brief duration, the table is <em>not there</em>. Your app will get errors.</p>
<p>Of course, we <em>should</em> be able to handle errors anytime, aywhere. But the honest truth is: we (as in <em>the world</em>) do not. Many apps will fail ungracefully should they get a <em>table not found</em> error.</p>
<p>An atomic swap, as compared, would make for briefly blocking operations, making the app ignorant of the swap.</p>
<h3>Rumor</h3>
<p>Rumor has it that we at GitHub are developing a new, triggerless, Online Schema Change tool. It is rumored to be based off binary logs and is rumored to have lots of interesting rumored implications.</p>
<p>Such rumored implementation would have to be asynchronous by nature, or so rumors say. And as such, it would fall for the same non-atomic table swap problem.</p>
<h3>Solution</h3>
<p>Once we heard it was rumored we were working on a triggerless online schema change tool, we realized we would have to solve the non-atomic swap problem. What we did was to gossip about it in between ourselves, which led to three different rumors of a solution, eventually manifested as three different working solutions. All three solutions make for blocking queries on the app&rsquo;s side. I will present one of these solution here, based on voluntary locks.</p>

  </p>

  
  <footer>
    <a href="/blog/2016/05/03/solving-the-facebook-osc-non-atomic-table-swap-problem/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/04/22/mysql-community-awards-2016-the-winners/">MySQL Community Awards 2016: the Winners</a></h2>

    <div class="post-meta">

  <div>

    <time>22 Apr 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>The MySQL Community Awards initiative is an effort to acknowledge and thank individuals and corporates for their contributions to the MySQL ecosystem. It is a from-the-community, by-the-community and for-the-community effort. The committee is composed of an independent group of community members of different orientation and opinion, themselves past winners or known contributors to the community.</p>
<p>The 2016 community awards were presented on April 21st, 2016, during the keynotes at the Percona Live conference. The winners are:</p>
<h4>MySQL Community Awards: Community Contributor of the year 2016</h4>
<ul>
<li><strong>Bill Karwin<br />
</strong>Bill has been working with the community for years, helping them understand SQL. Bill is the author of the great book &ldquo;SQL Antipatterns&rdquo;. He has given a large amount of help on sites such as StackOverflow, Quora, and of course many conference talks. Bill has provided a huge amount of help to the community directly.</li>
<li><strong style="line-height: 1.5;">Domas Mituzas<br />
</strong>Domas Mituzas started in the MySQL ecosystem as a MySQL Support Engineer at MySQL AB. Since he had some spare time, he did a lot of work to scale MySQL at Wikipedia. He is now a small data engineer at Facebook, mostly working with user-facing data systems. He continues to write very interesting blog posts and bug reports. Domas is responsible for giving us MyDumper, PoorMansProfiler, and the infamous Query Cache tuner!</li>
<li><strong>Yoshinori Matsunobu<br />
</strong>Yoshinori Matsunobu is currently leading the MyRocks effort to get the RocksDB storage engine for MySQL into production at Facebook. Previously (amongst his other accomplishments) he created HandlerSocket, and implemented MHA to support failover automation for MySQL – both of which have been used at many companies. He is a frequent speaker at community events, and his tutorials and slide decks do a lot to increase expertise in the community. He is a frequent bug reporter with a focus on replication (RBR, semi-sync).</li>
</ul>
<h4>MySQL Community Awards: Application of the year 2016</h4>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/2016/04/22/mysql-community-awards-2016-the-winners/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2016/02/05/mysql-community-awards-2016-call-for-nominations/">MySQL Community Awards 2016: Call for Nominations!</a></h2>

    <div class="post-meta">

  <div>

    <time>05 Feb 2016</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/community">community</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>The <strong>2016</strong> MySQL Community Awards event will take place, as usual, in Santa Clara, during the Percona Live Data Performance Conference, April 2016.</p>
<p>The MySQL Community Awards is a community based initiative. The idea is to publicly recognize contributors to the MySQL ecosystem. The entire process of discussing, voting and awarding is controlled by an independent group of community members, typically based of past winners or their representatives, as well as known contributors.</p>
<p>It is a self-appointed, self-declared, self-making-up-the-rules-as-it-goes committee. It is also very aware of the importance of the community; a no-nonsense, non-political, adhering to tradition, self criticizing committee.</p>
<p>The Call for Nominations is open. We are seeking the community’s assistance in nominating candidates in the following categories:<span id="more-7199"></span></p>
<h4>MySQL Community Awards: Community Contributor of the year 2016</h4>
<p>This is a personal award; a winner would a person who has made contribution to the MySQL ecosystem. This could be via development, advocating, blogging, speaking, supporting, etc. All things go.</p>
<h4>MySQL Community Awards: Application of the year 2016</h4>
<p>An application, project, product etc. which supports the MySQL ecosystem by either contributing code, complementing its behaviour, supporting its use, etc. This could range from a one man open source project to a large scale social service.</p>
<h4>MySQL Community Awards: Corporate Contributor of the year 2016</h4>
<p>A company who made contribution to the MySQL ecosystem. This might be a corporate which released major open source code; one that advocates for MySQL; one that help out community members by&hellip; anything.</p>
<p>For a list of previous winners, please see <a href="http://mysqlawards.org/mysql-hall-of-fame/">MySQL Hall of Fame</a>.</p>

  </p>

  
  <footer>
    <a href="/blog/2016/02/05/mysql-community-awards-2016-call-for-nominations/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2015/12/23/orchestrator-progress/">Orchestrator progress</a></h2>

    <div class="post-meta">

  <div>

    <time>23 Dec 2015</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/github">GitHub</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/orchestrator">orchestrator</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/secondary">secondary</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  This comes mostly to reassure, having moved into GitHub: orchestrator development continues. I will have the privilege of working on this open source solution in GitHub. There are a few directions we can take orchestrator to, and we will be looking into the possibilities. We will continue to strengthen the crash recovery process, and in fact I've got a couple ideas on drastically shortening Pseudo-GTID recovery time as well as other debts.
  </p>

  
  <footer>
    <a href="/blog/2015/12/23/orchestrator-progress/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  

  


<nav class="pagination" role="pagination">
  
  <i class="fa fa-chevron-left"></i>
  
  <span>&nbsp;1 / 38&nbsp;</span>
  
  <a href="/page/2/"><i class="fa fa-chevron-right"></i></a>
  
</nav>



</div>

</div>
</div>
<script src="/blogjs/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Your Google Analytics tracking ID', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>


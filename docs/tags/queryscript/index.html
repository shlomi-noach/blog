<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>Queryscript &middot; code.openark.org</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  
  <link rel="alternate" type="application/rss+xml" title="code.openark.org" href="/blog/tags/queryscript/index.xml" />
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/blogimg/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <a class="pure-menu-heading brand" href="/blog">openark.org</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/page/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="/blog/tags/queryscript/index.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a class="pure-menu-link">
        Shlomi Noach
        
          <div class="avatar-container">
        	  <div class="avatar-img-border">
                <img class="avatar-img" src="/blog/images/shlomi-noach.png" alt="code.openark.org" />
        	  </div>
        	</div>
        
      </a>
    </li>

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/shlomi-noach" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ShlomiNoach" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/shlominoach" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>





  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Queryscript</h1>
</div>

<div class="content">
  
    <article>
  <header>
    <h2><a href="/blog/2014/02/06/why-delegating-code-to-mysql-stored-routines-is-poor-engineering-practice/">Why delegating code to MySQL Stored Routines is poor engineering practice</a></h2>

    <div class="post-meta">

  <div>

    <time>06 Feb 2014</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/opinions">Opinions</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/stored-routines">Stored routines</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I happen to use stored routines with MySQL. In fact, my open source project <a href="http://code.google.com/p/common-schema/">common_schema</a> heavily utilizes them. DBA-wise, I think they provide with a lot of power (alas, the ANSI:SQL 2003 syntax feels more like COBOL than a sane programming language, which is why I use <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a> instead).</p>
<p>However I wish to discuss the use of stored routines as integral part of your application code, which I discourage.</p>
<p>The common discussion on whether to user or not use stored routines typically revolves around data transfer (with stored routines you transfer less data since it&rsquo;s being processed on server side), security (with stored routines you can obfuscate/hide internal datasets, and provide with limited and expected API) and performance (with MySQL this is not what you would expect, as routines are interpreted &amp; their queries re-evaluated, as opposed to other RDBMS you may be used to).</p>
<p>But I wish to discuss the use of stored routines from an engineering standpoint. The first couple of points I raise are cultural/behavioural.</p>
<h4>2nd grade citizens</h4>
<p>Your stored routines are not likely to integrate well with your IDE. While your Java/Scala/PHP/Ruby/whatnot code comfortably lies within your home directory, the stored routines live in their own space: a database container. They&rsquo;re not as visible to you as your standard code. Your IDE is unaware of their existence and is unlikely to have the necessary plugin/state of mind to be able to view these.</p>
<p>This leads to difficulty in maintaining the code. People typically resort to using some SQL-oriented GUI tool such as MySQL Workbench, SequelPro or other, commercial tools. But these tools, while make it easy to edit your routine code, do not integrate (well?) with your source control. I can&rsquo;t say I&rsquo;ve used all GUI tools; but how many of them will have Git/SVN/Mercurial connectors? How many of them will keep local history changes once you edit a routine? I&rsquo;m happy to get introduced to such a tool.</p>
<p>Even with such integration, you&rsquo;re split between two IDEs. And if you&rsquo;re the command line enthusiast, well, you can&rsquo;t just <strong>svn ci -m &ldquo;fixed my stored procedure bug&rdquo;</strong>. Your code is simply not in your trunk directory.</p>
<p>It <em>can</em> be done. You <em>could</em> maintain the entire routine code from within your source tree, and hats off to all those who do it. Most will not. See later on about deployments for more on this.</p>

  </p>

  
  <footer>
    <a href="/blog/2014/02/06/why-delegating-code-to-mysql-stored-routines-is-poor-engineering-practice/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/09/03/converting-an-olap-database-to-tokudb-part-1/">Converting an OLAP database to TokuDB, part 1</a></h2>

    <div class="post-meta">

  <div>

    <time>03 Sep 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/compression">compression</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/performance">Performance</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/tokudb">TokuDB</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>This is the first in a series of posts describing my impressions of converting a large OLAP server to TokuDB. There&rsquo;s a lot to tell, and the experiment is not yet complete, so this is an ongoing blogging. In this post I will describe the case at hand and out initial reasons for looking at TokuDB.</p>
<p>Disclosure: I have no personal interests and no company interests; we did get friendly, useful and free advice from Tokutek engineers. TokuDB is open source and free to use, though commercial license is also available.</p>
<h4>The case at hand</h4>
<p>We have a large and fast growing DWH MySQL setup. This data warehouse is but one component in a larger data setup, which includes Hadoop, Cassandra and more. For online dashboards and most reports, MySQL is our service. We populate this warehouse mainly via Hive/Hadoop. Thus, we have an hourly load of data from Hive, as well as a larger daily load.</p>
<p>There are some updates on the data, but the majority of writes are just <strong>mysqlimport</strong>s of Hive queries.</p>
<p>Usage of this database is OLAP: no concurrency issues here; we have some should-be-fast-running queries issued by our dashboards, as well as ok-to-run-longer queries issued for reports.</p>
<p>Our initial and most burning trouble is with size. Today we use <strong>COMPRESSED</strong> InnoDB tables (<strong>KEY_BLOCK_SIZE</strong> is default, i.e. <strong>8</strong>). Our data volume sums right now at about <strong>2TB</strong>. I happen to know this translates as <strong>4TB</strong> of uncompressed data.</p>
<p>However growth of data is accelerating. A year ago we would capture a dozen GB per month. Today it is a <strong>100GB</strong> per month, and by the end of this year it may climb to <strong>150GB</strong> per month or more.</p>
<p>Our data is not sharded. We have a simple replication topology of some <strong>6</strong> servers. Machines are quite generous as detailed following. And yet, we will be running out of resources shortly: disk space (total <strong>2.7TB</strong>) is now running low and is expected to run out in about six months. One of my first tasks in Outbrain is to find a solution to our DWH growth problem. The solution could be sharding; it could be a commercial DWH product; anything that works.</p>

  </p>

  
  <footer>
    <a href="/blog/2013/09/03/converting-an-olap-database-to-tokudb-part-1/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/08/13/common_schema-2-2-better-queryscript-isolation-tokudb-table_rotate-split-params/">common_schema 2.2: better QueryScript isolation &amp; cleanup; TokuDB; table_rotate, split params</a></h2>

    <div class="post-meta">

  <div>

    <time>13 Aug 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p><a href="https://code.google.com/p/common-schema/"><strong>common_schema 2.2</strong></a> is released. This is shortly after the 2.1 release; it was only meant as bug fixes release but some interesting things came up, leading to new functionality.</p>
<p>Highlights of the <strong>2.2</strong> release:</p>
<ul>
<li>Better QueryScript isolation &amp; cleanup: isolation improved across replication topology, cleanup done even on error</li>
<li>Added <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/tokudb_views.html">TokuDB related views</a></li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> with &ldquo;index&rdquo; hint (Ike, this is for you)</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/table_rotate.html"><strong>table_rotate()</strong></a>: a <em>logrotate</em>-like mechanism for tables</li>
<li>better throw()</li>
</ul>
<p>Drill down:</p>
<h4>Better QueryScript isolation &amp; cleanup</h4>
<p><em>common_schema</em> <strong>2.1</strong> introduced persistent tables for QueryScript. This also introduced the problem of isolating concurrent scripts, all reading from and writing to shared tables. In <strong>2.1</strong> isolation was based on session id. However although unique per machine, collisions were possible across replication topology: a script could be issued on master, another on slave (I have such use cases) and both use same (local) session id.</p>
<p>With 2.2 isolation is based on server_id &amp; session id combination; this is unique across a replication topology.</p>
<p>Until <strong>2.1</strong>, QueryScript used temporary tables. This meant any error would just break the script, and the tables were left (isolated as they were, and auto-destroyed in time). With persistent tables a script throwing an error meant legacy code piling up. With <em>common_schema</em> <strong>2.2</strong> and on MySQL &gt;= <strong>5.5</strong> all exceptions are caught, cleanup is made, leaving exceptions to be <strong>RESIGNAL</strong>led.</p>
<h4>TokuDB views</h4>
<p>A couple TokuDB related views help out in converting to TokuDB and in figuring out tables status on disk:</p>

  </p>

  
  <footer>
    <a href="/blog/2013/08/13/common_schema-2-2-better-queryscript-isolation-tokudb-table_rotate-split-params/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/07/22/common_schema-roadmap-thoughts/">common_schema roadmap thoughts</a></h2>

    <div class="post-meta">

  <div>

    <time>22 Jul 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/community">community</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I&rsquo;m happy with <strong><a href="https://code.google.com/p/common-schema/">common_schema</a></strong>; it is in fact a tool I use myself on an almost daily basis. I&rsquo;m also happy to see that it gains traction; which is why I&rsquo;m exposing a little bit of my thoughts on general future development. I&rsquo;d love to get feedback.</p>
<h4>Supported versions</h4>
<p>At this moment, <em>common_schema</em> supports MySQL &gt;= <strong>5.1</strong>, all variants. This includes <strong>5.5</strong>, <strong>5.6</strong>, MySQL, Percona Server &amp; MariaDB.</p>
<p><strong>5.1</strong> is today past end of line, and I&rsquo;m really missing the <strong>SIGNAL</strong>/<strong>RESIGNAL</strong> syntax that I would like to use; I can do in the meanwhile with version-specific code such as <strong>/*!50500 &hellip; */</strong>. Nevertheless, I&rsquo;m wondering whether I will eventually have to:</p>
<ul>
<li>Support different branches of <em>common_schema</em> (one that supports <strong>5.1</strong>, one that supports &gt;= <strong>5.5</strong>)</li>
<li>Stop support for <strong>5.1</strong></li>
</ul>
<p>Of course community-wise, the former is preferred; but I have limited resources, so I would like to make a quick poll here:</p>
<p>[poll id=&ldquo;3&rdquo;]</p>
<p>I&rsquo;ll use the poll&rsquo;s results as a <em>vague idea of what people use and want</em>. Or please use comments below to sound your voice!</p>
<h4>rdebug</h4>
<p>This was a crazy jump at providing a <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">stored routine debugger and debugging API</a>. From some talk I made I don&rsquo;t see this getting traction. For the time being, I don&rsquo;t see that I will concentrate my efforts on this. Actually it is almost complete. You can step-into, step-out, step-over, set breakpoints, read variables, modify variables &ndash; it&rsquo;s pretty cool.</p>

  </p>

  
  <footer>
    <a href="/blog/2013/07/22/common_schema-roadmap-thoughts/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/07/17/common_schema-2-1-released-advanced-improved-split-persistent-script-tables-more-schema-analysis-and-ahem-charts/">common_schema 2.1 released: advanced &amp; improved split(), persistent script tables, more schema analysis, and (ahem) charts!</a></h2>

    <div class="post-meta">

  <div>

    <time>17 Jul 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/charts">charts</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p><a href="https://code.google.com/p/common-schema/"><strong>common_schema 2.1</strong></a> is released! <em>common_schema</em> is your free &amp; open source companion schema within your MySQL server, providing with a function library, scripting capabilities, powerful routines and ready-to-apply information and recommendations.</p>
<p>New and noteworthy in version <strong>2.1</strong>:</p>
<ul>
<li>Better <em>QueryScript&rsquo;</em>s <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split()</strong></a> functionality</li>
<li>Persistent tables for QueryScript: no long held temporary tables</li>
<li>Index creation analysis, further range partition analysis</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/grant_access.html"><strong>grant_access()</strong></a>: allow everyone to use <em>common_schema</em></li>
<li>Ascii charts, google charts</li>
<li><strong>debugged_routines</strong>: show routines with debug code</li>
</ul>
<p>Other minor enhancements and bugfixes not listed.</p>
<p>Here&rsquo;s a breakdown of the above:</p>
<h4>split() enhancements</h4>
<p><strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html">split</a></strong> is one of those parts of <em>common_schema</em> that (should) appeal to every DBA. Break a huge transaction automagically into smaller chunks, and don&rsquo;t worry about how it&rsquo;s done. If you like, throttle execution, or print progress, or&hellip;</p>
<p><em>split</em> enhancements include:</p>
<ul>
<li>A much better auto-detection-and-selection of the chunking index. <em>split</em> now consults all columns covered by the index, and uses realistic heuristics to decide which <strong>UNIQUE KEY</strong> on your table is best for the chunking process. A couple bugs are solved on the way; <em>split</em> is much smarter now.</li>
<li>Better support for multi-column chunking keys. You may now utilize the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html#parameters"><strong>start</strong>/<strong>stop</strong> parameters</a> even on multi column keys, passing a comma delimited of values for the <em>split</em> operation to start/end with, respectively. Also fixed issue for nonexistent <strong>start/stop</strong> values, which are now valid: <em>split</em> will just keep to the given range.</li>
<li>split no longer requires a temporary table open through the duration of its operation. See next section.</p>

  </p>

  
  <footer>
    <a href="/blog/2013/07/17/common_schema-2-1-released-advanced-improved-split-persistent-script-tables-more-schema-analysis-and-ahem-charts/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/05/07/opeark-kit-revision-196-released/">opeark-kit revision 196 released</a></h2>

    <div class="post-meta">

  <div>

    <time>07 May 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>This is a long due maintenance release of <a href="http://code.google.com/p/openarkkit/"><strong>openark-kit</strong>.</a> This release includes bugfixes and some enhancements, mainly to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">oak-online-alter-table</a>.</p>
<p><em>oak-online-alter-table</em> Changes / bug fixes include:</p>
<ul>
<li>Support for keyword-named columns</li>
<li>Use of FORCE INDEX due to lack of MySQL&rsquo;s ability for figure out the chunking key at all times</li>
<li><strong>&ndash;sleep-ratio</strong> option added; allows for sleep time proportional to execution time (as opposed to constant sleep time with <strong>&ndash;sleep</strong>)</li>
<li>Support for chunk-retry (in case of deadlock) via <strong>&ndash;max-lock-retries</strong>)</li>
<li>Fixed order of cleanup</li>
<li>Fixed bug with verbose messages with non-integer chunking key</li>
<li>Fixed bug with single-row tables (people, no need for this tool for single row tables :))</li>
<li>Friendly verbose messages to remind you what&rsquo;s being executed</li>
</ul>
<p><em>oak-chunk-update</em> changes includes:</p>
<ul>
<li>Verbosing query comment if exists (friendly printing of what&rsquo;s being executed)</li>
</ul>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/2013/05/07/opeark-kit-revision-196-released/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2013/01/14/common_schema-1-3-security-goodies-parameterized-split-json-to-xml-query-checksum/">common_schema: 1.3: security goodies, parameterized split(), json-to-xml, query checksum</a></h2>

    <div class="post-meta">

  <div>

    <time>14 Jan 2013</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/new-features">New Features</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/security">Security</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>common_schema <strong>1.3</strong> is released and is <a href="http://code.google.com/p/common-schema">available for download</a>. New and noteworthy in this version:</p>
<ul>
<li>Parameterized <strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html">split()</a></strong>: take further control over huge transactions by breaking them down into smaller chunks, now manually tunable if needed</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/duplicate_grantee.html"><strong>duplicate_grantee()</strong></a>: copy+paste existing accounts along with their full set of privileges</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/similar_grants.html"><strong>similar_grants</strong></a>: find which accounts share the exact same set of privileges (i.e. have the same <em>role</em>)</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/json_to_xml.html"><strong>json_to_xml()</strong></a>: translate any valid JSON object into its equivalent XML form</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/extract_json_value.html"><strong>extract_json_value()</strong></a>: use XPath notation to extract info from JSON data, just as you would from XML</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_checksum.html"><strong>query_checksum()</strong></a>: given a query, calculate a checksum on the result set</li>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/random_hash.html"><strong>random_hash()</strong></a>: get a 40 hexadecimal digits random hash, using a reasonably large changing input</li>
</ul>
<p>Let&rsquo;s take a closer look at the above:</p>
<h4>Parameterized split()</h4>
<p><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> takes your bulk query and automagically breaks it down into smaller pieces. So instead of one huge <strong>UPDATE</strong> or <strong>DELETE</strong> or <strong>INSERT..SELECT</strong> transaction, you get many smaller transactions, each with smaller impact on I/O, locks, CPU.</p>
<p>As of <strong>1.3</strong>, <em>split()</em> gets more exposed: you can have some control on its execution, and you also get a lot of very interesting info during operation.</p>
<p>Here&rsquo;s an example of <em>split()</em> control:</p>
<blockquote>
<pre>set @script := &ldquo;
  <strong>split</strong>({<em>start</em>:7015, <em>step</em>:2000} : <span style="color: #3366ff;">UPDATE sakila.rental SET return_date = return_date + INTERVAL 1 DAY</span>)
    <strong>throttle</strong> 1;
&ldquo;;
call common_schema.run(@script);</pre>
</blockquote>
<p>In the above we choose a split size of 2,000 rows at a time; but we also choose to only start with <strong>7015</strong>, skipping all rows prior to that value. Just what is that value? It depends on the splitting key (and see next example for just that); but in this table we can safely assume this is the <strong>rental_id</strong> <strong>PRIMARY KEY</strong> of the table.</p>
<p>You don&rsquo;t <em>have to</em> use these control <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html#parameters">parameters</a>. But they can save you some time and effort.</p>

  </p>

  
  <footer>
    <a href="/blog/2013/01/14/common_schema-1-3-security-goodies-parameterized-split-json-to-xml-query-checksum/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/12/12/common_schema-over-traditional-scripts/">common_schema over traditional scripts</a></h2>

    <div class="post-meta">

  <div>

    <time>12 Dec 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/python">python</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/stored-routines">Stored routines</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>If you are familiar with both <a href="http://code.openark.org/forge/openark-kit">openark kit</a> and <a href="http://code.google.com/p/common-schema">common_schema</a>, you&rsquo;ll notice I&rsquo;ve incorporated some functionality already working in <em>openark kit</em> into <em>common_schema</em>, essentially rewriting what used to be a Python script into SQL/<a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a>.</p>
<p>What was my reasoning for rewriting good code? I wish to explain that, and provide with a couple examples.</p>
<p>I&rsquo;m generally interested in pushing as much functionality into the MySQL server. When using an external script, one:</p>
<ul>
<li>Needs the right dependencies (OS, Perl/Python version, Perl/Python modules).</li>
<li>Needs to provide with connection params,</li>
<li>Needs to get acquainted with a lot of command line options,</li>
<li>Is limited by whatever command line options are provided.</li>
<li>Has to invoke that script (duh!) to get the work done.</li>
</ul>
<p>This last bullet is not so trivial: it means you can&rsquo;t work some operation with your favorite GUI client, because it has no notion of your Perl script; does not run on the same machine where your Python code resides; simply can&rsquo;t run those scripts for you.</p>
<p>With server-side code, functionality is accessible via any client. You run your operation via a query (e.g. <strong>CALL some_procedure</strong>). That can be done from your GUI client, your command line client, your event scheduler, your cronjob, all equally. You only need access to your MySQL server, which is trivial.</p>
<p>Of course, server side scripting is <a href="http://code.openark.org/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine">limited</a>. Some stuff simply can&rsquo;t be written solely on server side. If you want to consult your replicating slave; gracefully take action on user&rsquo;s <strong>Ctrl+C</strong>, send data over the web, you&rsquo;ll have to do it with an external tool. There are actually a lot of surprising limitations to things one would assume <em>are</em> possible on server side. You may already know how frustrated I am by the fact one can <a href="http://code.openark.org/blog/mysql/reading-results-of-show-statements-on-server-side">hardly</a> get info from <strong>SHOW</strong> commands.</p>
<h4>But, when it works, it shines</h4>
<p>Let&rsquo;s review a couple examples. The first one is nearly trivial. The second less so.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/12/12/common_schema-over-traditional-scripts/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/11/14/purging-old-rows-with-queryscript-three-use-cases/">Purging old rows with QueryScript: three use cases</a></h2>

    <div class="post-meta">

  <div>

    <time>14 Nov 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/bulk-operations">Bulk operations</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Problem: you need to purge old rows from a table. This may be your weekly/monthly cleanup task. The table is large, the amount of rows to be deleted is large, and doing so in one big <strong>DELETE</strong> is too heavy.</p>
<p>You can use <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> or <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archiver</a> to accomplish the task. You can also use server side scripting with <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a>, offering a very simple syntax with no external scripting, dependencies and command line options.</p>
<p>I wish to present three cases of row deletion, with three different solutions. In all cases we assume some <strong>TIMESTAMP</strong> column exists in table, by which we choose to purge the row. In all cases we assume we wish to purge rows older than <strong>1</strong> month.</p>
<p>We assume the naive query is this:</p>
<blockquote>
<pre>DELETE FROM my_schema.my_table WHERE row_timestamp &lt; CURDATE() - INTERVAL 1 MONTH</pre>
</blockquote>
<h4>Case 1: TIMESTAMP column is indexed</h4>
<p>I almost always index a timestamp column, if only for being able to quickly purge data (but usually also to slice data by date). In this case where the column is indexed, it&rsquo;s very easy to figure out which rows are older than <strong>1</strong> month.</p>
<p>We break the naive query into smaller parts, and execute these in sequence:</p>

  </p>

  
  <footer>
    <a href="/blog/2012/11/14/purging-old-rows-with-queryscript-three-use-cases/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/11/13/common_schema-1-2-security-partition-management-processes-queryscript-goodies/">common_schema 1.2: security, partition management, processes, QueryScript goodies</a></h2>

    <div class="post-meta">

  <div>

    <time>13 Nov 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/partitioning">partitioning</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/security">Security</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p><a href="http://code.google.com/p/common-schema">common_schema</a> <strong>1.2</strong> is released! This version comes shortly after <strong>1.1</strong>, yet contains quite a few interesting goodies:</p>
<ul>
<li>Account blocking</li>
<li>Security audit</li>
<li>RANGE partition management</li>
<li>Slave status</li>
<li>Better blocking and idle transaction management</li>
<li><em>QueryScript </em>goodies:
<ul>
<li>echo, report</li>
<li>while-otherwise statement; foreach-otherwise statement</li>
<li>Better variable scope handling</li>
<li>Complete support for variable expansion</li>
<li>Transaction support within QueryScript</li>
</ul>
</li>
<li>More summary info and SQL statements in processlist-related views</li>
</ul>
<p>A closer look at these follows:</p>
<h4>Account blocking</h4>
<p>A new view called <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_accounts.html"><strong>sql_accounts</strong></a>, inspired by <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-block-account.html">oak-block-account</a> (also see <a href="http://code.openark.org/blog/mysql/blocking-user-accounts">here</a> and <a href="http://code.openark.org/blog/mysql/pop-quiz-what-is-the-most-basic-privilege-an-account-can-be-assigned-with">here</a>) provides with the means of blocking use accounts (and releasing them, of course) without revoking their privileges. It offers the SQL statements to block an account (by modifying its password in a symmetric way) and to release an account (by modifying its password back to normal). It really works like a charm. Together with <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/killall.html">killall()</a> and <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_grants.html">sql_accounts</a> this gives the administrator great control over accounts.</p>
<h4>Security audit</h4>
<p>Imported from <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-security-audit.html">openark kit</a>, and implemented via <em>QueryScript</em>, the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/security_audit.html"><strong>security_audit()</strong></a> procedure will audit your accounts, passwords and general settings to find problems, pitfalls and security hazards. I will write more on this later.</p>
<h4>RANGE partition management</h4>
<p>The <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_range_partitions.html"><strong>sql_range_partitions</strong></a> view manages your <strong>RANGE</strong> and <strong>RANGE COLUMNS</strong> partitioned tables by providing with the SQL statements to drop oldest partitions and to create the next (in sequence) partitions. See my <a href="http://code.openark.org/blog/mysql/your-magical-range-partitioning-maintenance-query">earlier post</a>.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/11/13/common_schema-1-2-security-partition-management-processes-queryscript-goodies/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/09/11/how-common_schema-installs-itself/">How common_schema installs itself</a></h2>

    <div class="post-meta">

  <div>

    <time>11 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/installation">Installation</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Up till <a href="http://code.google.com/p/common-schema/">common_schema</a> version <strong>1.1</strong>, the user would need to choose from distinct distribution files: an install compatible with MySQL <strong>5.1</strong>, one compatible with InnoDB Plugin enabled servers, and one compatible with Percona Server. The difference between the three is the availability of certain <strong>INFORMATION_SCHEMA</strong> tables.</p>
<p>With <strong>1.1</strong>, this is no longer the case: <em>common_schema</em> auto-detects the server and available feature set, and installs accordingly.</p>
<h4>Wait, isn&rsquo;t common_schema just a SQL file?</h4>
<p>Yes. It&rsquo;s not like there&rsquo;s an installer like <em>InstallShield</em> or anything. Nevertheless, <em>common</em><em>_schema</em> offers a smart way of conditional handling, which is uses in itself. It&rsquo;s called <a href="http://www.queryscript.com/">QueryScript</a>.</p>
<p><em>common_schema</em> is installed by importing the SQL file (via <strong>SOURCE</strong> command; the <em>mysql</em> client; your favorite GUI). This creates your usual tables, views and routines. But some of these routines make for an interpreter for <em>QueryScript</em>. Somewhere along the installation process (remember - it&rsquo;s just a SQL import), <em>common_schema</em> switches over to executing scripts to manage the installation. In particular, there are a few views which depend on optional tables, such as InnoDB Plugin&rsquo;s tables for <strong>INFORMATION_SCHEMA</strong>.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/09/11/how-common_schema-installs-itself/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/09/06/how-common_schema-splits-tables-internals/">How common_schema split()s tables - internals</a></h2>

    <div class="post-meta">

  <div>

    <time>06 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>This post exposes some of the internals, and the SQL behind QueryScript&rsquo;s <em>split</em>. <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema/QueryScript</a> <strong>1.1</strong> introduces the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> statement, which auto-breaks a &ldquo;large&rdquo; query (one which operates on large tables as a whole or without keys) into smaller queries, and executes them in sequence.</p>
<p>This makes for easier transactions, less locks held, potentially (depending on the user) more idle time released back to the database. <em>split<strong></strong></em> has similar concepts to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> and <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archiver</a>, but works differently, and implemented entirely in SQL on server side.</p>
<p>Take the following statement as example:</p>
<blockquote>
<pre><strong>split</strong> (<strong>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR</strong>)
  pass;</pre>
</blockquote>
<p>It yields with (roughly) the following statements:</p>
<blockquote>
<pre>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;1&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;1&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;1000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;1000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;1000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;2000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;2000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;2000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;3000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;3000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;3000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;4000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;4000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;4000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;4581&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;4581&rsquo;))));</pre>
</blockquote>
<p>(I say &ldquo;roughly&rdquo; because internally there are user defined variables at play, but for convenience, I verbose the actual values as constants.)</p>
<h4>How does that work?</h4>
<p><em>common_schema</em> works on server side. There is no Perl script or anything. It must therefore use server-side operations to:</p>
<ul>
<li>Identify table to be split</li>
<li>Analyze the table in the first place, deciding how to split it</li>
<li>Analyze the query, deciding on how to rewrite it</li>
<li>Split the table (logically) into unique and distinct chunks</li>
<li>Work out the query on each such chunk</li>
</ul>
<p>Following is an internal look at how <em>common_schema</em> does all the above.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/09/06/how-common_schema-splits-tables-internals/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/09/05/table-split-for-the-masses/">Table split(...) for the masses</a></h2>

    <div class="post-meta">

  <div>

    <time>05 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>(pun intended)</p>
<p><em>common_schema</em>&rsquo;s new <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> statement (see <a href="http://code.openark.org/blog/mysql/common_schema-1-1-released-split-try-catch-killall-profiling">release announcement</a>) auto-splits complex queries over large tables into smaller ones: instead of issuing one huge query, <em>split</em> breaks one&rsquo;s query into smaller queries, each working on a different set of rows (a chunk).</p>
<p>Thus, it is possible to avoid holding locks for long times, allowing for smaller transactions. It also makes for breathing space for the RDBMS, at times boosting operation speed, and at times prolonging operation speed at will.</p>
<p>In this post I show how <em>split</em> exposes itself to the user, should the user wish so.</p>
<p><em>split</em> can manage queries of the following forms:</p>
<ul>
<li>DELETE FROM table_name [WHERE]&hellip;</li>
<li>DELETE FROM table_name USING &lt;multi table syntax&gt; [WHERE]&hellip;</li>
<li>UPDATE table_name SET &hellip; [WHERE]&hellip;</li>
<li>UPDATE &lt;multiple tables&gt; SET &hellip; [WHERE]&hellip;</li>
<li>INSERT INTO some_table SELECT &hellip; FROM &lt;single or multiple tables&gt; [WHERE]&hellip;</li>
<li>REPLACE INTO some_table SELECT &hellip; FROM &lt;single or multiple tables&gt; [WHERE]&hellip;</li>
<li>SELECT &hellip; FROM &lt;multiple tables&gt; [WHERE]&hellip;</li>
</ul>
<p>The latter being a non-obvious one at first sight.</p>
<h4>Basically, it&rsquo; automatic</h4>
<p>You just say:</p>
<blockquote>
<pre><strong>split</strong> (UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR)
  throttle 2;</pre>
</blockquote>
<p>And <em>split</em> identifies <strong>sakila.inventory</strong> as the table which needs to be split, and injects appropriate conditions so as to work on a subset of the rows, in multiple steps.</p>
<p>By the way, here&rsquo;s <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_execution.html">how to execute a QueryScript code</a> like the above.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/09/05/table-split-for-the-masses/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/09/04/common_schema-1-1-released-split-try-catch-killall-profiling/">common_schema 1.1 released: split(), try-catch, killall(), profiling</a></h2>

    <div class="post-meta">

  <div>

    <time>04 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/analysis">Analysis</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I&rsquo;m very happy to announce the release of <a href="http://code.google.com/p/common-schema/">common_schema</a>, version <strong>1.1</strong> (revision <strong>300</strong>).</p>
<p>This version boasts with compelling new features: innovative QueryScript syntax, libraries, views which add to your skills as a DBA, making some maintenance and management tasks a breeze.</p>
<ul>
<li>QueryScript, <strong>split</strong> statement: automagically break long queries into smaller chunks, avoid long locks and reduce query/transaction overhead</li>
<li>QueryScript, <strong>try-catch</strong> statement: just <strong>try { something; } catch { act_on_error; }</strong>.</li>
<li><strong>killall()</strong>: quickly kill connections based on grantee/user/host information.</li>
<li><strong>profiling</strong>/<strong>profiling_last</strong>: utility views to assist in query profiling diagnostics</li>
<li><strong>1 size fits all</strong>: a single installer which auto-recognizes available server features and enables respective <em>common_schema</em> features accordingly.</li>
<li>QueryScript performance boost</li>
<li>much much more&hellip;</li>
</ul>
<p>Not familiar with <em>common_schema</em>? It allows you to do stuff on server side, by selecting from views, calling upon useful routines or writing <em>easy-to-manage</em> scripts.</p>
<p>I&rsquo;m suggesting that <em>common_schema</em> should be a <em>really-should-have</em> tool to accompany your MySQL install. Did I say &ldquo;tool&rdquo;? It&rsquo;s merely a <em>schema</em>. But it makes for a great framework:</p>
<p>In <a href="http://www.amazon.com/High-Performance-MySQL-Optimization-Replication/dp/1449314287/ref=dp_ob_title_bk">High Performance MySQL, 3rd edition</a>, Baron Schwartz describes <em>common_schema</em>:</p>
<blockquote>The <em>common_schema</em> is to MySQL as jQuery is to javaScript</blockquote>
<p>Reviewing highlights for version <strong>1.1</strong>:</p>
<h4>QueryScript</h4>
<p><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a> is a scripting language. It sees some major improvements here. I&rsquo;ve made some speed boosts by <a href="http://code.openark.org/blog/mysql/on-stored-routines-and-dynamic-statements">avoiding using temporary tables</a>, and by using string parsing instead.</p>
<p>Without doubt the two most handy statements added to <em>QueryScript</em> are:</p>

  </p>

  
  <footer>
    <a href="/blog/2012/09/04/common_schema-1-1-released-split-try-catch-killall-profiling/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/06/27/delete-dont-insert/">DELETE, don&#39;t INSERT</a></h2>

    <div class="post-meta">

  <div>

    <time>27 Jun 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/performance">Performance</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Have just read <a href="http://blog.9minutesnooze.com/insert-delete/">INSERT, Don’t DELETE</a> by Aaron Brown, and have some lengthy response, which is why I write this post instead of commenting on said post.</p>
<p>I wish to offer my counter thought and suggest that <strong>DELETE</strong>s are probably the better choice.</p>
<p>Aaron suggests that, when one wishes to purge rows from some table, a trick can be used: instead of <strong>DELETE</strong>ing unwanted rows, one can <strong>INSERT</strong> &ldquo;good&rdquo; rows into a new table, then switch over with <strong>RENAME</strong> (but please read referenced post for complete details).</p>
<p>I respectfully disagree on several points discussed.</p>
<h4>Lockdown</h4>
<p>The fact one needs to block writes during the time of creation of new table is problematic: you need to essentially turn off parts of your application. The posts suggests one could use a slave - but this solution is far from being trivial as well. To switch over, you yet again need to turn off access to DB, even if for a short while.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/06/27/delete-dont-insert/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/06/18/on-stored-routines-and-dynamic-statements/">On stored routines and dynamic statements</a></h2>

    <div class="post-meta">

  <div>

    <time>18 Jun 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/prepared-statements">Prepared Statements</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/stored-routines">Stored routines</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I very much enjoyed reading <a href="http://blog.mclaughlinsoftware.com/2012/06/16/overloading-procedures/" rel="bookmark">Overloading Procedures</a> by Michael McLaughlin: good stuff!</p>
<p>I&rsquo;m dealing with similar issues in <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema/QueryScript</a>, where I implement a whole new scripting language within MySQL, interpreted by stored routines. I am now finalizing the next version of <em>common_schema/QueryScript</em>, with a major addition to the scripting language to put yet even more power at the hands of the programmer/DBA using simple, clean syntax.</p>
<p>Still hush hush, the development of that feature touched at the very same issues described in Michael&rsquo;s post. Present in current release, these issues are intensified by the use and complexity of the new development. Here are a few insights of mine:</p>
<h4>Internal array implementation</h4>
<p>Like Michael, I started by implementing arrays through tables. That is, create a (temporary, in my case) table, wrap it up with a lot of stored routine code, and simulate an array. This array is not yet provided to the user, but is used internally for QueryScript&rsquo;s own code.</p>
<p>Well, disappointment here: during load tests on intense structures, such as a <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_foreach.html">foreach</a> loop, where each iteration of the loop requires the creation of an array, I found that the current solution does not hold well on busy servers.</p>
<p>Seemingly, there&rsquo;s nothing wrong with the creation of a new table every once in a while &ndash; and in particular a temporary table. However, I quickly found out that a busy server thrashes the table cache with such intense rate of creation/dropping of tables. The competition over the table cache mutex becomes intolerable and hogs not only the script&rsquo;s execution but the entire server&rsquo;s.</p>
<p>There&rsquo;s also the issue of the type of array values &ndash; no going around using textual columns, of course, but &ndash; how long? A <strong>VARCHAR(32767)</strong> should be enough for any reasonable implementation, but &ndash; how much memory would that consume? Both <strong>MEMORY</strong> and standard temporary tables (<em>Percona Server</em> has that partially <a href="http://www.mysqlperformanceblog.com/2011/09/06/dynamic-row-format-for-memory-tables/">resolved</a>) use a fixed row format, which means a 32K text is actually allocated in memory even when your value is &lsquo;x&rsquo;.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/06/18/on-stored-routines-and-dynamic-statements/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/02/09/mysqlqueryscript-use-case-delete-all-but-top-n-records-per-group/">MySQL/QueryScript use case: DELETE all but top N records per group</a></h2>

    <div class="post-meta">

  <div>

    <time>09 Feb 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Some administrative tasks can be simplified by using <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema/QueryScript</a>. I&rsquo;m collecting a bunch of these for documentation. Here&rsquo;s one for example:</p>
<p>The DBA/developer has the task of retaining only top <strong>3</strong> most populated countries per continent. That is, she has to <strong>DELETE 4th, 5th, 6th</strong>, &hellip; most populated counties in each continent.</p>
<p>Is it possible to work out with a single query? Yes. But the query is not pretty. In fact, it is quite complicated, and either involves unintuitive subqueries, or <a href="http://code.openark.org/blog/mysql/sql-selecting-top-n-records-per-group">unintuitive hacks</a>. A normal DBA would not want to write, neither maintain this kind of query, unless top-notch-geek, which is fine.</p>
<p>Since this is a one time job, we just need to get it done. And <em>common_schema</em>/QueryScript provide with the intuitive solution: if we read our demand aloud, we realize we want to <strong>delete</strong> <strong>4th, 5th, 6th</strong>, &hellip; populated countries <strong>for each</strong> continent.</p>
<p>I present a solution made available by QueryScript, and discuss the ways in which the code overcomes limitations, or simplifies complexity:</p>
<blockquote>
<pre>var $num_countries_to_delete;
foreach($continent, $num_countries: SELECT continent, COUNT(*) FROM world.Country GROUP BY continent)
{
  if ($num_countries &gt; 3)
  {
    set $num_countries_to_delete := $num_countries - 3;
    DELETE FROM world.Country WHERE Continent = $continent ORDER BY Population ASC LIMIT :$num_countries_to_delete;
  }
}</pre>
</blockquote>
<h4>Discussion</h4>
<p>The first thing that should be apparent from the above is that this is a <em>programmatic</em> solution. Queries are declarative, which is why complex ones sometimes look incomprehensible. The above is more straightforward.</p>

  </p>

  
  <footer>
    <a href="/blog/2012/02/09/mysqlqueryscript-use-case-delete-all-but-top-n-records-per-group/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/02/08/common_schema-rev-218-queryscript-throttling-processes-documentation/">common_schema rev. 218: QueryScript, throttling, processes, documentation</a></h2>

    <div class="post-meta">

  <div>

    <time>08 Feb 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/administration">Administration</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p><a href="http://code.google.com/p/common-schema/">common_schema</a>, revision <strong>218</strong> is released, with major new features, top one being <em>server side scripting</em>. Here are the highlights:</p>
<ul>
<li><a href="http://www.queryscript.com/"><strong>QueryScript</strong></a>: server side scripting is now supported by <em>common_schema</em>, which acts as an interpreter for QueryScript code.</li>
<li>Throttling for queries is now made available via the <strong>throttle()</strong> function.</li>
<li>Enhancements to processlist-related views, including the new <strong>slave_hosts</strong> view.</li>
<li>Inline documentation/help is available via the <strong>help()</strong> routine.</li>
<li>more&hellip;</li>
</ul>
<h4>QueryScript</h4>
<p><em>common_schema</em> makes for a QueryScript implementation for MySQL. You can run server side scripts, interpreted by <em>common_schema</em>, which allow for easy syntax and greater power than was otherwise previously available on the MySQL server. For example:</p>
<blockquote>
<pre>foreach($table, $schema, $engine: table like &lsquo;%&rsquo;)
  if ($engine = &lsquo;ndbcluster&rsquo;)
    ALTER ONLINE TABLE :$schema.:$table REORGANIZE PARTITION;</pre>
</blockquote>
<p>QueryScript includes flow control, conditional branching, variables &amp; variable expansion, script throttling and more.</p>
<p>Read more on <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema&rsquo;s QueryScript implementation</a>.</p>
<h4></p>

  </p>

  
  <footer>
    <a href="/blog/2012/02/08/common_schema-rev-218-queryscript-throttling-processes-documentation/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/2012/02/08/queryscript-sql-scripting-language/">QueryScript: SQL scripting language</a></h2>

    <div class="post-meta">

  <div>

    <time>08 Feb 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blogcategories/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blogtags/administration">Administration</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blogtags/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Introducing <strong><a href="http://www.queryscript.com/">QueryScript</a></strong>: a programming language aimed for SQL scripting, seamlessly combining scripting power such as flow control &amp; variables with standard SQL statements or RDBMS-specific commands.</p>
<p>QueryScript is available fro MySQL via <a href="http://code.google.com/p/common-schema">common_schema</a>, which adds MySQL-specific usage.</p>
<p><em>What does QueryScript look like?</em> Here are a few code samples:</p>
<p>Turn a bulk DELETE operation into smaller tasks. Throttle in between.</p>
<blockquote>
<pre>while (DELETE FROM archive.events WHERE ts &lt; CURDATE() LIMIT 1000)
{
  throttle 2;
}</pre>
</blockquote>
<p>Convert all InnoDB tables in the &lsquo;sakila&rsquo; database to compressed format:</p>
<blockquote>
<pre>foreach ($table, $schema, $engine: table in sakila)
{
  if ($engine = &lsquo;InnoDB&rsquo;)
    ALTER TABLE :$schema.:$table ENGINE=InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK<em>SIZE=8;
}</pre>
</blockquote>
<p>Shard your data across multiple schemata:</p>
<blockquote>
<pre>foreach($shard: {USA, GBR, JAP, FRA})
{
  CREATE DATABASE db</em>:$shard;
  CREATE TABLE db<em>:$shard.city LIKE world.City;
  INSERT INTO db</em>:$shard.city SELECT * FROM world.City WHERE CountryCode = $shard;
}</pre>
</blockquote>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/2012/02/08/queryscript-sql-scripting-language/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
</div>

</div>
</div>
<script src="/blogjs/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Your Google Analytics tracking ID', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

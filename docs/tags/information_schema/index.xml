<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Information_schema on code.openark.org</title>
    <link>/blog/tags/information_schema/</link>
    <description>Recent content in Information_schema on code.openark.org</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en-us</language>
    <copyright>&amp;copy; 2016. All rights reserved.</copyright>
    <lastBuildDate>Fri, 07 Aug 2015 14:39:59 +0000</lastBuildDate>
    <atom:link href="/blog/tags/information_schema/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Baffling 5.7 global/status variables issues, unclean migration path</title>
      <link>/blog/mysql/baffling-5-7-globalstatus-variables-issues-unclean-migration-path/</link>
      <pubDate>Fri, 07 Aug 2015 14:39:59 +0000</pubDate>
      
      <guid>/blog/mysql/baffling-5-7-globalstatus-variables-issues-unclean-migration-path/</guid>
      <description>&lt;p&gt;MySQL &lt;strong&gt;5.7&lt;/strong&gt; introduces a change in the way we query for global variables and status variables: the &lt;strong&gt;INFORMATION_SCHEMA.(GLOBAL|SESSION)_(VARIABLES|STATUS)&lt;/strong&gt; tables are now deprecated and empty. Instead, we are to use the respective &lt;strong&gt;performance_schema.(global|session)_(variables|status)&lt;/strong&gt; tables.&lt;/p&gt;
&lt;p&gt;But the change goes farther than that; there is also a security change. Oracle created a pitfall of &lt;strong&gt;2&lt;/strong&gt; changes at the same time:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Variables/status moved to a different table&lt;/li&gt;
&lt;li&gt;Privileges required on said table&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;As an example, my non-root user gets:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;mysql&amp;gt; show session variables like &#39;tx_isolation&#39;;
ERROR 1142 (42000): SELECT command denied to user &#39;normal_user&#39;@&#39;my_host&#39; for table &#39;session_variables&#39;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Who gets affected by this? Nearly &lt;em&gt;everyone and everything&lt;/em&gt;.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Your Nagios will not be able to read status variables&lt;/li&gt;
&lt;li&gt;Your ORM will not be able to determine session variables&lt;/li&gt;
&lt;li&gt;Your replication user will fail connecting (see &lt;a href=&#34;http://datacharmer.blogspot.nl/2015/08/mysql-578-features-bugs-and-rumors.html&#34;&gt;this post by Giuseppe&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;And most everyone else.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The problem with the above is that involves two unrelated changes to your setup, which are not entirely simple to coordinate:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Change your app code to choose the correct schema (information_schema vs. performance_schema)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;GRANT&lt;/strong&gt; the permissions on your database&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Perhaps at this point you still do not consider this to be a problem. You may be thinking: &lt;em&gt;well, let&#39;s first prepare by creating the GRANTs, and once that is in place, we can, at our leisure, modify the code&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Not so fast. Can you really that simply create those GRANTs?&lt;!--more--&gt;&lt;/p&gt;
&lt;h3&gt;Migration woes&lt;/h3&gt;
&lt;p&gt;How do you migrate to a new MySQL version? You do not reinstall all your servers. You want an easy migration path, and that path is: introduce one or two slaves of a newer version, see that everything works to your satisfaction, slowly upgrade all your other slaves, eventually switchover/upgrade your master.&lt;/p&gt;
&lt;p&gt;This should not be any different for &lt;strong&gt;5.7&lt;/strong&gt;. We would like to provision a &lt;strong&gt;5.7&lt;/strong&gt; slave in our topologies and just see that everything works. Well, we have, and things don&#39;t just work. Our Nagios stops working for that &lt;strong&gt;5.7&lt;/strong&gt; slave. &lt;em&gt;Orchestrator&lt;/em&gt; started complaining (by this time I&#39;ve &lt;a href=&#34;https://github.com/outbrain/orchestrator/releases/tag/v1.4.291&#34;&gt;already fixed it&lt;/a&gt; to be more tolerant for the &lt;strong&gt;5.7&lt;/strong&gt; problems so no crashes here).&lt;/p&gt;
&lt;p&gt;I hope you see the problem by now.&lt;/p&gt;
&lt;blockquote&gt;You cannot issue a &lt;strong&gt;GRANT SELECT ON performance_schema.global_variables TO &#39;...&#39;&lt;/strong&gt; on your &lt;strong&gt;5.6&lt;/strong&gt; master.&lt;/blockquote&gt;
&lt;p&gt;The table simply does not exist there, which means the statement will not go to binary logs, which means it will not replicate on your &lt;strong&gt;5.7&lt;/strong&gt; slave, which means you will not be able to &lt;strong&gt;SHOW GLOBAL VARIABLES&lt;/strong&gt; on your slave, which means everything remains broken.&lt;/p&gt;
&lt;p&gt;Yes, you can issue this directly on your &lt;strong&gt;5.7&lt;/strong&gt; slaves. It&#39;s &lt;em&gt;doable&lt;/em&gt;, but &lt;em&gt;undesired&lt;/em&gt;. It&#39;s ugly in terms of automation (and will quite possibly break some assumptions and sanity checks your automation uses); in terms of validity testing. It&#39;s unfriendly to GTID (make sure to &lt;strong&gt;SET SQL_LOG_BIN=0&lt;/strong&gt; before that).&lt;/p&gt;
&lt;h3&gt;WHY in the first place?&lt;/h3&gt;
&lt;p&gt;It seems like a security thing. I&#39;m not sure whether this was intended. So you prevent a &lt;strong&gt;SHOW GLOBAL VARIABLES&lt;/strong&gt; for a normal user. Makes sense. And yet:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;mysql&amp;gt; show global variables like &#39;hostname&#39;;
ERROR 1142 (42000): SELECT command denied to user &#39;normal_user&#39;@&#39;my_host&#39; for table &#39;global_variables&#39;

mysql&amp;gt; select @@global.hostname;
+---------------------+
| @@global.hostname   |
+---------------------+
| myhost.mydomain.com |
+---------------------+

mysql&amp;gt; select @@version;
+--------------+
| @@version    |
+--------------+
| 5.7.8-rc-log |
+--------------+

&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Seems like I&#39;m allowed access to that info after all. So it&#39;s not strictly a security design decision. For status variable, I admit, I don&#39;t have a similar workaround.&lt;/p&gt;
&lt;h3&gt;Solutions?&lt;/h3&gt;
&lt;p&gt;The following are meant to be solutions, but do not really solve the problem:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;SHOW&lt;/strong&gt; commands. &lt;strong&gt;SHOW GLOBAL|SESSION VARIABLES|STATUS&lt;/strong&gt; will work properly, and will implicitly know whether to provide the results via &lt;strong&gt;information_schema&lt;/strong&gt; or &lt;strong&gt;performance_schema&lt;/strong&gt; tables.
&lt;ul&gt;
&lt;li&gt;But, aren&#39;t we meant to be happier with &lt;strong&gt;SELECT&lt;/strong&gt; queries? So that I can really do stuff that is smarter than &lt;strong&gt;LIKE &#39;variable_name%&#39;&lt;/strong&gt;?&lt;/li&gt;
&lt;li&gt;And of course you cannot use &lt;strong&gt;SHOW&lt;/strong&gt; in server side cursors. Your stored routines are in a mess now.&lt;/li&gt;
&lt;li&gt;This does not solve the GRANTs problem.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;a href=&#34;http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_show_compatibility_56&#34;&gt;show_compatibility_56&lt;/a&gt;&lt;/strong&gt;: an introduced variable in &lt;strong&gt;5.7&lt;/strong&gt;, boolean. It truly is a time-travel-paradox novel in disguise, in multiple respects.
&lt;ul&gt;
&lt;li&gt;Documentation introduces it, and says it is deprecated.
&lt;ul&gt;
&lt;li&gt;time-travel-paradox :O&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;But it actually works in &lt;strong&gt;5.7.8&lt;/strong&gt; (latest)
&lt;ul&gt;
&lt;li&gt;time-travel-paradox plot thickens&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Your automation scripts do not know in advance whether your MySQL has this variable
&lt;ul&gt;
&lt;li&gt;Hence &lt;strong&gt;SELECT @@global.show_compatibility_56&lt;/strong&gt; will produce an error on &lt;strong&gt;5.6&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;But the &#34;safe&#34; way of &lt;strong&gt;SHOW GLOBAL VARIABLES LIKE &#39;show_compatibility_56&#39;&lt;/strong&gt; will fail on a privilege error on &lt;strong&gt;5.7&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;time-travel-paradox :O&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Actually advised by my colleague Simon J. Mudd, &lt;strong&gt;show_compatibility_56&lt;/strong&gt; defaults to &lt;strong&gt;OFF&lt;/strong&gt;. I &lt;em&gt;support&lt;/em&gt; this line of thought. Or else it&#39;s &lt;strong&gt;old_passwords=1&lt;/strong&gt; all over again.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;show_compatibility_56&lt;/strong&gt; doesn&#39;t solve the GRANTs problem.&lt;/li&gt;
&lt;li&gt;This does not solve any migration path. It just postpones the moment when I will hit the same problem. When I flip the variable from &lt;strong&gt;&#34;1&#34;&lt;/strong&gt; to &lt;strong&gt;&#34;0&#34;&lt;/strong&gt;, I&#39;m back at square one.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Suggestion&lt;/h3&gt;
&lt;p&gt;I claim security is not the issue, as presented above. I claim Oracle will yet again fall into the trap of no-easy-way-to-migrate-to-GTID in &lt;strong&gt;5.6&lt;/strong&gt; if the current solution is unchanged. I claim that there have been too many changes at once. Therefore, I suggest one of the alternative two flows:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;Flow 1&lt;/strong&gt;: keep &lt;strong&gt;information_schema&lt;/strong&gt;, later migration into &lt;strong&gt;performance_schema&lt;/strong&gt;
&lt;ul&gt;
&lt;li&gt;In &lt;strong&gt;5.7&lt;/strong&gt;, &lt;strong&gt;information_schema&lt;/strong&gt; tables should still produce the data.&lt;/li&gt;
&lt;li&gt;No security constraints on &lt;strong&gt;information_schema&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Generate WARNINGs on reading from &lt;strong&gt;information_schema&lt;/strong&gt; (&#34;...this will be deprecated...&#34;)&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;performance_schema &lt;/strong&gt;&lt;em&gt;also available&lt;/em&gt;. With security constraints, whatever.&lt;/li&gt;
&lt;li&gt;In &lt;strong&gt;5.8&lt;/strong&gt; remove &lt;strong&gt;information_schema&lt;/strong&gt; tables; we are left with &lt;strong&gt;performance_schema&lt;/strong&gt; only.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Flow 2&lt;/strong&gt;: easy migration into &lt;strong&gt;performance_schema&lt;/strong&gt;:
&lt;ul&gt;
&lt;li&gt;In &lt;strong&gt;5.7&lt;/strong&gt;, &lt;strong&gt;performance_schema&lt;/strong&gt; tables should not require any special privileges. Any user can read from them.&lt;/li&gt;
&lt;li&gt;Keep &lt;strong&gt;show_compatibility_56 &lt;/strong&gt;as it is.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SHOW&lt;/strong&gt; commands choose between &lt;strong&gt;information_schema&lt;/strong&gt; or &lt;strong&gt;performance_schema&lt;/strong&gt; on their own -- just as things are done now.&lt;/li&gt;
&lt;li&gt;In &lt;strong&gt;5.8&lt;/strong&gt;, &lt;strong&gt;performance_schema&lt;/strong&gt; tables will require &lt;strong&gt;SELECT&lt;/strong&gt; privileges.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;As always, I love the work done by the engineers; and I love how they listen to the community.&lt;/p&gt;
&lt;p&gt;Comments are most welcome. Have I missed the simple solution here? Are there even more complications to these features? Thoughts on my suggested two flows?&lt;/p&gt;
&lt;h3&gt;[UPDATE 2015-08-19]&lt;/h3&gt;
&lt;p&gt;Please &lt;a href=&#34;http://www.tocker.ca/2015/08/18/a-followup-on-show_compatibility_56.html&#34;&gt;see this followup&lt;/a&gt; by Morgan Tocker of Oracle.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>common_schema &amp; openark-kit in the media: #DBHangOps, OurSQL</title>
      <link>/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql/</link>
      <pubDate>Wed, 26 Jun 2013 21:46:57 +0000</pubDate>
      
      <guid>/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql/</guid>
      <description>&lt;h4&gt;#DBHangOps&lt;/h4&gt;
&lt;p&gt;I had the pleasure of joining into &lt;a href=&#34;https://twitter.com/DBHangops&#34;&gt;@DBHangOps&lt;/a&gt; today, and speak about &lt;a href=&#34;https://code.google.com/p/common-schema/&#34;&gt;common_schema&lt;/a&gt; and &lt;a href=&#34;http://code.google.com/p/openarkkit/&#34;&gt;openark-kit&lt;/a&gt;. What was meant to be a 15 minute session turned to be 50 -- sorry, people, I don&#39;t talk as much at home, but when it comes to my pet projects...&lt;/p&gt;
&lt;p&gt;I also realized I was missing on a great event: DBHangOps is a hangout where you can chat and discuss MySQL &amp;amp; related technologies with friends and colleagues, with whom you typically only meet at conferences. I will certainly want to attend future events.&lt;/p&gt;
&lt;p&gt;Thanks to John Cesario and Geoffrey Anderson who invited me to talk, and to the friends and familiar faces who attended; I was happy to talk about my work, and very interested in hearing about how it&#39;s being put to use. We also had time to discuss &lt;a href=&#34;http://www.markleith.co.uk/ps_helper/&#34;&gt;ps_helper&lt;/a&gt; with no other than Mark Leith!&lt;/p&gt;
&lt;p&gt;The video is &lt;a href=&#34;https://twitter.com/DBHangops/status/349965939690835970&#34;&gt;available on Twitter/YouTube&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;OurSQL&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;openark-kit&lt;/em&gt; has also been &lt;a href=&#34;http://technocation.org/content/oursql-episode-143%3A-biblical-tools&#34;&gt;featured on the OurSQL podcast&lt;/a&gt; by Sheeri &amp;amp; Gerry, who did great coverage of some tools. I will disclose that more is to come; I&#39;m happy this is in capable hands and look further to hear the next episode!&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Hierarchical data in INFORMATION_SCHEMA and derivatives</title>
      <link>/blog/mysql/hierarchical-data-in-information_schema-and-derivatives/</link>
      <pubDate>Tue, 08 Jan 2013 13:19:56 +0000</pubDate>
      
      <guid>/blog/mysql/hierarchical-data-in-information_schema-and-derivatives/</guid>
      <description>&lt;p&gt;Just how often do you encounter hierarchical data? Consider a table with some parent-child relation, like the this classic &lt;strong&gt;employee&lt;/strong&gt; table:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;CREATE TABLE employee (
  employee_id INT UNSIGNED PRIMARY KEY,
  employee_name VARCHAR(100),
  manager_id INT UNSIGNED,
  CONSTRAINT `employee_manager_fk` FOREIGN KEY (manager_id) REFERENCES employee (employee_id)
) engine=innodb
;
+-------------+---------------+------------+
| employee_id | employee_name | manager_id |
+-------------+---------------+------------+
|           1 | Rachel        |       NULL |
|           2 | John          |          1 |
|           3 | Stan          |          1 |
|           4 | Naomi         |          2 |
+-------------+---------------+------------+&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Questions like &lt;em&gt;&#34;What is the (nested) list of employees managed by Rachel?&#34;&lt;/em&gt; or &lt;em&gt;&#34;Get Naomi&#39;s managers chain of command&#34;&lt;/em&gt; are classical questions. There are sometimes dependencies: if John leaves, does that mean Naomi loses her job, or does she get promoted, or something else? If John and Stan are on sick leave, does Rachel have any reason to come to work?&lt;/p&gt;
&lt;p&gt;Hierarchical data is not limited to a single-table structure. Sometimes it takes a combination of a few tables (it&#39;s just a &lt;strong&gt;JOIN&lt;/strong&gt;) to make out the parent-child relation.&lt;/p&gt;
&lt;p&gt;Hierarchical data is difficult to manage with SQL. This is especially true for MySQL, which does not support the &lt;strong&gt;WITH&lt;/strong&gt; recursive query syntax.&lt;/p&gt;
&lt;h4&gt;Where can you find hierarchical data?&lt;/h4&gt;
&lt;p&gt;Even if you do not provide it by yourself, MySQL&#39;s &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; has some for you. Partly obvious, partly implicit, here are some examples:&lt;!--more--&gt;&lt;/p&gt;
&lt;h4&gt;Foreign Keys&lt;/h4&gt;
&lt;p&gt;This is probably the most obvious hierarchical dataset in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;. The &lt;strong&gt;KEY_COLUMN_USAGE&lt;/strong&gt; table lists the table dependencies based on foreign key constraints. It&#39;s a bit confusing, as it also lists &lt;strong&gt;UNIQUE&lt;/strong&gt; constraints, and the complete list of FKs are in &lt;strong&gt;REFERENTIAL_CONSTRAINTS&lt;/strong&gt; -- but the latter table does not list the dependencies. You typically want to join both tables to get the complete information.&lt;/p&gt;
&lt;p&gt;So, taking &lt;strong&gt;sakila&lt;/strong&gt;&#39;s DVD rental shop sample,  &lt;strong&gt;film_actor&lt;/strong&gt; table depends on &lt;strong&gt;film&lt;/strong&gt; as well as on &lt;strong&gt;actor&lt;/strong&gt; via foreign keys. &lt;strong&gt;film&lt;/strong&gt; can depend on the &lt;strong&gt;category&lt;/strong&gt; table, etc. The hierarchies can turn to be very complex, with multiple roots an very deep branches.&lt;/p&gt;
&lt;p&gt;Dependency questions are very clear when speaking of foreign keys: what happens when we delete some &lt;strong&gt;film&lt;/strong&gt; record? Does it hold that we also delete all references to that film on &lt;strong&gt;film_actor&lt;/strong&gt;? Or do we deny deletion of said film in such case?&lt;/p&gt;
&lt;h4&gt;Redundant Keys&lt;/h4&gt;
&lt;p&gt;The &lt;strong&gt;KEY (col1, col2)&lt;/strong&gt; makes the &lt;strong&gt;KEY (col1)&lt;/strong&gt; redundant. The latter is not strictly required (though you may wish to keep it for covering index performance reason). The list of &lt;em&gt;dominant-redundant&lt;/em&gt; keys makes for hierarchical data. It is typically very shallow (keys can only be redundant within the scope of a single table -- how deep can you get with such small dataset?)&lt;/p&gt;
&lt;p&gt;There is no immediate reference in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; as for redundant keys, but it can be inferred by self joining the &lt;strong&gt;STATISTICS&lt;/strong&gt; table onto itself. It is not immediate, since you need to do some aggregation and check for particular cases. For example, &lt;strong&gt;UNIQUE KEY (col1, col2)&lt;/strong&gt; is actually made redundant by &lt;strong&gt;UNIQUE KEY (col1)&lt;/strong&gt;, which is just the opposite from our previous example.&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;http://code.google.com/p/common-schema&#34;&gt;common_schema&lt;/a&gt; provides with this implicit information now turned explicit, in the for of the &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/redundant_keys.html&#34;&gt;redundant_keys&lt;/a&gt; view: the &lt;strong&gt;redundant_index_name&lt;/strong&gt; and &lt;strong&gt;dominant_index_name&lt;/strong&gt; columns make for parent-child relationship.&lt;/p&gt;
&lt;p&gt;Dependency questions are a bit redundant here: the general objective is to &lt;em&gt;not have&lt;/em&gt; dependencies. So get rid of redundant keys - and do so wisely. There&#39;s a good discussion of index redundancies on &lt;strong&gt;redundant_keys&lt;/strong&gt;&#39;s &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/redundant_keys.html&#34;&gt;documentation&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;Locked transactions&lt;/h4&gt;
&lt;p&gt;A transaction is locked. It is locked because another transaction holds some locks needed by locked transaction. But this transaction in itself can obtain locks needed by yet other transactions. And so we can get a hierarchy of locked transaction. The &#34;parent&#34; is the one blocking the &#34;child&#34;.&lt;/p&gt;
&lt;p&gt;Combining InnoDB&#39;s &lt;strong&gt;INNODB_TRX&lt;/strong&gt; - &lt;strong&gt;INNODB_LOCK_WAITS&lt;/strong&gt; - &lt;strong&gt;INNODB_TRX&lt;/strong&gt; tables, we get this information. &lt;em&gt;common_schema&lt;/em&gt; provides with this inferred data in the form of &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/innodb_locked_transactions.html&#34;&gt;innodb_locked_transactions&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Hierarchies in locked-transactions could be deep, and they can most commonly be &lt;em&gt;wide&lt;/em&gt;. A single transaction can lock dozens of others.&lt;/p&gt;
&lt;p&gt;Dependency questions are &lt;em&gt;&#34;would killing this transaction release all other waiting transactions?&#34;&lt;/em&gt;; &lt;em&gt;&#34;What is &lt;/em&gt;the one&lt;em&gt; transaction I need to kill in order to release the bottleneck?&#34;&lt;/em&gt;; &lt;em&gt;&#34;Why are these transactions related in the first place? Can I remove this dependency?&#34;&lt;/em&gt;. etc.&lt;/p&gt;
&lt;h4&gt;Locks&lt;/h4&gt;
&lt;p&gt;You can look at the same dataset as above from a different angle. Instead of looking at transaction-lock-transaction, you can look at lock-transaction-lock. Which locks are causing other locks to be held? This is counter-intuitive to our understanding of how things work, but is valid nonetheless.&lt;/p&gt;
&lt;h4&gt;Views&lt;/h4&gt;
&lt;p&gt;A &lt;strong&gt;VIEW&lt;/strong&gt; can query a table or another view. It can join multiple views. This hierarchy of view-reading-from-view can turn out to be complex; if not for the human mind then for the optimizer.&lt;/p&gt;
&lt;p&gt;Surprisingly, there is no data in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;, other than the &lt;strong&gt;CREATE VIEW&lt;/strong&gt; clause, to help us out in resolving these dependencies. Even more surprising is MySQL&#39;s own inability to get clear conclusions itself. The view definition clause is parsed, re-parsed and re-evaluated whenever information on &#34;parent&#34; views is required. For example, try to &lt;strong&gt;DESCRIBE&lt;/strong&gt; a view. How does MySQL deduce the data types of columns? It dives in head first into the hierarchy, crawls and parses view definitions, till it resolves the answer. The &lt;a href=&#34;http://code.openark.org/forge/mycheckpoint&#34;&gt;mycheckpoint&lt;/a&gt; projects uses view hierarchies intensively. It draws powers from the hierarchy and produces some surprising data (&lt;a href=&#34;http://code.openark.org/forge/mycheckpoint/documentation/generating-google-charts&#34;&gt;charts&lt;/a&gt; from raw data, for example). But it also suffers from MySQL indirect inference of views. Checking up a deep-nested &lt;em&gt;mycehckpoint&lt;/em&gt; view in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; makes for a heavyweight dive for MySQL into locks and table handles.&lt;/p&gt;
&lt;p&gt;Dependency questions are &lt;em&gt;&#34;what is the type of this column?&#34;&lt;/em&gt;, &lt;em&gt;&#34;are there any &lt;strong&gt;TEMPTABLE&lt;/strong&gt; views along the chain of execution? Or are all &lt;strong&gt;MERGE&lt;/strong&gt; views?&#34;&lt;/em&gt; and more.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Killing InnoDB idle transactions</title>
      <link>/blog/mysql/killing-innodb-idle-transactions/</link>
      <pubDate>Tue, 04 Dec 2012 14:23:12 +0000</pubDate>
      
      <guid>/blog/mysql/killing-innodb-idle-transactions/</guid>
      <description>&lt;p&gt;The issue of terminating long-time idle open InnoDB transaction has been discussed recently by many. I wish to add my share, by proposing a quick and clean solution via &lt;a href=&#34;http://code.google.com/p/common-schema/&#34;&gt;common_schema&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;common_schema &lt;strong&gt;1.2&lt;/strong&gt;&lt;/em&gt; provides with the &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/innodb_transactions.html&#34;&gt;&lt;strong&gt;innodb_transactions&lt;/strong&gt;&lt;/a&gt; view, which relies on &lt;strong&gt;INNODB_TRX&lt;/strong&gt; - one of the InnoDB Plugin views in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; - as well as on &lt;strong&gt;PROCESSLIST&lt;/strong&gt;, and so is able to determine with certainty that a transaction has been idle for a long time.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;innodb_transactions&lt;/strong&gt; offers us with a &lt;strong&gt;sql_kill_query&lt;/strong&gt; column, which produces a &lt;strong&gt;&#39;KILL QUERY 12345&#39;&lt;/strong&gt; type of value. So we can:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT &lt;strong&gt;sql_kill_query&lt;/strong&gt; FROM &lt;strong&gt;innodb_transactions&lt;/strong&gt; WHERE &lt;strong&gt;trx_idle_seconds &amp;gt;= 10; 
&lt;/strong&gt;+-------------------+
| sql_kill_query    |
+-------------------+
| KILL QUERY 292509 |
| KILL QUERY 292475 |
+-------------------+&lt;strong&gt; &lt;/strong&gt;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;common_schema&lt;/em&gt;&#39;s useful &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/eval.html&#34;&gt;&lt;strong&gt;eval()&lt;/strong&gt;&lt;/a&gt; routine allows us to actually invoke those &lt;strong&gt;KILL&lt;/strong&gt; statements, all in a one-liner:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;call &lt;strong&gt;eval&lt;/strong&gt;(&lt;span style=&#34;color: #003366;&#34;&gt;&#39;SELECT &lt;strong&gt;sql_kill_query&lt;/strong&gt; FROM innodb_transactions WHERE &lt;strong&gt;trx_idle_seconds &amp;gt;= 10&lt;/strong&gt;&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Technical details&lt;!--more--&gt;&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;trx_idle_seconds&lt;/strong&gt; notes the time, in seconds, the transaction has been idle, or 0 if the transaction is not idle at all.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;sql_kill_query&lt;/strong&gt; is a self-generated SQL query which kills the running query, e.g. &lt;strong&gt;&#39;KILL QUERY 12345&#39;&lt;/strong&gt;.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;eval()&lt;/strong&gt; takes a query as text, retrieves the SQL resulting column, and executes it live.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Background details&lt;/h4&gt;
&lt;p&gt;The connection between &lt;strong&gt;INNODB_TRX&lt;/strong&gt; and &lt;strong&gt;PROCESSLIST&lt;/strong&gt; is not synchronous. It is possible that by the time one is querying &lt;strong&gt;INNODB_TRX&lt;/strong&gt;, &lt;strong&gt;PROCESSLIST&lt;/strong&gt; data may change (e.g. next query is already replacing the one you were considering in &lt;strong&gt;INNODB_TRX&lt;/strong&gt;). But in our case it is of little consequence: we are interested in transactions that have been idle for quite some time. Say, &lt;strong&gt;10&lt;/strong&gt; seconds. So we are not troubled by having &lt;strong&gt;200&lt;/strong&gt; queries per second changing under our hands.&lt;/p&gt;
&lt;p&gt;If the transaction has been asleep for &lt;strong&gt;10&lt;/strong&gt; seconds, and we decide to kill it, well, it is possible that just as we kill it it will turn active again. It&#39;s a risk we take no matter what kind of solution we apply, since there&#39;s no atomic &#34;get-status-and-kill&#34; operation on InnoDB transactions.&lt;/p&gt;
&lt;p&gt;The above solution is manual: one must invoke the query which kills the idle transactions. This is as opposed to a built-in server feature which does the same. Events can used to semi-automate this: one can call upon this query once every &lt;strong&gt;10&lt;/strong&gt; seconds, for example.&lt;/p&gt;
&lt;p&gt;See the many related and inspiring solutions below:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://mysqlblog.fivefarmers.com/2012/08/28/identifying-and-killing-blocking-transactions-in-innodb/&#34;&gt;Identifying and killing blocking transactions in InnoDB&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.markleith.co.uk/2011/05/31/finding-and-killing-long-running-innodb-transactions-with-events/&#34;&gt;Finding and killing long running InnoDB transactions with Events&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://datacharmer.blogspot.co.il/2008/10/using-event-scheduler-to-purge-process.html&#34;&gt;Using the event scheduler to purge the process list&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://www.mysqlperformanceblog.com/2011/03/08/how-to-debug-long-running-transactions-in-mysql/&#34;&gt;How to debug long-running transactions in MySQL&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://yoshinorimatsunobu.blogspot.co.il/2011/04/tracking-long-running-transactions-in.html&#34;&gt;Tracking long running transactions in MySQL&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</description>
    </item>
    
    <item>
      <title>How common_schema split()s tables - internals</title>
      <link>/blog/mysql/how-common_schema-splits-tables-internals/</link>
      <pubDate>Thu, 06 Sep 2012 07:25:07 +0000</pubDate>
      
      <guid>/blog/mysql/how-common_schema-splits-tables-internals/</guid>
      <description>&lt;p&gt;This post exposes some of the internals, and the SQL behind QueryScript&#39;s &lt;em&gt;split&lt;/em&gt;. &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html&#34;&gt;common_schema/QueryScript&lt;/a&gt; &lt;strong&gt;1.1&lt;/strong&gt; introduces the &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html&#34;&gt;&lt;strong&gt;split&lt;/strong&gt;&lt;/a&gt; statement, which auto-breaks a &#34;large&#34; query (one which operates on large tables as a whole or without keys) into smaller queries, and executes them in sequence.&lt;/p&gt;
&lt;p&gt;This makes for easier transactions, less locks held, potentially (depending on the user) more idle time released back to the database. &lt;em&gt;split&lt;strong&gt;&lt;/strong&gt;&lt;/em&gt; has similar concepts to &lt;a href=&#34;http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html&#34;&gt;oak-chunk-update&lt;/a&gt; and &lt;a href=&#34;http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html&#34;&gt;pt-archiver&lt;/a&gt;, but works differently, and implemented entirely in SQL on server side.&lt;/p&gt;
&lt;p&gt;Take the following statement as example:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;split&lt;/strong&gt; (&lt;strong&gt;UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR&lt;/strong&gt;)
  pass;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;It yields with (roughly) the following statements:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`inventory`.`inventory_id` &amp;gt; &#39;1&#39;)) OR ((`inventory`.`inventory_id` = &#39;1&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;1000&#39;)) OR ((`inventory`.`inventory_id` = &#39;1000&#39;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`inventory`.`inventory_id` &amp;gt; &#39;1000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;2000&#39;)) OR ((`inventory`.`inventory_id` = &#39;2000&#39;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`inventory`.`inventory_id` &amp;gt; &#39;2000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;3000&#39;)) OR ((`inventory`.`inventory_id` = &#39;3000&#39;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`inventory`.`inventory_id` &amp;gt; &#39;3000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;4000&#39;)) OR ((`inventory`.`inventory_id` = &#39;4000&#39;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`inventory`.`inventory_id` &amp;gt; &#39;4000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;4581&#39;)) OR ((`inventory`.`inventory_id` = &#39;4581&#39;))));&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;(I say &#34;roughly&#34; because internally there are user defined variables at play, but for convenience, I verbose the actual values as constants.)&lt;/p&gt;
&lt;h4&gt;How does that work?&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;common_schema&lt;/em&gt; works on server side. There is no Perl script or anything. It must therefore use server-side operations to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Identify table to be split&lt;/li&gt;
&lt;li&gt;Analyze the table in the first place, deciding how to split it&lt;/li&gt;
&lt;li&gt;Analyze the query, deciding on how to rewrite it&lt;/li&gt;
&lt;li&gt;Split the table (logically) into unique and distinct chunks&lt;/li&gt;
&lt;li&gt;Work out the query on each such chunk&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Following is an internal look at how &lt;em&gt;common_schema&lt;/em&gt; does all the above.&lt;!--more--&gt;&lt;/p&gt;
&lt;h4&gt;Identifying the table&lt;/h4&gt;
&lt;p&gt;When query operates on a single table, &lt;em&gt;split&lt;/em&gt; is able to parse the query&#39;s SQL and find out that table. When multiple tables are involved, &lt;em&gt;split&lt;/em&gt; requires user instruction: which table is it that the query should be split by?&lt;/p&gt;
&lt;h4&gt;Analyzing the table&lt;/h4&gt;
&lt;p&gt;Table analysis is done via a &lt;em&gt;similar&lt;/em&gt; method to &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/candidate_keys_recommended.html&#34;&gt;candidate_keys_recommended&lt;/a&gt;. It is almost identical, only it uses &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/information-schema-optimization.html&#34;&gt;INFORMATION_SCHEMA optimizations&lt;/a&gt; to make the query short and lightweight. Simulating the analysis using &lt;strong&gt;candidate_keys_recommended&lt;/strong&gt;, we get:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;mysql&amp;gt; select * from candidate_keys_recommended where table_name=&#39;inventory&#39; \G
*************************** 1. row ***************************
          table_schema: sakila
            table_name: inventory
recommended_index_name: PRIMARY
          has_nullable: 0
            is_primary: 1
 count_column_in_index: 1
          column_names: inventory_id&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;This is cool, simple and very easy to work with: we choose to split the table via the &lt;strong&gt;inventory_id&lt;/strong&gt; column, which is conveniently an integer. We&#39;ll soon see &lt;em&gt;split&lt;/em&gt; can handle complex cases as well.&lt;/p&gt;
&lt;h4&gt;Analyzing the query&lt;/h4&gt;
&lt;p&gt;This is done in part via Roland&#39;s &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_analysis_routines.html&#34;&gt;query_analysis_routines&lt;/a&gt;, and in part just parsing the query, looking for &lt;strong&gt;WHERE&lt;/strong&gt;,&lt;strong&gt; GROUP BY&lt;/strong&gt;, &lt;strong&gt;LIMIT&lt;/strong&gt; etc. clauses.&lt;/p&gt;
&lt;p&gt;The nice part is injecting a &lt;strong&gt;WHERE&lt;/strong&gt; condition, which didn&#39;t appear in the original query. That &lt;strong&gt;WHERE&lt;/strong&gt; condition is what limits the query to a distinct chunk of rows.&lt;/p&gt;
&lt;h4&gt;Splitting the table&lt;/h4&gt;
&lt;p&gt;With a single &lt;strong&gt;INTEGER PRIMARY KEY&lt;/strong&gt; this sounds simple, right? Take rows &lt;strong&gt;1..1,000&lt;/strong&gt;, then &lt;strong&gt;1,001..2,000&lt;/strong&gt;, then &lt;strong&gt;2,001..3,000&lt;/strong&gt; etc.&lt;/p&gt;
&lt;p&gt;Wrong: even with this simple scenario, things are much more complex. Are the numbers successive? What if there are holes? What if there is a &lt;strong&gt;1,000,000&lt;/strong&gt; gap between every two numbers? What if there are multiple holes of differing size and frequency?&lt;/p&gt;
&lt;p&gt;And if we have two columns in our &lt;strong&gt;UNIQUE KEY&lt;/strong&gt;? What if one of them is textual, not an &lt;strong&gt;INTEGER&lt;/strong&gt;, the other a &lt;strong&gt;TIMESTAMP&lt;/strong&gt;, not an &lt;strong&gt;INTEGER&lt;/strong&gt; either?&lt;/p&gt;
&lt;p&gt;&lt;em&gt;split&lt;/em&gt; doesn&#39;t work in that naive way. It makes no assumptions on the density of values. It only requires:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;some &lt;strong&gt;UNIQUE KEY&lt;/strong&gt; to work with,&lt;/li&gt;
&lt;li&gt;which has no &lt;strong&gt;NULL&lt;/strong&gt; values.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Given the above, it uses &lt;em&gt;User Defined Variables&lt;/em&gt; to setup the chunks. With our single &lt;strong&gt;INTEGER&lt;/strong&gt; column, the minimum value is set like this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;select 
  inventory_id 
from 
  `sakila`.`inventory` 
order by 
  inventory_id ASC 
limit 1  
into @_split_column_variable_min_1
;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;This sets the first value of the first chunk. What value terminates this chunk? It is calculated like this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;select 
  inventory_id 
from (
  select 
    inventory_id 
  from 
    `sakila`.`inventory` 
  where 
    (((`inventory`.`inventory_id` &amp;gt; @_split_column_variable_range_start_1)) OR ((`inventory`.`inventory_id` = @_split_column_variable_range_start_1))) and (((`inventory`.`inventory_id` &amp;lt; @_split_column_variable_max_1)) OR ((`inventory`.`inventory_id` = @_split_column_variable_max_1))) 
  order by 
    inventory_id ASC limit 1000 
  ) sel_split_range  
order by 
  inventory_id DESC 
limit 1  
into @_split_column_variable_range_end_1
;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Now there&#39;s a query you wouldn&#39;t want to work by hand, now would you?&lt;/p&gt;
&lt;p&gt;The cool part here is that the above works well for any type of column; this doesn&#39;t have to be an &lt;strong&gt;INTEGER&lt;/strong&gt;. Dates, strings etc. are all just fine.&lt;/p&gt;
&lt;p&gt;The above also works well for multiple columns, where the query gets more complicated (see following).&lt;/p&gt;
&lt;h4&gt;Working out the query per chunk&lt;/h4&gt;
&lt;p&gt;This part is the easy one, now that all the hard work is done. We know ho to manipulate the query, we know the lower and upper boundaries of the chunk, so we just fill in the values and execute.&lt;/p&gt;
&lt;h4&gt;Multi-columns keys&lt;/h4&gt;
&lt;p&gt;Consider a similar query on &lt;strong&gt;sakila.film_actor&lt;/strong&gt;, where the &lt;strong&gt;PRIMARY KEY&lt;/strong&gt; is a compound of two columns:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;split (UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR)
  throttle 2;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;The chunked queries will look like this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;1&#39;)) OR ((`film_actor`.`actor_id` = &#39;1&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;1&#39;)) OR ((`film_actor`.`actor_id` = &#39;1&#39;) AND (`film_actor`.`film_id` = &#39;1&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;39&#39;)) OR ((`film_actor`.`actor_id` = &#39;39&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;293&#39;)) OR ((`film_actor`.`actor_id` = &#39;39&#39;) AND (`film_actor`.`film_id` = &#39;293&#39;))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;39&#39;)) OR ((`film_actor`.`actor_id` = &#39;39&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;293&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;76&#39;)) OR ((`film_actor`.`actor_id` = &#39;76&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;234&#39;)) OR ((`film_actor`.`actor_id` = &#39;76&#39;) AND (`film_actor`.`film_id` = &#39;234&#39;))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;76&#39;)) OR ((`film_actor`.`actor_id` = &#39;76&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;234&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;110&#39;)) OR ((`film_actor`.`actor_id` = &#39;110&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;513&#39;)) OR ((`film_actor`.`actor_id` = &#39;110&#39;) AND (`film_actor`.`film_id` = &#39;513&#39;))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;110&#39;)) OR ((`film_actor`.`actor_id` = &#39;110&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;513&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;146&#39;)) OR ((`film_actor`.`actor_id` = &#39;146&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;278&#39;)) OR ((`film_actor`.`actor_id` = &#39;146&#39;) AND (`film_actor`.`film_id` = &#39;278&#39;))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;146&#39;)) OR ((`film_actor`.`actor_id` = &#39;146&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;278&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;183&#39;)) OR ((`film_actor`.`actor_id` = &#39;183&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;862&#39;)) OR ((`film_actor`.`actor_id` = &#39;183&#39;) AND (`film_actor`.`film_id` = &#39;862&#39;))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR &lt;strong&gt;WHERE&lt;/strong&gt; ((((`film_actor`.`actor_id` &amp;gt; &#39;183&#39;)) OR ((`film_actor`.`actor_id` = &#39;183&#39;) AND (`film_actor`.`film_id` &amp;gt; &#39;862&#39;))) AND (((`film_actor`.`actor_id` &amp;lt; &#39;200&#39;)) OR ((`film_actor`.`actor_id` = &#39;200&#39;) AND (`film_actor`.`film_id` &amp;lt; &#39;993&#39;)) OR ((`film_actor`.`actor_id` = &#39;200&#39;) AND (`film_actor`.`film_id` = &#39;993&#39;))));&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;View the complete command to realize just how much more complex each query is, and how much more complex the chunking becomes. Here&#39;s how I evaluate the chunk&#39;s &#34;next range end&#34; variables:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;select 
  actor_id, film_id 
from (
  select 
    actor_id, film_id 
  from 
    `sakila`.`film_actor` 
  where 
    (((`film_actor`.`actor_id` &amp;gt; @_split_column_variable_range_start_1)) OR ((`film_actor`.
`actor_id` = @_split_column_variable_range_start_1) AND (`film_actor`.`film_id` &amp;gt; @_split_column_variable_range_start_2))) and (((`film_actor`.`actor_id` &amp;lt; @_split_column_variable_max_1)) OR ((`film_actor`.`actor_id` = @_split_column_variable_max_1) AND (`film_actor`.`film_id` &amp;lt; @_split_column_variable_max_2)) OR ((`film_actor`.`actor_id` = @_split_column_variable_max_1) AND (`film_actor`.`film_id` = @_split_column_variable_max_2))) 
  order by 
    actor_id ASC, film_id ASC 
  limit 1000 
  ) sel_split_range  
order by 
  actor_id DESC, film_id DESC 
limit 1  
into @_split_column_variable_range_end_1, @_split_column_variable_range_end_2
;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;By the way, you may recall that everything is done server side. The &lt;strong&gt;WHERE&lt;/strong&gt; condition for the chunked queries is in itself generated via SQL statement, and not too much by programmatic logic. Here&#39;s &lt;em&gt;part&lt;/em&gt; of the query which computes the limiting condition:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;  select
    group_concat(&#39;(&#39;, partial_comparison, &#39;)&#39; order by n separator &#39; OR &#39;) as comparison
  from (
    select 
      n,
      group_concat(&#39;(&#39;, column_name, &#39; &#39;, if(is_last, comparison_operator, &#39;=&#39;), &#39; &#39;, variable_name, &#39;)&#39; order by column_order separator &#39; AND &#39;) as partial_comparison
    from (
      select 
        n, CONCAT(mysql_qualify(split_table_name), &#39;.&#39;, mysql_qualify(column_name)) AS column_name,
        case split_variable_type
          when &#39;range_start&#39; then range_start_variable_name
          when &#39;range_end&#39; then range_end_variable_name
          when &#39;max&#39; then max_variable_name
        end as variable_name,
        _split_column_names_table.column_order, _split_column_names_table.column_order = n as is_last 
      from 
        numbers, _split_column_names_table 
      where 
        n between _split_column_names_table.column_order and num_split_columns 
      order by n, _split_column_names_table.column_order
    ) s1
    group by n
  ) s2
  into return_value
  ;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;There is a lot of complexity to &lt;em&gt;split&lt;/em&gt; to make it able to provide with as clean a syntax for the user as possible.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Table split(...) for the masses</title>
      <link>/blog/mysql/table-split-for-the-masses/</link>
      <pubDate>Wed, 05 Sep 2012 07:04:05 +0000</pubDate>
      
      <guid>/blog/mysql/table-split-for-the-masses/</guid>
      <description>&lt;p&gt;(pun intended)&lt;/p&gt;
&lt;p&gt;&lt;em&gt;common_schema&lt;/em&gt;&#39;s new &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html&#34;&gt;&lt;strong&gt;split&lt;/strong&gt;&lt;/a&gt; statement (see &lt;a href=&#34;http://code.openark.org/blog/mysql/common_schema-1-1-released-split-try-catch-killall-profiling&#34;&gt;release announcement&lt;/a&gt;) auto-splits complex queries over large tables into smaller ones: instead of issuing one huge query, &lt;em&gt;split&lt;/em&gt; breaks one&#39;s query into smaller queries, each working on a different set of rows (a chunk).&lt;/p&gt;
&lt;p&gt;Thus, it is possible to avoid holding locks for long times, allowing for smaller transactions. It also makes for breathing space for the RDBMS, at times boosting operation speed, and at times prolonging operation speed at will.&lt;/p&gt;
&lt;p&gt;In this post I show how &lt;em&gt;split&lt;/em&gt; exposes itself to the user, should the user wish so.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;split&lt;/em&gt; can manage queries of the following forms:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;DELETE FROM table_name [WHERE]...&lt;/li&gt;
&lt;li&gt;DELETE FROM table_name USING &amp;lt;multi table syntax&amp;gt; [WHERE]...&lt;/li&gt;
&lt;li&gt;UPDATE table_name SET ... [WHERE]...&lt;/li&gt;
&lt;li&gt;UPDATE &amp;lt;multiple tables&amp;gt; SET ... [WHERE]...&lt;/li&gt;
&lt;li&gt;INSERT INTO some_table SELECT ... FROM &amp;lt;single or multiple tables&amp;gt; [WHERE]...&lt;/li&gt;
&lt;li&gt;REPLACE INTO some_table SELECT ... FROM &amp;lt;single or multiple tables&amp;gt; [WHERE]...&lt;/li&gt;
&lt;li&gt;SELECT ... FROM &amp;lt;multiple tables&amp;gt; [WHERE]...&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The latter being a non-obvious one at first sight.&lt;/p&gt;
&lt;h4&gt;Basically, it&#39; automatic&lt;/h4&gt;
&lt;p&gt;You just say:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;split&lt;/strong&gt; (UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR)
  throttle 2;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;And &lt;em&gt;split&lt;/em&gt; identifies &lt;strong&gt;sakila.inventory&lt;/strong&gt; as the table which needs to be split, and injects appropriate conditions so as to work on a subset of the rows, in multiple steps.&lt;/p&gt;
&lt;p&gt;By the way, here&#39;s &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_execution.html&#34;&gt;how to execute a QueryScript code&lt;/a&gt; like the above.&lt;!--more--&gt;&lt;/p&gt;
&lt;h4&gt;But you can drive in manual mode&lt;/h4&gt;
&lt;p&gt;You can use the following syntax:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;split&lt;/strong&gt; (sakila.inventory)
{
  -- No action taken, but this block of code
  -- is executed per chunk of the table.
  -- I wonder what can be done here?
}&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;split&lt;/em&gt; provides with &lt;em&gt;magic variables&lt;/em&gt;, which you can use in the action block. These are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;$split_step&lt;/strong&gt;: &lt;strong&gt;1&lt;/strong&gt;-based loop counter&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_rowcount&lt;/strong&gt;: number of rows affected in current chunk operation&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_total_rowcount&lt;/strong&gt;: total number of rows affected during this &lt;em&gt;split&lt;/em&gt; statement&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_total_elapsed_time&lt;/strong&gt;: number of seconds elapsed since beginning of this &lt;em&gt;split&lt;/em&gt; operation.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_clause&lt;/strong&gt;: &lt;em&gt;the&lt;/em&gt; magic variable: the filtering condition limiting rows to current chunk.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_table_schema&lt;/strong&gt;: the explicit or inferred schema of split table&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$split_table_name&lt;/strong&gt;: the explicit or inferred table being split&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;To illustrate, consider the following script:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;split&lt;/strong&gt; (sakila.inventory)
{
  select &lt;strong&gt;$split_step&lt;/strong&gt; as step, &lt;strong&gt;$split_clause&lt;/strong&gt; as clause;
}&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;The output is this:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| step | clause                                                                                                                                                                    |
+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
|    1 | ((((`inventory`.`inventory_id` &amp;gt; &#39;1&#39;)) OR ((`inventory`.`inventory_id` = &#39;1&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;1000&#39;)) OR ((`inventory`.`inventory_id` = &#39;1000&#39;)))) |
+------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

+------+--------------------------------------------------------------------------------------------------------------------------------------+
| step | clause                                                                                                                               |
+------+--------------------------------------------------------------------------------------------------------------------------------------+
|    2 | ((((`inventory`.`inventory_id` &amp;gt; &#39;1000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;2000&#39;)) OR ((`inventory`.`inventory_id` = &#39;2000&#39;)))) |
+------+--------------------------------------------------------------------------------------------------------------------------------------+

+------+--------------------------------------------------------------------------------------------------------------------------------------+
| step | clause                                                                                                                               |
+------+--------------------------------------------------------------------------------------------------------------------------------------+
|    3 | ((((`inventory`.`inventory_id` &amp;gt; &#39;2000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;3000&#39;)) OR ((`inventory`.`inventory_id` = &#39;3000&#39;)))) |
+------+--------------------------------------------------------------------------------------------------------------------------------------+

+------+--------------------------------------------------------------------------------------------------------------------------------------+
| step | clause                                                                                                                               |
+------+--------------------------------------------------------------------------------------------------------------------------------------+
|    4 | ((((`inventory`.`inventory_id` &amp;gt; &#39;3000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;4000&#39;)) OR ((`inventory`.`inventory_id` = &#39;4000&#39;)))) |
+------+--------------------------------------------------------------------------------------------------------------------------------------+

+------+--------------------------------------------------------------------------------------------------------------------------------------+
| step | clause                                                                                                                               |
+------+--------------------------------------------------------------------------------------------------------------------------------------+
|    5 | ((((`inventory`.`inventory_id` &amp;gt; &#39;4000&#39;))) AND (((`inventory`.`inventory_id` &amp;lt; &#39;4581&#39;)) OR ((`inventory`.`inventory_id` = &#39;4581&#39;)))) |
+------+--------------------------------------------------------------------------------------------------------------------------------------+&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;So you can get yourself a nice present: the SQL clause which filters the distinct chunks.&lt;/p&gt;
&lt;h4&gt;A simple demo: what can the user do with &#34;manual mode&#34;?&lt;/h4&gt;
&lt;p&gt;Normally, I would expect the user to use the automated version of &lt;em&gt;split&lt;/em&gt;. Let it do the hard work! But sometimes, you may wish to take control into your hands.&lt;/p&gt;
&lt;p&gt;Consider an example: I wish to export a table into CSV file, but in chunks. &lt;a href=&#34;http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html&#34;&gt;pt-archiver&lt;/a&gt; does that. But it is also easily achievable with &lt;em&gt;split&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;split&lt;/strong&gt; (sakila.inventory) {
  var &lt;strong&gt;$file_name&lt;/strong&gt; := QUOTE(CONCAT(&#39;/tmp/inventory_chunk_&#39;, &lt;strong&gt;$split_step&lt;/strong&gt;, &#39;.csv&#39;));
  select * from sakila.inventory WHERE &lt;strong&gt;:${split_clause}&lt;/strong&gt; INTO OUTFILE &lt;strong&gt;:${file_name}&lt;/strong&gt;;
}&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;This script uses the powerful &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_variables.html&#34;&gt;variable expansion&lt;/a&gt; feature of QueryScript: it extracts the text behind &lt;strong&gt;&lt;/strong&gt;&lt;strong&gt;:${split_clause}&lt;/strong&gt; and plants it as part of the query. It does the same for &lt;strong&gt;&lt;/strong&gt;&lt;strong&gt;:${file_name}&lt;/strong&gt;, making a variable possible where MySQL would normally disallow one (the &lt;strong&gt;INTO OUTFILE&lt;/strong&gt; clause only accepts a constant string).&lt;/p&gt;
&lt;p&gt;What do we get as result?&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;&lt;strong&gt;bash:/tmp$ ls -s1 inventory_chunk_*&lt;/strong&gt;
32 inventory_chunk_1.csv
32 inventory_chunk_2.csv
32 inventory_chunk_3.csv
32 inventory_chunk_4.csv
20 inventory_chunk_5.csv&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Conclusion&lt;/h4&gt;
&lt;p&gt;During the past months, and even as I developed &lt;em&gt;split&lt;/em&gt; for &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html&#34;&gt;QueryScript&lt;/a&gt;, I found myself using it more and more for my own purposes. As it evolved I realized how much more simple it makes these complex operations. Heck, it beats &lt;a href=&#34;http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html&#34;&gt;oak-chunk-update&lt;/a&gt; in its ease of use. They both have their place, but &lt;em&gt;split&lt;/em&gt; is so much more intuitive and easy to write. And, no external scripts, no package dependencies.&lt;/p&gt;
&lt;p&gt;I suggest that &lt;em&gt;split&lt;/em&gt; is a major tool for server side scripting, server maintenance, developer operations. &lt;a href=&#34;http://code.google.com/p/common-schema/&#34;&gt;Check it out&lt;/a&gt;!&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Auto caching INFORMATION_SCHEMA tables: seeking input</title>
      <link>/blog/mysql/auto-caching-information_schema-tables-seeking-input/</link>
      <pubDate>Thu, 08 Mar 2012 20:31:56 +0000</pubDate>
      
      <guid>/blog/mysql/auto-caching-information_schema-tables-seeking-input/</guid>
      <description>&lt;h4&gt;The short version&lt;/h4&gt;
&lt;p&gt;I have it all working. It&#39;s kind of magic. But there are issues, and I&#39;m not sure it should even exist, and am looking for input.&lt;/p&gt;
&lt;h4&gt;The long version&lt;/h4&gt;
&lt;p&gt;In &lt;a title=&#34;Link to Auto caching tables&#34; href=&#34;http://code.openark.org/blog/mysql/auto-caching-tables&#34; rel=&#34;bookmark&#34;&gt;Auto caching tables&lt;/a&gt; I presented with a hack which allows getting cached or fresh results via a simple SELECT queries.&lt;/p&gt;
&lt;p&gt;The drive for the above hack was &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; tables. There are two major problems with &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Queries on schema-oriented tables such as &lt;strong&gt;TABLES&lt;/strong&gt;, &lt;strong&gt;COLUMNS&lt;/strong&gt;, &lt;strong&gt;STATISTICS&lt;/strong&gt;, etc. are heavyweight. How heavyweight? Enough to make a lockdown of your database. Enough to crash down your database in some cases.&lt;/li&gt;
&lt;li&gt;The data is always generated on-the-fly, as you request it. Query the &lt;strong&gt;COLUMNS&lt;/strong&gt; table twice, and risk two lockdowns of your database.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The auto-cache mechanism solves issue &lt;strong&gt;#2&lt;/strong&gt;. I have it working, time based. I have an auto-cache table for each of the &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; heavyweight tables. Say, every &lt;strong&gt;30&lt;/strong&gt; minutes the cache is invalidated. Throughout those &lt;strong&gt;30&lt;/strong&gt; minutes, you get a free pass!&lt;/p&gt;
&lt;p&gt;The auto-cache mechanism also paves the road to solving issue &lt;strong&gt;#1&lt;/strong&gt;: since it works by invoking a stored routine, I have better control of the way I read &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;. This, I can take advantage of &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/information-schema-optimization.html&#34;&gt;INFORMATION_SCHEMA optimization&lt;/a&gt;. It&#39;s tedious, but not complicated.&lt;/p&gt;
&lt;p&gt;For example, if I wanted to cache the &lt;strong&gt;TABLES&lt;/strong&gt; table, I don&#39;t necessarily read the entire &lt;strong&gt;TABLES&lt;/strong&gt; data in one read. Instead, I can iterate the schemata, get a list of table names per schema, then read full row data for these, table by table. The result? Many many more &lt;strong&gt;SELECT&lt;/strong&gt;s, but more optimized, and no one-big-lock-it-all query.&lt;/p&gt;
&lt;h4&gt;And the problem is...&lt;/h4&gt;
&lt;p&gt;&lt;!--more--&gt;I have two burning problems.&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; optimization only works &lt;em&gt;that much&lt;/em&gt;. It sometimes does not work. In particular, I&#39;ve noticed that if you have a view which relies on another view (possibly relying on yet another view), things get out of hand. I author a monitoring tool for MySQL called &lt;a href=&#34;http://code.openark.org/forge/mycheckpoint/&#34;&gt;mycheckpoint&lt;/a&gt;. It uses some fancy techniques for generating aggregated data, HTML and charts, by means of nested views. There are a few views there I can never query for in &lt;strong&gt;COLUMNS&lt;/strong&gt;. It just crashes down my server. Repeatedly. And it&#39;s a good machine with good configuration. Make that &lt;strong&gt;5&lt;/strong&gt; machines. They all crash, repeatedly. I just can&#39;t trust &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;!&lt;/li&gt;
&lt;li&gt;Replication: any caching table is bound to replicate. Does it make any sense to replicate cache for internal metadata? Does it make sense to query for the cached table on slave, to have it answer for &lt;em&gt;master&#39;&lt;/em&gt;s data? With plain old &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;, every server is on its own. Caching kinda works against this. Or is it fair enough, since we would usually expect master/slaves to reflect same schema structure?&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I would feel much better if I could read &lt;strong&gt;SHOW&lt;/strong&gt; statements with a &lt;strong&gt;SELECT&lt;/strong&gt; query. Though I&#39;ve found this &lt;a href=&#34;http://code.openark.org/blog/mysql/reading-results-of-show-statements-on-server-side&#34;&gt;nice hack&lt;/a&gt;, it can&#39;t work from a stored function, only via stored procedure. So it can&#39;t be used from within a &lt;strong&gt;SELECT&lt;/strong&gt; query. I&#39;ve been banging my head for months now, I think I gave up on this one.&lt;/p&gt;
&lt;p&gt;Any insights are welcome!&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>INFORMATION_SCHEMA Optimizations: still crashing my servers</title>
      <link>/blog/mysql/information_schema-optimizations-still-crashing-my-servers/</link>
      <pubDate>Mon, 12 Dec 2011 09:35:19 +0000</pubDate>
      
      <guid>/blog/mysql/information_schema-optimizations-still-crashing-my-servers/</guid>
      <description>&lt;p&gt;&lt;strong&gt;[Update&lt;/strong&gt;: need to take more breaks: now&lt;strong&gt; NOT&lt;/strong&gt; crashing my servers! See clarifications below&lt;strong&gt;]&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/information-schema-optimization.html&#34;&gt;INFORMATION_SCHEMA Optimizations&lt;/a&gt; are meant to make your &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; queries lighter and safer.&lt;/p&gt;
&lt;p&gt;For example, if you&#39;re going to query the &lt;strong&gt;COLUMNS&lt;/strong&gt; table for just the columns of a single table, then the following:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA=&#39;sakila&#39; AND TABLE_NAME=&#39;rental&#39;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;makes for an optimization: specifying a literal on &lt;strong&gt;TABLE_SCHEMA&lt;/strong&gt; avoid scanning the directories of other schemata. Specifying a literal on &lt;strong&gt;TABLE_NAME&lt;/strong&gt; avoids checking up on other tables. So it&#39;s a one-schema-one-table read operation, as opposed to &lt;em&gt;&#34;first read every single column from all and any single schema and table, then return only those I&#39;m interested in&#34;&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Here&#39;s the execution plan for the above query:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: COLUMNS
         type: ALL
possible_keys: NULL
          key: TABLE_SCHEMA,TABLE_NAME
      key_len: NULL
          ref: NULL
         rows: NULL
        Extra: Using where; Open_frm_only; Scanned 0 databases&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;What I tried to do is to read the entire &lt;strong&gt;COLUMNS&lt;/strong&gt; table, one schema at a time, one table at a time. I&#39;m good with this taking longer time.&lt;/p&gt;
&lt;p&gt;I have a production system on which reads from &lt;strong&gt;COLUMNS&lt;/strong&gt; &lt;em&gt;consistently crash the servers&lt;/em&gt;. Well, one read at a time can&#39;t do harm, right?&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;&lt;del&gt;Unfortunately, as the title of this posts reveals, even sequential read of &lt;strong&gt;COLUMNS&lt;/strong&gt; using &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; optimization does not help: a minute into the process and the client lost connection. The server crashed.&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&lt;del&gt;I was expecting that table locks would be released, buffers released etc. One at a time, there wouldn&#39;t be a congestion of locks, reads, table cache suffocation etc.&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;&lt;del&gt;Was actually having high hopes for this to succeed. I have to find a way in which &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; tables are not dangerous.&lt;/del&gt;&lt;/p&gt;
&lt;p&gt;A few hours later, and I have both conclusions and achievements.&lt;/p&gt;
&lt;p&gt;There are indeed memory issues with querying from &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; tables. I&#39;ve found that &lt;strong&gt;VARCHAR(64)&lt;/strong&gt; columns can consume &lt;strong&gt;64K&lt;/strong&gt; each: I&#39;m reading from large tables of more than &lt;strong&gt;1,000&lt;/strong&gt; columns each, while monitoring MySQL&#39;s memory consumption. By dividing the increase in memory by the number of rows resulting from a query I sent, and which was for one single columns, I got an almost exact &lt;strong&gt;64K&lt;/strong&gt; value per row.&lt;/p&gt;
&lt;p&gt;So a query on &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; consumes much more memory than it should. The good news is that this memory is released once the query terminates. So there is no leak into the session memory.&lt;/p&gt;
&lt;p&gt;This is combined with a &lt;em&gt;mistake of mine&lt;/em&gt; in the way I iterated the tables, such that the problem was amplified: I happened to query much more than I needed, and so got my query&#39;s memory bloated. That is to say, I used the &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; optimizations only partly right, and so got only part of the savings it could offer me.&lt;/p&gt;
&lt;p&gt;With better pinpointing I&#39;m now actually able to read from &lt;strong&gt;COLUMNS,&lt;/strong&gt; without crashing my servers, &lt;em&gt;consistently&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I will further look into the &lt;strong&gt;64K&lt;/strong&gt; issue. That in itself still drains a lot of memory: on my &lt;a href=&#34;http://code.openark.org/forge/mycheckpoint&#34;&gt;mycheckpoint&lt;/a&gt; schema tables a singe table read means &amp;gt; &lt;strong&gt;64MB&lt;/strong&gt; of query memory down the drain.&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>More MySQL foreach()</title>
      <link>/blog/mysql/more-mysql-foreach/</link>
      <pubDate>Fri, 02 Dec 2011 15:55:32 +0000</pubDate>
      
      <guid>/blog/mysql/more-mysql-foreach/</guid>
      <description>&lt;p&gt;In my &lt;a href=&#34;http://code.openark.org/blog/mysql/mysql-foreach&#34;&gt;previous post&lt;/a&gt; I&#39;ve shown several generic use cases for &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/foreach.html&#34;&gt;&lt;em&gt;foreach()&lt;/em&gt;&lt;/a&gt;, a new scripting functionality introduced in &lt;a href=&#34;http://code.google.com/p/common-schema/&#34; rel=&#34;nofollow&#34;&gt;common_schema&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In this part I present DBA&#39;s handy syntax for schema and table operations and maintenance.&lt;/p&gt;
&lt;p&gt;Confession: while I love &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;&#39;s power, I just &lt;em&gt;hate&lt;/em&gt; writing queries against it. It&#39;s just so much typing! Just getting the list of tables in a schema makes for this heavy duty query:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_SCHEMA=&#39;sakila&#39; AND TABLE_TYPE=&#39;BASE TABLE&#39;;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;When a join is involved this really becomes a nightmare. I think it&#39;s cumbersome, and as result, many do not remember the names and meaning of columns, making for &lt;em&gt;&#34;oh, I need to read the manual all over again just to get that query right&#34;&lt;/em&gt;. Anyway, that&#39;s my opinion.&lt;/p&gt;
&lt;p&gt;A &lt;strong&gt;SHOW TABLES&lt;/strong&gt; statement is easier to type, but cannot be integrated into a &lt;strong&gt;SELECT&lt;/strong&gt; query (though &lt;a href=&#34;http://code.openark.org/blog/mysql/reading-results-of-show-statements-on-server-side&#34;&gt;we have a partial solution&lt;/a&gt; for that, too), and besides, when filtering out the views, the &lt;strong&gt;SHOW&lt;/strong&gt; statement becomes almost as cumbersome as the one on &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Which is why &lt;em&gt;foreach()&lt;/em&gt; offers handy shortcuts to common iterations on schemata and tables, as follows:&lt;/p&gt;
&lt;h4&gt;Use case: iterate all databases&lt;/h4&gt;
&lt;blockquote&gt;
&lt;pre&gt;call foreach(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;schema&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;CREATE TABLE ${schema}.event(event_id INT, msg VARCHAR(128))&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;In the above we execute a query on each database. Hmmm, maybe not such a good idea to perform this operation on all databases? Let&#39;s filter them:&lt;/p&gt;
&lt;h4&gt;Use case: iterate databases by name match&lt;/h4&gt;
&lt;blockquote&gt;
&lt;pre&gt;call foreach(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;schema like wordpress_%&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;ALTER TABLE ${schema}.wp_posts MODIFY COLUMN comment_author VARCHAR(96) NOT NULL&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;The above will only iterate my WordPress databases (I have several of these), performing an &lt;strong&gt;ALTER&lt;/strong&gt; on &lt;strong&gt;wp_posts&lt;/strong&gt; for each of those databases.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;I don&#39;t have to quote the &lt;em&gt;like&lt;/em&gt; expression, but I can, if I wish to.&lt;/p&gt;
&lt;p&gt;I can also use a regular expression match:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;call foreach(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;schema ~ /^wordpress_[0-9]+$/&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;ALTER TABLE ${schema}.wp_posts MODIFY COLUMN comment_author VARCHAR(96) NOT NULL&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Use case: iterate tables in a specific schema&lt;/h4&gt;
&lt;p&gt;Time to upgrade our &lt;strong&gt;sakila&lt;/strong&gt; tables to InnoDB&#39;s compressed format. We use &lt;strong&gt;$()&lt;/strong&gt;, a synonym for &lt;em&gt;foreach()&lt;/em&gt;.&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;call $(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;table in sakila&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;ALTER TABLE ${schema}.${table} ENGINE=InnoDB ROW_FORMAT=COMPRESSED&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;The above will iterate on tables in &lt;strong&gt;sakila&lt;/strong&gt;. I say &lt;em&gt;tables&lt;/em&gt;, since it will avoid iterating views (there is still no specific syntax for views iteration). This is done on purpose, as my experience shows there is very little in common between tables and views when it comes to maintenance and operations.&lt;/p&gt;
&lt;h4&gt;Use case: iterate tables by name match&lt;/h4&gt;
&lt;p&gt;Here&#39;s a interesting scenario: you wish to work on all tables matching some name. The naive approach would be to:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT TABLE_SCHEMA, TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = &#39;wp_posts&#39; AND TABLE_TYPE = &#39;BASE TABLE&#39;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Wait!&lt;/strong&gt;&lt;/em&gt; Are you aware this may bring your server down? This query will open all databases at once, opening all &lt;strong&gt;.frm&lt;/strong&gt; files (though thankfully not data files, since we only check for name and type).&lt;/p&gt;
&lt;p&gt;Here&#39;s a better approach:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;call foreach(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;table like wp_posts&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;ALTER TABLE ${schema}.${table} ENGINE=InnoDB&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;(There&#39;s now FULLTEXT to InnoDB, so the above can make sense in the near future!)&lt;/p&gt;
&lt;p&gt;The good part is that &lt;em&gt;foreach()&lt;/em&gt; will look for matching tables &lt;em&gt;one database at a time&lt;/em&gt;. It will iterate the list of database, then look for matching tables per database, thereby optimizing the query on &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Here, too, I can use regular expressions:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;call $(&lt;span style=&#34;color: #808000;&#34;&gt;&#39;table ~ /^wp_.*$/&#39;&lt;/span&gt;, &lt;span style=&#34;color: #003366;&#34;&gt;&#39;ALTER TABLE ${schema}.${table} ENGINE=InnoDB&#39;&lt;/span&gt;);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Conclusion&lt;/h4&gt;
&lt;p&gt;This is work in the making, but, as someone who maintains a few productions servers, I&#39;ve already put it to work.&lt;/p&gt;
&lt;p&gt;I&#39;m hoping the syntax is easy to comprehend. I know that since I developed it it must be far more intuitive to myself than to others. I&#39;ve tried to keep close on common syntax and concepts from various programming languages.&lt;/p&gt;
&lt;p&gt;I would like to get as much feedback as possible. I have further ideas and thoughts on the direction &lt;a href=&#34;http://code.google.com/p/common-schema/&#34;&gt;common_schema&lt;/a&gt; is taking, but wish take it in small steps. Your feedback is appreciated!&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Reading results of SHOW statements, on server side</title>
      <link>/blog/mysql/reading-results-of-show-statements-on-server-side/</link>
      <pubDate>Fri, 25 Nov 2011 21:39:58 +0000</pubDate>
      
      <guid>/blog/mysql/reading-results-of-show-statements-on-server-side/</guid>
      <description>&lt;p&gt;&lt;strong&gt;SHOW&lt;/strong&gt; statements are show stoppers on server side. While clients can get a &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/show.html&#34;&gt;SHOW statement&lt;/a&gt; as a result set just as any normal &lt;strong&gt;SELECT&lt;/strong&gt;, things are not as such on server side.&lt;/p&gt;
&lt;p&gt;On server side, that is, from within MySQL itself, one &lt;em&gt;cannot&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT `Database` FROM (SHOW DATABASES);&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;One &lt;em&gt;cannot&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;DECLARE show_cursor CURSOR FOR SHOW TABLES;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;One &lt;em&gt;cannot&lt;/em&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SHOW TABLES INTO OUTFILE &#39;/tmp/my_file.txt&#39;;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;So it is impossible to get the results with a query; impossible to get the results from a stored routine; impossible to get the results by file reading...&lt;/p&gt;
&lt;h4&gt;Bwahaha! A hack!&lt;/h4&gt;
&lt;p&gt;For some &lt;strong&gt;SHOW&lt;/strong&gt; statements, there is a way around this. I&#39;ve been banging my head against the wall for weeks now on this. Now I have a partial solution: I&#39;m able to read &lt;strong&gt;SHOW&lt;/strong&gt; output for several &lt;strong&gt;SHOW&lt;/strong&gt; statements. Namely, those &lt;strong&gt;SHOW&lt;/strong&gt; statements &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/extended-show.html&#34;&gt;which allow a LIKE or a WHERE&lt;/a&gt; clause.&lt;/p&gt;
&lt;p&gt;For example, most are familiar with the following syntax:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;USE mysql;
SHOW TABLE STATUS LIKE &#39;user&#39;;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;However not so many know that any &lt;strong&gt;SHOW&lt;/strong&gt; statement which accepts &lt;strong&gt;LIKE&lt;/strong&gt;, can also accept &lt;strong&gt;WHERE&lt;/strong&gt;:&lt;!--more--&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SHOW TABLE STATUS WHERE Name=&#39;user&#39;\G
*************************** 1. row ***************************
           Name: user
         Engine: MyISAM
        Version: 10
     Row_format: Dynamic
           Rows: 17
 Avg_row_length: 69
    Data_length: 1184
Max_data_length: 281474976710655
   Index_length: 2048
      Data_free: 0
 Auto_increment: NULL
    Create_time: 2010-10-03 08:23:48
    Update_time: 2011-07-30 19:31:00
     Check_time: NULL
      Collation: utf8_bin
       Checksum: NULL
 Create_options:
        Comment: Users and global privileges&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;It&#39;s not just about &#34;&lt;strong&gt;Name&lt;/strong&gt;&#34;. I can filter using any column I like:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SHOW TABLE STATUS WHERE Rows &amp;gt; 1000;
SHOW TABLE STATUS WHERE Rows &amp;gt; 1000 AND Index_length &amp;gt; 65536;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;etc.&lt;/p&gt;
&lt;p&gt;If you&#39;ve been to my talk on &lt;a href=&#34;http://www.percona.com/live/london-2011/session/programmatic-queries-things-you-can-code-with-sql/&#34;&gt;Programmatic Queries: things you can code with SQL&lt;/a&gt;, you have a good guess as for where I&#39;m taking this.&lt;/p&gt;
&lt;h4&gt;Where there&#39;s WHERE, there&#39;s code&lt;/h4&gt;
&lt;p&gt;I can write code within the &lt;strong&gt;WHERE&lt;/strong&gt; clause. Specifically, I can work with user defined variables. Shall we cut to the point and provide with an example?&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;mysql&amp;gt; SET @databases := &#39;&#39;;

mysql&amp;gt; SHOW DATABASES WHERE (@databases := CONCAT(@databases, `Database`, &#39;,&#39;)) IS NULL;

mysql&amp;gt; SELECT @databases;
+-------------------------------------------------------------------+
| @databases                                                        |
+-------------------------------------------------------------------+
| information_schema,common_schema,mycheckpoint,mysql,sakila,world, |
+-------------------------------------------------------------------+&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Let&#39;s discuss the above. We:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Set a user variables called &lt;strong&gt;@databases&lt;/strong&gt; to an empty text&lt;/li&gt;
&lt;li&gt;Iterate through the &lt;strong&gt;SHOW DATABASES&lt;/strong&gt; rowset. The &lt;strong&gt;WHERE&lt;/strong&gt; clause is always &lt;em&gt;false&lt;/em&gt; (the expression is in fact &lt;strong&gt;NOT NULL&lt;/strong&gt; for all rows), so rows are not printed out, and we get an empty result set (we&#39;re not really interested in a result set here, since there&#39;s no way to read it anyhow).&lt;/li&gt;
&lt;li&gt;However we do take care to &#34;remember&#34; the value we visit, by concatenating the &lt;strong&gt;`Database`&lt;/strong&gt; column value.&lt;/li&gt;
&lt;li&gt;We end up with a delimited string of database names. You&#39;ll forgive the ending &lt;strong&gt;&#39;,&#39;&lt;/strong&gt;. This is just a simple example, it is of no importance.&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;Further notes&lt;/h4&gt;
&lt;p&gt;What can we do with the concatenated list of database names? Whatever we want to. We can parse it again, &lt;strong&gt;INSERT&lt;/strong&gt; it &lt;strong&gt;INTO&lt;/strong&gt; some table, save to file, iterate, what have you!&lt;/p&gt;
&lt;p&gt;We can wrap the above in a stored routine. Alas, not with a stored function, since the &lt;strong&gt;SHOW&lt;/strong&gt; command, although returns with an empty result set, does return with a result set, not allowed withing functions.&lt;strong&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;h4&gt;Limitations&lt;/h4&gt;
&lt;ul&gt;
&lt;li&gt;Sadly, &lt;strong&gt;SHOW SLAVE STATUS&lt;/strong&gt;, &lt;strong&gt;SHOW MASTER LOGS&lt;/strong&gt; etc., do not support &lt;strong&gt;LIKE&lt;/strong&gt; or &lt;strong&gt;WHERE&lt;/strong&gt; syntax. Bummer.&lt;/li&gt;
&lt;li&gt;Stored functions, as just mentioned, cannot utilize this hack. Hey, I&#39;m still working on this!&lt;/li&gt;
&lt;/ul&gt;
&lt;h4&gt;To what use?&lt;/h4&gt;
&lt;p&gt;Originally I wanted to avoid the time &amp;amp; locking it takes for &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; queries, such as on &lt;strong&gt;TABLES&lt;/strong&gt;, &lt;strong&gt;COLUMNS&lt;/strong&gt;, etc. Ironically, in a few days apart I&#39;ve found &lt;em&gt;another&lt;/em&gt; interesting solution (well, two, actually) to manage reads from &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; with less overhead than in normal use. I&#39;ll talk about that another time; am about to use this in &lt;a href=&#34;http://code.google.com/p/common-schema/&#34; rel=&#34;nofollow&#34;&gt;common_schema&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;Further notes&lt;/h4&gt;
&lt;p&gt;I met &lt;a href=&#34;http://rpbouman.blogspot.com/&#34;&gt;Roland&lt;/a&gt; in &lt;a href=&#34;http://www.percona.com/live/london-2011/&#34;&gt;London&lt;/a&gt;, and he liked the solution. As &lt;a href=&#34;http://www.mysqlperformanceblog.com/author/baron/&#34;&gt;Baron&lt;/a&gt; joined, Roland said: &#34;Baron, do you know Shlomi devised a method to read the output of &lt;strong&gt;SHOW&lt;/strong&gt; commands?&#34;&lt;/p&gt;
&lt;p&gt;And Baron said: &#34;Without using files? Then a &lt;strong&gt;SHOW&lt;/strong&gt; statement can have a &lt;strong&gt;WHERE&lt;/strong&gt; clause, in which case you can use a variable&#34;, and went on looking for his wife.&lt;/p&gt;
&lt;p&gt;And we remained speechless.&lt;/p&gt;
&lt;p&gt;[UPDATE: I&#39;ve manually changed timestamp of this post due to failure in its aggregation in planet.mysql, being a major source of incoming traffic to this site]&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>MySQL Global status difference using single query</title>
      <link>/blog/mysql/mysql-global-status-difference-using-single-query/</link>
      <pubDate>Fri, 12 Aug 2011 18:31:12 +0000</pubDate>
      
      <guid>/blog/mysql/mysql-global-status-difference-using-single-query/</guid>
      <description>&lt;p&gt;Have just read &lt;a href=&#34;http://karlssonondatabases.blogspot.com/2011/08/mysql-global-status-difference-using_12.html&#34;&gt;MySQL Global status difference using MySQL procedures / functions&lt;/a&gt;, by Andres Karlsson. Have commented, but realized I did not provide with a direct answer. In the comment, I suggested checking out &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/global_status_diff.html&#34;&gt;a solution based on views&lt;/a&gt;, found in &lt;a href=&#34;http://code.google.com/p/common-schema/&#34; rel=&#34;nofollow&#34;&gt;common_schema&lt;/a&gt;. But the solution in &lt;em&gt;common_schema&lt;/em&gt; is split into two views, due to the fact views cannot handle derived tables subqueries.&lt;/p&gt;
&lt;p&gt;Well, here&#39;s a single query to do that: it checks &lt;strong&gt;GLOBAL_STATUS&lt;/strong&gt; twice, &lt;strong&gt;10&lt;/strong&gt; seconds apart in the following sample. It uses &lt;strong&gt;SLEEP()&lt;/strong&gt; to actually wait between the two reads. Yes, you can do that with a query.&lt;/p&gt;
&lt;p&gt;The following query shows all &lt;strong&gt;GLOBAL_STATUS&lt;/strong&gt; values that have changed during the sample period.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;[UPDATE]&lt;/strong&gt; query updated to work with MySQL &lt;strong&gt;5.6&lt;/strong&gt; optimizer&lt;!--more--&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT STRAIGHT_JOIN
   LOWER(gs0.VARIABLE_NAME) AS variable_name,
   gs0.VARIABLE_VALUE AS variable_value_0,
   gs1.VARIABLE_VALUE AS variable_value_1,
   (gs1.VARIABLE_VALUE - gs0.VARIABLE_VALUE) AS variable_value_diff,
   (gs1.VARIABLE_VALUE - gs0.VARIABLE_VALUE) / 10 AS variable_value_psec,
   (gs1.VARIABLE_VALUE - gs0.VARIABLE_VALUE) * 60 / 10 AS
variable_value_pminute
FROM
   (
     SELECT
       VARIABLE_NAME,
       VARIABLE_VALUE
     FROM
       INFORMATION_SCHEMA.GLOBAL_STATUS
     UNION ALL
     SELECT
       &#39;&#39;,
       SLEEP(10)
     FROM DUAL
   ) AS gs0
   JOIN (
     SELECT 
       VARIABLE_NAME,
       VARIABLE_VALUE
     FROM 
       INFORMATION_SCHEMA.GLOBAL_STATUS
   ) gs1 USING (VARIABLE_NAME)
WHERE
   gs1.VARIABLE_VALUE != gs0.VARIABLE_VALUE
;
+-----------------------------------+------------------+------------------+---------------------+---------------------+------------------------+
| variable_name                     | variable_value_0 | variable_value_1 | variable_value_diff | variable_value_psec | variable_value_pminute |
+-----------------------------------+------------------+------------------+---------------------+---------------------+------------------------+
| aborted_clients                   | 2210669          | 2210686          |                  17 |                 1.7 |                    102 |
| bytes_received                    | 53259933210      | 53260211104      |              277894 |             27789.4 |                1667364 |
| bytes_sent                        | 351130988015     | 351132884956     |             1896941 |            189694.1 |               11381646 |
| com_change_db                     | 3760546          | 3760584          |                  38 |                 3.8 |                    228 |
| com_delete                        | 6774784          | 6774801          |                  17 |                 1.7 |                    102 |
| com_insert                        | 52743750         | 52744012         |                 262 |                26.2 |                   1572 |
| com_insert_select                 | 13362650         | 13362740         |                  90 |                   9 |                    540 |
| com_select                        | 51722818         | 51723107         |                 289 |                28.9 |                   1734 |
| com_set_option                    | 108564134        | 108564754        |                 620 |                  62 |                   3720 |
| com_show_collations               | 3760530          | 3760568          |                  38 |                 3.8 |                    228 |
| com_show_processlist              | 366078           | 366082           |                   4 |                 0.4 |                     24 |
| com_show_status                   | 366047           | 366051           |                   4 |                 0.4 |                     24 |
| com_show_variables                | 3760535          | 3760573          |                  38 |                 3.8 |                    228 |
| com_update                        | 6271283          | 6271324          |                  41 |                 4.1 |                    246 |
| connections                       | 3781382          | 3781420          |                  38 |                 3.8 |                    228 |
| created_tmp_disk_tables           | 983223           | 983224           |                   1 |                 0.1 |                      6 |
| created_tmp_tables                | 9134044          | 9134126          |                  82 |                 8.2 |                    492 |
| handler_commit                    | 125798040        | 125798688        |                 648 |                64.8 |                   3888 |
| handler_delete                    | 6849562          | 6849578          |                  16 |                 1.6 |                     96 |
| handler_read_first                | 5332451          | 5332498          |                  47 |                 4.7 |                    282 |
| handler_read_key                  | 373910509        | 373912469        |                1960 |                 196 |                  11760 |
| handler_read_next                 | 850122025        | 850170403        |               48378 |              4837.8 |                 290268 |
| handler_read_rnd                  | 255104660        | 255105932        |                1272 |               127.2 |                   7632 |
| handler_read_rnd_next             | 992505444        | 992549948        |               44504 |              4450.4 |                 267024 |
| handler_update                    | 27930283         | 27930465         |                 182 |                18.2 |                   1092 |
| handler_write                     | 2051582925       | 2051602416       |               19491 |              1949.1 |                 116946 |
| innodb_buffer_pool_pages_data     | 77232            | 77243            |                  11 |                 1.1 |                     66 |
| innodb_buffer_pool_pages_dirty    | 626              | 645              |                  19 |                 1.9 |                    114 |
| innodb_buffer_pool_pages_flushed  | 38429812         | 38430032         |                 220 |                  22 |                   1320 |
| innodb_buffer_pool_pages_misc     | 4294922063       | 4294922052       |                 -11 |                -1.1 |                    -66 |
| innodb_buffer_pool_read_requests  | 1933796064       | 1933871603       |               75539 |              7553.9 |                 453234 |
| innodb_buffer_pool_reads          | 11360212         | 11360214         |                   2 |                 0.2 |                     12 |
| innodb_buffer_pool_write_requests | 1074109722       | 1074115394       |                5672 |               567.2 |                  34032 |
| innodb_data_fsyncs                | 5583880          | 5583905          |                  25 |                 2.5 |                    150 |
| innodb_data_read                  | 3339489280       | 3339501568       |               12288 |              1228.8 |                  73728 |
| innodb_data_reads                 | 11796492         | 11796494         |                   2 |                 0.2 |                     12 |
| innodb_data_writes                | 105587582        | 105588145        |                 563 |                56.3 |                   3378 |
| innodb_data_written               | 3721600000       | 3727315968       |             5715968 |            571596.8 |               34295808 |
| innodb_dblwr_pages_written        | 38429812         | 38430032         |                 220 |                  22 |                   1320 |
| innodb_dblwr_writes               | 596503           | 596506           |                   3 |                 0.3 |                     18 |
| innodb_log_write_requests         | 380978894        | 380981368        |                2474 |               247.4 |                  14844 |
| innodb_log_writes                 | 74407604         | 74407990         |                 386 |                38.6 |                   2316 |
| innodb_os_log_fsyncs              | 2310799          | 2310807          |                   8 |                 0.8 |                     48 |
| innodb_os_log_written             | 2905292800       | 2906502656       |             1209856 |            120985.6 |                7259136 |
| innodb_pages_created              | 1341584          | 1341593          |                   9 |                 0.9 |                     54 |
| innodb_pages_read                 | 13117652         | 13117654         |                   2 |                 0.2 |                     12 |
| innodb_pages_written              | 38429812         | 38430032         |                 220 |                  22 |                   1320 |
| innodb_rows_deleted               | 6849552          | 6849568          |                  16 |                 1.6 |                     96 |
| innodb_rows_inserted              | 43787980         | 43788207         |                 227 |                22.7 |                   1362 |
| innodb_rows_read                  | 4289845136       | 4289919560       |               74424 |              7442.4 |                 446544 |
| innodb_rows_updated               | 24119627         | 24119809         |                 182 |                18.2 |                   1092 |
| key_read_requests                 | 41262330         | 41262338         |                   8 |                 0.8 |                     48 |
| open_files                        | 7                | 5                |                  -2 |                -0.2 |                    -12 |
| opened_files                      | 4212920          | 4212924          |                   4 |                 0.4 |                     24 |
| questions                         | 253158874        | 253160331        |                1457 |               145.7 |                   8742 |
| select_full_join                  | 546              | 547              |                   1 |                 0.1 |                      6 |
| select_range                      | 721945           | 721947           |                   2 |                 0.2 |                     12 |
| select_scan                       | 12828865         | 12828989         |                 124 |                12.4 |                    744 |
| sort_range                        | 170971           | 170973           |                   2 |                 0.2 |                     12 |
| sort_rows                         | 255175383        | 255176655        |                1272 |               127.2 |                   7632 |
| sort_scan                         | 534078           | 534080           |                   2 |                 0.2 |                     12 |
| table_locks_immediate             | 142673687        | 142674454        |                 767 |                76.7 |                   4602 |
| threads_cached                    | 7                | 8                |                   1 |                 0.1 |                      6 |
| threads_connected                 | 5                | 10               |                   5 |                 0.5 |                     30 |
| threads_created                   | 840486           | 840509           |                  23 |                 2.3 |                    138 |
+-----------------------------------+------------------+------------------+---------------------+---------------------+------------------------+&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Some values don&#39;t make sense to do difference on (e.g. &lt;strong&gt;threads_connected&lt;/strong&gt;), since they present with momentary status and are not incrementing as others (e.g. &lt;strong&gt;threads_created&lt;/strong&gt;).&lt;/p&gt;
&lt;p&gt;Happy SQLing!&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Announcing common_schema: common views &amp; routines for MySQL</title>
      <link>/blog/mysql/announcing-common_schema-common-views-routines-for-mysql/</link>
      <pubDate>Wed, 13 Jul 2011 06:25:24 +0000</pubDate>
      
      <guid>/blog/mysql/announcing-common_schema-common-views-routines-for-mysql/</guid>
      <description>&lt;p&gt;Today I have released &lt;a title=&#34;common_schema&#34; href=&#34;http://code.openark.org/forge/common_schema&#34;&gt;common_schema&lt;/a&gt;, a utility schema for MySQL which includes many views and functions, and is aimed to be installed on any MySQL server.&lt;/p&gt;
&lt;h4&gt;What does it do?&lt;/h4&gt;
&lt;p&gt;There are views answering for all sorts of useful information: stuff related to schema analysis, data dimensions, monitoring, processes &amp;amp; transactions, security, internals... There are basic functions answering for common needs.&lt;/p&gt;
&lt;p&gt;Some of the views/routines simply formalize those queries we tend to write over and over again. Others take the place of external tools, answering complex questions via SQL and metadata. Still others help out with SQL generation.&lt;/p&gt;
&lt;p&gt;Here are a few highlights:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Did you know you can work out &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/global_status_diff_nonzero.html&#34;&gt;simple monitoring&lt;/a&gt; of your server with a &lt;em&gt;query&lt;/em&gt;?  There&#39;s a view to do that for you.&lt;/li&gt;
&lt;li&gt;How about showing just &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/processlist_top.html&#34;&gt;the good parts of the processlist&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;Does your schema have &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/redundant_keys.html&#34;&gt;redundant keys&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;Or InnoDB tables with &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/no_pk_innodb_tables.html&#34;&gt;no PRIMARY KEY&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;Is AUTO_INCREMENT &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/auto_increment_columns.html&#34;&gt;running out of space&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;Can I get the SQL statements to &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_foreign_keys.html&#34;&gt;generate my FOREIGN KEYs&lt;/a&gt;? To drop them?&lt;/li&gt;
&lt;li&gt;And can we finally get &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_show_grants.html&#34;&gt;SHOW GRANTS for all accounts&lt;/a&gt;, and as an &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_grants.html&#34;&gt;SQL query&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;Ever needed a &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/general_functions.html#crc64&#34;&gt;64 bit CRC function&lt;/a&gt;?&lt;/li&gt;
&lt;li&gt;And aren&#39;t you tired of writing the cumbersome SUBSTRING_INDEX(SUBSTRING_INDEX(str, &#39;,&#39;, 3), &#39;,&#39;, -1)? &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/string_functions.html#split_token&#34;&gt;There&#39;s an alternative&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;There&#39;s more. Take a look at the &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/introduction.html&#34;&gt;common_schema documentation&lt;/a&gt; for full listing. And it&#39;s evolving: I&#39;ve got quite a few ideas already for future components.&lt;/p&gt;
&lt;p&gt;Some of these views rely on heavyweight INFORMATION_SCHEMA tables. You should be aware of the impact and &lt;a href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/risks.html&#34;&gt;risks&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;What do I need to install?&lt;/h4&gt;
&lt;p&gt;There&#39;s no script or executable file. It&#39;s just a schema. The distribution in an SQL file which generates &lt;em&gt;common_schema&lt;/em&gt;. Much like a dump file.&lt;/p&gt;
&lt;h4&gt;&lt;!--more--&gt;What are the system requirements?&lt;/h4&gt;
&lt;p&gt;It&#39;s just between you and your MySQL. There are currently three distribution files, dedicated for different versions of MySQL (and allowing for increased functionality):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;common_schema_mysql_51&lt;/strong&gt;: fits all MySQL &amp;gt;= 5.1 distributions&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;common_schema_innodb_plugin&lt;/strong&gt;: fits MySQL &amp;gt;= 5.1, with InnoDB plugin + INFORMATION_SCHEMA tables enabled&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;common_schema_percona_server&lt;/strong&gt;: fits Percona Server &amp;gt;= 5.1&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Refer to the &lt;a rel=&#34;nofollow&#34; href=&#34;http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/download.html&#34;&gt;documentation&lt;/a&gt; for more details.&lt;/p&gt;
&lt;h4&gt;What are the terms of use?&lt;/h4&gt;
&lt;p&gt;&lt;em&gt;common_schema&lt;/em&gt; is released under the &lt;a href=&#34;http://www.opensource.org/licenses/bsd-license.php&#34;&gt;BSD license&lt;/a&gt;.&lt;/p&gt;
&lt;h4&gt;Where can I download it?&lt;/h4&gt;
&lt;p&gt;On the &lt;a href=&#34;http://code.google.com/p/common-schema/&#34;&gt;common_schema project page&lt;/a&gt;. Enjoy it!&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>ROUTINE_PRIVILEGES implementation</title>
      <link>/blog/mysql/routine_privileges-implementation/</link>
      <pubDate>Wed, 22 Jun 2011 14:14:45 +0000</pubDate>
      
      <guid>/blog/mysql/routine_privileges-implementation/</guid>
      <description>&lt;p&gt;Following up on &lt;a title=&#34;Link to MySQL security: inconsistencies&#34; rel=&#34;bookmark&#34; href=&#34;http://code.openark.org/blog/mysql/mysql-security-inconsistencies&#34;&gt;MySQL security: inconsistencies&lt;/a&gt;, and on &lt;a href=&#34;http://bugs.mysql.com/bug.php?id=61596&#34;&gt;MySQL bug #61596&lt;/a&gt;, I was thinking it may take a long time till the non-existent &lt;strong&gt;ROUTINE_PRIVILEGES&lt;/strong&gt; view is implemented. Here&#39;s my own implementation of the view.&lt;/p&gt;
&lt;p&gt;I&#39;ve followed the somewhat strange conventions used in the &lt;strong&gt;*_PRIVILEGES&lt;/strong&gt; tables in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;, where the &lt;strong&gt;IS_GRANTABLE&lt;/strong&gt; is a separate column, although in &lt;em&gt;&lt;del&gt;2nd&lt;/del&gt; 1st normal form&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;I present it here as a query, using session variables, rather than a view definition:&lt;span id=&#34;more-3764&#34;&gt;&lt;/span&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT STRAIGHT_JOIN
  CONCAT(&#39;\&#39;&#39;, User, &#39;\&#39;@\&#39;&#39;, Host, &#39;\&#39;&#39;) AS GRANTEE,
  NULL AS ROUTINE_CATALOG,
  Db AS ROUTINE_SCHEMA,
  Routine_name AS ROUTINE_NAME,
  Routine_type AS ROUTINE_TYPE,
  UPPER(SUBSTRING_INDEX(SUBSTRING_INDEX(Proc_priv, &#39;,&#39;, n+1), &#39;,&#39;, -1)) AS PRIVILEGE_TYPE,
  IF(grantable_procs_priv.User IS NULL, &#39;NO&#39;, &#39;YES&#39;) AS IS_GRANTABLE
FROM
  mysql.procs_priv
  CROSS JOIN (SELECT @counter := -1) select_init
  CROSS JOIN (
    SELECT
      @counter := @counter+1 AS n
    FROM
      INFORMATION_SCHEMA.COLLATIONS
    LIMIT 5
  ) numbers
  LEFT JOIN (
      SELECT
        DISTINCT User, Host, Db, Routine_name
      FROM
        mysql.procs_priv
      WHERE
         find_in_set(&#39;Grant&#39;, Proc_priv) &amp;gt; 0
    ) grantable_procs_priv USING (User, Host, Db, Routine_name)
WHERE
  numbers.n BETWEEN 0 AND CHAR_LENGTH(Proc_priv) - CHAR_LENGTH(REPLACE(Proc_priv, &#39;,&#39;, &#39;&#39;))
  AND UPPER(SUBSTRING_INDEX(SUBSTRING_INDEX(Proc_priv, &#39;,&#39;, n+1), &#39;,&#39;, -1)) != &#39;GRANT&#39;
ORDER BY
  GRANTEE, ROUTINE_SCHEMA, ROUTINE_NAME, ROUTINE_TYPE, n
;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;It takes &lt;strong&gt;2&lt;/strong&gt; views and a table to make this a VIEW rather than a query.&lt;/p&gt;
&lt;p&gt;First teaser: the view which represents this query, along with many other interesting diagnostic views, is to take part in a new open source project I&#39;m working on.&lt;/p&gt;
&lt;h4&gt;[UPDATE]&lt;/h4&gt;
&lt;p&gt;Guess I was in a rush to produce the query. Here&#39;s a shorter, cleaner one:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT
  CONCAT(&#39;\&#39;&#39;, User, &#39;\&#39;@\&#39;&#39;, Host, &#39;\&#39;&#39;) AS GRANTEE,
  NULL AS ROUTINE_CATALOG,
  Db AS ROUTINE_SCHEMA,
  Routine_name AS ROUTINE_NAME,
  Routine_type AS ROUTINE_TYPE,
  UPPER(SUBSTRING_INDEX(SUBSTRING_INDEX(Proc_priv, &#39;,&#39;, n+1), &#39;,&#39;, -1)) AS PRIVILEGE_TYPE,
  IF(find_in_set(&#39;Grant&#39;, Proc_priv) &amp;gt; 0, &#39;YES&#39;, &#39;NO&#39;) AS IS_GRANTABLE
FROM
  mysql.procs_priv
  CROSS JOIN (
    SELECT
      @counter := @counter+1 AS n
    FROM
      INFORMATION_SCHEMA.COLLATIONS, (SELECT @counter := -1) select_init
    LIMIT 5
  ) numbers
WHERE
  numbers.n BETWEEN 0 AND CHAR_LENGTH(Proc_priv) - CHAR_LENGTH(REPLACE(Proc_priv, &#39;,&#39;, &#39;&#39;))
  AND UPPER(SUBSTRING_INDEX(SUBSTRING_INDEX(Proc_priv, &#39;,&#39;, n+1), &#39;,&#39;, -1)) != &#39;GRANT&#39;
ORDER BY
  GRANTEE, ROUTINE_SCHEMA, ROUTINE_NAME, ROUTINE_TYPE, n
;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;Example output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;+--------------------------+-----------------+----------------+----------------------------+--------------+----------------+--------------+
| GRANTEE                  | ROUTINE_CATALOG | ROUTINE_SCHEMA | ROUTINE_NAME               | ROUTINE_TYPE | PRIVILEGE_TYPE | IS_GRANTABLE |
+--------------------------+-----------------+----------------+----------------------------+--------------+----------------+--------------+
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | film_in_stock              | PROCEDURE    | EXECUTE        | NO           |
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | film_in_stock              | PROCEDURE    | ALTER ROUTINE  | NO           |
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | get_customer_balance       | FUNCTION     | EXECUTE        | NO           |
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | get_customer_balance       | FUNCTION     | ALTER ROUTINE  | NO           |
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | inventory_held_by_customer | FUNCTION     | EXECUTE        | NO           |
| &#39;other_user&#39;@&#39;localhost&#39; |            NULL | sakila         | inventory_held_by_customer | FUNCTION     | ALTER ROUTINE  | NO           |
| &#39;shlomi&#39;@&#39;127.0.0.1&#39;     |            NULL | sakila         | film_in_stock              | PROCEDURE    | EXECUTE        | YES          |
| &#39;shlomi&#39;@&#39;127.0.0.1&#39;     |            NULL | sakila         | get_customer_balance       | FUNCTION     | EXECUTE        | NO           |
| &#39;shlomi&#39;@&#39;127.0.0.1&#39;     |            NULL | sakila         | get_customer_balance       | FUNCTION     | ALTER ROUTINE  | NO           |
| &#39;world_user&#39;@&#39;localhost&#39; |            NULL | sakila         | get_customer_balance       | FUNCTION     | EXECUTE        | YES          |
| &#39;world_user&#39;@&#39;localhost&#39; |            NULL | sakila         | get_customer_balance       | FUNCTION     | ALTER ROUTINE  | YES          |
+--------------------------+-----------------+----------------+----------------------------+--------------+----------------+--------------+&lt;/pre&gt;
&lt;/blockquote&gt;</description>
    </item>
    
    <item>
      <title>MySQL security: inconsistencies</title>
      <link>/blog/mysql/mysql-security-inconsistencies/</link>
      <pubDate>Wed, 22 Jun 2011 08:39:01 +0000</pubDate>
      
      <guid>/blog/mysql/mysql-security-inconsistencies/</guid>
      <description>&lt;p&gt;Doing some work with MySQL security, I&#39;ve noticed a few inconsistencies. They&#39;re mostly not-too-terrible for daily work, except they get in my way right now.&lt;/p&gt;
&lt;h4&gt;The ALL PRIVILEGES inconsistency&lt;/h4&gt;
&lt;p&gt;The preferred way of assigning account privileges in MySQL is by way of using &lt;a href=&#34;http://dev.mysql.com/doc/refman/5.1/en/grant.html&#34;&gt;GRANT&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;With &lt;strong&gt;GRANT&lt;/strong&gt;, one assigns one or more privileges to an account, such as &lt;strong&gt;SELECT&lt;/strong&gt;, &lt;strong&gt;UPDATE&lt;/strong&gt;, &lt;strong&gt;ALTER&lt;/strong&gt;, &lt;strong&gt;SUPER&lt;/strong&gt; ,etc. Sometimes it makes sense for an account to have complete control over a domain. For example, the &lt;strong&gt;root&lt;/strong&gt; account is typically assigned with all privileges. Or, some user may require all possible privileges on a certain schema.&lt;/p&gt;
&lt;p&gt;Instead of listing the entire set of privileges, the &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt; meta-privilege can be used. There is a fine issue to notice here; typically this is not a problem, but I see it as a flaw. Assume the following account:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;root@mysql-5.1.51&amp;gt; GRANT &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt; ON world.* TO &#39;world_user&#39;@&#39;localhost&#39;;

root@mysql-5.1.51&amp;gt; SHOW GRANTS FOR &#39;world_user&#39;@&#39;localhost&#39;;
+---------------------------------------------------------------+
| Grants for world_user@localhost                               |
+---------------------------------------------------------------+
| GRANT USAGE ON *.* TO &#39;world_user&#39;@&#39;localhost&#39;                |
| GRANT &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt; ON `world`.* TO &#39;world_user&#39;@&#39;localhost&#39; |
+---------------------------------------------------------------&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;This makes sense. We granted &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt; and we see that the account is granted with &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Now notice the following:&lt;!--more--&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;root@mysql-5.1.51&amp;gt; GRANT ALTER, ALTER ROUTINE, CREATE, CREATE ROUTINE, CREATE TEMPORARY TABLES, CREATE VIEW, DELETE, DROP, EVENT, EXECUTE, INDEX, INSERT, LOCK TABLES, REFERENCES, SELECT, SHOW VIEW, TRIGGER, UPDATE ON `world`.* TO &#39;other_user&#39;@&#39;localhost&#39;;

root@mysql-5.1.51&amp;gt; SHOW GRANTS FOR &#39;other_user&#39;@&#39;localhost&#39;;
+---------------------------------------------------------------+
| Grants for other_user@localhost                               |
+---------------------------------------------------------------+
| GRANT USAGE ON *.* TO &#39;other_user&#39;@&#39;localhost&#39;                |
| GRANT &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt; ON `world`.* TO &#39;other_user&#39;@&#39;localhost&#39; |
+---------------------------------------------------------------+&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;I didn&#39;t &lt;em&gt;ask&lt;/em&gt; for &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt;. I explicitly listed what I thought should be an account&#39;s privileges. It just so happens that these make for the entire set of privileges available on the schema domain.&lt;/p&gt;
&lt;p&gt;You might think this is a nice feature, an ease out MySQL provides with. I do not see it this way.&lt;/p&gt;
&lt;p&gt;My preferred way of upgrading MySQL version involves exporting and importing of the GRANTs. That is, I do not dump and load the &lt;strong&gt;mysql&lt;/strong&gt; system tables, but rather export all the &lt;strong&gt;SHOW GRANTS FOR ...&lt;/strong&gt; (e.g. with mk-show-grants), then execute these on the new version. This process was extremely useful on upgrades from &lt;strong&gt;5.0&lt;/strong&gt; to &lt;strong&gt;5.1&lt;/strong&gt;, where some &lt;strong&gt;mysql&lt;/strong&gt; system tables were modified.&lt;/p&gt;
&lt;p&gt;Now, consider the case where some new MySQL version introduced a new set of privileges. My &lt;strong&gt;&#39;other_user&#39;@&#39;localhost&#39;&lt;/strong&gt; was not created with that set of privileges, nor did I intend it to have them. However, when exporting with &lt;strong&gt;SHOW GRANTS&lt;/strong&gt;, the account is said to have &lt;strong&gt;ALL PRIVILEGES&lt;/strong&gt;. When executed on the new version, the account will have privileges which I &lt;em&gt;never assigned it&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Typically, this is not an issue. I mean, how many times do I assign an account with the entire set of privileges, yet do not intend it to have all privileges? Nevertheless, this makes for an inconsistency. It is unclear, by way of definition, which privileges are assigned to a user, without knowing the context of the version and the set of privileges per version. It makes for an inconsistency when moving between versions. And right now I&#39;m working on some code which doesn&#39;t like these inconsistencies.&lt;/p&gt;
&lt;h4&gt;The WITH GRANT OPTION inconsistency&lt;/h4&gt;
&lt;p&gt;An account can be granted with the &lt;strong&gt;WITH GRANT OPTION&lt;/strong&gt; privilege, which means the account&#39;s user can assign her privileges to other accounts. The inconsistency I found is that the &lt;strong&gt;GRANT&lt;/strong&gt; mechanism is fuzzy with regard to &lt;strong&gt;GRANT OPTION&lt;/strong&gt;, and falsely presents us with the wrong impression.&lt;/p&gt;
&lt;p&gt;Let&#39;s begin with the bottom line: the &lt;strong&gt;WITH GRANT OPTION&lt;/strong&gt; can only be set globally for an account-domain combination. Consider:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;root@mysql-5.1.51&amp;gt; GRANT INSERT, DELETE, UPDATE ON world.City TO &#39;gromit&#39;@&#39;localhost&#39;;
Query OK, 0 rows affected (0.00 sec)

root@mysql-5.1.51&amp;gt; GRANT SELECT ON world.City TO &#39;gromit&#39;@&#39;localhost&#39; WITH GRANT OPTION;
Query OK, 0 rows affected (0.00 sec)

root@mysql-5.1.51&amp;gt; SHOW GRANTS FOR &#39;gromit&#39;@&#39;localhost&#39;;
+--------------------------------------------------------------------------------------------------+
| Grants for gromit@localhost                                                                      |
+--------------------------------------------------------------------------------------------------+
| GRANT USAGE ON *.* TO &#39;gromit&#39;@&#39;localhost&#39;                                                       |
| GRANT &lt;strong&gt;SELECT, INSERT, UPDATE, DELETE&lt;/strong&gt; ON `world`.`City` TO &#39;gromit&#39;@&#39;localhost&#39; &lt;strong&gt;WITH GRANT OPTION&lt;/strong&gt; |
+--------------------------------------------------------------------------------------------------+
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;The syntax of first two queries leads us to believe that we&#39;re only providing the &lt;strong&gt;WITH GRANT OPTION&lt;/strong&gt; for the &lt;strong&gt;SELECT&lt;/strong&gt; privilege. But that is not so: the &lt;strong&gt;WITH GRANT OPTION&lt;/strong&gt; is assigned for all privileges on &lt;strong&gt;world.City&lt;/strong&gt; to &lt;strong&gt;&#39;gromit&#39;@&#39;localhost&#39;&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;The syntax would be more correct if we were to write something like:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;GRANT &lt;strong&gt;GRANT_OPTION&lt;/strong&gt; ON world.* TO &#39;gromit&#39;@&#39;localhost&#39;;&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;That would make it clear that this privilege does not depend on other privileges set on the specified domain.&lt;/p&gt;
&lt;h4&gt;The USAGE inconsistency&lt;/h4&gt;
&lt;p&gt;You can &lt;strong&gt;GRANT&lt;/strong&gt; the &lt;strong&gt;USAGE&lt;/strong&gt; privilege, but you may never &lt;strong&gt;REVOKE&lt;/strong&gt; it. To revoke &lt;strong&gt;USAGE&lt;/strong&gt; means to &lt;strong&gt;DROP USER&lt;/strong&gt;.&lt;/p&gt;
&lt;h4&gt;The missing ROUTINES_PRIVILEGES inconsistency&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; provides with four privileges tables: &lt;strong&gt;USER_PRIVILEGES&lt;/strong&gt;, &lt;strong&gt;SCHEMA_PRIVILEGES&lt;/strong&gt;, &lt;strong&gt;TABLE_PRIVILEGES&lt;/strong&gt;, &lt;strong&gt;COLUMN_PRIVILEGES&lt;/strong&gt;, which map well to &lt;strong&gt;mysql&lt;/strong&gt;&#39;s &lt;strong&gt;user&lt;/strong&gt;, &lt;strong&gt;db&lt;/strong&gt;, &lt;strong&gt;tables_priv&lt;/strong&gt; and &lt;strong&gt;columns_priv&lt;/strong&gt; tables, respectively.&lt;/p&gt;
&lt;p&gt;Ahem, which &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt; table maps to &lt;strong&gt;mysql.procs_priv&lt;/strong&gt;?&lt;/p&gt;</description>
    </item>
    
    <item>
      <title>Checking for AUTO_INCREMENT capacity with single query</title>
      <link>/blog/mysql/checking-for-auto_increment-capacity-with-single-query/</link>
      <pubDate>Tue, 05 Apr 2011 07:36:56 +0000</pubDate>
      
      <guid>/blog/mysql/checking-for-auto_increment-capacity-with-single-query/</guid>
      <description>&lt;p&gt;&lt;em&gt;Darn!&lt;/em&gt; This means &lt;a href=&#34;http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-show-limits.html&#34;&gt;oak-show-limits&lt;/a&gt; becomes redundant. Am I not supposed to speak about it on my &lt;a href=&#34;http://en.oreilly.com/mysql2011/public/schedule/detail/17155&#34;&gt;coming presentation&lt;/a&gt;? Bad timing!&lt;/p&gt;
&lt;p&gt;You have &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; columns. How far are you pushing the limits? Are you going to run out of &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; values soon? Perhaps you wonder whether you should &lt;strong&gt;ALTER&lt;/strong&gt; from &lt;strong&gt;INT&lt;/strong&gt; to &lt;strong&gt;BIGINT&lt;/strong&gt;?&lt;/p&gt;
&lt;p&gt;The answer is all there in &lt;strong&gt;INFORMATION_SCHEMA&lt;/strong&gt;. The &lt;strong&gt;TABLES&lt;/strong&gt; table shows the current &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; value per table, and the &lt;strong&gt;COLUMNS&lt;/strong&gt; table tells us all about a column&#39;s data type.&lt;/p&gt;
&lt;p&gt;It takes some ugly code to deduce the maximum value per column type, what with signed/unsigned and data type, but then its very simple. Here is the query:&lt;!--more--&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;SELECT
  TABLE_SCHEMA,
  TABLE_NAME,
  COLUMN_NAME,
  DATA_TYPE,
  COLUMN_TYPE,
  IF(
    LOCATE(&#39;unsigned&#39;, COLUMN_TYPE) &amp;gt; 0,
    1,
    0
  ) AS IS_UNSIGNED,
  (
    CASE DATA_TYPE
      WHEN &#39;tinyint&#39; THEN 255
      WHEN &#39;smallint&#39; THEN 65535
      WHEN &#39;mediumint&#39; THEN 16777215
      WHEN &#39;int&#39; THEN 4294967295
      WHEN &#39;bigint&#39; THEN 18446744073709551615
    END &amp;gt;&amp;gt; IF(LOCATE(&#39;unsigned&#39;, COLUMN_TYPE) &amp;gt; 0, 0, 1)
  ) AS MAX_VALUE,
  AUTO_INCREMENT,
  AUTO_INCREMENT / (
    CASE DATA_TYPE
      WHEN &#39;tinyint&#39; THEN 255
      WHEN &#39;smallint&#39; THEN 65535
      WHEN &#39;mediumint&#39; THEN 16777215
      WHEN &#39;int&#39; THEN 4294967295
      WHEN &#39;bigint&#39; THEN 18446744073709551615
    END &amp;gt;&amp;gt; IF(LOCATE(&#39;unsigned&#39;, COLUMN_TYPE) &amp;gt; 0, 0, 1)
  ) AS AUTO_INCREMENT_RATIO
FROM
  INFORMATION_SCHEMA.COLUMNS
  INNER JOIN INFORMATION_SCHEMA.TABLES USING (TABLE_SCHEMA, TABLE_NAME)
WHERE
  TABLE_SCHEMA NOT IN (&#39;mysql&#39;, &#39;INFORMATION_SCHEMA&#39;, &#39;performance_schema&#39;)
  AND EXTRA=&#39;auto_increment&#39;
;
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;p&gt;There&#39;s one row in the result set for each &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; column. since at most one &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; column can exist for any given table, each row also identifies a unique table. Resulting columns are mostly self-explanatory, but here&#39;s some details on some of the columns:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;IS_UNSIGNED&lt;/strong&gt;: &lt;strong&gt;1&lt;/strong&gt; when the column is &lt;strong&gt;UNSIGNED&lt;/strong&gt;, &lt;strong&gt;0&lt;/strong&gt; otherwise.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;MAX_VALUE&lt;/strong&gt;: maximum value that can be contained within column.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt;: current &lt;strong&gt;AUTO_INCREMENT&lt;/strong&gt; value for table.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;AUTO_INCREMENT_RATIO&lt;/strong&gt;: value in the range &lt;strong&gt;[0..1]&lt;/strong&gt;, where &lt;strong&gt;1&lt;/strong&gt; means &#34;100% full&#34;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;A sample output:&lt;/p&gt;
&lt;blockquote&gt;
&lt;pre&gt;+--------------+------------+--------------+-----------+-----------------------+-------------+------------+----------------+----------------------+
| TABLE_SCHEMA | TABLE_NAME | COLUMN_NAME  | DATA_TYPE | COLUMN_TYPE           | IS_UNSIGNED | MAX_VALUE  | AUTO_INCREMENT | AUTO_INCREMENT_RATIO |
+--------------+------------+--------------+-----------+-----------------------+-------------+------------+----------------+----------------------+
| sakila       | actor      | actor_id     | smallint  | smallint(5) unsigned  |           1 |      65535 |            201 |               0.0031 |
| sakila       | address    | address_id   | smallint  | smallint(5) unsigned  |           1 |      65535 |            606 |               0.0092 |
| sakila       | category   | category_id  | tinyint   | tinyint(3) unsigned   |           1 |        255 |             17 |               0.0667 |
| sakila       | city       | city_id      | smallint  | smallint(5) unsigned  |           1 |      65535 |            601 |               0.0092 |
| sakila       | country    | country_id   | smallint  | smallint(5) unsigned  |           1 |      65535 |            110 |               0.0017 |
| sakila       | customer   | customer_id  | smallint  | smallint(5) unsigned  |           1 |      65535 |            600 |               0.0092 |
| sakila       | film       | film_id      | smallint  | smallint(5) unsigned  |           1 |      65535 |           1001 |               0.0153 |
| sakila       | inventory  | inventory_id | mediumint | mediumint(8) unsigned |           1 |   16777215 |           4582 |               0.0003 |
| sakila       | language   | language_id  | tinyint   | tinyint(3) unsigned   |           1 |        255 |              7 |               0.0275 |
| sakila       | payment    | payment_id   | smallint  | smallint(5) unsigned  |           1 |      65535 |          16050 |               0.2449 |
| sakila       | rental     | rental_id    | int       | int(11)               |           0 | 2147483647 |          16050 |               0.0000 |
| sakila       | staff      | staff_id     | tinyint   | tinyint(3) unsigned   |           1 |        255 |              3 |               0.0118 |
| sakila       | store      | store_id     | tinyint   | tinyint(3) unsigned   |           1 |        255 |              3 |               0.0118 |
+--------------+------------+--------------+-----------+-----------------------+-------------+------------+----------------+----------------------+
&lt;/pre&gt;
&lt;/blockquote&gt;
&lt;h4&gt;Bonus: free advice on increasing your AUTO_INCREMENT capacity&lt;/h4&gt;
&lt;p&gt;Make it &lt;strong&gt;UNSIGNED&lt;/strong&gt;. No, really. Check your definitions now.&lt;/p&gt;</description>
    </item>
    
  </channel>
</rss>
<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>&#34;Anemomaster&#34;: DML visibility. Your must-do for tomorrow &middot; code.openark.org</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/blogimg/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <a class="pure-menu-heading brand" href="/blog">openark.org</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/page/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a class="pure-menu-link">
        Shlomi Noach
        
          <div class="avatar-container">
        	  <div class="avatar-img-border">
                <img class="avatar-img" src="/blog/images/shlomi-noach.png" alt="code.openark.org" />
        	  </div>
        	</div>
        
      </a>
    </li>

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/shlomi-noach" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ShlomiNoach" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/shlominoach" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>





  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">

<div class="header-post">
  <div>code.openark.org</div>
</div>

<div class="header">
  <h1>&#34;Anemomaster&#34;: DML visibility. Your must-do for tomorrow</h1>
  <h2></h2>
</div>
<div class="content">

  <div class="post-meta">

  <div>

    <time>18 Apr 2014</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/anemometer">Anemometer</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/devops">DevOps</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/monitoring">Monitoring</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/replication">Replication</a>
          
        </span>
      
    
  </div>

</div>


  <p>Here's our take of master DML query monitoring at <a href="http://www.outbrain.com/">Outbrain</a> (<a href="https://www.percona.com/live/mysql-conference-2014/sessions/mysql-devops-outbrain">presented April 2014</a>). It took a half-day to code, implement, automate and deploy, and within the first hour of work we managed to catch multiple ill-doing services and scripts. You might want to try this out for yourself.</p>
<h4>What's this about?</h4>
<p>What queries do you monitor on your MySQL servers? Many don't monitor queries at all, and only look up slow queries on occasion, using <a href="http://www.percona.com/doc/percona-toolkit/2.2/pt-query-digest.html">pt-query-digest</a>. Some monitor slow queries, where <a href="https://github.com/box/Anemometer/wiki">Anemometer</a> (relying on pt-query-digest) is a very good tool. To the extreme, some monitor TCP traffic on all MySQL servers -- good for you! In between, there's a particular type of queries that are of special interest: DML (<strong>INSERT/UPDATE/DELETE</strong>) queries issued against the master.</p>
<p>They are of particular interest because they are only issued once against the master, yet propagate through replication topology to execute on all slaves. These queries have a direct impact on your slave lag and on your overall replication capacity. I suggest you should be familiar with your DMLs just as you are with your slow queries.</p>
<p>In particular, we had multiple occasions in the past where all or most slaves started lagging. Frantically we would go to our metrics; yes! We would see a spike in <strong>com_insert</strong>. Someone (some service) was obviously generating more <strong>INSERT</strong>s than usual, at a high rate that the slaves could not keep up with. But, <em>which</em> <strong>INSERT</strong> was that? Blindly, we would look at the binary logs. Well, erm, what are we looking for, exactly?</p>
<p>Two such occasions convinced us that there should be a solution, but it took some time till it hit us. We were already using <em>Anemometer</em> for monitoring our slow logs. We can do the same for monitoring our binary logs. Thus was born <em>"Anemomaster"</em>.</p>
<p>Quick recap on how Anemometer works: you issue <em>pt-query-digest</em> on your slow logs on all MySQL hosts (we actually first ship the slow logs to a central place where we analyse them; same thing). This is done periodically, and slow logs are then rotated. You throw the output of <em>pt-query-digest</em> to a central database (this is built in with <em>pt-query-digest</em>; it doesn't necessarily produce human readable reports). <em>Anemometer</em> would read this central database and visualize the slow queries.</p>
<h4>Analysing DMLs</h4>
<p>But then, <em>pt-query-digest</em> doesn't only parse slow logs. It can parse binary logs. Instead of asking for total query time, we ask for query count, and on we go to establish the same mechanism, using same <em>pt-query-digest</em> and same <em>Anemometer</em> to store and visualize the DMLs issued on our masters.</p>
<p>When analysing DMLs we're interested in parsing binary logs -- and it makes no sense to do the same on all slaves. All slaves just have same copy of binlog entries as the master produces. It only takes <em>one</em> server to get an accurate picture of the DMLs on your replication topology.</p>
<p><!--more--></p>
<p>One server could be the master, and this can indeed be done: just <strong>FLUSH MASTER LOGS</strong>, parse the binary logs with <em>pt-query-digest</em>, and you're done. But like others, we tend to look at our masters as tender babies. We care for them, and do not wish to overload them unnecessarily. We chose to get the binlog entries from our slaves, instead. We also chose to get the entries from the relay logs, since these are unaffected by slave performance and as long as network is good, we can expect the relay logs to be <em>very</em> up to date. At any given time we have two slaves that take this role (this is automated and verified). On a <strong>10</strong> minute period we would flush the relay logs on these servers, and analyse whatever relay logs we have not analysed as yet.</p>
<p>The script below is a slightly modified version of our own, and should work for the standard installation. Modify to fit your own data (in particular, it assumes relay logs are named <strong>mysqld-relay-bin</strong>; <strong>datadir</strong> is specified in <strong>/etc/my.cnf</strong>, and please don't ask me how to do this on Windows):</p>
<blockquote><pre>
#!/bin/bash
#
# Digest latest relay logs file, write results to &quot;anemomaster&quot;
#
# This script can run from any machine; it only needs to execute on a single machine per mysql cluster, but for
# analysis availability it should execute on at least two hosts per cluster.
#
DATADIR=`grep datadir /etc/my.cnf|awk -F= '{print $2}'`
TMPDIR=/tmp
DIGESTED_RELAY_LOGS_FILE=${DATADIR}/digested_relay_logs.txt
touch $DIGESTED_RELAY_LOGS_FILE
chown mysql:mysql $DIGESTED_RELAY_LOGS_FILE
hostname=$(hostname)
echo &quot;deleting old relay logs from ${TMPDIR}&quot;
rm ${TMPDIR}/mysqld-relay-bin.[0-9]*
echo &quot;Getting current relay log files&quot;
existing_relay_log_files=$(ls -tr ${DATADIR}/mysqld-relay-bin.[0-9]* | head -n -1)
for existing_relay_log_file in $existing_relay_log_files
do
    cp -u $existing_relay_log_file $TMPDIR
done
echo &quot;flushing relay logs&quot;
/usr/bin/mysql -umyself -psecret -e 'flush relay logs\G;' 2&gt;/dev/null
# sleep because the log file takes some time to disappear
sleep 1
echo &quot;Getting current relay log files&quot;
existing_relay_log_files=$(ls -tr ${DATADIR}/mysqld-relay-bin.[0-9]* | head -n -1)
for existing_relay_log_file in $existing_relay_log_files
do
    cp -u $existing_relay_log_file $TMPDIR
done
cd $TMPDIR
for relay_log_file in mysqld-relay-bin.[0-9]*
do
    # Filter this relay log file, since it's already been digested
    grep $relay_log_file $DIGESTED_RELAY_LOGS_FILE &amp;&amp; rm $relay_log_file
done
for relay_log_file in mysqld-relay-bin.[0-9]*
do
    echo &quot;digesting $relay_log_file&quot;
    mysqlbinlog $relay_log_file | /usr/bin/pt-query-digest \
      --type binlog --order-by Query_time:cnt --group-by fingerprint --limit 100 \
      --review  P=3306,u=anemomaster,p=secret,h=anemomaster_host,D=anemomaster,t=global_query_review \
      --history P=3306,u=anemomaster,p=secret,h=anemomaster_host,D=anemomaster,t=global_query_review_history \
      --filter=&quot; \$event-&gt;{Bytes} = length(\$event-&gt;{arg}) and \$event-&gt;{hostname}=\&quot;$(hostname)\&quot; &quot; \
      --no-report
    echo &quot;$relay_log_file&quot; &gt;&gt; $DIGESTED_RELAY_LOGS_FILE
    rm $relay_log_file
done
# make sure the file does not bloat. 20 entries is more than enough.
tail -n 20 $DIGESTED_RELAY_LOGS_FILE &gt; ${TMPDIR}/DIGESTED_RELAY_LOGS_FILE
cat ${TMPDIR}/DIGESTED_RELAY_LOGS_FILE &gt; $DIGESTED_RELAY_LOGS_FILE
echo &quot;done&quot;
</pre></blockquote>
<p>As for Anemometer, we patched it to support multiple environments ("clusters") -- but irrelevant to the DML change. If you just want to make it visualize DMLs, here's the major configuration changes to <strong>config.inc.php</strong> (marked with <strong>bold</strong>):</p>
<blockquote><pre>
$conf['history_defaults'] = array(
	'output'		=&gt; 'table',
	'fact-group'	=&gt; 'date',
	'fact-order'	=&gt; 'date DESC',
	'fact-limit' =&gt; '90',
	'dimension-ts_min_start' =&gt; date(&quot;Y-m-d H:i:s&quot;, strtotime( '-90 day')),
	'dimension-ts_min_end'	=&gt; date(&quot;Y-m-d H:i:s&quot;),
	'table_fields' =&gt; array('date', 'query_time_avg','ts_cnt','Query_time_sum')
);
$conf['report_defaults'] = array(
	'fact-group'	=&gt; 'checksum',
	'fact-order'	=&gt; 'ts_cnt DESC',
	'fact-limit' =&gt; '20',
	'dimension-ts_min_start' =&gt; date(&quot;Y-m-d H:i:s&quot;, strtotime( '-1 day')),
	'dimension-ts_min_end'	=&gt; date(&quot;Y-m-d H:i:s&quot;),
	'table_fields' =&gt; array('checksum','snippet', 'query_time_avg','ts_cnt','Query_time_sum'),
	'dimension-pivot-hostname_max' =&gt; null,
	'dimension-pivot-clustername_max' =&gt; null
);
$conf['graph_defaults'] = array(
	'fact-group'	=&gt; 'minute_ts',
	'fact-order'	=&gt; 'minute_ts',
	'fact-limit' =&gt; '',
	'dimension-ts_min_start' =&gt; date(&quot;Y-m-d H:i:s&quot;, strtotime( '-7 day')),
	'dimension-ts_min_end'	=&gt; date(&quot;Y-m-d H:i:s&quot;),
	'table_fields' =&gt; array('minute_ts'),
	// hack ... fix is to make query builder select the group and order fields,
	// then table fields only has to contain the plot_field
	'plot_field' =&gt; 'ts_cnt',
);
</pre></blockquote>
<p>With a <strong>10</strong> minute rotation &amp; digestion, we are able to analyze near real-time what's been done on our masters. If we see a spike in <strong>com_insert/com_update/com_delete</strong>, or just see slave lags, we turn to <em>Anemomaster </em>and within a couple minutes know exactly what service is guilty of abusing our database. We are also working to protect our database against abuse, but that's for another discussion.</p>

  
<div class="prev-next-post pure-g">
  <div class="pure-u-1-24" style="text-align: left;">
    
    <a href="/blog/mysql/some-anecdotes-i-learned-at-percona-live/"><i class="fa fa-chevron-left"></i></a>
    
  </div>
  <div class="pure-u-10-24">
    
    <nav class="prev">
      <a href="/blog/mysql/some-anecdotes-i-learned-at-percona-live/">Some anecdotes I learned at Percona Live</a>
    </nav>
    
  </div>
  <div class="pure-u-2-24">
    &nbsp;
  </div>
  <div class="pure-u-10-24">
    
    <nav class="next">
      <a href="/blog/mysql/monitoring-dmlslow-queries-with-graphite/">Monitoring DML/slow queries with graphite</a>
    </nav>
    
  </div>
  <div class="pure-u-1-24" style="text-align: right;">
    
    <a href="/blog/mysql/monitoring-dmlslow-queries-with-graphite/"><i class="fa fa-chevron-right"></i></a>
    
  </div>
</div>



  
<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    if (window.location.hostname == "localhost")
        return;

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'Your Disqus shortname';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</div>

</div>
</div>
<script src="/blog/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Your Google Analytics tracking ID', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>


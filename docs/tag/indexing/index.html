<!DOCTYPE html>
<html lang="en">

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="generator" content="Hugo 0.16" />

  <title>Indexing &middot; code.openark.org</title>

  
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->

  <!--[if lte IE 8]>
  <link rel="stylesheet" href="/css/side-menu-old-ie.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
  <link rel="stylesheet" href="/blog/css/side-menu.css">
  <!--<![endif]-->

  <link rel="stylesheet" href="/blog/css/blackburn.css">

  
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

  
  <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type="text/css">

  
  
  <link rel="alternate" type="application/rss+xml" title="code.openark.org" href="/blog/tag/indexing/index.xml" />
  

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/androidstudio.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  

  <link rel="shortcut icon" href="/blogimg/favicon.ico" type="image/x-icon" />

  
  

</head>


<body>
<div id="layout">

  
<a href="#menu" id="menuLink" class="menu-link">
  
  <span></span>
</a>
<div id="menu">

  

  <a class="pure-menu-heading brand" href="/blog">openark.org</a>


  <div class="pure-menu">
    <ul class="pure-menu-list">
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/"><i class='fa fa-home fa-fw'></i>Home</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/post/"><i class='fa fa-list fa-fw'></i>Posts</a>
      
        </li>
      
      
        <li class="pure-menu-item">
          <a class="pure-menu-link" href="/blog/page/about"><i class='fa fa-user fa-fw'></i>About</a>
      
        </li>
      
      
      <li class="pure-menu-item">
        <a class="pure-menu-link" href="/blog/tag/indexing/index.xml"><i class="fa fa-rss fa-fw"></i>RSS</a>
      </li>
      
    </ul>
  </div>

  <div class="pure-menu social">
  <ul class="pure-menu-list">
    <li class="pure-menu-item">
      <a class="pure-menu-link">
        Shlomi Noach
        
          <div class="avatar-container">
        	  <div class="avatar-img-border">
                <img class="avatar-img" src="/blog/images/shlomi-noach.png" alt="code.openark.org" />
        	  </div>
        	</div>
        
      </a>
    </li>

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://github.com/shlomi-noach" target="_blank"><i class="fa fa-github-square fa-fw"></i>GitHub</a>
    </li>
    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://twitter.com/ShlomiNoach" target="_blank"><i class="fa fa-twitter-square fa-fw"></i>Twitter</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    <li class="pure-menu-item">
      <a class="pure-menu-link" href="https://linkedin.com/in/shlominoach" target="_blank"><i class="fa fa-linkedin-square fa-fw"></i>LinkedIn</a>
    </li>
    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

  </ul>
</div>





  <div>
  <div class="small-print">
    <small>&copy; 2016. All rights reserved.</small>
  </div>
  <div class="small-print">
    <small>Built with&nbsp;<a href="https://gohugo.io/" target="_blank">Hugo</a></small>
    <small>Theme&nbsp;<a href="https://github.com/yoshiharuyamashita/blackburn" target="_blank">Blackburn</a></small>
  </div>
</div>

</div>


  <div id="main">


<div class="header">
  <h1>Indexing</h1>
</div>

<div class="content">
  
    <article>
  <header>
    <h2><a href="/blog/mysql/purging-old-rows-with-queryscript-three-use-cases/">Purging old rows with QueryScript: three use cases</a></h2>

    <div class="post-meta">

  <div>

    <time>14 Nov 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/bulk-operations">Bulk operations</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Problem: you need to purge old rows from a table. This may be your weekly/monthly cleanup task. The table is large, the amount of rows to be deleted is large, and doing so in one big <strong>DELETE</strong> is too heavy.</p>
<p>You can use <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> or <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archiver</a> to accomplish the task. You can also use server side scripting with <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a>, offering a very simple syntax with no external scripting, dependencies and command line options.</p>
<p>I wish to present three cases of row deletion, with three different solutions. In all cases we assume some <strong>TIMESTAMP</strong> column exists in table, by which we choose to purge the row. In all cases we assume we wish to purge rows older than <strong>1</strong> month.</p>
<p>We assume the naive query is this:</p>
<blockquote>
<pre>DELETE FROM my_schema.my_table WHERE row_timestamp &lt; CURDATE() - INTERVAL 1 MONTH</pre>
</blockquote>
<h4>Case 1: TIMESTAMP column is indexed</h4>
<p>I almost always index a timestamp column, if only for being able to quickly purge data (but usually also to slice data by date). In this case where the column is indexed, it&rsquo;s very easy to figure out which rows are older than <strong>1</strong> month.</p>
<p>We break the naive query into smaller parts, and execute these in sequence:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/purging-old-rows-with-queryscript-three-use-cases/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/how-common_schema-splits-tables-internals/">How common_schema split()s tables - internals</a></h2>

    <div class="post-meta">

  <div>

    <time>06 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>This post exposes some of the internals, and the SQL behind QueryScript&rsquo;s <em>split</em>. <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema/QueryScript</a> <strong>1.1</strong> introduces the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> statement, which auto-breaks a &ldquo;large&rdquo; query (one which operates on large tables as a whole or without keys) into smaller queries, and executes them in sequence.</p>
<p>This makes for easier transactions, less locks held, potentially (depending on the user) more idle time released back to the database. <em>split<strong></strong></em> has similar concepts to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> and <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archiver</a>, but works differently, and implemented entirely in SQL on server side.</p>
<p>Take the following statement as example:</p>
<blockquote>
<pre><strong>split</strong> (<strong>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR</strong>)
  pass;</pre>
</blockquote>
<p>It yields with (roughly) the following statements:</p>
<blockquote>
<pre>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;1&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;1&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;1000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;1000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;1000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;2000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;2000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;2000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;3000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;3000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;3000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;4000&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;4000&rsquo;))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((<code>inventory</code>.<code>inventory_id</code> &gt; &lsquo;4000&rsquo;))) AND (((<code>inventory</code>.<code>inventory_id</code> &lt; &lsquo;4581&rsquo;)) OR ((<code>inventory</code>.<code>inventory_id</code> = &lsquo;4581&rsquo;))));</pre>
</blockquote>
<p>(I say &ldquo;roughly&rdquo; because internally there are user defined variables at play, but for convenience, I verbose the actual values as constants.)</p>
<h4>How does that work?</h4>
<p><em>common_schema</em> works on server side. There is no Perl script or anything. It must therefore use server-side operations to:</p>
<ul>
<li>Identify table to be split</li>
<li>Analyze the table in the first place, deciding how to split it</li>
<li>Analyze the query, deciding on how to rewrite it</li>
<li>Split the table (logically) into unique and distinct chunks</li>
<li>Work out the query on each such chunk</li>
</ul>
<p>Following is an internal look at how <em>common_schema</em> does all the above.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/how-common_schema-splits-tables-internals/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/table-split-for-the-masses/">Table split(...) for the masses</a></h2>

    <div class="post-meta">

  <div>

    <time>05 Sep 2012</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/queryscript">QueryScript</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/scripts">scripts</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>(pun intended)</p>
<p><em>common_schema</em>&rsquo;s new <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> statement (see <a href="http://code.openark.org/blog/mysql/common_schema-1-1-released-split-try-catch-killall-profiling">release announcement</a>) auto-splits complex queries over large tables into smaller ones: instead of issuing one huge query, <em>split</em> breaks one&rsquo;s query into smaller queries, each working on a different set of rows (a chunk).</p>
<p>Thus, it is possible to avoid holding locks for long times, allowing for smaller transactions. It also makes for breathing space for the RDBMS, at times boosting operation speed, and at times prolonging operation speed at will.</p>
<p>In this post I show how <em>split</em> exposes itself to the user, should the user wish so.</p>
<p><em>split</em> can manage queries of the following forms:</p>
<ul>
<li>DELETE FROM table_name [WHERE]&hellip;</li>
<li>DELETE FROM table_name USING &lt;multi table syntax&gt; [WHERE]&hellip;</li>
<li>UPDATE table_name SET &hellip; [WHERE]&hellip;</li>
<li>UPDATE &lt;multiple tables&gt; SET &hellip; [WHERE]&hellip;</li>
<li>INSERT INTO some_table SELECT &hellip; FROM &lt;single or multiple tables&gt; [WHERE]&hellip;</li>
<li>REPLACE INTO some_table SELECT &hellip; FROM &lt;single or multiple tables&gt; [WHERE]&hellip;</li>
<li>SELECT &hellip; FROM &lt;multiple tables&gt; [WHERE]&hellip;</li>
</ul>
<p>The latter being a non-obvious one at first sight.</p>
<h4>Basically, it&rsquo; automatic</h4>
<p>You just say:</p>
<blockquote>
<pre><strong>split</strong> (UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR)
  throttle 2;</pre>
</blockquote>
<p>And <em>split</em> identifies <strong>sakila.inventory</strong> as the table which needs to be split, and injects appropriate conditions so as to work on a subset of the rows, in multiple steps.</p>
<p>By the way, here&rsquo;s <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_execution.html">how to execute a QueryScript code</a> like the above.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/table-split-for-the-masses/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/common_schema-rev-68-eval-processlist_grantees-candidate_keys-easter_day/">common_schema rev. 68: eval(), processlist_grantees, candidate_keys, easter_day()</a></h2>

    <div class="post-meta">

  <div>

    <time>06 Sep 2011</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/security">Security</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Revision <strong>68</strong> of <a rel="nofollow" href="http://code.google.com/p/common-schema/">common_schema</a> is out, and includes some interesting features:</p>
<ul>
<li><strong>eval()</strong>: Evaluates the queries generated by a given query</li>
<li><strong>match_grantee()</strong>: Match an existing account based on user+host</li>
<li><strong>processlist_grantees</strong>: Assigning of GRANTEEs for connected processes</li>
<li><strong>candidate_keys</strong>: Listing of prioritized candidate keys: keys which are UNIQUE, by order of best-use.</li>
<li><strong>easter_day()</strong>: Returns DATE of easter day in given DATETIME&rsquo;s year.</li>
</ul>
<p>Let&rsquo;s take a slightly closer look at these:</p>
<h4>eval()</h4>
<p>I&rsquo;ve dedicated this blog post on <a href="http://code.openark.org/blog/mysql/mysql-eval">MySQL eval()</a> to describe it. In simple summary: <strong>eval()</strong> takes a query which generates queries (most common use queries on <strong>INFORMATION_SCHEMA</strong>) and auto-evaluates (executes) those queries. <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/general_procedures.html#eval">Read more</a></p>
<h4>match_grantee()</h4>
<p>As presented in <a title="Link to Finding CURRENT_USER for any user" rel="bookmark" href="http://code.openark.org/blog/mysql/finding-current_user-for-any-user">Finding CURRENT_USER for any user</a>, I&rsquo;ve developed the algorithm to match a connected user+host details (as presented with <strong>PROCESSLIST</strong>) with the grantee tables (i.e. the <strong>mysql.user</strong> table), in a manner which simulates the MySQL server account matching algorithm.</p>
<p>This is now available as a stored function: given a user+host, the function returns with the best matched grantee. <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/privileges_functions.html#match_grantee">Read more</a></p>
<h4>processlist_grantees</h4>
<p>This view relies on the above, and maps the entire <strong>PROCESSLIST</strong> onto GRANTEEs. The view maps each process onto the GRANTEE (MySQL account) which is the owner of that process. Surprisingly, MySQL does not provide one with such information.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/common_schema-rev-68-eval-processlist_grantees-candidate_keys-easter_day/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/announcing-common_schema-common-views-routines-for-mysql/">Announcing common_schema: common views &amp; routines for MySQL</a></h2>

    <div class="post-meta">

  <div>

    <time>13 Jul 2011</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/analysis">Analysis</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/common_schema">common_schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/data-types">Data Types</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/monitoring">Monitoring</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/schema">Schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/security">Security</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/stored-routines">Stored routines</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Today I have released <a title="common_schema" href="http://code.openark.org/forge/common_schema">common_schema</a>, a utility schema for MySQL which includes many views and functions, and is aimed to be installed on any MySQL server.</p>
<h4>What does it do?</h4>
<p>There are views answering for all sorts of useful information: stuff related to schema analysis, data dimensions, monitoring, processes &amp; transactions, security, internals&hellip; There are basic functions answering for common needs.</p>
<p>Some of the views/routines simply formalize those queries we tend to write over and over again. Others take the place of external tools, answering complex questions via SQL and metadata. Still others help out with SQL generation.</p>
<p>Here are a few highlights:</p>
<ul>
<li>Did you know you can work out <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/global_status_diff_nonzero.html">simple monitoring</a> of your server with a <em>query</em>?  There&rsquo;s a view to do that for you.</li>
<li>How about showing just <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/processlist_top.html">the good parts of the processlist</a>?</li>
<li>Does your schema have <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/redundant_keys.html">redundant keys</a>?</li>
<li>Or InnoDB tables with <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/no_pk_innodb_tables.html">no PRIMARY KEY</a>?</li>
<li>Is AUTO_INCREMENT <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/auto_increment_columns.html">running out of space</a>?</li>
<li>Can I get the SQL statements to <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_foreign_keys.html">generate my FOREIGN KEYs</a>? To drop them?</li>
<li>And can we finally get <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_show_grants.html">SHOW GRANTS for all accounts</a>, and as an <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_grants.html">SQL query</a>?</li>
<li>Ever needed a <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/general_functions.html#crc64">64 bit CRC function</a>?</li>
<li>And aren&rsquo;t you tired of writing the cumbersome SUBSTRING_INDEX(SUBSTRING_INDEX(str, &lsquo;,&rsquo;, 3), &lsquo;,&rsquo;, -1)? <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/string_functions.html#split_token">There&rsquo;s an alternative</a>.</li>
</ul>
<p>There&rsquo;s more. Take a look at the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/introduction.html">common_schema documentation</a> for full listing. And it&rsquo;s evolving: I&rsquo;ve got quite a few ideas already for future components.</p>
<p>Some of these views rely on heavyweight INFORMATION_SCHEMA tables. You should be aware of the impact and <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/risks.html">risks</a>.</p>
<h4>What do I need to install?</h4>
<p>There&rsquo;s no script or executable file. It&rsquo;s just a schema. The distribution in an SQL file which generates <em>common_schema</em>. Much like a dump file.</p>
<h4></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/announcing-common_schema-common-views-routines-for-mysql/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/reasons-to-use-auto_increment-columns-on-innodb/">Reasons to use AUTO_INCREMENT columns on InnoDB</a></h2>

    <div class="post-meta">

  <div>

    <time>22 Mar 2011</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/schema">Schema</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  An InnoDB table must have a primary key (one is created if you don't do it yourself). You may have a natural key at hand. Stop! Allow me to suggest an AUTO_INCREMENT may be better. Why should one add an AUTO_INCREMENT PRIMARY KEY on a table on which there's a natural key? Isn't an AUTO_INCREMENT a pseudo key, meaning, it doesn't have any explicit relation to the row data, other than it is a number and unique?
  </p>

  
  <footer>
    <a href="/blog/mysql/reasons-to-use-auto_increment-columns-on-innodb/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/multi-condition-update-query/">Multi condition UPDATE query</a></h2>

    <div class="post-meta">

  <div>

    <time>27 Jan 2011</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>A simple question I&rsquo;ve been asked:</p>
<p>Is it possible to merge two <strong>UPDATE</strong> queries, each on different <strong>WHERE</strong> conditions, into a single query?</p>
<p>For example, is it possible to merge the following two <strong>UPDATE</strong> statements into one?</p>
<blockquote>
<pre>mysql&gt; <strong>UPDATE</strong> film <strong>SET</strong> rental_duration=rental_duration+1 <strong>WHERE</strong> rating = &lsquo;G&rsquo;;
Query OK, 178 rows affected (0.01 sec)</p>

<p>mysql&gt; <strong>UPDATE</strong> film <strong>SET</strong> rental_rate=rental_rate-0.5 <strong>WHERE</strong> length &lt; 90;
Query OK, 320 rows affected (0.01 sec)
</pre>
</blockquote>
<p>To verify our tests, we take a checksum:</p>
<blockquote>
<pre>mysql&gt; pager md5sum
PAGER set to &lsquo;md5sum&rsquo;
mysql&gt; <strong>SELECT</strong> film_id, title, rental_duration, rental_rate <strong>FROM</strong> film <strong>ORDER BY</strong> film_id;
c2d253c3919efaa6d11487b1fd5061f3  -
</pre>
</blockquote>
<p>Obviously, the following query is <strong>incorrect</strong>:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/multi-condition-update-query/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/simple-guideline-for-choosing-appropriate-innodb-primary-keys/">Simple guideline for choosing appropriate InnoDB PRIMARY KEYs</a></h2>

    <div class="post-meta">

  <div>

    <time>21 Oct 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Risking some flames, I&rsquo;d like to suggest only two options for choosing <strong>PRIMARY KEY</strong>s for InnoDB tables. I suggest they should cover 99% (throwing numbers around) of cases.</p>
<h4>PRIMARY KEY cases</h4>
<ol>
<li>An integer (SMALLINT / INT / BIGINT), possibly <strong>AUTO_INCREMENT</strong> column.</li>
<li>The combination of two columns on a many-to-many connecting table (e.g. <strong>film_actor</strong>, which connects <strong>film</strong>s to <strong>actor</strong>s), the two columns being the <strong>PRIMARY KEY</strong>s of respective data tables. This rule may be extended to 3-way relation tables.</li>
</ol>
<p>A short recap: an InnoDB must have a <strong>PRIMARY KEY</strong>. It will pick one if you don&rsquo;t offer it. It can pick a really bad <strong>UNIQUE KEY</strong> (e.g. <strong>website_url(255)</strong>) or make one up using InnoDB internal row ids. If you don&rsquo;t have a good candidate, an <strong>AUTO_INCREMENT PRIMARY KEY</strong> is probably the easiest way out.</p>
<p>A 2-column combination for a many-to-many connection table is common and viable. The <strong>PRIMARY KEY</strong> will not only provide with good join access method, but will also provide with the required <strong>UNIQUE</strong> constraint.</p>
<p>An integer-based <strong>PRIMARY KEY</strong> will make for more compact &amp; shallow index tree structures, which leads to less I/O and page reads.</p>
<p>An <strong>AUTO_INCREMENT</strong> will allow for ascending <strong>PRIMARY KEY</strong> order of <strong>INSERT</strong>, which is InnoDB-friendly: index pages will be more utilized, less fragmented.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/simple-guideline-for-choosing-appropriate-innodb-primary-keys/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/thoughts-and-ideas-for-online-schema-change/">Thoughts and ideas for Online Schema Change</a></h2>

    <div class="post-meta">

  <div>

    <time>07 Oct 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/open-source">Open Source</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/openark-kit">openark kit</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/opinions">Opinions</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/python">python</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/schema">Schema</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/scripts">scripts</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/triggers">Triggers</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Here&rsquo;s a few thoughts on current status and further possibilities for Facebook&rsquo;s <a href="http://www.facebook.com/note.php?note_id=430801045932">Online Schema Change</a> (OSC) tool. I&rsquo;ve had these thoughts for months now, pondering over improving <a href="../../forge/openark-kit/oak-online-alter-table">oak-online-alter-table</a> but haven&rsquo;t got around to implement them nor even write them down. Better late than never.</p>
<p>The tool has some limitations. Some cannot be lifted, some could. Quoting from the <a href="http://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932">announcement</a> and looking at the code, I add a few comments. I conclude with a general opinion on the tool&rsquo;s abilities.</p>
<h4>&ldquo;The original table must have PK. Otherwise an error is returned.&rdquo;</h4>
<p>This restriction could be lifted: it&rsquo;s enough that the table has a UNIQUE KEY. My original <em>oak-online-alter-table</em> handled that particular case. As far as I see from their code, the Facebook code would work just as well with any unique key.</p>
<p>However, this restriction is of no real interest. As we&rsquo;re mostly interested in InnoDB tables, and since any InnoDB table <em>should have</em> a PRIMARY KEY, we shouldn&rsquo;t care too much.</p>
<h4>&ldquo;No foreign keys should exist. Otherwise an error is returned.&rdquo;</h4>
<p>Tricky stuff. With <em>oak-online-alter-table</em>, changes to the original table were immediately reflected in the <em>ghost</em> table. With InnoDB tables, that meant same transaction. And although I never got to update the text and code, there shouldn&rsquo;t be a reason for not using child-side foreign keys (the child-side is the table on which the FK constraint is defined).</p>
<p>The Facebook patch works differently: it captures changes and writes them to a <strong>delta</strong> table,  to be later (asynchronously) analyzed and make for a <em>replay</em> of actions on the <em>ghost</em> table.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/thoughts-and-ideas-for-online-schema-change/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/how-often-should-you-use-optimize-table-followup/">How often should you use OPTIMIZE TABLE? - followup</a></h2>

    <div class="post-meta">

  <div>

    <time>04 Oct 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/performance">Performance</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>This post follows up on Baron&rsquo;s <a href="http://www.xaprb.com/blog/2010/02/07/how-often-should-you-use-optimize-table/">How often should you use OPTIMIZE TABLE?</a>. I had the opportunity of doing some massive purging of data from large tables, and was interested to see the impact of the <strong>OPTIMIZE</strong> operation on table&rsquo;s indexes. I worked on some production data I was authorized to provide as example.</p>
<h4>The use case</h4>
<p>I&rsquo;ll present a single use case here. The table at hand is a compressed InnoDB table used for logs. I&rsquo;ve rewritten some column names for privacy:</p>
<blockquote>
<pre>mysql&gt; show create table logs \G</p>

<p>Create Table: CREATE TABLE <code>logs</code> (
 <code>id</code> int(11) NOT NULL AUTO_INCREMENT,
 <code>name</code> varchar(20) CHARACTER SET ascii COLLATE ascii_bin NOT NULL,
 <code>ts</code> timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
 <code>origin</code> varchar(64) CHARACTER SET ascii COLLATE ascii_bin NOT NULL,
 <code>message</code> text NOT NULL,
 <code>level</code> tinyint(11) NOT NULL DEFAULT &lsquo;0&rsquo;,
 <code>s</code> char(16) CHARACTER SET ascii COLLATE ascii_bin NOT NULL DEFAULT &ldquo;,
 PRIMARY KEY (<code>id</code>),
 KEY <code>s</code> (<code>s</code>),
 KEY <code>name</code> (<code>name</code>,<code>ts</code>),
 KEY <code>origin</code> (<code>origin</code>,<code>ts</code>)
) ENGINE=InnoDB AUTO_INCREMENT=186878729 DEFAULT CHARSET=utf8 ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8</pre>
</blockquote>
<p>The table had log records starting <strong>2010-08-23</strong> and up till <strong>2010-09-02</strong> noon. Table status:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/how-often-should-you-use-optimize-table-followup/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/table-refactoring-application-version-upgrades-part-ii/">Table refactoring &amp; application version upgrades, Part II</a></h2>

    <div class="post-meta">

  <div>

    <time>12 Aug 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/replication">Replication</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Continuing <a href="http://code.openark.org/blog/mysql/table-refactoring-application-version-upgrades-part-i">Table refactoring &amp; application version upgrades, Part I</a>, we now discuss code &amp; database upgrades which require <strong>DROP</strong> operations. As before, we break apart the upgrade process into sequential steps, each involving either the application or the database, but not both.</p>
<p>As I&rsquo;ll show, DROP operations are significantly simpler than creation operations. Interestingly, it&rsquo;s the same as in life.</p>
<h4>DROP COLUMN</h4>
<p>A column turns to be redundant, unused. Before it is dropped from the database, we must ensure no one is using it anymore. The steps are:</p>
<ol>
<li>App: <strong>V1</strong> -&gt; <strong>V2</strong>. Remove all references to column; make sure no queries use said column.</li>
<li>DB: <strong>V1</strong> -&gt; <strong>V2</strong> (possibly failover from <strong>M1</strong> to <strong>M2</strong>), change is <strong>DROP COLUMN</strong>.</li>
</ol>
<h4>DROP INDEX</h4>
<p>A possibly simpler case here. Why would you drop an index? Is it because you found out you never use it anymore? Then all you have to do is just drop it.</p>
<p>Or perhaps you don&rsquo;t need the functionality the index supports anymore? Then first drop the functionality:</p>
<ol>
<li>(optional) App: <strong>V1</strong> -&gt; <strong>V2</strong>. Discard using functionality which relies on index.</li>
<li>DB: <strong>V1</strong> -&gt; <strong>V2</strong> (possibly failover from <strong>M1</strong> to <strong>M2</strong>), change is <strong>DROP INDEX</strong>. Check out InnoDB Plugin here.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/table-refactoring-application-version-upgrades-part-ii/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/table-refactoring-application-version-upgrades-part-i/">Table refactoring &amp; application version upgrades, Part I</a></h2>

    <div class="post-meta">

  <div>

    <time>10 Aug 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/development">Development</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/replication">Replication</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>A developer&rsquo;s major concern is: <em>How do I do application &amp; database upgrades with minimal downtime? How do I synchronize between a DB&rsquo;s version upgrade and an application&rsquo;s version upgrade?<br />
</em></p>
<p>I will break down the discussion into types of database refactoring operations, and I will limit to single table refactoring. The discussion will try to understand the need for refactoring and will dictate the steps towards a successful upgrade.</p>
<h4>Reader prerequisites</h4>
<p>I will assume MySQL to be the underlying database. To take a major component out of the equation: we may need to deal with very large tables, for which an <strong>ALTER</strong> command may take long hours. I will assume familiarity with Master-Master (Active-Passive) replication, with possible use of <a href="http://mysql-mmm.org/">MMM for MySQL</a>. When I describe &ldquo;Failover from <strong>M1</strong> to <strong>M2</strong>&rdquo;, I mean &ldquo;Make the <strong>ALTER</strong> changes on <strong>M2</strong> (passive), then switch your application from <strong>M1</strong> to <strong>M2</strong> (change of IPs, VIP, etc.), promoting <strong>M2</strong> to active position, then apply same changes on <strong>M1</strong> (now passive) or completely rebuild it&rdquo;.</p>
<p>Phew, a one sentence description of M-M usage&hellip;</p>
<p>I also assume the reader&rsquo;s understanding that a table&rsquo;s schema can be different on master &amp; slave, which is the basis for the &ldquo;use replication for refactoring&rdquo; trick. But it cannot be too different, or, to be precise, the two schemata must both support the ongoing queries for the table.</p>
<p>A full discussion of the above is beyond the scope of this post.</p>
<h4>Types of refactoring needs</h4>
<p>As I limit this discussion to single table refactoring,we can look at major refactoring operations and their impact on application &amp; upgrades. We will discuss ADD/DROP COLUMN, ADD/DROP INDEX, ADD/DROP UNIQUE INDEX, ADD/DROP FOREIGN KEY, ADD/DROP TABLE.</p>
<p>We will assume the database and application are both in Version #1 (<strong>V1</strong>), and need to be upgraded to <strong>V2</strong> or greater.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/table-refactoring-application-version-upgrades-part-i/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/sql-forcing-single-row-tables-integrity/">SQL: forcing single row tables integrity</a></h2>

    <div class="post-meta">

  <div>

    <time>22 Jun 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Single row tables are used in various cases. Such tables can be used for &ldquo;preferences&rdquo; or &ldquo;settings&rdquo;; for managing counters (e.g. summary tables), for general-purpose administration tasks (e.g. heartbeat table) etc.</p>
<p>The problem with single row tables is that, well, they must have s single row. And the question is: <em>how can you force them to have just one row?</em></p>
<h4>The half-baked solution</h4>
<p>The common solution is to create a <strong>PRIMARY KEY</strong> and always use the same value for that key. In addition, using <strong>REPLACE</strong> or <strong>INSERT INTO ON DUPLICATE KEY UPDATE</strong> helps out in updating the row. For example:</p>
<blockquote><pre>
CREATE TABLE heartbeat (
 id int NOT NULL PRIMARY KEY,
 ts datetime NOT NULL
 );
</pre></blockquote>
<p>The above table definition is taken from <a href="http://www.maatkit.org/doc/mk-heartbeat.html">mk-heartbeat</a>. It should be noted that <em>mk-heartbeat</em> in itself does not require that the table has a single row, so it is not the target of this post. I&rsquo;m taking the above table definition as a very simple example.</p>
<p>So, we assume we want this table to have a single row, for whatever reasons we have. We would usually do:</p>
<blockquote><pre>
REPLACE INTO heartbeat (id, ts) VALUES (1, NOW());
</pre></blockquote>
<p>or</p>
<blockquote><pre>
INSERT INTO heartbeat (id, ts) VALUES (1, NOW()) ON DUPLICATE KEY UPDATE ts = NOW();
</pre></blockquote>
<p>Why is the above a <em>&ldquo;half baked solution&rdquo;</em>? Because it is up to the application to make sure it reuses the same <strong>PRIMARY KEY</strong> value. There is nothing in the database to prevent the following:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/sql-forcing-single-row-tables-integrity/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/reducing-locks-by-narrowing-primary-key/">Reducing locks by narrowing primary key</a></h2>

    <div class="post-meta">

  <div>

    <time>04 May 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/performance">Performance</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>In a period of two weeks, I had two cases with the exact same symptoms.</p>
<p>Database users were experiencing low responsiveness. DBAs were seeing locks occurring on seemingly normal tables. In particular, looking at Innotop, it seemed that <strong>INSERT</strong>s were causing the locks.</p>
<p>In both cases, tables were InnoDB. In both cases, there was a <strong>PRIMARY KEY</strong> on the combination of all <strong>5</strong> columns. And in both cases, there was no clear explanation as for why the <strong>PRIMARY KEY</strong> was chosen as such.</p>
<h4>Choosing a proper PRIMARY KEY</h4>
<p>Especially with InnoDB, which uses clustered index structure, the <strong>PRIMARY KEY</strong> is of particular importance. Besides the fact that a bloated <strong>PRIMARY KEY</strong> bloats the entire clustered index and secondary keys (see: <a href="http://code.openark.org/blog/mysql/the-depth-of-an-index-primer">The depth of an index: primer</a>), it is also a source for locks. It&rsquo;s true that any <strong>UNIQUE KEY</strong> can serve as a <strong>PRIMARY KEY</strong>. But not all such keys are good candidates.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/reducing-locks-by-narrowing-primary-key/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/monotonic-functions-sql-and-mysql/">Monotonic functions, SQL and MySQL</a></h2>

    <div class="post-meta">

  <div>

    <time>09 Feb 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/math">Math</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><blockquote>In mathematics, a <strong>monotonic function</strong> (or <strong>monotone function</strong>) is a function which preserves the given order. [<a href="http://en.wikipedia.org/wiki/Monotonic_function">Wikipedia</a>]</blockquote>
<p>To be more precise, a function <em>f</em> is monotonic increasing, if for every <em>x ≤ y</em> it holds that <em>f(x) ≤ f(y)</em>. <em>f</em> is said to be strictly monotonic increasing is for every <em>x &lt; y</em> it holds that <em>f(x) &lt; f(y)</em>.</p>
<p>So, if we follow values in some order, we say that <em>f</em> is monotonic increasing if <em>f</em>&rsquo;s value never decreases (it either increases or stays the same), and we say that <em>f</em> is strictly increasing if <em>f</em>&rsquo;s value is always changes &ldquo;upwards&rdquo;.</p>
<p>Monotonic functions play an important role in SQL. To discuss monotonic functions in SQL we must first determine what the <em>order</em> is, and then, what the <em>function</em> is.</p>
<p>Well, they both change according to our point of view. Let&rsquo;s look at some examples. Take a look at the following table:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/monotonic-functions-sql-and-mysql/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/beware-of-implicit-casting/">Beware of implicit casting</a></h2>

    <div class="post-meta">

  <div>

    <time>02 Feb 2010</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Ever so often a query provides a &ldquo;bad&rdquo; execution plan. Adding a missing index can many times solve the problem. However, not everything can be solved with an index. I wish to highlight the point of having an <em>implicit cast</em>, which negates the use of an index on MySQL.</p>
<p>I see this happening a lot on customers&rsquo; databases, and this begs for a short introduction.</p>
<h4>MySQL doesn&rsquo;t support index functions</h4>
<p>Let&rsquo;s assume the following table:</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/beware-of-implicit-casting/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/useful-temporal-functions-queries/">Useful temporal functions &amp; queries</a></h2>

    <div class="post-meta">

  <div>

    <time>08 Dec 2009</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/data-types">Data Types</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Here&rsquo;s a complication of some common and useful time &amp; date calculations and equations. Some, though very simple, are often misunderstood, leading to inefficient or incorrect implementations.</p>
<p>There are many ways to solve such problems. I&rsquo;ll present my favorites.</p>
<h4>Querying for time difference</h4>
<p>Given two timestamps: <em>ts1</em> (older) and <em>ts2</em> (newer), how much time has passed between them?</p>
<p>One can use <strong>TIMEDIFF()</strong> &amp; <strong>DATEDIFF()</strong>, or compare two <strong>UNIX_TIMESTAMP()</strong> values. My personal favorite is to use <strong>TIMESTAMPDIFF()</strong>. Reason being that I&rsquo;m usually interested in a specific metric, like the number of hours which have passed, or the number of days, disregarding the smaller minute/second resolution. Which allows one to:</p>
<blockquote>
<pre>SELECT TIMESTAMPDIFF(HOUR, ts1, ts2)</pre>
</blockquote>
<p>Take, for example:</p>
<blockquote>
<pre>SELECT TIMESTAMPDIFF(MONTH, &lsquo;2008-10-07 00:00:00&rsquo;, &lsquo;2009-12-06 00:00:00&rsquo;)</pre>
</blockquote>
<p>The function correctly identifies the number of days per month, and provides with <strong>13</strong>, being the truncated number of full months.</p>
<h4>Doing arithmetics</h4>
<p>One can use <strong>TIMESTAMPADD()</strong>, or <strong>DATE_SUB()</strong>, but, again, when dealing with specific resolutions, I find &ldquo;<strong>+ INTERVAL</strong>&rdquo; to be the most convenient:</p>
<blockquote>
<pre>SELECT ts1 + INTERVAL 10 HOUR</pre>
</blockquote>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/useful-temporal-functions-queries/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/sql-finding-a-users-countryregion-based-on-ip/">SQL: finding a user&#39;s country/region based on IP</a></h2>

    <div class="post-meta">

  <div>

    <time>26 May 2009</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/performance">Performance</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I&rsquo;ve encountered the same problem twice for different customers, so I guess it&rsquo;s worth a discussion.</p>
<p>A common task for web applications is to find out the country/region of a user, based on her IP address, as can be detected in the HTTP request. Depending on the country of origin, the website can translate dates for different time zones, can change locale settings, and, perhaps most commonly, show advertisements in her native language.</p>
<p>To start with, there&rsquo;s a table which lists the IP ranges per country/region. Let&rsquo;s assume we&rsquo;re only dealing with IPv4:</p>
<blockquote>
<pre>CREATE TABLE regions_ip_range (
  regions_ip_range_id INT UNSIGNED AUTO_INCREMENT,
  country VARCHAR(64) CHARSET utf8,
  region VARCHAR(64) CHARSET utf8,
  start_ip INT UNSIGNED,
  end_ip INT UNSIGNED,
  …
  PRIMARY KEY(regions_ip_range_id),
  &hellip;
);</pre>
</blockquote>
<p>The table is fixed, and is populated. Now the question arises: how do we query this table, and which indexes should be created?</p>
<h4>The wrong way</h4>
<p>The form I&rsquo;ve encountered is as follows: an index is declared on regions_ip_range:</p>
<blockquote>
<pre>KEY ip_range_idx (start_ip, end_ip)</pre>
</blockquote>
<p>And the query goes like this:</p>
<blockquote>
<pre>SELECT * FROM regions_ip_range
WHERE my_ip BETWEEN start_ip AND end_ip</pre>
</blockquote>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/sql-finding-a-users-countryregion-based-on-ip/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/mysql-not-being-able-to-utilize-a-compound-index/">MySQL not being able to utilize a compound index?</a></h2>

    <div class="post-meta">

  <div>

    <time>07 May 2009</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>I came today upon a very strange issue. It seems like MySQL is unable to utilize a compound index when evaluating a plan for a query with a range condition. I&rsquo;m looking for an explanation. I&rsquo;ll appreciate any insight on this.</p>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/mysql-not-being-able-to-utilize-a-compound-index/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/the-depth-of-an-index-primer/">The depth of an index: primer</a></h2>

    <div class="post-meta">

  <div>

    <time>09 Apr 2009</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/data-types">Data Types</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/myisam">MyISAM</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>InnoDB and MyISAM use B+ and B trees for indexes (InnoDB also has internal hash index).</p>
<p>In both these structures, the depth of the index is an important factor. When looking for an indexed row, a search is made on the index, from root to leaves.</p>
<p>Assuming the index is not in memory, the depth of the index represents the minimal cost (in I/O operation) for an index based lookup. Of course, most of the time we expect large portions of the indexes to be cached in memory. Even so, the depth of the index is an important factor. The deeper the index is, the worse it performs: there are simply more lookups on index nodes.</p>
<p>What affects the depth of an index?</p>
<p>There are quite a few structural issues, but it boils down to two important factors:</p>
<ol>
<li>The number of rows in the table: obviously, more rows leads to larger index, larger indexes grow in depth.</li>
<li>The size of the indexed column(s). An index on an INT column can be expected to be shallower than an index on a CHAR(32) column (on a very small number of rows they may have the same depth, so we&rsquo;ll assume a large number of rows).</li>
</ol>
<p></p>

  </p>

  
  <footer>
    <a href="/blog/mysql/the-depth-of-an-index-primer/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/7-ways-to-convince-mysql-to-use-the-right-index/">7 ways to convince MySQL to use the right index</a></h2>

    <div class="post-meta">

  <div>

    <time>02 Apr 2009</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/books">Books</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/execution-plan">Execution plan</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/syntax">Syntax</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>Sometimes MySQL gets it wrong. It doesn&rsquo;t use the right index.</p>
<p>It happens that MySQL generates a query plan which is really bad (EXPLAIN says it&rsquo;s going to explore some 10,000,000 rows), when another plan (soon to show how was generated) says: &ldquo;Sure, I can do that with 100 rows using a key&rdquo;.</p>
<h4>A true story</h4>
<p>A customer had issues with his database. Queries were taking 15 minutes to complete, and the db in general was not responsive. Looking at the slow query log, I found the criminal query. Allow me to bring you up to speed:</p>
<p>A table is defined like this:</p>
<blockquote>
<pre>CREATE TABLE t (
  id INT UNSIGNED AUTO_INCREMENT,
  type INT UNSIGNED,
  level TINYINT unsigned,
  &hellip;
  PRIMARY KEY(id),
  KEY <code>type</code> (type)
) ENGINE=InnoDB;</pre>
</blockquote>
<p>The offending query was this:</p>
<blockquote>
<pre>SELECT id FROM data
WHERE type=12345 AND level &gt; 3
ORDER BY id</pre>
</blockquote>
<p>The facts were:</p>
<ul>
<li><code>t</code> has about 10,000,000 rows.</li>
<li>The index on <code>type</code> is selective: about 100 rows per value on average.</li>
<li>The query took a long time to complete.</li>
<li>EXPLAIN has shown that MySQL uses the PRIMARY KEY, hence searches 10,000,000 rows, filtered &ldquo;using where&rdquo;.</li>
<li>The <em>other</em> EXPLAIN has shown that by using the <code>type</code> key, only 110 rows are expected, to be filtered &ldquo;using where&rdquo;, then sorted &ldquo;using filesort&rdquo;</li>
</ul>
<p>So MySQL acknowledged it was generating the wrong plan. The <em>other</em> plan was better by its own standards.</p>
<h4>Solving the problem</h4>
<p>Let&rsquo;s walk through 7 ways to solve the problem, starting with the more aggressive solutions, refining to achieve desired behavior through subtle changes.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/7-ways-to-convince-mysql-to-use-the-right-index/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/useful-database-analysis-queries-with-information_schema/">Useful database analysis queries with INFORMATION_SCHEMA</a></h2>

    <div class="post-meta">

  <div>

    <time>26 Nov 2008</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/analysis">Analysis</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/information_schema">INFORMATION_SCHEMA</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/sql">SQL</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/syntax">Syntax</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>A set of useful queries on INFORMATION_SCHEMA follows. These queries can be used when approaching a new database, to learn about some of its properties, or they can be regularly used on an existing schema, so as to verify its integrity.</p>
<p>I will present queries for:</p>
<ul>
<li>Checking on database engines and size</li>
<li>Locating duplicate and redundant indexes</li>
<li>Checking on character sets for columns and tables, looking for variances</li>
<li>Checking on processes and long queries (only with MySQL 5.1)</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/useful-database-analysis-queries-with-information_schema/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/two-storage-engines-different-plans-part-ii/">Two storage engines; different plans, Part II</a></h2>

    <div class="post-meta">

  <div>

    <time>07 Nov 2008</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/execution-plan">Execution plan</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/myisam">MyISAM</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>In <a title=" Two storage engines; different plans, Part I" href="http://code.openark.org/blog/?p=9">Part I</a> of this article, we have seen how the internal structure of the storage engine&rsquo;s index can affect an execution plan. We&rsquo;ve seen that some plans are inherent to the way engines are implemented.</p>
<p>We wish to present a second scenario in which execution plans vary for different storage engines. Again, we will consider MyISAM and InnoDB. Again, we will use the world database for testing. This time, we will see how confident the storage engines are in their index search capabilities.</p>
<p>Many newcomers to databases often believe that an index search is always preferable to full table scan. This is not the case. If I were to look for 10 rows in a 1,000,000 rows table, using an indexed column - I could benefit from an index search. However, if I’m looking for 200,000 rows on that table (that’s 20% of the rows) - an index search can actually be much more expensive than a full table scan.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/two-storage-engines-different-plans-part-ii/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
    <article>
  <header>
    <h2><a href="/blog/mysql/two-storage-engines-different-plans-part-i/">Two storage engines; different plans, Part I</a></h2>

    <div class="post-meta">

  <div>

    <time>01 Nov 2008</time>
  </div>

  

  

  <div>
    
      
      
        <span>
          
            <a class="post-taxonomy-category" href="/blog/category/mysql">MySQL</a>
          
        </span>
      
    

    
      
      
        <span>
          <i class="fa fa-tags fa-fw"></i>
          
            <a class="post-taxonomy-tag" href="/blog/tag/execution-plan">Execution plan</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/indexing">Indexing</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/innodb">InnoDB</a>&nbsp;&#47;
          
            <a class="post-taxonomy-tag" href="/blog/tag/myisam">MyISAM</a>
          
        </span>
      
    
  </div>

</div>


  </header>

  <p>
  <p><p>A popping question is: &ldquo;Can an execution plan change for different storage engines?&rdquo;</p>
<p>The answer is &ldquo;Yes&rdquo;. I will present two such cases, where the MySQL optimizer will choose different execution plans, based on our choice of storage engine.</p>
<p>We will consider MyISAM and InnoDB, the two most popular engines. The two differ in many respects, and in particular, the way they implement indexes and statistics: two major players in the optimizer&rsquo;s point of view.</p>

  </p>

  
  <footer>
    <a href="/blog/mysql/two-storage-engines-different-plans-part-i/">Read more<i class="fa fa-angle-double-right fa-fw"></i></a>
  </footer>
  
</article>

  
</div>

</div>
</div>
<script src="/blog/js/ui.js"></script>


<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'Your Google Analytics tracking ID', 'auto');
  ga('send', 'pageview');

</script>



</body>
</html>

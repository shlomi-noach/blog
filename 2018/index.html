<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	

	<title>2018 – code.openark.org</title>
<link rel="dns-prefetch" href="//secure.gravatar.com">
<link rel="dns-prefetch" href="//s.w.org">


<link rel="stylesheet" id="wp-block-library-css" href="https://shlomi-noach.github.io/blog/wp-includes/css/dist/block-library/style.min.css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<link rel="stylesheet" id="wp-polls-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-css.css" media="all">
<style id="wp-polls-inline-css">
.wp-polls .pollbar {
	margin: 1px;
	font-size: 6px;
	line-height: 8px;
	height: 8px;
	background-image: url('https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/images/default/pollbg.gif');
	border: 1px solid #c8c8c8;
}

</style>
<link rel="stylesheet" id="openark-primer-style-css" href="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/style.css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/css/jetpack.css" media="all">
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery-migrate.min.js"></script>



<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<link rel="dns-prefetch" href="//v0.wordpress.com">


<meta property="og:type" content="website">
<meta property="og:title" content="2018 – code.openark.org">
<meta property="og:site_name" content="code.openark.org">
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg">
<meta property="og:locale" content="en_US">


<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(242,101,34,.88);}</style></head>

<body class="archive date hfeed no-sidebar">
<div id="page" class="site">
	<a class="skip-link screen-reader-text" href="#primary">Skip to content</a>

	<header id="masthead" class="site-header">
		<div class="site-branding">
							<p class="site-title"><a href="https://shlomi-noach.github.io/blog/" rel="home">code.openark.org</a></p>
								<p class="site-description">Blog by Shlomi Noach</p>
			
			<nav id="site-navigation" class="main-navigation">
				<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">primary-menu</button>
				<div class="menu-primary-menu-container"><ul id="menu-primary-menu" class="menu"><li id="menu-item-8109" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8109"><a href="https://shlomi-noach.github.io/blog/archives">archives</a></li>
<li id="menu-item-8050" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8050"><a href="https://shlomi-noach.github.io/blog/presentations">presentations</a></li>
<li id="menu-item-8055" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8055"><a href="https://shlomi-noach.github.io/blog/about">about</a></li>
<li id="menu-item-8071" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8071"><a href="https://github.com/shlomi-noach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li>
<li id="menu-item-8074" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8074"><a href="https://www.linkedin.com/in/shlominoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li>
<li id="menu-item-8072" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8072"><a href="https://twitter.com/ShlomiNoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a></li>
<li id="menu-item-8073" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8073"><a href="https://shlomi-noach.github.io/blog/feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-12.832 20c-1.197 0-2.168-.969-2.168-2.165s.971-2.165 2.168-2.165 2.167.969 2.167 2.165-.97 2.165-2.167 2.165zm5.18 0c-.041-4.029-3.314-7.298-7.348-7.339v-3.207c5.814.041 10.518 4.739 10.561 10.546h-3.213zm5.441 0c-.021-7.063-5.736-12.761-12.789-12.792v-3.208c8.83.031 15.98 7.179 16 16h-3.211z"></path></svg></a></li>
</ul></div>			</nav>
		</div>
	</header>

	<main id="primary" class="site-main">

		
			<header class="page-header">
				<h1 class="page-title">Year: 2018</h1>			</header>

			
<article id="post-7854" class="post-7854 post type-post status-publish format-standard hentry category-mysql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-6-other-methods" rel="bookmark">MySQL master discovery methods, part 6: other methods</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-6-other-methods" rel="bookmark"><time class="entry-date published" datetime="2018-05-22T10:39:46+02:00">May 22, 2018</time><time class="updated" datetime="2018-05-22T10:42:32+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This is the sixth in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<h3>Hard coded configuration deployment</h3>
<p>You may use your source/config repo as master service discovery method of sorts.</p>
<p>The master’s identity would be hard coded into your, say, <code>git</code> repo, to be updated and deployed to production upon failover.</p>
<p>This method is simple and I’ve seen it being used by companies, in production. Noteworthy:</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-6-other-methods#more-7854" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 6: other methods”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-6-other-methods#comments">1 Comment<span class="screen-reader-text"> on MySQL master discovery methods, part 6: other methods</span></a></span>	</footer>
</article>

<article id="post-7869" class="post-7869 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-5-service-discovery-proxy" rel="bookmark">MySQL master discovery methods, part 5: Service discovery & Proxy</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-5-service-discovery-proxy" rel="bookmark"><time class="entry-date published" datetime="2018-05-14T10:08:32+02:00">May 14, 2018</time><time class="updated" datetime="2018-05-22T10:45:32+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This is the fifth in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<p>We discuss asynchronous (or semi-synchronous) replication, a classic single-master-multiple-replicas setup. A later post will briefly discuss synchronous replication (Galera/XtraDB Cluster/InnoDB Cluster).</p>
<h3>Master discovery via Service discovery and Proxy</h3>
<p><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-4-proxy-heuristics">Part 4</a> presented with an anti-pattern setup, where a proxy would infer the identify of the master by drawing conclusions from backend server checks. This led to split brains and undesired scenarios. The problem was the loss of context.</p>
<p>We re-introduce a service discovery component (illustrated in <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-3-app-service-discovery">part 3</a>), such that:</p>
<ul>
<li>The app does not own the discovery, and</li>
<li>The proxy behaves in an expected and consistent way.</li>
</ul>
<p>In a failover/service discovery/proxy setup, there is clear ownership of duties:</p>
<ul>
<li>The failover tool own the failover itself and the master identity change notification.</li>
<li>The service discovery component is the source of truth as for the identity of the master of a cluster.</li>
<li>The proxy routes traffic but does not make routing decisions.</li>
<li>The app only ever connects to a single target, but should allow for a brief outage while failover takes place.</li>
</ul>
<p>Depending on the technologies used, we can further achieve:</p>
<ul>
<li>Hard cut for connections to old, demoted master <code>M</code>.</li>
<li>Black/hold off for incoming queries for the duration of failover.</li>
</ul>
<p>We explain the setup using the following assumptions and scenarios:</p>
<ul>
<li>All clients connect to master via <code>cluster1-writer.example.net</code>, which resolves to a proxy box.</li>
<li>We fail over from master <code>M</code> to promoted replica <code>R</code>.</li>
</ul>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-5-service-discovery-proxy#more-7869" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 5: Service discovery & Proxy”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-5-service-discovery-proxy#respond">Leave a Comment<span class="screen-reader-text"> on MySQL master discovery methods, part 5: Service discovery & Proxy</span></a></span>	</footer>
</article>

<article id="post-7867" class="post-7867 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-4-proxy-heuristics" rel="bookmark">MySQL master discovery methods, part 4: Proxy heuristics</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-4-proxy-heuristics" rel="bookmark"><time class="entry-date published" datetime="2018-05-10T08:10:34+02:00">May 10, 2018</time><time class="updated" datetime="2018-05-22T10:43:52+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p><em>Note: the method described here is an anti pattern</em></p>
<p>This is the fourth in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<p>We discuss asynchronous (or semi-synchronous) replication, a classic single-master-multiple-replicas setup. A later post will briefly discuss synchronous replication (Galera/XtraDB Cluster/InnoDB Cluster).</p>
<h3>Master discovery via Proxy Heuristics</h3>
<p>In Proxy Heuristics all clients connect to the master through a proxy. The proxy observes the backend MySQL servers and determines who the master is.</p>
<p><strong>This setup is simple and easy, but is an anti pattern. I recommend against using this method, as explained shortly</strong>.</p>
<p>Clients are all configured to connect to, say, <code>cluster1-writer.proxy.example.net:3306</code>. The proxy will intercept incoming requests either based on hostname or by port. It is aware of all/some MySQL backend servers in that cluster, and will route traffic to the master <code>M</code>.</p>
<p>A simple heuristic that I’ve seen in use is: pick the server that has <code>read_only=0</code>, a very simple check.</p>
<p>Let’s take a look at how this works and what can go wrong.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-4-proxy-heuristics#more-7867" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 4: Proxy heuristics”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-4-proxy-heuristics#respond">Leave a Comment<span class="screen-reader-text"> on MySQL master discovery methods, part 4: Proxy heuristics</span></a></span>	</footer>
</article>

<article id="post-7865" class="post-7865 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-3-app-service-discovery" rel="bookmark">MySQL master discovery methods, part 3: app & service discovery</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-3-app-service-discovery" rel="bookmark"><time class="entry-date published" datetime="2018-05-08T10:02:19+02:00">May 8, 2018</time><time class="updated" datetime="2018-05-22T10:44:07+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This is the third in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<p>We discuss asynchronous (or semi-synchronous) replication, a classic single-master-multiple-replicas setup. A later post will briefly discuss synchronous replication (Galera/XtraDB Cluster/InnoDB Cluster).</p>
<h3>App & service discovery</h3>
<p><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns">Part 1</a> and <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-2-vip-dns">part 2</a> presented solutions where the app remained ingorant of master’s identity. This part takes a complete opposite direction and gives the app ownership on master access.</p>
<p>We introduce a service discovery component. Commonly known are <em>Consul</em>, <em>ZooKeeper</em>, <em>etcd</em>, highly available stores offering key/value (K/V) access, leader election or full blown service discovery & health.</p>
<p>We satisfy ourselves with K/V functionality. A key would be <code>mysql/master/cluster1</code> and a value would be the master’s hostname/port.</p>
<p>It is the app’s responsibility at all times to fetch the identity of the master of a given cluster by querying the service discovery component, thereby opening connections to the indicated master.</p>
<p>The service discovery component is expected to be up at all times and to contain the identity of the master for any given cluster.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-3-app-service-discovery#more-7865" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 3: app & service discovery”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-3-app-service-discovery#respond">Leave a Comment<span class="screen-reader-text"> on MySQL master discovery methods, part 3: app & service discovery</span></a></span>	</footer>
</article>

<article id="post-7863" class="post-7863 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-2-vip-dns" rel="bookmark">MySQL master discovery methods, part 2: VIP & DNS</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-2-vip-dns" rel="bookmark"><time class="entry-date published" datetime="2018-05-07T08:46:22+02:00">May 7, 2018</time><time class="updated" datetime="2018-05-22T10:44:34+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This is the second in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<p>We discuss asynchronous (or semi-synchronous) replication, a classic single-master-multiple-replicas setup. A later post will briefly discuss synchronous replication (Galera/XtraDB Cluster/InnoDB Cluster).</p>
<h3>Master discovery via VIP</h3>
<p>In <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns">part 1</a> we saw that one the main drawbacks of DNS discovery is the time it takes for the apps to connect to the promoted master. This is the result of both DNS deployment time as well as client’s <code>TTL</code>.</p>
<p>A quicker method is offered: use of VIPs (Virtual IPs). As before, apps would connect to <code>cluster1-writer.example.net</code>, <code>cluster2-writer.example.net</code>, etc. However, these would resolve to specific VIPs.</p>
<p>Say <code>cluster1-writer.example.net</code> resolves to <code>10.10.0.1</code>. We let this address float between servers. Each server has its own IP (say <code>10.20.0.XXX</code>) but could also potentially claim the VIP <code>10.10.0.1</code>.</p>
<p>VIPs can be assigned by switches and I will not dwell into the internals, because I’m not a network expert. However, the following holds:</p>
<ul>
<li>Acquiring a VIP is a very quick operation.</li>
<li>Acquiring a VIP must take place on the acquiring host.</li>
<li>A host may be unable to acquire a VIP should another host holds the same VIP.</li>
<li>A VIP can only be assigned within a bounded space: hosts connected to the same switch; hosts in the same Data Center or availability zone.</li>
</ul>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-2-vip-dns#more-7863" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 2: VIP & DNS”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-2-vip-dns#comments">3 Comments<span class="screen-reader-text"> on MySQL master discovery methods, part 2: VIP & DNS</span></a></span>	</footer>
</article>

<article id="post-7861" class="post-7861 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns" rel="bookmark">MySQL master discovery methods, part 1: DNS</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns" rel="bookmark"><time class="entry-date published" datetime="2018-05-03T12:56:46+02:00">May 3, 2018</time><time class="updated" datetime="2018-05-22T10:44:42+02:00">May 22, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This is the first in a series of posts reviewing methods for MySQL master discovery: the means by which an application connects to the master of a replication tree. Moreover, the means by which, upon master failover, it identifies and connects to the newly promoted master.</p>
<p>These posts are not concerned with the manner by which the replication failure detection and recovery take place. I will share <code>orchestrator</code> specific configuration/advice, and point out where cross DC <code>orchestrator/raft</code> setup plays part in discovery itself, but for the most part any recovery tool such as <code>MHA</code>, <code>replication-manager</code>, <code>severalnines</code> or other, is applicable.</p>
<p>We discuss asynchronous (or semi-synchronous) replication, a classic single-master-multiple-replicas setup. A later post will briefly discuss synchronous replication (Galera/XtraDB Cluster/InnoDB Cluster).</p>
<h3>Master discovery via DNS</h3>
<p>In DNS master discovery applications connect to the master via a name that gets resolved to the master’s box. By way of example, apps would target the masters of different clusters by connecting to <code>cluster1-writer.example.net</code>, <code>cluster2-writer.example.net</code>, etc. It is up for the DNS to resolve those names to IPs.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns#more-7861" class="more-link">Continue reading »<span class="screen-reader-text"> “MySQL master discovery methods, part 1: DNS”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/mysql-master-discovery-methods-part-1-dns#respond">Leave a Comment<span class="screen-reader-text"> on MySQL master discovery methods, part 1: DNS</span></a></span>	</footer>
</article>

<article id="post-7848" class="post-7848 post type-post status-publish format-standard hentry category-mysql tag-dbdeployer tag-gh-ost tag-open-source tag-replication tag-testing">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/using-dbdeployer-in-ci-tests" rel="bookmark">Using dbdeployer in CI tests</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/dbdeployer" rel="tag">dbdeployer</a><a href="https://shlomi-noach.github.io/blog/tag/gh-ost" rel="tag">gh-ost</a><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a><a href="https://shlomi-noach.github.io/blog/tag/testing" rel="tag">testing</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/using-dbdeployer-in-ci-tests" rel="bookmark"><time class="entry-date published" datetime="2018-02-20T09:29:58+02:00">February 20, 2018</time><time class="updated" datetime="2020-05-11T08:28:06+02:00">May 11, 2020</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>I was very pleased when Giuseppe Maxia (aka <a href="http://datacharmer.blogspot.co.il/">datacharmer</a>) unveiled <a href="https://github.com/datacharmer/dbdeployer">dbdeployer</a> in his talk at <a href="http://lefred.be/content/pre-fosdem-mysql-day-2018-the-schedule/">pre-FOSDEM MySQL day</a>. The announcement came just at the right time. I wish to briefly describe how we use <code>dbdeployer</code> (work in progress).</p>
<h3>The case for gh-ost</h3>
<p>A user opened <a href="https://github.com/github/gh-ost/issues/538">an issue</a> on <a href="https://github.com/github/gh-ost"><code>gh-ost</code></a>, and the user was using MySQL <code>5.5</code>. <code>gh-ost</code> is being tested on <code>5.7</code> where the problem does not reproduce. A discussion with Gillian Gunson raised the concern of not testing on all versions. Can we run <code>gh-ost</code> tests for all MySQL/Percona/MariaDB versions? Should we? How easy would it be?</p>
<h3>gh-ost tests</h3>
<p><code>gh-ost</code> has three different test types:</p>
<ul>
<li>Unit tests: these are plain <code>golang</code> logic tests which are very easy and quick to run.</li>
<li>Integration tests: the topic of this post, see following. Today these do not run as part of an automated CI testing.</li>
<li>System tests: putting our production tables to the test, continuously migrating our production data on dedicated replicas, verifying checksums are identical and data is intact, <a href="https://githubengineering.com/mysql-testing-automation-at-github/#schema-migrations">read more</a>.</li>
</ul>
<p>Unit tests are already running as part of automated CI (every PR is subjected to those tests). Systems tests are clearly tied to our production servers. What’s the deal with the integration tests? <a href="https://shlomi-noach.github.io/blog/mysql/using-dbdeployer-in-ci-tests#more-7848" class="more-link">Continue reading »<span class="screen-reader-text"> “Using dbdeployer in CI tests”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/using-dbdeployer-in-ci-tests#respond">Leave a Comment<span class="screen-reader-text"> on Using dbdeployer in CI tests</span></a></span>	</footer>
</article>

<article id="post-7833" class="post-7833 post type-post status-publish format-standard hentry category-mysql tag-high-availability tag-open-source tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-3-0-6-faster-crash-detection-recoveries-auto-pseudo-gtid-semi-sync-and-more" rel="bookmark">orchestrator 3.0.6: faster crash detection & recoveries, auto Pseudo-GTID, semi-sync and more</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/high-availability" rel="tag">High availability</a><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-3-0-6-faster-crash-detection-recoveries-auto-pseudo-gtid-semi-sync-and-more" rel="bookmark"><time class="entry-date published" datetime="2018-01-29T11:40:05+02:00">January 29, 2018</time><time class="updated" datetime="2018-01-29T23:02:20+02:00">January 29, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p><code>orchestrator</code> <a href="https://github.com/github/orchestrator/releases/tag/v3.0.6"><strong>3.0.6</strong> is released</a> and includes some exciting improvements and features. It quickly follows up on <a href="https://github.com/github/orchestrator/releases/tag/v3.0.5"><strong>3.0.5</strong></a> released recently, and this post gives a breakdown of some notable changes:</p>
<h3>Faster failure detection</h3>
<p>Recall that <code>orchestrator</code> uses a holistic approach for <a href="https://github.com/github/orchestrator/blob/master/docs/failure-detection.md#failure-detection">failure detection</a>: it reads state not only from the failed server (e.g. master) but also from its replicas. <code>orchestrator</code> now detects failure faster than before:</p>
<ul>
<li>A detection cycle has been eliminated, leading to quicker resolution of a failure. On our setup, where we poll servers every <code>5sec</code>, failure detection time dropped from <code>7-10sec</code> to <code>3-5sec</code>, <em>keeping reliability</em>. The reduction in time does not lead to increased false positives.<br>
Side note: you may see increased not-quite-failure analysis such as “I can’t see the master” (<code>UnreachableMaster</code>).</li>
<li>Better handling of network scenarios where packets are dropped. Instead of hanging till TCP timeout, <code>orchestrator</code> now observes server discovery asynchronously. We have <a href="https://githubengineering.com/mysql-testing-automation-at-github/#failovers">specialized failover tests</a> that simulate dropped packets. The change reduces detection time by some <code>5sec</code>.</li>
</ul>
<h3>Faster master recoveries</h3>
<p>Promoting a new master is a complex task which attempts to promote the best replica out of the pool of replicas. It’s not always the most up-to-date replica. The choice varies depending on replica configuration, version, and state.</p>
<p>With recent changes, <code>orchestrator</code> is able to to recognize, early on, that the replica it would like to promote as master is <em>ideal</em>. Assuming that is the case, <code>orchestrator</code> is able to immediate promote it (i.e. run hooks, set <code>read_only=0</code> etc.), and run the rest of the failover logic, i.e. the rewiring of replicas under the newly promoted master, asynchronously.</p>
<p>This allows the promoted server to take writes sooner, even while its replicas are not yet connected. It also means external hooks are executed sooner.</p>
<p>Between faster detection and faster recoveries, we’re looking at some <code>10sec</code> reduction in overall recovery time: from moment of crash to moment where a new master accepts writes. We stand now at <code>< 20sec</code> in almost all cases, and <code>< 15s</code> in optimal cases. Those times are measured on our failover tests.</p>
<p>We are working on reducing failover time unrelated to <code>orchestrator</code> and hope to update soon.</p>
<h3>Automated Pseudo-GTID</h3>
<p>As reminder, Pseudo-GTID is an alternative to GTID, without the kind of commitment you make with GTID. It provides similar “point your replica under any other server” behavior GTID allows. <a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-3-0-6-faster-crash-detection-recoveries-auto-pseudo-gtid-semi-sync-and-more#more-7833" class="more-link">Continue reading »<span class="screen-reader-text"> “orchestrator 3.0.6: faster crash detection & recoveries, auto Pseudo-GTID, semi-sync and more”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-3-0-6-faster-crash-detection-recoveries-auto-pseudo-gtid-semi-sync-and-more#respond">Leave a Comment<span class="screen-reader-text"> on orchestrator 3.0.6: faster crash detection & recoveries, auto Pseudo-GTID, semi-sync and more</span></a></span>	</footer>
</article>

<article id="post-7820" class="post-7820 post type-post status-publish format-standard hentry category-golang tag-golang">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/golang/implementing-non-re-entrant-functions-in-golang" rel="bookmark">Implementing non re-entrant functions in Golang</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/golang" rel="category tag">golang</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/golang" rel="tag">golang</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/golang/implementing-non-re-entrant-functions-in-golang" rel="bookmark"><time class="entry-date published" datetime="2018-01-04T13:34:13+02:00">January 4, 2018</time><time class="updated" datetime="2018-01-04T13:37:10+02:00">January 4, 2018</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>A non re-entrant function is a function that could only be executing once at any point in time, regardless of how many times it is being invoked and by how many goroutines.</p>
<p>This post illustrates <em>blocking</em> non re-entrant functions and <em>yielding</em> non re-entrant functions implementations in <code>golang</code>.</p>
<h3>A use case</h3>
<p>A service is polling for some conditions, monitoring some statuses once per second. We want each status to be checked independently of others without blocking. An implementation might look like:</p>
<pre>func main() {
    tick := time.Tick(time.Second)
    go func() {
        for range tick {
            go CheckSomeStatus()
            go CheckAnotherStatus()
        }
    }()
}
</pre>
<p>We choose to run each status check in its own goroutine so that <code>CheckAnotherStatus()</code> doesn’t wait upon <code>CheckSomeStatus()</code> to complete.</p>
<p>Each of these checks typically take a very short amount of time, and much less than a second. What happens, though, if <code>CheckAnotherStatus()</code> itself takes more than one second to run? Perhaps there’s an unexpected network or disk latency affecting the execution time of the check.</p>
<p>Does it make sense for the function to be executed twice at the same time? If not, we want it to be non re-entrant. <a href="https://shlomi-noach.github.io/blog/golang/implementing-non-re-entrant-functions-in-golang#more-7820" class="more-link">Continue reading »<span class="screen-reader-text"> “Implementing non re-entrant functions in Golang”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/golang/implementing-non-re-entrant-functions-in-golang#respond">Leave a Comment<span class="screen-reader-text"> on Implementing non re-entrant functions in Golang</span></a></span>	</footer>
</article>

	</main>


	<footer id="colophon" class="site-footer">
		<div class="site-info">
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
			<span class="sep"> | </span>
				Theme: <a href="http://openark.org">openark-primer</a> by <a href="http://underscores.me/">Underscores.me</a>.		</div>
	</footer>
</div>

	<div style="display:none">
	</div>
<script>
var pollsL10n = {"ajax_url":"https:\/\/shlomi-noach.github.io\/blog\/wp-admin\/admin-ajax.php","text_wait":"Your last request is still being processed. Please wait a while ...","text_valid":"Please choose a valid poll answer.","text_multiple":"Maximum number of choices allowed: ","show_loading":"1","show_fading":"1"};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-js.js"></script>
<script src="https://secure.gravatar.com/js/gprofiles.js?ver=2020Junaa"></script>
<script>
var WPGroHo = {"my_hash":""};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/modules/wpgroho.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/navigation.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/skip-link-focus-fix.js"></script>
<script type="text/javascript" src="https://stats.wp.com/e-202024.js" async="async" defer></script>
<script type="text/javascript">
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:8.2.1',blog:'32412571',post:'0',tz:'2',srv:'code.openark.org'} ]);
	_stq.push([ 'clickTrackerInit', '32412571', '0' ]);
</script>

</body>
</html>

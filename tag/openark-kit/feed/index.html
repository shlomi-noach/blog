<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>openark kit &#8211; code.openark.org</title>
	<atom:link href="https://shlomi-noach.github.io/blog/tag/openark-kit/feed" rel="self" type="application/rss+xml" />
	<link>http://shlomi-noach.github.io/blog/</link>
	<description>Blog by Shlomi Noach</description>
	<lastBuildDate>Wed, 26 Jun 2013 19:46:57 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.3.3</generator>
<site xmlns="com-wordpress:feed-additions:1">32412571</site>	<item>
		<title>common_schema &#038; openark-kit in the media: #DBHangOps, OurSQL</title>
		<link>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql#respond</comments>
				<pubDate>Wed, 26 Jun 2013 19:46:57 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[community]]></category>
		<category><![CDATA[INFORMATION_SCHEMA]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Speaking]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6393</guid>
				<description><![CDATA[#DBHangOps I had the pleasure of joining into @DBHangOps today, and speak about common_schema and openark-kit. What was meant to be a 15 minute session turned to be 50 &#8212; sorry, people, I don&#8217;t talk as much at home, but when it comes to my pet projects&#8230; I also realized I was missing on a [&#8230;]]]></description>
								<content:encoded><![CDATA[<h4>#DBHangOps</h4>
<p>I had the pleasure of joining into <a href="https://twitter.com/DBHangops">@DBHangOps</a> today, and speak about <a href="https://code.google.com/p/common-schema/">common_schema</a> and <a href="http://code.google.com/p/openarkkit/">openark-kit</a>. What was meant to be a 15 minute session turned to be 50 &#8212; sorry, people, I don&#8217;t talk as much at home, but when it comes to my pet projects&#8230;</p>
<p>I also realized I was missing on a great event: DBHangOps is a hangout where you can chat and discuss MySQL &amp; related technologies with friends and colleagues, with whom you typically only meet at conferences. I will certainly want to attend future events.</p>
<p>Thanks to John Cesario and Geoffrey Anderson who invited me to talk, and to the friends and familiar faces who attended; I was happy to talk about my work, and very interested in hearing about how it&#8217;s being put to use. We also had time to discuss <a href="http://www.markleith.co.uk/ps_helper/">ps_helper</a> with no other than Mark Leith!</p>
<p>The video is <a href="https://twitter.com/DBHangops/status/349965939690835970">available on Twitter/YouTube</a>.</p>
<h4>OurSQL</h4>
<p><em>openark-kit</em> has also been <a href="http://technocation.org/content/oursql-episode-143%3A-biblical-tools">featured on the OurSQL podcast</a> by Sheeri &amp; Gerry, who did great coverage of some tools. I will disclose that more is to come; I&#8217;m happy this is in capable hands and look further to hear the next episode!</p>
<p>&nbsp;</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6393</post-id>	</item>
		<item>
		<title>opeark-kit revision 196 released</title>
		<link>https://shlomi-noach.github.io/blog/mysql/opeark-kit-revision-196-released</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/opeark-kit-revision-196-released#respond</comments>
				<pubDate>Tue, 07 May 2013 05:47:22 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[Development]]></category>
		<category><![CDATA[Open Source]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[QueryScript]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6335</guid>
				<description><![CDATA[This is a long due maintenance release of openark-kit. This release includes bugfixes and some enhancements, mainly to oak-online-alter-table. oak-online-alter-table Changes / bug fixes include: Support for keyword-named columns Use of FORCE INDEX due to lack of MySQL&#8217;s ability for figure out the chunking key at all times &#8211;sleep-ratio option added; allows for sleep time [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>This is a long due maintenance release of <a href="http://code.google.com/p/openarkkit/"><strong>openark-kit</strong>.</a> This release includes bugfixes and some enhancements, mainly to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">oak-online-alter-table</a>.</p>
<p><em>oak-online-alter-table</em> Changes / bug fixes include:</p>
<ul>
<li>Support for keyword-named columns</li>
<li>Use of FORCE INDEX due to lack of MySQL&#8217;s ability for figure out the chunking key at all times</li>
<li><strong>&#8211;sleep-ratio</strong> option added; allows for sleep time proportional to execution time (as opposed to constant sleep time with <strong>&#8211;sleep</strong>)</li>
<li>Support for chunk-retry (in case of deadlock) via <strong>&#8211;max-lock-retries</strong>)</li>
<li>Fixed order of cleanup</li>
<li>Fixed bug with verbose messages with non-integer chunking key</li>
<li>Fixed bug with single-row tables (people, no need for this tool for single row tables :))</li>
<li>Friendly verbose messages to remind you what&#8217;s being executed</li>
</ul>
<p><em>oak-chunk-update</em> changes includes:</p>
<ul>
<li>Verbosing query comment if exists (friendly printing of what&#8217;s being executed)</li>
</ul>
<p><span id="more-6335"></span>(Do check out <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html">QueryScript&#8217;s split()</a>; it&#8217;s a simple, server side solution which works almost same way as <em>oak-chunk-update</em>)</p>
<p>More issues and changes not listed here.</p>
<h4>Download</h4>
<p><em>openark-kit</em> is released under the new BSD license, and is freely available.</p>
<ul>
<li><a href="http://code.google.com/p/openarkkit/">Download latest openark-kit revision (#196)</a>.</li>
<li>Browse <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/introduction.html">openark-kit documentation</a>.</li>
</ul>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/opeark-kit-revision-196-released/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6335</post-id>	</item>
		<item>
		<title>Speaking at Percona Live 2013: common_schema, lightning talks</title>
		<link>https://shlomi-noach.github.io/blog/mysql/speaking-at-percona-live-2013-common_schema-lightning-talks</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/speaking-at-percona-live-2013-common_schema-lightning-talks#comments</comments>
				<pubDate>Thu, 11 Apr 2013 05:17:04 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[PerconaLive]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6268</guid>
				<description><![CDATA[In two weeks time I will be giving these talks at Percona Live: common_schema: DBA&#8217;s framework for MySQL: an introduction to common_schema, my evolving server side solutions project. This will be a revised version of the talk I gave at Percona Live London; I have felt some weaknesses during that talk, which I&#8217;ve thrown out, [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>In two weeks time I will be giving these talks at Percona Live:</p>
<ul>
<li><a href="http://www.percona.com/live/mysql-conference-2013/sessions/commonschema-dbas-framework-mysql">common_schema: DBA&#8217;s framework for MySQL</a>: an introduction to <a href="https://code.google.com/p/common-schema/">common_schema</a>, my evolving server side solutions project. This will be a revised version of the talk I gave at Percona Live London; I have felt some weaknesses during that talk, which I&#8217;ve thrown out, letting room for cool stuff. I will discuss <em>common_schema</em>&#8216;s various views, interesting and useful routines, the power of <strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a></strong>, and a brief intro to the newcomer <strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">rdebug</a></strong>, debugger and debugging API for MySQL. If you&#8217;re not familiar with <em>common_schema</em>, it&#8217;s a good time to pick up on what I (being most biased) consider to be your smart assistant to MySQL maintenance and administration!</li>
<li><a href="http://www.percona.com/live/mysql-conference-2013/sessions/lt-query-which-peak-my-career">The query which is the peak of my career</a>: this is a 6 minute lightning talk. You&#8217;re bound to attend if you&#8217;re at the community reception (which you are), so I don&#8217;t need to do promotional. You already payed the ticket and the doors will be locked. No escapees.</li>
</ul>
<p>As far as I&#8217;m concerned the conference can be closed down the moment I provide these two talks, and we can all go to the beach.</p>
<p>Wait, no, I will also be at the DotOrg Pavillion at the <a href="http://www.percona.com/live/mysql-conference-2013/exhibit-hall">Exhibit Hall</a>, where I present <em>common_schema</em> and <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/introduction.html">openark-kit</a>. Come by to hear more about these!</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/speaking-at-percona-live-2013-common_schema-lightning-talks/feed</wfw:commentRss>
		<slash:comments>4</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6268</post-id>	</item>
		<item>
		<title>common_schema over traditional scripts</title>
		<link>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts#comments</comments>
				<pubDate>Wed, 12 Dec 2012 11:55:44 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[QueryScript]]></category>
		<category><![CDATA[scripts]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5509</guid>
				<description><![CDATA[If you are familiar with both openark kit and common_schema, you&#8217;ll notice I&#8217;ve incorporated some functionality already working in openark kit into common_schema, essentially rewriting what used to be a Python script into SQL/QueryScript. What was my reasoning for rewriting good code? I wish to explain that, and provide with a couple examples. I&#8217;m generally [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>If you are familiar with both <a href="http://code.openark.org/forge/openark-kit">openark kit</a> and <a href="http://code.google.com/p/common-schema">common_schema</a>, you&#8217;ll notice I&#8217;ve incorporated some functionality already working in <em>openark kit</em> into <em>common_schema</em>, essentially rewriting what used to be a Python script into SQL/<a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a>.</p>
<p>What was my reasoning for rewriting good code? I wish to explain that, and provide with a couple examples.</p>
<p>I&#8217;m generally interested in pushing as much functionality into the MySQL server. When using an external script, one:</p>
<ul>
<li>Needs the right dependencies (OS, Perl/Python version, Perl/Python modules).</li>
<li>Needs to provide with connection params,</li>
<li>Needs to get acquainted with a lot of command line options,</li>
<li>Is limited by whatever command line options are provided.</li>
<li>Has to invoke that script (duh!) to get the work done.</li>
</ul>
<p>This last bullet is not so trivial: it means you can&#8217;t work some operation with your favorite GUI client, because it has no notion of your Perl script; does not run on the same machine where your Python code resides; simply can&#8217;t run those scripts for you.</p>
<p>With server-side code, functionality is accessible via any client. You run your operation via a query (e.g. <strong>CALL some_procedure</strong>). That can be done from your GUI client, your command line client, your event scheduler, your cronjob, all equally. You only need access to your MySQL server, which is trivial.</p>
<p>Of course, server side scripting is <a href="https://shlomi-noach.github.io/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine">limited</a>. Some stuff simply can&#8217;t be written solely on server side. If you want to consult your replicating slave; gracefully take action on user&#8217;s <strong>Ctrl+C</strong>, send data over the web, you&#8217;ll have to do it with an external tool. There are actually a lot of surprising limitations to things one would assume <em>are</em> possible on server side. You may already know how frustrated I am by the fact one can <a href="https://shlomi-noach.github.io/blog/mysql/reading-results-of-show-statements-on-server-side">hardly</a> get info from <strong>SHOW</strong> commands.</p>
<h4>But, when it works, it shines</h4>
<p>Let&#8217;s review a couple examples. The first one is nearly trivial. The second less so.<span id="more-5509"></span></p>
<h4>Example: getting AUTO_INCREMENT &#8220;free space&#8221;</h4>
<p><em>openark kit</em> offers <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-show-limits.html">oak-show-limits</a>. It&#8217;s a tool that tells you if any of your <strong>AUTO_INCREMENT</strong> columns are running out of space (and so you might want to <strong>ALTER</strong> that <strong>INT</strong> to <strong>BIGINT</strong>).</p>
<p>It&#8217;s a very simple Python script. It gets your <strong>MAX(auto_increment_column) FROM tables_with_auto_increment</strong>, and compares that <strong>MAX</strong> value to the column type. It pre-computes:</p>
<blockquote>
<pre>max_values['tinyint'] = 2**8
max_values['smallint'] = 2**16
max_values['mediumint'] = 2**24
max_values['int'] = 2**32
max_values['bigint'] = 2**64</pre>
</blockquote>
<p>takes care of <strong>SIGNED/UNSIGNED</strong>, and does the math. Why is this tool such a perfect candidate for <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/auto_increment_columns.html">replacement on server side</a>? For two reasons.</p>
<p>First, It turns out it takes very little effort to <a href="https://shlomi-noach.github.io/blog/mysql/checking-for-auto_increment-capacity-with-single-query">build a query</a> which does the same. In which case it is also easy to build a view which provides the same.</p>
<p>Second, there&#8217;s this thing with command line arguments. The <em>openark</em> tool provides with <strong>&#8211;threshold</strong> (only output those columns where capacity is larger than <strong>x%</strong>), <strong>&#8211;database</strong> (only scan given database), <strong>&#8211;table</strong> (only for tables matching name), <strong>&#8211;column</strong> (only for columns matching name).</p>
<p>I don&#8217;t like this. See, the above is essentially an extra layer for saying:</p>
<ul>
<li><strong>WHERE</strong> auto_increment_ratio &gt;= x</li>
<li><strong>WHERE</strong> table_schema = &#8230;</li>
<li><strong>WHERE</strong> table_name = &#8230;</li>
<li><strong>WHERE</strong> column_name = &#8230;</li>
</ul>
<p>The command line arguments each take the role of some <strong>WHERE/AND</strong> condition.Wow, what a <strong>1-1</strong> mapping. How about if I wanted the results sorted in some specific order? I would have to add a command line argument for that! How about only listing the <strong>SIGNED</strong> columns? I would have to add a command line argument for that, too! How about showing top <strong>10</strong>? Yes, another command line argument!</p>
<p>Some of the above can be solved via shell scripting (<strong>sort -k 3 -n</strong>, <strong>head -n 10</strong>, etc.). But, hey, we&#8217;re OK with SQL, aren&#8217;t we? Why add now these <em>two extra layers</em>? Get to know all the command line options, get to script it? I love scripting, but this is an abuse.</p>
<p>So it makes much more sense, in my opinion, to <strong>SELECT * FROM auto_increment_columns WHERE table_schema=&#8217;my_db&#8217; AND auto_increment_ratio &gt;= 0.8 ORDER BY auto_increment_ratio DESC LIMIT 10</strong>. It doesn&#8217;t require SQL-fu skills, just basic SQL skills which every DBA and DB user are expected to have. And it allows one to work from whatever environment one feels comfortable with. Heck, with your GUI editor you can probably get off with it by right-clicking and left-clicking your mouse buttons, never typing one character.</p>
<h4>Example: blocking user accounts</h4>
<p>The above mapped very easily to a query, and was just a read-only query. What if we had to modify data? <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-block-account.html">oak-block-accounts</a> is a tool which allows one to block grantees from logging in, then releasing them later on. <em>common_schema</em> offers <a href="common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_accounts.html">sql_accounts</a> and <a href="file:///home/shlomi/workspace/common_schema/doc/html/eval.html">eval()</a>.</p>
<p>Let&#8217;s skip the command line arguments issue, as it is identical to the above. How should we best provide with &#8220;taking action&#8221; interface? A script would have no problem to first <strong>SELECT</strong> stuff, then <strong>UPDATE</strong>, or <strong>SET PASSWORD</strong>, or <strong>DROP</strong> etc. How easy is it to do the same on server side?</p>
<p>The immediate solution is to write a stored procedure to do that. I reject the idea. Why? Because the procedure would look like this:</p>
<blockquote>
<pre>PROCEDURE block_account(user VARCHAR(64), host VARCHAR(64), only_if_empty_password BOOL, ...);</pre>
</blockquote>
<p>Can you see where I&#8217;m getting at? Doing the above re-introduces command line options, this time disguised as procedure parameters. We would again have to list all available filtering methods, only this time things are worse: since stored procedures have no such notion as overloading, and change to the params will break compatibility. Once we introduce this routine, we&#8217;re stuck with it.</p>
<p><em>common_schema</em> tries to stay away as far as it can from this pitfall. It presents another solution: the <em>view</em> solution. Just as with <em>auto_increment_columns</em>, <strong>SELECT</strong> your way to get the right rows. But this time, the result is a SQL query:</p>
<blockquote>
<pre>mysql&gt; SELECT <strong>sql_block_account</strong> FROM <strong>sql_accounts</strong> <strong>WHERE USER = 'gromit'</strong>;
+-------------------------------------------------------------------------------------+
| sql_block_account                                                                   |
+-------------------------------------------------------------------------------------+
| SET PASSWORD FOR 'gromit'@'localhost' = '752AA50E562A6B40DE87DF0FA69FACADD908EA32*' |
+-------------------------------------------------------------------------------------+</pre>
</blockquote>
<p>Do your own <strong>WHERE</strong>/<strong>AND</strong> combination in SQL. But, how to take action? Our view cannot take the actual action for us!</p>
<p><em>eval()</em> is at the core of many common_schema operations, like this one:</p>
<blockquote>
<pre>CALL <strong>eval</strong>(<span style="color: #000080;">"SELECT <strong>sql_block_account</strong> FROM <strong>sql_accounts WHERE USER = 'gromit'</strong>"</span>);</pre>
</blockquote>
<p>The <strong>SET PASSWORD</strong> query just got evaluated. Meaning it was executed. <em>eval()</em> is a very powerful solution.</p>
<h4>Conclusion</h4>
<p>I prefer stuff on server side. It requires basic SQL skills (or a smart GUI editor), and allows you easy access to a lot of functionality, removing dependency requirements. It is not always possible, and external scripts can do miracles not possible on server side, but server side scripting has its own miracles.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts/feed</wfw:commentRss>
		<slash:comments>2</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5509</post-id>	</item>
		<item>
		<title>State of InnDB Online DDL in MySQL 5.6.8-RC</title>
		<link>https://shlomi-noach.github.io/blog/mysql/state-of-inndb-online-ddl-in-mysql-5-6-8-rc</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/state-of-inndb-online-ddl-in-mysql-5-6-8-rc#comments</comments>
				<pubDate>Tue, 20 Nov 2012 09:49:14 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[InnoDB]]></category>
		<category><![CDATA[New Features]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Review]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5823</guid>
				<description><![CDATA[5.6.8-rc is out, and so I&#8217;m following up on InnoDB&#8217;s online DDL new feature: the ability to SELECT, INSERT, DELETE, UPDATE a table even while an ALTER TABLE is executing on same table. The brief summary Not as advertised; many things can&#8217;t be done. The longer review I&#8217;m using 5.6.8-rc 64bit binary distribution for Linux, [&#8230;]]]></description>
								<content:encoded><![CDATA[<p><strong>5.6.8-rc</strong> is out, and so I&#8217;m following up on InnoDB&#8217;s online DDL new feature: the ability to SELECT, INSERT, DELETE, UPDATE a table even while an ALTER TABLE is executing on same table.</p>
<h4>The brief summary</h4>
<p>Not as advertised; many things can&#8217;t be done.</p>
<h4>The longer review</h4>
<p>I&#8217;m using <strong>5.6.8-rc 64bit</strong> binary distribution for Linux, installed via <a href="http://mysqlsandbox.net/">mysqlsandbox</a>. My hardware is irrelevant, but the fact I&#8217;m testing on my laptop assists me in that <strong>ALTER TABLE</strong> operations take a while, so that I&#8217;m able to easily type commands in two terminals and have the time to watch them being executed. Query cache is disabled.<span id="more-5823"></span></p>
<p>I&#8217;m using the sakila sample database, and in particular I&#8217;m working with the rental table. Here&#8217;s the table definition:</p>
<blockquote>
<pre>CREATE TABLE `rental` (
  `rental_id` int(11) NOT NULL AUTO_INCREMENT,
  `rental_date` datetime NOT NULL,
  `inventory_id` mediumint(8) unsigned NOT NULL,
  `customer_id` smallint(5) unsigned NOT NULL,
  `return_date` datetime DEFAULT NULL,
  `staff_id` tinyint(3) unsigned NOT NULL,
  `last_update` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`rental_id`),
  UNIQUE KEY `rental_date` (`rental_date`,`inventory_id`,`customer_id`),
  KEY `idx_fk_inventory_id` (`inventory_id`),
  KEY `idx_fk_customer_id` (`customer_id`),
  KEY `idx_fk_staff_id` (`staff_id`),
  CONSTRAINT `fk_rental_staff` FOREIGN KEY (`staff_id`) REFERENCES `staff` (`staff_id`) ON UPDATE CASCADE,
  CONSTRAINT `fk_rental_inventory` FOREIGN KEY (`inventory_id`) REFERENCES `inventory` (`inventory_id`) ON UPDATE CASCADE,
  CONSTRAINT `fk_rental_customer` FOREIGN KEY (`customer_id`) REFERENCES `customer` (`customer_id`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=16050 DEFAULT CHARSET=utf8</pre>
</blockquote>
<p>Highlights for the table: <strong>AUTO_INCREMENT PRIMARY KEY</strong>, some columns indexed, some not, and Foreign Keys in place. Pretty much a standard table. It contains <strong>16,044</strong> rows. Row format is <strong>COMPACT</strong>.</p>
<p>What I want to know is: which DDL commands allow for which online DML commands?</p>
<p>So, on terminal #1 I will issue queries like:</p>
<blockquote>
<pre>node1 5.6.8-rc-log sakila&gt; alter table <strong>sakila.rental</strong> ROW_FORMAT=COMPACT <strong>/* or whatever */</strong>;
Query OK, 0 rows affected (10.57 sec)
Records: 0  Duplicates: 0  Warnings: 0</pre>
</blockquote>
<p>And during the above operation, I will execute the following on terminal #2:</p>
<ol>
<li><strong>select max(rental_id) from sakila.rental;</strong> this queries the AUTO_INCREMENT value, which is of course a PRIMARY KEY</li>
<li><strong>select min(rental_date) from sakila.rental</strong>; there is an index on rental_date, and normal execution plan is to optimize table away and just use the index</li>
<li><strong>select min(return_date) from sakila.rental</strong>; there is no index on return_date, and full table scan is required</li>
<li><strong>update rental set return_date = return_date + interval 1 second where rental_id=3</strong>; the UPDATE uses the PRIMARY KEY</li>
<li><strong>update rental set return_date = return_date + interval 1 second where return_date = NOW()</strong>; won&#8217;t actually affect anything, but requires full scan.</li>
</ol>
<p>So here are the results:</p>
<blockquote>
<pre>+-------------------------------------------------------------+-------+---------------------------+---------------+---------------------+-------------------------+--------------+---------------------+
| ALTER statement                                             | Time  | General comments          | select max PK | select min by index | select min by full scan | update by PK | update by full scan |
+-------------------------------------------------------------+-------+---------------------------+---------------+---------------------+-------------------------+--------------+---------------------+
| ROW_FORMAT=COMPACT                                          | 10.92 |                           | <span style="color: #008000;">Instant</span>       | <span style="color: #008000;">Instant</span>             | <span style="color: #008000;">Instant</span>                 | <span style="color: #800000;">blocked</span>      | <span style="color: #800000;">blocked</span>             |
| AUTO_INCREMENT=16051                                        |  0.06 | Instant, no table rebuild | N/A           | N/A                 | N/A                     | N/A          | N/A                 |
| ADD INDEX(last_update)                                      |  2.37 |                           | <span style="color: #800000;">blocked</span>       | <span style="color: #800000;">blocked</span>             | <span style="color: #800000;">blocked</span>                 | <span style="color: #800000;">blocked</span>      | <span style="color: #800000;">blocked</span>             |
| ADD INDEX(last_update), ALGORITHM=INPLACE                   |  1.83 |                           | <span style="color: #800000;">blocked</span>       | <span style="color: #800000;">blocked</span>             | <span style="color: #800000;">blocked</span>                 | <span style="color: #800000;">blocked</span>      | <span style="color: #800000;">blocked</span>             |
| ADD INDEX(last_update), ALGORITHM=INPLACE, LOCK=NONE        |  0.00 | ERROR 1235 (42000): ...   | N/A           | N/A                 | N/A                     | N/A          | N/A                 |
| ADD COLUMN c CHAR(1) NOT NULL                               | 11.20 |                           | <span style="color: #008000;">Instant</span>       | <span style="color: #008000;">Instant</span>             | <span style="color: #008000;">Instant</span>                 | <span style="color: #800000;">blocked</span>      | <span style="color: #800000;">blocked</span>             |
| ADD COLUMN c CHAR(1) NOT NULL, ALGORITHM=INPLACE, LOCK=NONE |  0.00 | ERROR 1235 (42000): .     | N/A           | N/A                 | N/A                     | N/A          | N/A                 |
+-------------------------------------------------------------+-------+---------------------------+---------------+---------------------+-------------------------+--------------+---------------------+</pre>
</blockquote>
<p>Rather surprising, I would say.</p>
<ul>
<li><em>None</em> of my tests resolved with online write (<strong>UPDATE</strong>). At best I could get online read (<strong>SEELCT</strong>).<br />
<strong></strong></li>
<li><strong>AUTO_INCREMENT</strong> is instantaneous. High time for that! It&#8217;s just some number in the <strong>.frm</strong> file, never understood the need for table rebuild.</li>
<li>Apparently <strong>ADD COLUMN</strong> is <em>more online</em> than <strong>ADD INDEX</strong>, and I&#8217;ve tested this again and again and again to make sure I was doing it right. This is quite weird, even according to the <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl.html">docs</a>.</li>
<li>In none of the above tests (and others, non listed), have I been able to specify <strong>LOCK=NONE</strong>. It&#8217;s always <strong>ERROR 1235 (42000): This version of MySQL doesn&#8217;t yet support &#8216;alter table sakila.rental &lt;whatever&gt;, algorithm=inplace, lock=none&#8217;</strong>.</li>
</ul>
<p>So what&#8217;s so online about this? Online reads are nice, but most everyone cannot accept blocking writes (for same reason no one would use <em>mysqlhotcopy</em>, also so wrongly named). This leaves us again with <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">oak-online-alter-table</a> and <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html">pt-online-schema-change</a>.</p>
<h4>The butler did it</h4>
<p>Apologies to the butler, the <strong>FOREIGN KEY</strong>s did it. Let&#8217;s try the same again without foreign keys:</p>
<blockquote>
<pre>node1 5.6.8-rc-log sakila&gt; create table rental2 like rental;
node1 5.6.8-rc-log sakila&gt; insert into rental2 select * from rental;
node1 5.6.8-rc-log sakila&gt; rename table rental to rental_old, rental2 to rental;
Query OK, 0 rows affected (0.31 sec)</pre>
</blockquote>
<p>Here are the results:</p>
<blockquote>
<pre>+-------------------------------------------------------------+-------+---------------------------+----------------+---------------------+-------------------------+----------------+---------------------+
| ALTER statement                                             | Time  | General comments          | select max PK  | select min by index | select min by full scan | update by PK   | update by full scan |
+-------------------------------------------------------------+-------+---------------------------+----------------+---------------------+-------------------------+----------------+---------------------+
| ROW_FORMAT=COMPACT                                          | 11.03 |                           | <span style="color: #008000;">Instant</span>        | <span style="color: #008000;">Instant</span>             | <span style="color: #008000;">Instant</span>                 | <span style="color: #008000;">Instant</span>        | <span style="color: #008000;">Instant</span>             |
| AUTO_INCREMENT=16051                                        |  0.05 | Instant, no table rebuild | N/A            | N/A                 | N/A                     | N/A            | N/A                 |
| ADD INDEX(last_update)                                      |  2.04 |                           | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      | * <span style="color: #ff6600;">Inconsistent</span>          | <span style="color: #800000;">blocked</span>        | <span style="color: #800000;">blocked</span>             |
| ADD INDEX(last_update), ALGORITHM=INPLACE, LOCK=NONE        |  3.14 |                           | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      | * <span style="color: #ff6600;">Inconsistent</span>          | <span style="color: #800000;">blocked</span>        | <span style="color: #800000;">blocked</span>             |
| ADD COLUMN c CHAR(1) NOT NULL                               |    ** |                           | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      | * <span style="color: #ff6600;">Inconsistent</span>          | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      |
| ADD COLUMN c CHAR(1) NOT NULL, ALGORITHM=INPLACE, LOCK=NONE |    ** |                           | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      | * <span style="color: #ff6600;">Inconsistent</span>          | * <span style="color: #ff6600;">Inconsistent</span> | * <span style="color: #ff6600;">Inconsistent</span>      |
+-------------------------------------------------------------+-------+---------------------------+----------------+---------------------+-------------------------+----------------+---------------------+</pre>
</blockquote>
<p>What&#8217;s going on here?</p>
<ul>
<li><strong>ALGORITHM=INPLACE, LOCK=NONE</strong> is accepted! Bad, bad foreign keys!<br />
<strong></strong></li>
<li><strong>* ADD INDEX</strong> usually allows for concurrent reads, but after repeated tests <strong>SELECT</strong>s start to block. Then they don&#8217;t work concurrently anymore until table is recreated. But even that not always, so I&#8217;m not sure what the inconsistency is.</li>
<li><strong>* ADD COLUMN</strong> is still more concurrent than <strong>ADD INDEX</strong>, and actually allows for concurrent writes! Though, inconsistently. Sometimes it does not allow for concurrent writes.</li>
<li><strong>** ADD COLUMN</strong> runtime highly affected by concurrent queries. It wents as high as <strong>45</strong> seconds on my laptop. Now, to make things clear, I&#8217;m not running an automated benchmark here: I&#8217;m copying+pasting the statements from my editor to the mysql CLI. So, maybe <strong>10</strong> or <strong>15</strong><strong>SELECT</strong> and <strong>UPDATE</strong> queries executes. How does that justify <strong>35</strong> seconds delay in table rebuild?</li>
</ul>
<h4>Some conclusions:</h4>
<ul>
<li>The documentation does not specify anything about <strong>FOREIGN KEY</strong>s crashing the party. It should.</li>
<li>The documentation specifically mentions the <strong>ADD/DROP INDEX</strong> statements to be online. <strong>ADD INDEX</strong> is less online than <strong>ADD COLUMN</strong>.</li>
<li>Everything is still shaky. Sometimes things work, sometimes they don&#8217;t.</li>
<li>Runtimes are unproportionally affected by concurrent queries.</li>
<li>For the meantime, I keep to my online alter table scripts. Been using them for <strong>3.5</strong> years now.</li>
</ul>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/state-of-inndb-online-ddl-in-mysql-5-6-8-rc/feed</wfw:commentRss>
		<slash:comments>1</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5823</post-id>	</item>
		<item>
		<title>Experimenting with 5.6 InnoDB Online DDL (bugs included)</title>
		<link>https://shlomi-noach.github.io/blog/mysql/experimenting-with-5-6-innodb-online-ddl-bugs-included</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/experimenting-with-5-6-innodb-online-ddl-bugs-included#comments</comments>
				<pubDate>Thu, 18 Oct 2012 12:41:46 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[InnoDB]]></category>
		<category><![CDATA[New Features]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Opinions]]></category>
		<category><![CDATA[scripts]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5673</guid>
				<description><![CDATA[MySQL 5.6 offers the groundbreaking online DDL operations for InnoDB. Most common use cases will enjoy this feature, and the need for online alter table scripts will decrease. This is a killer feature! I&#8217;ve put this new feature to the usability test. How did it go? Not too well, I&#8217;m afraid. [Updates to this text [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>MySQL <strong>5.6</strong> offers the groundbreaking online DDL operations for InnoDB. Most common use cases will enjoy this feature, and the need for <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">online alter table</a> scripts will decrease. This is a killer feature!</p>
<p>I&#8217;ve put this new feature to the usability test. How did it go? Not too well, I&#8217;m afraid.</p>
<p>[Updates to this text inline], also see <a href="https://shlomi-noach.github.io/blog/mysql/innodb-ddl-kudos-to-quick-responders-on-bugs-mysql-com">this followup</a>.</p>
<h4>sakila &amp; DDL</h4>
<p><a href="http://dev.mysql.com/doc/sakila/en/index.html">sakila</a> is still a very useful database. I say &#8220;still&#8221; because it is not very large, and computing power is getting stronger; yet on my laptop some operations can still take many seconds to complete, which is just fine for my tests.</p>
<p>Sakila tables are mostly InnoDB, and rental being the largest, I do:</p>
<blockquote>
<pre>node1 (sakila) &gt; <strong>alter table sakila.rental engine=InnoDB;</strong>
Query OK, 16044 rows affected (<strong>6.94</strong> sec)
Records: 16044  Duplicates: 0  Warnings: 0</pre>
</blockquote>
<p>So what can be executed during these <strong>6.94</strong> seconds? In a second terminal, I try the following:<span id="more-5673"></span></p>
<h4>Meta</h4>
<blockquote>
<pre>node1 (sakila) &gt; show create table sakila.rental\G
*************************** 1. row ***************************
       Table: rental
Create Table: CREATE TABLE `rental` (
  `rental_id` int(11) NOT NULL AUTO_INCREMENT,
  `rental_date` datetime NOT NULL,
  `inventory_id` mediumint(8) unsigned NOT NULL,
  `customer_id` smallint(5) unsigned NOT NULL,
  `return_date` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `staff_id` tinyint(3) unsigned NOT NULL,
  `last_update` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`rental_id`),
  UNIQUE KEY `rental_date` (`rental_date`,`inventory_id`,`customer_id`),
  KEY `idx_fk_inventory_id` (`inventory_id`),
  KEY `idx_fk_customer_id` (`customer_id`),
  KEY `idx_fk_staff_id` (`staff_id`),
  CONSTRAINT `fk_rental_customer` FOREIGN KEY (`customer_id`) REFERENCES `customer` (`customer_id`) ON UPDATE CASCADE,
  CONSTRAINT `fk_rental_inventory` FOREIGN KEY (`inventory_id`) REFERENCES `inventory` (`inventory_id`) ON UPDATE CASCADE,
  CONSTRAINT `fk_rental_staff` FOREIGN KEY (`staff_id`) REFERENCES `staff` (`staff_id`) ON UPDATE CASCADE
) ENGINE=InnoDB AUTO_INCREMENT=16050 DEFAULT CHARSET=utf8
1 row in set (<strong>1.08 sec</strong>)</pre>
</blockquote>
<p><strong>1.08</strong> seconds for <strong>SHOW CREATE TABLE</strong>. Consider: up till <strong>5.5</strong> you can&#8217;t run <strong>SHOW CREATE TABLE</strong> while an <strong>ALTER</strong> was running on that table.</p>
<h4>Read</h4>
<p>While ALTER TABLE runs, I execute:</p>
<blockquote>
<pre>node1 (sakila) &gt; select min(rental_date), max(return_date) from sakila.rental;
+---------------------+---------------------+
| min(rental_date)    | max(return_date)    |
+---------------------+---------------------+
| 2005-05-24 22:53:30 | 2005-09-02 02:35:22 |
+---------------------+---------------------+
1 row in set (2.77 sec)</pre>
</blockquote>
<p>So <strong>2.77</strong> seconds for a query which uses a full table scan to return. I&#8217;m not measuring performance here; am satisfies that query did actually succeed even while table was being altered.</p>
<h4>Read &amp; bug</h4>
<p>But, unfortunately, being the type of geek who likes to make trouble, I am also able to consistently fail the <strong>ALTER TABLE</strong>. Hang it, actually:</p>
<p>See session <strong>#1</strong>:</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental engine=innodb; 

... (waiting forever)</pre>
</blockquote>
<p>And session <strong>#2</strong>:</p>
<blockquote>
<pre>node1 (sakila) &gt; show processlist;
+----+----------+-----------+--------+---------+------+---------------------------------+-----------------------------------------+
| Id | User     | Host      | db     | Command | Time | State                           | Info                                    |
+----+----------+-----------+--------+---------+------+---------------------------------+-----------------------------------------+
|  6 | msandbox | localhost | sakila | Query   |  <strong>219</strong> | <strong>Waiting for table metadata lock</strong> | <strong>alter table sakila.rental engine=innodb</strong> |
|  4 | msandbox | localhost | sakila | Query   |    0 | init                            | show processlist                        |
+----+----------+-----------+--------+---------+------+---------------------------------+-----------------------------------------+</pre>
</blockquote>
<p>Read all about it in <a href="http://bugs.mysql.com/bug.php?id=67286">bug report #67286</a> .</p>
<h4>Write: not so simple</h4>
<p>The following <strong>UPDATE</strong> query hangs till the <strong>ALTER</strong> process is over:</p>
<blockquote>
<pre>node1 (sakila) &gt; update sakila.rental set return_date=now() where rental_id = floor(rand()*100);
Query OK, 3 rows affected, 1 warning (6.10 sec)</pre>
</blockquote>
<p>No online DDL for writes?</p>
<p>Was I unfair? Is &#8220;ENGINE=InnoDB&#8221; really an online DDL operation? OK, let&#8217;s try with:</p>
<blockquote>
<pre>alter table sakila.rental <strong>row_format=compact</strong>;</pre>
</blockquote>
<p>Which is documented as one of the supported online DDL operations. Same.</p>
<p>The <a href="http://dev.mysql.com/doc/refman/5.6/en/innodb-online-ddl.html">manual</a> says I can define the <strong>ALGORITHM</strong> and the <strong>LOCK</strong> properties for the <strong>ALTER TABLE</strong> operation. But is gives no example, so I try my own:</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental row_format=compact <strong>ALGORITHM=INPLACE LOCK=NONE</strong>;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'ALGORITHM=INPLACE LOCK=NONE' at line 1</pre>
</blockquote>
<p>Ummm&#8230;. then maybe:</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental <strong>ALGORITHM=INPLACE LOCK=NONE</strong> row_format=compact;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'LOCK=NONE row_format=compact' at line 1</pre>
</blockquote>
<p>OK, how about:</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental <strong>ALGORITHM=INPLACE</strong> row_format=compact <strong>LOCK=NONE</strong>;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near 'row_format=compact LOCK=NONE' at line 1</pre>
</blockquote>
<p>Reading, rereading, re-verifying <a href="http://dev.mysql.com/doc/refman/5.6/en/alter-table.html">the manual</a> &#8212; I am typing a valid statement! What&#8217;s wrong here?</p>
<p>Yes, I&#8217;m on <strong>5.6.7-rc-log</strong>. No, I can&#8217;t find, in <strong>5.6</strong> documentation and slides from <a href="https://oracleus.activeevents.com/connect/search.ww?event=openworld#loadSearch-event=openworld&amp;searchPhrase=&amp;searchType=session&amp;tc=0&amp;sortBy=&amp;p=&amp;i%2810942%29=15982&amp;i%2811425%29=&amp;i%2810053%29=&amp;i%2811404%29=&amp;i%2811562%29=&amp;i%2811488%29=&amp;i%2810089%29=&amp;i%2811840%29=">MySQL connect</a>, any code sample that actually uses <strong>ALGORITHM</strong> and <strong>LOCK</strong> (!?)</p>
<p><strong>[UPDATE]</strong>, as Marc Alff point out, I did in fact use the wrong syntax, and was missing commas. The right syntax is:</p>
<blockquote>
<pre>node1 (sakila) &gt; <strong>alter table sakila.rental row_format=compact, algorithm=inplace, lock=none;</strong>
ERROR 1235 (42000): This version of MySQL doesn't yet support 'alter table sakila.rental row_format=compact, algorithm=inplace, lock=none'</pre>
</blockquote>
<p>Unfortunately this still results with an error. Another attempt shows that:</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental row_format=compact, algorithm=inplace, lock=shared;
Query OK, 0 rows affected (11.08 sec)</pre>
</blockquote>
<p>works well. So, apparently, you can only run <em>this type</em> of <strong>ALTER TABLE</strong> a with a <strong>SHARED</strong> lock. The bad news?</p>
<blockquote>
<pre>node1 (sakila) &gt; alter table sakila.rental <strong>add index(return_date)</strong>, algorithm=inplace, lock=<strong>none</strong>;
ERROR 1235 (42000): This version of MySQL doesn't yet support 'alter table sakila.rental add index(return_date), algorithm=inplace, lock=none'
node1 (sakila) &gt; alter table sakila.rental <strong>add column c char</strong>, algorithm=inplace, lock=<strong>none</strong>;
ERROR 1235 (42000): This version of MySQL doesn't yet support 'alter table sakila.rental add column c char, algorithm=inplace, lock=none'</pre>
</blockquote>
<p>So I&#8217;m not sure as yet what kind of DDL operations are available with <strong>LOCK=NONE</strong>.</p>
<h4>Conclusion</h4>
<p>Little success with online DDL. SHARED-only is many times as good as completely blocked.</p>
<p>My personal conclusion is (and I do take into account <strong>5.6</strong> is RC at this time, not GA): <em>not there yet!</em> Stick to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/introduction.html">openark-kit</a>, <a href="http://www.percona.com/doc/percona-toolkit/2.1/">Percona-toolkit</a> or <a href="http://www.facebook.com/notes/mysql-at-facebook/online-schema-change-for-mysql/430801045932">Facebook OSC</a> for some time. They all provide with online-alter-table operations via external scripts.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/experimenting-with-5-6-innodb-online-ddl-bugs-included/feed</wfw:commentRss>
		<slash:comments>8</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5673</post-id>	</item>
		<item>
		<title>How common_schema split()s tables &#8211; internals</title>
		<link>https://shlomi-noach.github.io/blog/mysql/how-common_schema-splits-tables-internals</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/how-common_schema-splits-tables-internals#comments</comments>
				<pubDate>Thu, 06 Sep 2012 05:25:07 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[Indexing]]></category>
		<category><![CDATA[INFORMATION_SCHEMA]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[QueryScript]]></category>
		<category><![CDATA[scripts]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5035</guid>
				<description><![CDATA[This post exposes some of the internals, and the SQL behind QueryScript&#8217;s split. common_schema/QueryScript 1.1 introduces the split statement, which auto-breaks a &#8220;large&#8221; query (one which operates on large tables as a whole or without keys) into smaller queries, and executes them in sequence. This makes for easier transactions, less locks held, potentially (depending on [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>This post exposes some of the internals, and the SQL behind QueryScript&#8217;s <em>split</em>. <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">common_schema/QueryScript</a> <strong>1.1</strong> introduces the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script_split.html"><strong>split</strong></a> statement, which auto-breaks a &#8220;large&#8221; query (one which operates on large tables as a whole or without keys) into smaller queries, and executes them in sequence.</p>
<p>This makes for easier transactions, less locks held, potentially (depending on the user) more idle time released back to the database. <em>split<strong></strong></em> has similar concepts to <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> and <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archiver</a>, but works differently, and implemented entirely in SQL on server side.</p>
<p>Take the following statement as example:</p>
<blockquote>
<pre><strong>split</strong> (<strong>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR</strong>)
  pass;</pre>
</blockquote>
<p>It yields with (roughly) the following statements:</p>
<blockquote>
<pre>UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`inventory`.`inventory_id` &gt; '1')) OR ((`inventory`.`inventory_id` = '1'))) AND (((`inventory`.`inventory_id` &lt; '1000')) OR ((`inventory`.`inventory_id` = '1000'))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`inventory`.`inventory_id` &gt; '1000'))) AND (((`inventory`.`inventory_id` &lt; '2000')) OR ((`inventory`.`inventory_id` = '2000'))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`inventory`.`inventory_id` &gt; '2000'))) AND (((`inventory`.`inventory_id` &lt; '3000')) OR ((`inventory`.`inventory_id` = '3000'))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`inventory`.`inventory_id` &gt; '3000'))) AND (((`inventory`.`inventory_id` &lt; '4000')) OR ((`inventory`.`inventory_id` = '4000'))));
UPDATE sakila.inventory SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`inventory`.`inventory_id` &gt; '4000'))) AND (((`inventory`.`inventory_id` &lt; '4581')) OR ((`inventory`.`inventory_id` = '4581'))));</pre>
</blockquote>
<p>(I say &#8220;roughly&#8221; because internally there are user defined variables at play, but for convenience, I verbose the actual values as constants.)</p>
<h4>How does that work?</h4>
<p><em>common_schema</em> works on server side. There is no Perl script or anything. It must therefore use server-side operations to:</p>
<ul>
<li>Identify table to be split</li>
<li>Analyze the table in the first place, deciding how to split it</li>
<li>Analyze the query, deciding on how to rewrite it</li>
<li>Split the table (logically) into unique and distinct chunks</li>
<li>Work out the query on each such chunk</li>
</ul>
<p>Following is an internal look at how <em>common_schema</em> does all the above.<span id="more-5035"></span></p>
<h4>Identifying the table</h4>
<p>When query operates on a single table, <em>split</em> is able to parse the query&#8217;s SQL and find out that table. When multiple tables are involved, <em>split</em> requires user instruction: which table is it that the query should be split by?</p>
<h4>Analyzing the table</h4>
<p>Table analysis is done via a <em>similar</em> method to <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/candidate_keys_recommended.html">candidate_keys_recommended</a>. It is almost identical, only it uses <a href="http://dev.mysql.com/doc/refman/5.1/en/information-schema-optimization.html">INFORMATION_SCHEMA optimizations</a> to make the query short and lightweight. Simulating the analysis using <strong>candidate_keys_recommended</strong>, we get:</p>
<blockquote>
<pre>mysql&gt; select * from candidate_keys_recommended where table_name='inventory' \G
*************************** 1. row ***************************
          table_schema: sakila
            table_name: inventory
recommended_index_name: PRIMARY
          has_nullable: 0
            is_primary: 1
 count_column_in_index: 1
          column_names: inventory_id</pre>
</blockquote>
<p>This is cool, simple and very easy to work with: we choose to split the table via the <strong>inventory_id</strong> column, which is conveniently an integer. We&#8217;ll soon see <em>split</em> can handle complex cases as well.</p>
<h4>Analyzing the query</h4>
<p>This is done in part via Roland&#8217;s <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_analysis_routines.html">query_analysis_routines</a>, and in part just parsing the query, looking for <strong>WHERE</strong>,<strong> GROUP BY</strong>, <strong>LIMIT</strong> etc. clauses.</p>
<p>The nice part is injecting a <strong>WHERE</strong> condition, which didn&#8217;t appear in the original query. That <strong>WHERE</strong> condition is what limits the query to a distinct chunk of rows.</p>
<h4>Splitting the table</h4>
<p>With a single <strong>INTEGER PRIMARY KEY</strong> this sounds simple, right? Take rows <strong>1..1,000</strong>, then <strong>1,001..2,000</strong>, then <strong>2,001..3,000</strong> etc.</p>
<p>Wrong: even with this simple scenario, things are much more complex. Are the numbers successive? What if there are holes? What if there is a <strong>1,000,000</strong> gap between every two numbers? What if there are multiple holes of differing size and frequency?</p>
<p>And if we have two columns in our <strong>UNIQUE KEY</strong>? What if one of them is textual, not an <strong>INTEGER</strong>, the other a <strong>TIMESTAMP</strong>, not an <strong>INTEGER</strong> either?</p>
<p><em>split</em> doesn&#8217;t work in that naive way. It makes no assumptions on the density of values. It only requires:</p>
<ul>
<li>some <strong>UNIQUE KEY</strong> to work with,</li>
<li>which has no <strong>NULL</strong> values.</li>
</ul>
<p>Given the above, it uses <em>User Defined Variables</em> to setup the chunks. With our single <strong>INTEGER</strong> column, the minimum value is set like this:</p>
<blockquote>
<pre>select 
  inventory_id 
from 
  `sakila`.`inventory` 
order by 
  inventory_id ASC 
limit 1  
into @_split_column_variable_min_1
;</pre>
</blockquote>
<p>This sets the first value of the first chunk. What value terminates this chunk? It is calculated like this:</p>
<blockquote>
<pre>select 
  inventory_id 
from (
  select 
    inventory_id 
  from 
    `sakila`.`inventory` 
  where 
    (((`inventory`.`inventory_id` &gt; @_split_column_variable_range_start_1)) OR ((`inventory`.`inventory_id` = @_split_column_variable_range_start_1))) and (((`inventory`.`inventory_id` &lt; @_split_column_variable_max_1)) OR ((`inventory`.`inventory_id` = @_split_column_variable_max_1))) 
  order by 
    inventory_id ASC limit 1000 
  ) sel_split_range  
order by 
  inventory_id DESC 
limit 1  
into @_split_column_variable_range_end_1
;</pre>
</blockquote>
<p>Now there&#8217;s a query you wouldn&#8217;t want to work by hand, now would you?</p>
<p>The cool part here is that the above works well for any type of column; this doesn&#8217;t have to be an <strong>INTEGER</strong>. Dates, strings etc. are all just fine.</p>
<p>The above also works well for multiple columns, where the query gets more complicated (see following).</p>
<h4>Working out the query per chunk</h4>
<p>This part is the easy one, now that all the hard work is done. We know ho to manipulate the query, we know the lower and upper boundaries of the chunk, so we just fill in the values and execute.</p>
<h4>Multi-columns keys</h4>
<p>Consider a similar query on <strong>sakila.film_actor</strong>, where the <strong>PRIMARY KEY</strong> is a compound of two columns:</p>
<blockquote>
<pre>split (UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR)
  throttle 2;</pre>
</blockquote>
<p>The chunked queries will look like this:</p>
<blockquote>
<pre>UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '1')) OR ((`film_actor`.`actor_id` = '1') AND (`film_actor`.`film_id` &gt; '1')) OR ((`film_actor`.`actor_id` = '1') AND (`film_actor`.`film_id` = '1'))) AND (((`film_actor`.`actor_id` &lt; '39')) OR ((`film_actor`.`actor_id` = '39') AND (`film_actor`.`film_id` &lt; '293')) OR ((`film_actor`.`actor_id` = '39') AND (`film_actor`.`film_id` = '293'))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '39')) OR ((`film_actor`.`actor_id` = '39') AND (`film_actor`.`film_id` &gt; '293'))) AND (((`film_actor`.`actor_id` &lt; '76')) OR ((`film_actor`.`actor_id` = '76') AND (`film_actor`.`film_id` &lt; '234')) OR ((`film_actor`.`actor_id` = '76') AND (`film_actor`.`film_id` = '234'))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '76')) OR ((`film_actor`.`actor_id` = '76') AND (`film_actor`.`film_id` &gt; '234'))) AND (((`film_actor`.`actor_id` &lt; '110')) OR ((`film_actor`.`actor_id` = '110') AND (`film_actor`.`film_id` &lt; '513')) OR ((`film_actor`.`actor_id` = '110') AND (`film_actor`.`film_id` = '513'))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '110')) OR ((`film_actor`.`actor_id` = '110') AND (`film_actor`.`film_id` &gt; '513'))) AND (((`film_actor`.`actor_id` &lt; '146')) OR ((`film_actor`.`actor_id` = '146') AND (`film_actor`.`film_id` &lt; '278')) OR ((`film_actor`.`actor_id` = '146') AND (`film_actor`.`film_id` = '278'))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '146')) OR ((`film_actor`.`actor_id` = '146') AND (`film_actor`.`film_id` &gt; '278'))) AND (((`film_actor`.`actor_id` &lt; '183')) OR ((`film_actor`.`actor_id` = '183') AND (`film_actor`.`film_id` &lt; '862')) OR ((`film_actor`.`actor_id` = '183') AND (`film_actor`.`film_id` = '862'))));
UPDATE sakila.film_actor SET last_update = last_update + INTERVAL 6 HOUR <strong>WHERE</strong> ((((`film_actor`.`actor_id` &gt; '183')) OR ((`film_actor`.`actor_id` = '183') AND (`film_actor`.`film_id` &gt; '862'))) AND (((`film_actor`.`actor_id` &lt; '200')) OR ((`film_actor`.`actor_id` = '200') AND (`film_actor`.`film_id` &lt; '993')) OR ((`film_actor`.`actor_id` = '200') AND (`film_actor`.`film_id` = '993'))));</pre>
</blockquote>
<p>View the complete command to realize just how much more complex each query is, and how much more complex the chunking becomes. Here&#8217;s how I evaluate the chunk&#8217;s &#8220;next range end&#8221; variables:</p>
<blockquote>
<pre>select 
  actor_id, film_id 
from (
  select 
    actor_id, film_id 
  from 
    `sakila`.`film_actor` 
  where 
    (((`film_actor`.`actor_id` &gt; @_split_column_variable_range_start_1)) OR ((`film_actor`.
`actor_id` = @_split_column_variable_range_start_1) AND (`film_actor`.`film_id` &gt; @_split_column_variable_range_start_2))) and (((`film_actor`.`actor_id` &lt; @_split_column_variable_max_1)) OR ((`film_actor`.`actor_id` = @_split_column_variable_max_1) AND (`film_actor`.`film_id` &lt; @_split_column_variable_max_2)) OR ((`film_actor`.`actor_id` = @_split_column_variable_max_1) AND (`film_actor`.`film_id` = @_split_column_variable_max_2))) 
  order by 
    actor_id ASC, film_id ASC 
  limit 1000 
  ) sel_split_range  
order by 
  actor_id DESC, film_id DESC 
limit 1  
into @_split_column_variable_range_end_1, @_split_column_variable_range_end_2
;</pre>
</blockquote>
<p>By the way, you may recall that everything is done server side. The <strong>WHERE</strong> condition for the chunked queries is in itself generated via SQL statement, and not too much by programmatic logic. Here&#8217;s <em>part</em> of the query which computes the limiting condition:</p>
<blockquote>
<pre>  select
    group_concat('(', partial_comparison, ')' order by n separator ' OR ') as comparison
  from (
    select 
      n,
      group_concat('(', column_name, ' ', if(is_last, comparison_operator, '='), ' ', variable_name, ')' order by column_order separator ' AND ') as partial_comparison
    from (
      select 
        n, CONCAT(mysql_qualify(split_table_name), '.', mysql_qualify(column_name)) AS column_name,
        case split_variable_type
          when 'range_start' then range_start_variable_name
          when 'range_end' then range_end_variable_name
          when 'max' then max_variable_name
        end as variable_name,
        _split_column_names_table.column_order, _split_column_names_table.column_order = n as is_last 
      from 
        numbers, _split_column_names_table 
      where 
        n between _split_column_names_table.column_order and num_split_columns 
      order by n, _split_column_names_table.column_order
    ) s1
    group by n
  ) s2
  into return_value
  ;</pre>
</blockquote>
<p>There is a lot of complexity to <em>split</em> to make it able to provide with as clean a syntax for the user as possible.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/how-common_schema-splits-tables-internals/feed</wfw:commentRss>
		<slash:comments>5</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5035</post-id>	</item>
		<item>
		<title>DELETE, don&#8217;t INSERT</title>
		<link>https://shlomi-noach.github.io/blog/mysql/delete-dont-insert</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/delete-dont-insert#comments</comments>
				<pubDate>Wed, 27 Jun 2012 05:25:09 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Performance]]></category>
		<category><![CDATA[QueryScript]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5008</guid>
				<description><![CDATA[Have just read INSERT, Don’t DELETE by Aaron Brown, and have some lengthy response, which is why I write this post instead of commenting on said post. I wish to offer my counter thought and suggest that DELETEs are probably the better choice. Aaron suggests that, when one wishes to purge rows from some table, [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>Have just read <a href="http://blog.9minutesnooze.com/insert-delete/">INSERT, Don’t DELETE</a> by Aaron Brown, and have some lengthy response, which is why I write this post instead of commenting on said post.</p>
<p>I wish to offer my counter thought and suggest that <strong>DELETE</strong>s are probably the better choice.</p>
<p>Aaron suggests that, when one wishes to purge rows from some table, a trick can be used: instead of <strong>DELETE</strong>ing unwanted rows, one can <strong>INSERT</strong> &#8220;good&#8221; rows into a new table, then switch over with <strong>RENAME</strong> (but please read referenced post for complete details).</p>
<p>I respectfully disagree on several points discussed.</p>
<h4>Lockdown</h4>
<p>The fact one needs to block writes during the time of creation of new table is problematic: you need to essentially turn off parts of your application. The posts suggests one could use a slave &#8211; but this solution is far from being trivial as well. To switch over, you yet again need to turn off access to DB, even if for a short while.<span id="more-5008"></span></p>
<p>A switch over to a slave is quite a big deal, in my opinion, for the mere purpose of deletion of rows.</p>
<h4>DELETEs are easy</h4>
<p>The DELETEs are so much easier: the first thing to note is the following: <em>You don&#8217;t actually have to delete all the rows *at once*</em>.</p>
<p>You just need to drop some rows, right? Why waste a huge transaction that takes minutes, when you can drop the rows by chunks, one at a time?<br />
For that, you can use either <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-archiver.html">pt-archive</a> from <em>Percona Toolkit</em>, <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-chunk-update.html">oak-chunk-update</a> from <em>openark-kit</em>, or write a simple <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a> code with <em>common_schema</em>:</p>
<blockquote>
<pre>while (DELETE FROM title WHERE title &lt;= 'g' LIMIT 1000)
{
  throttle 1;
}</pre>
</blockquote>
<p>So, drop <strong>1,000</strong> rows or so at a time, then sleep some time, etc. The total runtime is longer, but who cares? The impact can be reduced to be unnoticeable.</p>
<h4>Space reclaim</h4>
<p>You can use online table operations to rebuild your table and reclaim the disk space. Either see <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">oak-online-alter-table</a> or <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html">pt-online-schema-change</a>. Again, both work in small chunks, so no long stalls.</p>
<p>But more on this: my usual purge scenario shows that it is repetitive. You purge, data fills again, you purge again, and so on.</p>
<p>Which is why it doesn&#8217;t make much sense to rebuild the table and reclaim the disk space: it just grows again to roughly same dimensions.<br />
For a one time operation (e.g. after neglect of cleanup for long time) &#8212; yes, absolutely, do a rebuild and reclaim. For repetitive cleanup &#8211; I don&#8217;t bother.</p>
<h4>Conclusion</h4>
<p>Aaron does make note at the end of his post that <strong>DELETE</strong> operations can be done online, while the <strong>INSERT</strong> trick requires downtime, and this is a fair assessment.</p>
<p>But just to make a point: none of the <strong>DELETE</strong> timings are interesting. Since we are not concerned with deleting the rows in a given time (no &#8220;press the red button&#8221;), we can spread them over time and make the impact negligible. So not only is everything done online, it also goes unnoticed by the user. And this, I believe, is the major thing to consider.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/delete-dont-insert/feed</wfw:commentRss>
		<slash:comments>6</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5008</post-id>	</item>
		<item>
		<title>Webinar review: Zero-Downtime Schema Changes In MySQL</title>
		<link>https://shlomi-noach.github.io/blog/mysql/webinar-review-zero-downtime-schema-changes-in-mysql</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/webinar-review-zero-downtime-schema-changes-in-mysql#comments</comments>
				<pubDate>Thu, 03 May 2012 14:17:19 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[openark kit]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=4895</guid>
				<description><![CDATA[Yesterday I attended the Zero-Downtime Schema Changes In MySQL webinar by Baron Schwartz, Percona (do you say &#8220;attended&#8221; for something you listened to from your home office?) I was keen to learn about possible enhancements and improvements of pt-online-schema-change over oak-online-alter-table. Here are my impressions: The base logic of pt-online-schema-change is essentially the same as [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>Yesterday I attended the <a href="http://www.percona.com/webinars/2012-05-02-zero-downtime-schema-changes-in-mysql/">Zero-Downtime Schema Changes In MySQL</a> webinar by Baron Schwartz, Percona (<em>do you say &#8220;attended&#8221; for something you listened to from your home office?</em>)</p>
<p>I was keen to learn about possible enhancements and improvements of <a href="http://www.percona.com/doc/percona-toolkit/2.1/pt-online-schema-change.html">pt-online-schema-change</a> over <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-online-alter-table.html">oak-online-alter-table</a>. Here are my impressions:</p>
<p>The base logic of <em>pt-online-schema-change</em> is essentially the same as of <em>oak-online-alter-table</em>. You create a ghost/shadow table, create complex triggers, copy in chunks, freeze and swap. Both work on any type of <strong>PRIMARY KEY</strong> (<em>oak-online-alter-table</em> can work with any <strong>UNIQUE KEY</strong>, I&#8217;m not sure about <em>pt-online-schema-change</em> on this), be it an <strong>INTEGER</strong>, other type, or a multi column one.</p>
<p>However, <em>pt-online-schema-change</em> also adds the following:</p>
<ul>
<li>It supports <strong>FOREIGN KEY</strong>s (to some extent). This is something I&#8217;ve wanted to do with <em>oak-online-alter-table</em> but never got around to it. Foreign keys are very tricky, as Baron noted. With child-side keys, things are reasonably manageable. With parent-side this becomes a nightmare, sometimes unsolvable (when I say &#8220;unsolvable&#8221;, I mean that under the constraint of having the operation run in a non-blocking, transparent way).</li>
<li>Chunk size is auto-calculated by the script. This is a cool addition. Instead of letting the user throwing out numbers like <strong>1,000</strong> rows per chunk, in the hope that this is neither too small nor too large, the tool monitors the time it takes a chunk to complete, then adjusts the size of next chunk accordingly. Hopefully this leads to a more optimized run, where locks are only held for very short periods, yet enough rows are being processed at a time.</li>
<li>The tool looks into replicating slaves to verify they&#8217;re up to the job. If the slave lags too far, the tool slows down the work. This is an excellent feature, and again, one that I always wanted to have. Great work!</li>
</ul>
<p>So the three bullets above are what I understand to be the major advantages of Percona&#8217;s tool over <em>oak-online-alter-table</em>.</p>
<h4>Q &amp; A</h4>
<p>The presentation itself was very good, and Baron answered some questions. There was one question he did not answer during the webinar, nor here, and I though I may pop in and answer it. Although I can&#8217;t speak for the coders of <em>pt-online-schema-change</em>, I safely assume that since the logic follows that of <em>oak-online-alter-table</em>, the same answer applies in the case of Percona&#8217;s toolkit.<span id="more-4895"></span></p>
<p>But, first, a background question (asked and answered during the webinar):</p>
<p><strong>Q</strong>: What if my table already has <strong>AFTER TRIGGER</strong>s?</p>
<p><strong>A</strong>: Then this can&#8217;t work out. The table must not have triggers.</p>
<p>Which led to the next question:</p>
<p><strong>Q</strong>: Can&#8217;t the tool use <strong>BEFORE TRIGGER</strong>s instead?</p>
<p>Imagine a <strong>MyISAM</strong> table being altered to <strong>InnoDB</strong> (this is a major task for which my tool was built). Suppose we used a <strong>BEFORE</strong> trigger on an <strong>INSERT</strong>, but the <strong>INSERT</strong> failed. That would make the shadow table inconsistent with the original table. Which is the reason why the trigger must be an <strong>AFTER</strong> trigger.</p>
<p>With <strong>InnoDB</strong> this should not be an issue, since triggers and actions all play within the same transaction, so all succeed or all fail. I have this nagging feeling at the back of my head which says I&#8217;ve already had thoughts on this and have found a problem with <strong>InnoDB</strong> tables as well. I can&#8217;t put my finger on it now, so no comment on this one at this stage.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/webinar-review-zero-downtime-schema-changes-in-mysql/feed</wfw:commentRss>
		<slash:comments>1</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">4895</post-id>	</item>
		<item>
		<title>Documentation in SQL: CALL for help()</title>
		<link>https://shlomi-noach.github.io/blog/mysql/documentation-in-sql-call-for-help</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/documentation-in-sql-call-for-help#comments</comments>
				<pubDate>Wed, 11 Jan 2012 07:01:54 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[Development]]></category>
		<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[documentation]]></category>
		<category><![CDATA[mycheckpoint]]></category>
		<category><![CDATA[Open Source]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=4536</guid>
				<description><![CDATA[Documentation is an important part of any project. On the projects I maintain I put a lot of effort on documentation, and, frankly, the majority of time spent on my projects is on documentation. The matter of keeping the documentation faithful is a topic of interest. I&#8217;d like to outline a few documentation bundling possibilities, [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>Documentation is an important part of any project. On the projects I maintain I put a lot of effort on documentation, and, frankly, the majority of time spent on my projects is on documentation.</p>
<p>The matter of keeping the documentation faithful is a topic of interest. I&#8217;d like to outline a few documentation bundling possibilities, and the present the coming new documentation method for <a href="http://code.google.com/p/common-schema/" rel="nofollow">common_schema</a>. I&#8217;ll talk about any bundling that is NOT <em>man pages</em>.</p>
<h4>High level: web docs</h4>
<p>This is the initial method of documentation I used for <a title="openark kit" href="../../forge/openark-kit">openark kit</a> and <a title="mycheckpoint" href="../../forge/mycheckpoint">mycheckpoint</a>. It&#8217;s still valid for <em>mycheckpoint</em>. Documentation is web-based. You need Internet access to read it. It&#8217;s in HTML format.</p>
<p>Well, not exactly HTML format: I wrote it in WordPress. Yes, it&#8217;s HTML, but there&#8217;s a lot of noise around (theme, menus, etc.) which is not strictly part of the documentation.</p>
<p>While this is perhaps the easiest way to go, here&#8217;s a few drawbacks:<span id="more-4536"></span></p>
<ul>
<li>You&#8217;re bound to some framework (WordPress in this case)</li>
<li>Docs are split between MySQL database (my underlying WordPRess storage) &amp; WordPress files (themes, style, header, footer etc.)</li>
<li>Documentation is separate from your code &#8211; they&#8217;re just not in the same place</li>
<li>There is no version control over the documentation.</li>
</ul>
<p>The result is a single source of documentation, which applies to whatever version is latest. It&#8217;s impossible to maintain docs for multiple versions. You must manually synchronize your WordPress updates with code commits (or rather &#8211; code release!).</p>
<h4>Mid level: version controlled HTML docs</h4>
<p>I first saw this approach on Baron&#8217;s <a href="http://www.xaprb.com/blog/2010/09/22/aspersa-gets-a-user-manual/" rel="bookmark">Aspersa gets a user manual</a> post. I loved it: the documentation is HTML, but stored as part of your project&#8217;s code, in same version control.</p>
<p>This means one can <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/introduction.html">browse the documentation</a> (<em>openark kit</em> in this example) exactly as it appears in the baseline. Depending on your project hosting, one may be able to do so per version.</p>
<p>The approach has the great benefit of having the docs tightly coupled with the code in terms of development. Before committing code, one updates documentation for that code, then commits/releases both together.</p>
<p>You&#8217;re also not bound to any development framework. You may edit with <em>vim, emacs, gedit, bluefish, eclipse,</em> &#8230; any tool of your choice. It&#8217;s all down to plain old text files.</p>
<h4>Mid level #2: documentation bundling</h4>
<p>One thing I started doing with common_schema is to release a doc bundle with the code. So one can download a compressed bundle of all HTML files. That way one is absolutely certain what&#8217;s the right documentation for revision <strong>178</strong>. There&#8217;s no effort about it: the docs are already tightly coupled with code versions. Just compress and distribute.</p>
<h4>Low level: documentation coupled with your code</h4>
<p>Perl scripts can be written as Perl modules, in which case they are eligible for using the <em>perldoc</em> convention. You code your documentation within your script itself, as comment. <em>Perldoc</em> can extract the documentation and present in man-like format. Same happens with Python&#8217;s <em>pydoc</em>. Baron&#8217;s <a href="http://www.xaprb.com/blog/2011/11/07/when-documentation-is-code/" rel="bookmark">When documentation is code</a> illustrates that approach. <a href="http://www.maatkit.org/">Maatkit</a> (now <em>Percona Toolkit</em>) has been using it for years.</p>
<p>This method has the advantage of having the documentation ready right within your shell. You don&#8217;t need a browser, nor firewall access. The docs are just there for you in the same environment where you&#8217;re executing the code.</p>
<h4>SQL Low level: CALL for help()</h4>
<p><em>common_schema</em> is a different type of project. It is merely a schema. There&#8217;s no Perl nor Python. One imports the schema into one&#8217;s MySQL server.</p>
<p>What&#8217;s the low-level approach for this type of code?</p>
<p>For <em>common_schema</em> I use three levels of documentation: the mid-level, where one can <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/introduction.html">browse through the versioned docs</a>, the 2nd mid-level, where one can <a href="http://code.google.com/p/common-schema/downloads/list">download bundled documentation</a>, and then a low-level approach: documentation embedded within the code.</p>
<p>MySQL&#8217;s documentation is also built into the server: see the <strong>help_*</strong> tables within the <strong>mysql</strong> schema. The <em>mysql</em> command line client allows one to access help by supporting the help command, e.g.</p>
<blockquote>
<pre>mysql&gt; help create table;</pre>
</blockquote>
<p>The client intercepts this command (this is not server side command) and searches through the <strong>mysql.help_*</strong> docs.</p>
<p>With <em>common_schema</em>, I don&#8217;t have control over the client; it&#8217;s all on server side. But the code being a schema, what with stored routines and tables, it&#8217;s easy enough to set up documentation.</p>
<p>As of the next version of <em>common_schema</em>, and following MySQL&#8217;s method, <em>common_schema</em> provides a <strong>help</strong> table:</p>
<blockquote>
<pre>DESC help;
+--------------+-------------+------+-----+---------+-------+
| Field        | Type        | Null | Key | Default | Extra |
+--------------+-------------+------+-----+---------+-------+
| topic        | varchar(32) | NO   | PRI | NULL    |       |
| help_message | text        | NO   |     | NULL    |       |
+--------------+-------------+------+-----+---------+-------+</pre>
</blockquote>
<p>And a <strong>help()</strong> procedure, so that you can call for <em>help()</em>. The procedure will look for the best matching document based on your search expression:</p>
<blockquote>
<pre>root@mysql-5.1.51&gt; <strong>CALL help('match');</strong>
<strong>+---------------------------------------</strong>----------------------------------------+
| help                                                                          |
+-------------------------------------------------------------------------------+
|                                                                               |
| NAME                                                                          |
|                                                                               |
| match_grantee(): Match an existing account based on user+host.                |
|                                                                               |
| TYPE                                                                          |
|                                                                               |
| Function                                                                      |
|                                                                               |
| DESCRIPTION                                                                   |
|                                                                               |
| MySQL does not provide with identification of logged in accounts. It only     |
| provides with user + host:port combination within processlist. Alas, these do |
| not directly map to accounts, as MySQL lists the host:port from which the     |
| connection is made, but not the (possibly wildcard) user or host.             |
| This function matches a user+host combination against the known accounts,     |
| using the same matching method as the MySQL server, to detect the account     |
| which MySQL identifies as the one matching. It is similar in essence to       |
| CURRENT_USER(), only it works for all sessions, not just for the current      |
| session.                                                                      |
|                                                                               |
| SYNOPSIS                                                                      |
|                                                                               |
|                                                                               |
|                                                                               |
|        match_grantee(connection_user char(16) CHARSET utf8,                   |
|        connection_host char(70) CHARSET utf8)                                 |
|          RETURNS VARCHAR(100) CHARSET utf8                                    |
|                                                                               |
|                                                                               |
| Input:                                                                        |
|                                                                               |
| * connection_user: user login (e.g. as specified by PROCESSLIST)              |
| * connection_host: login host. May optionally specify port number (e.g.       |
|   webhost:12345), which is discarded by the function. This is to support      |
|   immediate input from as specified by PROCESSLIST.                           |
|                                                                               |
|                                                                               |
| EXAMPLES                                                                      |
|                                                                               |
| Find an account matching the given use+host combination:                      |
|                                                                               |
|                                                                               |
|        mysql&gt; SELECT match_grantee('apps', '192.128.0.1:12345') AS            |
|        grantee;                                                               |
|        +------------+                                                         |
|        | grantee    |                                                         |
|        +------------+                                                         |
|        | 'apps'@'%' |                                                         |
|        +------------+                                                         |
|                                                                               |
|                                                                               |
|                                                                               |
| ENVIRONMENT                                                                   |
|                                                                               |
| MySQL 5.1 or newer                                                            |
|                                                                               |
| SEE ALSO                                                                      |
|                                                                               |
| processlist_grantees                                                          |
|                                                                               |
| AUTHOR                                                                        |
|                                                                               |
| Shlomi Noach                                                                  |
|                                                                               |
+-------------------------------------------------------------------------------+</pre>
</blockquote>
<p>I like HTML for documentation. I think it&#8217;s a good format, provided you don&#8217;t start doing funny things. Perhaps <em>TROFF</em> is more suitable; certainly more popular on Unix machines. But I already have everything in HTML. So, what do I do?</p>
<p>My decision was to keep documentation in HTML, and use the handy <em>html2text</em> tool to do the job. And it does it pretty well! The sample you see above is an automated translation of HTML to plain text.</p>
<p>I add a few touches of my own: SELECTing long texts is ugly, whether you do it via &#8220;<strong>;</strong>&#8221; or &#8220;<strong>\G</strong>&#8220;. The <strong>help()</strong> routine breaks the text by &#8216;<strong>\n</strong>&#8216;, returning a multi row result set. The above sample makes for some <strong>60+</strong> rows, nicely formatted, broken from the original single text appearing in the <strong>help</strong> table.</p>
<p>So now you have an internal help method for <em>common_schema</em>, right where the code is. You don&#8217;t have to leave the command line client in order to get help.</p>
<p><a href="http://datacharmer.blogspot.com/">Giuseppe</a> offered me the idea for this, even while my own thinking about it was in early stages.</p>
<p>The next version of <em>common_schema</em> will be available in a few weeks. The code is pretty much ready. I just need to work on, ahem&#8230;, the documentation.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/documentation-in-sql-call-for-help/feed</wfw:commentRss>
		<slash:comments>2</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">4536</post-id>	</item>
	</channel>
</rss>

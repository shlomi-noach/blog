<?xml version="1.0" encoding="UTF-8"?><rss version="2.0"
	xmlns:content="http://purl.org/rss/1.0/modules/content/"
	xmlns:wfw="http://wellformedweb.org/CommentAPI/"
	xmlns:dc="http://purl.org/dc/elements/1.1/"
	xmlns:atom="http://www.w3.org/2005/Atom"
	xmlns:sy="http://purl.org/rss/1.0/modules/syndication/"
	xmlns:slash="http://purl.org/rss/1.0/modules/slash/"
	
	xmlns:georss="http://www.georss.org/georss"
	xmlns:geo="http://www.w3.org/2003/01/geo/wgs84_pos#"
	>

<channel>
	<title>Stored routines &#8211; code.openark.org</title>
	<atom:link href="https://shlomi-noach.github.io/blog/tag/stored-routines/feed" rel="self" type="application/rss+xml" />
	<link>http://shlomi-noach.github.io/blog/</link>
	<description>Blog by Shlomi Noach</description>
	<lastBuildDate>Tue, 27 Dec 2016 16:45:41 +0000</lastBuildDate>
	<language>en-US</language>
	<sy:updatePeriod>
	hourly	</sy:updatePeriod>
	<sy:updateFrequency>
	1	</sy:updateFrequency>
	<generator>https://wordpress.org/?v=5.3.3</generator>
<site xmlns="com-wordpress:feed-additions:1">32412571</site>	<item>
		<title>Baffling 5.7 global/status variables issues, unclean migration path</title>
		<link>https://shlomi-noach.github.io/blog/mysql/baffling-5-7-globalstatus-variables-issues-unclean-migration-path</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/baffling-5-7-globalstatus-variables-issues-unclean-migration-path#comments</comments>
				<pubDate>Fri, 07 Aug 2015 12:39:59 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[Configuration]]></category>
		<category><![CDATA[INFORMATION_SCHEMA]]></category>
		<category><![CDATA[Monitoring]]></category>
		<category><![CDATA[New Features]]></category>
		<category><![CDATA[Opinions]]></category>
		<category><![CDATA[orchestrator]]></category>
		<category><![CDATA[performance_schema]]></category>
		<category><![CDATA[Security]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=7327</guid>
				<description><![CDATA[MySQL 5.7 introduces a change in the way we query for global variables and status variables: the INFORMATION_SCHEMA.(GLOBAL&#124;SESSION)_(VARIABLES&#124;STATUS) tables are now deprecated and empty. Instead, we are to use the respective performance_schema.(global&#124;session)_(variables&#124;status) tables. But the change goes farther than that; there is also a security change. Oracle created a pitfall of 2 changes at the same time: [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>MySQL <strong>5.7</strong> introduces a change in the way we query for global variables and status variables: the <strong>INFORMATION_SCHEMA.(GLOBAL|SESSION)_(VARIABLES|STATUS)</strong> tables are now deprecated and empty. Instead, we are to use the respective <strong>performance_schema.(global|session)_(variables|status)</strong> tables.</p>
<p>But the change goes farther than that; there is also a security change. Oracle created a pitfall of <strong>2</strong> changes at the same time:</p>
<ol>
<li>Variables/status moved to a different table</li>
<li>Privileges required on said table</li>
</ol>
<p>As an example, my non-root user gets:</p>
<blockquote>
<pre>mysql&gt; show session variables like 'tx_isolation';
ERROR 1142 (42000): SELECT command denied to user 'normal_user'@'my_host' for table 'session_variables'</pre>
</blockquote>
<p>Who gets affected by this? Nearly <em>everyone and everything</em>.</p>
<ul>
<li>Your Nagios will not be able to read status variables</li>
<li>Your ORM will not be able to determine session variables</li>
<li>Your replication user will fail connecting (see <a href="http://datacharmer.blogspot.nl/2015/08/mysql-578-features-bugs-and-rumors.html">this post by Giuseppe</a>)</li>
<li>And most everyone else.</li>
</ul>
<p>The problem with the above is that involves two unrelated changes to your setup, which are not entirely simple to coordinate:</p>
<ol>
<li>Change your app code to choose the correct schema (information_schema vs. performance_schema)</li>
<li><strong>GRANT</strong> the permissions on your database</li>
</ol>
<p>Perhaps at this point you still do not consider this to be a problem. You may be thinking: <em>well, let&#8217;s first prepare by creating the GRANTs, and once that is in place, we can, at our leisure, modify the code</em>.</p>
<p>Not so fast. Can you really that simply create those GRANTs?<span id="more-7327"></span></p>
<h3>Migration woes</h3>
<p>How do you migrate to a new MySQL version? You do not reinstall all your servers. You want an easy migration path, and that path is: introduce one or two slaves of a newer version, see that everything works to your satisfaction, slowly upgrade all your other slaves, eventually switchover/upgrade your master.</p>
<p>This should not be any different for <strong>5.7</strong>. We would like to provision a <strong>5.7</strong> slave in our topologies and just see that everything works. Well, we have, and things don&#8217;t just work. Our Nagios stops working for that <strong>5.7</strong> slave. <em>Orchestrator</em> started complaining (by this time I&#8217;ve <a href="https://github.com/outbrain/orchestrator/releases/tag/v1.4.291">already fixed it</a> to be more tolerant for the <strong>5.7</strong> problems so no crashes here).</p>
<p>I hope you see the problem by now.</p>
<blockquote><p>You cannot issue a <strong>GRANT SELECT ON performance_schema.global_variables TO &#8216;&#8230;&#8217;</strong> on your <strong>5.6</strong> master.</p></blockquote>
<p>The table simply does not exist there, which means the statement will not go to binary logs, which means it will not replicate on your <strong>5.7</strong> slave, which means you will not be able to <strong>SHOW GLOBAL VARIABLES</strong> on your slave, which means everything remains broken.</p>
<p>Yes, you can issue this directly on your <strong>5.7</strong> slaves. It&#8217;s <em>doable</em>, but <em>undesired</em>. It&#8217;s ugly in terms of automation (and will quite possibly break some assumptions and sanity checks your automation uses); in terms of validity testing. It&#8217;s unfriendly to GTID (make sure to <strong>SET SQL_LOG_BIN=0</strong> before that).</p>
<h3>WHY in the first place?</h3>
<p>It seems like a security thing. I&#8217;m not sure whether this was intended. So you prevent a <strong>SHOW GLOBAL VARIABLES</strong> for a normal user. Makes sense. And yet:</p>
<blockquote>
<pre>mysql&gt; show global variables like 'hostname';
ERROR 1142 (42000): SELECT command denied to user 'normal_user'@'my_host' for table 'global_variables'

mysql&gt; select @@global.hostname;
+---------------------+
| @@global.hostname   |
+---------------------+
| myhost.mydomain.com |
+---------------------+

mysql&gt; select @@version;
+--------------+
| @@version    |
+--------------+
| 5.7.8-rc-log |
+--------------+

</pre>
</blockquote>
<p>Seems like I&#8217;m allowed access to that info after all. So it&#8217;s not strictly a security design decision. For status variable, I admit, I don&#8217;t have a similar workaround.</p>
<h3>Solutions?</h3>
<p>The following are meant to be solutions, but do not really solve the problem:</p>
<ul>
<li><strong>SHOW</strong> commands. <strong>SHOW GLOBAL|SESSION VARIABLES|STATUS</strong> will work properly, and will implicitly know whether to provide the results via <strong>information_schema</strong> or <strong>performance_schema</strong> tables.
<ul>
<li>But, aren&#8217;t we meant to be happier with <strong>SELECT</strong> queries? So that I can really do stuff that is smarter than <strong>LIKE &#8216;variable_name%&#8217;</strong>?</li>
<li>And of course you cannot use <strong>SHOW</strong> in server side cursors. Your stored routines are in a mess now.</li>
<li>This does not solve the GRANTs problem.</li>
</ul>
</li>
<li><strong><a href="http://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_show_compatibility_56">show_compatibility_56</a></strong>: an introduced variable in <strong>5.7</strong>, boolean. It truly is a time-travel-paradox novel in disguise, in multiple respects.
<ul>
<li>Documentation introduces it, and says it is deprecated.
<ul>
<li>time-travel-paradox :O</li>
</ul>
</li>
<li>But it actually works in <strong>5.7.8</strong> (latest)
<ul>
<li>time-travel-paradox plot thickens</li>
</ul>
</li>
<li>Your automation scripts do not know in advance whether your MySQL has this variable
<ul>
<li>Hence <strong>SELECT @@global.show_compatibility_56</strong> will produce an error on <strong>5.6</strong></li>
<li>But the &#8220;safe&#8221; way of <strong>SHOW GLOBAL VARIABLES LIKE &#8216;show_compatibility_56&#8217;</strong> will fail on a privilege error on <strong>5.7</strong></li>
<li>time-travel-paradox :O</li>
</ul>
</li>
<li>Actually advised by my colleague Simon J. Mudd, <strong>show_compatibility_56</strong> defaults to <strong>OFF</strong>. I <em>support</em> this line of thought. Or else it&#8217;s <strong>old_passwords=1</strong> all over again.</li>
<li><strong>show_compatibility_56</strong> doesn&#8217;t solve the GRANTs problem.</li>
<li>This does not solve any migration path. It just postpones the moment when I will hit the same problem. When I flip the variable from <strong>&#8220;1&#8221;</strong> to <strong>&#8220;0&#8221;</strong>, I&#8217;m back at square one.</li>
</ul>
</li>
</ul>
<h3>Suggestion</h3>
<p>I claim security is not the issue, as presented above. I claim Oracle will yet again fall into the trap of no-easy-way-to-migrate-to-GTID in <strong>5.6</strong> if the current solution is unchanged. I claim that there have been too many changes at once. Therefore, I suggest one of the alternative two flows:</p>
<ol>
<li><strong>Flow 1</strong>: keep <strong>information_schema</strong>, later migration into <strong>performance_schema</strong>
<ul>
<li>In <strong>5.7</strong>, <strong>information_schema</strong> tables should still produce the data.</li>
<li>No security constraints on <strong>information_schema</strong></li>
<li>Generate WARNINGs on reading from <strong>information_schema</strong> (&#8220;&#8230;this will be deprecated&#8230;&#8221;)</li>
<li><strong>performance_schema </strong><em>also available</em>. With security constraints, whatever.</li>
<li>In <strong>5.8</strong> remove <strong>information_schema</strong> tables; we are left with <strong>performance_schema</strong> only.</li>
</ul>
</li>
<li><strong>Flow 2</strong>: easy migration into <strong>performance_schema</strong>:
<ul>
<li>In <strong>5.7</strong>, <strong>performance_schema</strong> tables should not require any special privileges. Any user can read from them.</li>
<li>Keep <strong>show_compatibility_56 </strong>as it is.</li>
<li><strong>SHOW</strong> commands choose between <strong>information_schema</strong> or <strong>performance_schema</strong> on their own &#8212; just as things are done now.</li>
<li>In <strong>5.8</strong>, <strong>performance_schema</strong> tables will require <strong>SELECT</strong> privileges.</li>
</ul>
</li>
</ol>
<p>As always, I love the work done by the engineers; and I love how they listen to the community.</p>
<p>Comments are most welcome. Have I missed the simple solution here? Are there even more complications to these features? Thoughts on my suggested two flows?</p>
<h3>[UPDATE 2015-08-19]</h3>
<p>Please <a href="http://www.tocker.ca/2015/08/18/a-followup-on-show_compatibility_56.html">see this followup</a> by Morgan Tocker of Oracle.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/baffling-5-7-globalstatus-variables-issues-unclean-migration-path/feed</wfw:commentRss>
		<slash:comments>5</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">7327</post-id>	</item>
		<item>
		<title>Why delegating code to MySQL Stored Routines is poor engineering practice</title>
		<link>https://shlomi-noach.github.io/blog/mysql/why-delegating-code-to-mysql-stored-routines-is-poor-engineering-practice</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/why-delegating-code-to-mysql-stored-routines-is-poor-engineering-practice#comments</comments>
				<pubDate>Thu, 06 Feb 2014 08:32:17 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[Development]]></category>
		<category><![CDATA[Opinions]]></category>
		<category><![CDATA[QueryScript]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6713</guid>
				<description><![CDATA[I happen to use stored routines with MySQL. In fact, my open source project common_schema heavily utilizes them. DBA-wise, I think they provide with a lot of power (alas, the ANSI:SQL 2003 syntax feels more like COBOL than a sane programming language, which is why I use QueryScript instead). However I wish to discuss the [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>I happen to use stored routines with MySQL. In fact, my open source project <a href="http://code.google.com/p/common-schema/">common_schema</a> heavily utilizes them. DBA-wise, I think they provide with a lot of power (alas, the ANSI:SQL 2003 syntax feels more like COBOL than a sane programming language, which is why I use <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a> instead).</p>
<p>However I wish to discuss the use of stored routines as integral part of your application code, which I discourage.</p>
<p>The common discussion on whether to use or not use stored routines typically revolves around data transfer (with stored routines you transfer less data since it&#8217;s being processed on server side), security (with stored routines you can obfuscate/hide internal datasets, and provide with limited and expected API) and performance (with MySQL this is not what you would expect, as routines are interpreted &amp; their queries re-evaluated, as opposed to other RDBMS you may be used to).</p>
<p>But I wish to discuss the use of stored routines from an engineering standpoint. The first couple of points I raise are cultural/behavioural.</p>
<h4>2nd grade citizens</h4>
<p>Your stored routines are not likely to integrate well with your IDE. While your Java/Scala/PHP/Ruby/whatnot code comfortably lies within your home directory, the stored routines live in their own space: a database container. They&#8217;re not as visible to you as your standard code. Your IDE is unaware of their existence and is unlikely to have the necessary plugin/state of mind to be able to view these.</p>
<p>This leads to difficulty in maintaining the code. People typically resort to using some SQL-oriented GUI tool such as MySQL Workbench, SequelPro or other, commercial tools. But these tools, while make it easy to edit your routine code, do not integrate (well?) with your source control. I can&#8217;t say I&#8217;ve used all GUI tools; but how many of them will have Git/SVN/Mercurial connectors? How many of them will keep local history changes once you edit a routine? I&#8217;m happy to get introduced to such a tool.</p>
<p>Even with such integration, you&#8217;re split between two IDEs. And if you&#8217;re the command line enthusiast, well, you can&#8217;t just <strong>svn ci -m &#8220;fixed my stored procedure bug&#8221;</strong>. Your code is simply not in your trunk directory.</p>
<p>It <em>can</em> be done. You <em>could</em> maintain the entire routine code from within your source tree, and hats off to all those who do it. Most will not. See later on about deployments for more on this.<span id="more-6713"></span></p>
<h4>Testing</h4>
<p>While engineers are keen on writing unit tests for every class and method they create, they are less keen on doing the same for stored routines. This is an observation, having seen many instalments. And I can tell you why: your stored routine testing will not integrate well with your JUnit/PHPUnit/&#8230;</p>
<p>There are testing frameworks for databases, and indeed I hacked my own mini unit testing code with <em>common_schema</em>. But it&#8217;s a <em>different</em> testing framework. You might also have realized by now that testing databases is somewhat different. It <em>can</em> be done, and hats off again to those that implement it as common practice. Many don&#8217;t. Database are often more heavyweight to test. Not all operations done by routines are easily rolled back, which leads to having to rebuild the entire dataset before tests. This in itself leads to longer test periods and a need for multiple test databases so as to allow for concurrent builds.</p>
<p>How many companies practice both version control and unit testing over their routine code? I believe not many (and am happy to hear about those who do). To be more direct, of all the companies I ever consulted to: <em>I have never seen one that does both</em>.</p>
<h4>Debugging</h4>
<p>MySQL stored routines do not have built in debugging capabilities. To debug your routines, you will have to use one of two methods:</p>
<ul>
<li>Simulate your routine code (ie mimic their execution on top of some interpreter). There are tools to do that. For me this is a complete NO GO and utterly untrustworthy. You can mimic what you think is how the routine should behave, but never they full behaviour. While developing <em>common_schema</em> I came upon plenty weird behaviour, some of it bugs, that you just can&#8217;t build into your emulation.</li>
<li>Inject debugging code into your routine code. I do that with <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">RDebug</a>. You can do breakpoints, step into, step out, most of the interesting stuff. Other tools do that as well. It is not the right way to go: you&#8217;re essentially modifying your code, placing more locks, communicating, and losing some functionality. It is a necessary evil solution for a necessary evil programming method&#8230; How good can that be?</li>
</ul>
<p>The right way to go would be to have debugging API built into the MySQL server.</p>
<p>But, wait, that would still be next to worthless, since our discussion is over programming with stored routines: letting your application call upon stored routines in your database. Until the day where I could use my IntelliJ debugger to step from my java method which calls upon a stored procedure, and into the stored procedure itself, debugging your code is completely detached from your stored routine debugging.</p>
<h4>Refactoring &amp; deploying</h4>
<p>Say you wanted to add a column to your table: you would go ahead and add it, and perhaps populate it. You would then modify your application code to support this new column, and deploy. Say you wanted to drop a table column. You would first deploy changes to your application code that ignore said column, and once the code is in place you would go and actually make the DROP.</p>
<p>How do you do the same with a stored routine? Support your routine accepts two parameters, and you wish to add a third?</p>
<p>There is no support for optional parameters. Your routine either accepts two parameters or three. Your application code will have to provide the exact number of parameters. You will have to deploy <em>both your SQL changes and your application changes at the same time</em>. This is by definition impossible, unless you are OK with a <em>stop the world approach</em>, which is unlikely in production.</p>
<h4>Code constraints</h4>
<p>One solution to the above is to create a new routines. Somehow &#8220;overload&#8221; it. But you can&#8217;t overload a stored routine; you&#8217;ll have to create a routine by a new name. This will allow you to slowly and smoothly migrate between the two.</p>
<p>Ahem, smoothly? How easy is it to find all invocations of a certain routines from your code? It will be typically lie in some String, or within some XML config file. There is no safe &#8220;find references to this procedure&#8221; IDE mechanism. There is no constraint in your IDE that will tell you &#8220;there is no such procedure&#8221; if you misspell the name.</p>
<h4>Trash bin</h4>
<p>Suppose you overcame the above. You now have two routines. You need to remember to DROP the old one, right? Will you?</p>
<p>When presenting <em>common_schema</em>, a common question I ask the audience is as follows:</p>
<blockquote><p>Suppose I accessed your database and listed the entire set of stored functions and procedures. How many of them are you not even sure are in use anymore? How many of them you think you can DROP, but are too afraid to, and keep them in <em>just in case</em>?</p></blockquote>
<p>I wouldn&#8217;t commonly ask that question had it not always provides a common nodding and smiling in the audience. People forget to drop their routines, and then forget about them, and are never sure whether they are used (your IDE doesn&#8217;t easily tell you that, remember? Sure, you can grep around; that&#8217;s not what most engineers would do). And those routines pile up to become trash.</p>
<h4>Data or code?</h4>
<p>Last but not least: a stored routine is a piece of code, right? Well, as far as the database is concerned, it&#8217;s really a piece of data. It&#8217;s located within a schema. It&#8217;s <em>stored</em>. It is an integral part of your data set: when you back up your <em>data</em>, you&#8217;re most likely to backup the <em>code</em> as well. When you restore, you&#8217;re likely to restore <em>both</em>. There are obvious advantages to that, DB-wise. Or should I say, DBA-wise. Engineering-wise? Does a database-restore operation count as code deployment? We can argue over beer.</p>
<h4>Final notes</h4>
<p>Having said all that: yes, I&#8217;m using an occasional stored routine. I see these occasions as a necessary evil, and sometimes it&#8217;s just the correct solution.</p>
<p>I&#8217;m happy to know what methods have been developed out there to overcome the above, please share; and please feel free to contradict the above.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/why-delegating-code-to-mysql-stored-routines-is-poor-engineering-practice/feed</wfw:commentRss>
		<slash:comments>11</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6713</post-id>	</item>
		<item>
		<title>common_schema &#038; openark-kit in the media: #DBHangOps, OurSQL</title>
		<link>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql#respond</comments>
				<pubDate>Wed, 26 Jun 2013 19:46:57 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[community]]></category>
		<category><![CDATA[INFORMATION_SCHEMA]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[Speaking]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6393</guid>
				<description><![CDATA[#DBHangOps I had the pleasure of joining into @DBHangOps today, and speak about common_schema and openark-kit. What was meant to be a 15 minute session turned to be 50 &#8212; sorry, people, I don&#8217;t talk as much at home, but when it comes to my pet projects&#8230; I also realized I was missing on a [&#8230;]]]></description>
								<content:encoded><![CDATA[<h4>#DBHangOps</h4>
<p>I had the pleasure of joining into <a href="https://twitter.com/DBHangops">@DBHangOps</a> today, and speak about <a href="https://code.google.com/p/common-schema/">common_schema</a> and <a href="http://code.google.com/p/openarkkit/">openark-kit</a>. What was meant to be a 15 minute session turned to be 50 &#8212; sorry, people, I don&#8217;t talk as much at home, but when it comes to my pet projects&#8230;</p>
<p>I also realized I was missing on a great event: DBHangOps is a hangout where you can chat and discuss MySQL &amp; related technologies with friends and colleagues, with whom you typically only meet at conferences. I will certainly want to attend future events.</p>
<p>Thanks to John Cesario and Geoffrey Anderson who invited me to talk, and to the friends and familiar faces who attended; I was happy to talk about my work, and very interested in hearing about how it&#8217;s being put to use. We also had time to discuss <a href="http://www.markleith.co.uk/ps_helper/">ps_helper</a> with no other than Mark Leith!</p>
<p>The video is <a href="https://twitter.com/DBHangops/status/349965939690835970">available on Twitter/YouTube</a>.</p>
<h4>OurSQL</h4>
<p><em>openark-kit</em> has also been <a href="http://technocation.org/content/oursql-episode-143%3A-biblical-tools">featured on the OurSQL podcast</a> by Sheeri &amp; Gerry, who did great coverage of some tools. I will disclose that more is to come; I&#8217;m happy this is in capable hands and look further to hear the next episode!</p>
<p>&nbsp;</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/common_schema-openark-kit-in-the-media-dbhangops-oursql/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6393</post-id>	</item>
		<item>
		<title>Taking common_schema&#8217;s rdebug to a test-drive</title>
		<link>https://shlomi-noach.github.io/blog/mysql/taking-common_schemas-rdebug-to-a-test-drive</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/taking-common_schemas-rdebug-to-a-test-drive#respond</comments>
				<pubDate>Tue, 09 Apr 2013 07:36:17 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[rdebug]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6211</guid>
				<description><![CDATA[This is a simple step-by-step introduction to rdebug: Debugger and Debugging API for MySQL Stored Routines, as part of common_schema. In other words: let me take you through the steps for debugging your stored routines on your own server. We will step into, step over, step out, modify variables, set a breakpoint, run to breakpoint&#8230; [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>This is a simple step-by-step introduction to <strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">rdebug</a>: Debugger and Debugging API for MySQL Stored Routines</strong>, as part of <a href="https://code.google.com/p/common-schema/">common_schema</a>.</p>
<p>In other words: let me take you through the steps for debugging your stored routines on your own server. We will step into, step over, step out, modify variables, set a breakpoint, run to breakpoint&#8230;</p>
<p>Command line geeks, this one&#8217;s for you. GUI lovers, this is actually an API; I am hoping for someone wrap it up with a plugin for your favorite GUI editor.</p>
<h4>Requirements:</h4>
<ul>
<li>Install <a href="https://code.google.com/p/common-schema/"><em>common_schema</em> 2.0</a> or above (at this time of writing <a href="https://shlomi-noach.github.io/blog/mysql/common_schema-2-0-0-alpha-rdebug-gpl">2.0.0-alpha is released</a>).</li>
<li>Get sample data &amp; routine file [download id=&#8221;4&#8243; format=&#8221;1&#8243;]</li>
<li>mysql&gt; <strong>SOURCE rdebug_demo.sql_.txt</strong>
<ul>
<li>You should now have a table called <strong>color_count</strong> in the test database, along with two routines: <strong>review_colors()</strong> and <strong>review_single_color()</strong>.</li>
</ul>
</li>
<li>Open two sessions. We call them the <em>debugger</em> session and the <em>worker</em> session. The <em>worker</em> session will execute the routine; the <em>debugger</em> session will control it.</li>
</ul>
<h4>Walk-through: preparation</h4>
<p>Walk this thing with me. We will alternate between the <em>debugger</em> and the <em>worker</em>.<span id="more-6211"></span></p>
<p><strong>1. worker session:</strong> get connection ID.</p>
<blockquote>
<pre><em><span style="color: #003300;">mysql [worker]&gt; <strong>select CONNECTION_ID();</strong>
+-----------------+
| CONNECTION_ID() |
+-----------------+
|            1234 |
+-----------------+</span></em></pre>
</blockquote>
<p>I&#8217;ll use <strong>1234</strong>, you will use whatever connection ID your worker has.</p>
<p><strong>2. debugger session:</strong> &#8220;compile&#8221; routine with debug info (this injects code into your routines).</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>use common_schema;</strong>
mysql [debugger]&gt; <strong>call rdebug_compile_routine('test', 'review_colors', true);</strong>
mysql [debugger]&gt; <strong>call rdebug_compile_routine('test', 'review_single_color', true);</strong></span></pre>
</blockquote>
<p>If you like, review the routines after compilation as follows:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_show_routine('test', 'review_colors');</strong>
+---------------------------------------------------------------------------------+
| `test`.`review_colors` breakpoints                                              |
+---------------------------------------------------------------------------------+
| begin                                                                           |
|   declare done bool default false;                                              |
|   declare current_color varchar(32) default null;                               |
|   declare current_count int unsigned;                                           |
|   declare color_cursor cursor for                                               |
|             select color_name, count from test.color_count order by color_name; |
|   declare continue handler for not found set done := true;                      |
|                                                                                 |
|   [:94]open color_cursor;                                                       |
|   [:100]cursor_loop: while not done do                                          |
|     [:112]fetch color_cursor into current_color, current_count;                 |
|     [:125]if done then                                                          |
|       [:132]leave cursor_loop;                                                  |
|     [:138]end if;                                                               |
|                                                                                 |
|     [:145]call review_single_color(current_color);                              |
|   [:154]end while;                                                              |
|   [:160]close color_cursor;                                                     |
| [:165]end                                                                       |
+---------------------------------------------------------------------------------+

mysql [debugger]&gt; <strong>call rdebug_show_routine('test', 'review_single_color');</strong>
+----------------------------------------------------------------+
| `test`.`review_single_color` breakpoints                       |
+----------------------------------------------------------------+
| begin                                                          |
|   [:4]set @review_message := concat(color_name, ' is pretty'); |
|   [:20]select @review_message;                                 |
| [:25]end                                                       |
+----------------------------------------------------------------+
</span></pre>
</blockquote>
<p>The above shows the routine code with symbolic breakpoint IDs.</p>
<h4>Walk-through &#8211; start debugging</h4>
<p><strong>3. debugger session:</strong> Start a debug session, attach to <i>worker</i> session using its connection ID:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_start(1234);</strong></span></pre>
</blockquote>
<p>Replace <strong>1234</strong> with your own worker&#8217;s connection ID as read above.</p>
<p>Let&#8217;s set verbose mode on; more fun on command line, less typing.</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_set_verbose(true);</strong></span></pre>
</blockquote>
<p>And step into it!</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_step_into();</strong></span></pre>
</blockquote>
<p>This should hang the debugger. Why? Because it&#8217;s stepping into, and is expecting the worker to actually do something.</p>
<p><strong>4. worker session:</strong> execute routine</p>
<blockquote>
<pre><span style="color: #003300;"><em>mysql [worker]&gt; <strong>call test.review_colors();</strong></em></span></pre>
</blockquote>
<h4>Walk-through &#8211; debug</h4>
<p>The debugger session should immediately follow with the following (all by <strong>entry_time</strong> should be identical to your output):</p>
<blockquote>
<pre><span style="color: #000080;">+-------------+----------------+---------------+--------------+---------------------+</span>
<span style="color: #000080;">| stack_level | routine_schema | routine_name  | statement_id | entry_time          |</span>
<span style="color: #000080;">+-------------+----------------+---------------+--------------+---------------------+</span>
<span style="color: #000080;">|           1 | test           | review_colors |           94 | 2013-04-08 15:41:28 |</span>
<span style="color: #000080;">+-------------+----------------+---------------+--------------+---------------------+</span>

<span style="color: #000080;">+----------------+---------------+---------------+---------------+----------------+</span>
<span style="color: #000080;">| routine_schema | routine_name  | variable_name | variable_type | variable_value |</span>
<span style="color: #000080;">+----------------+---------------+---------------+---------------+----------------+</span>
<span style="color: #000080;">| test           | review_colors | current_color | local         | NULL           |</span>
<span style="color: #000080;">| test           | review_colors | current_count | local         | NULL           |</span>
<span style="color: #000080;">| test           | review_colors | done          | local         | 0              |</span>
<span style="color: #000080;">+----------------+---------------+---------------+---------------+----------------+</span>

<span style="color: #000080;">+----------------+---------------+--------------+-------------------+</span>
<span style="color: #000080;">| routine_schema | routine_name  | statement_id | statement         |</span>
<span style="color: #000080;">+----------------+---------------+--------------+-------------------+</span>
<span style="color: #000080;">| test           | review_colors |           94 | open color_cursor |</span>
<span style="color: #000080;">+----------------+---------------+--------------+-------------------+</span></pre>
</blockquote>
<p>That&#8217;s the result of setting verbose mode. From here, if you&#8217;ve ever debugged code, the way is clear:</p>
<p><strong>5. debugger session:</strong> Step into a few more times:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_step_into();</strong>
mysql [debugger]&gt; <strong>call rdebug_step_into();</strong>
mysql [debugger]&gt; <strong>call rdebug_step_into();</strong>
...</span></pre>
</blockquote>
<p>Until the stack shows that you have entered the second routine: <strong>review_single_color():</strong></p>
<blockquote>
<pre><span style="color: #000080;">+-------------+----------------+---------------------+--------------+---------------------+</span>
<span style="color: #000080;">| stack_level | routine_schema | routine_name        | statement_id | entry_time          |</span>
<span style="color: #000080;">+-------------+----------------+---------------------+--------------+---------------------+</span>
<span style="color: #000080;">|           1 | test           | review_colors       |          145 | 2013-04-08 15:41:28 |</span>
<span style="color: #000080;">|           <strong>2</strong> | <strong>test</strong>           | <strong>review_single_color</strong> |           20 | 2013-04-08 15:45:23 |</span>
<span style="color: #000080;">+-------------+----------------+---------------------+--------------+---------------------+</span>

<span style="color: #000080;">+----------------+---------------------+-----------------+---------------+-----------------+</span>
<span style="color: #000080;">| routine_schema | routine_name        | variable_name   | variable_type | variable_value  |</span>
<span style="color: #000080;">+----------------+---------------------+-----------------+---------------+-----------------+</span>
<span style="color: #000080;">| test           | review_single_color | @review_message | user_defined  | green is pretty |</span>
<span style="color: #000080;">| test           | review_single_color | color_name      | param         | green           |</span>
<span style="color: #000080;">+----------------+---------------------+-----------------+---------------+-----------------+</span>

<span style="color: #000080;">+----------------+---------------------+--------------+------------------------+</span>
<span style="color: #000080;">| routine_schema | routine_name        | statement_id | statement              |</span>
<span style="color: #000080;">+----------------+---------------------+--------------+------------------------+</span>
<span style="color: #000080;">| test           | review_single_color |           20 | select @review_message |</span>
<span style="color: #000080;">+----------------+---------------------+--------------+------------------------+</span></pre>
</blockquote>
<p>You can further call <strong>rdebug_step_out()</strong> to leave this routine, <strong>rdebug_step_over()</strong> to avoid re-entry&#8230;</p>
<p><strong>6. debugger session:</strong> modify variables</p>
<p>Assuming you are inside the <strong>review_single_color()</strong> routine, would you like to modify a variable?</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_set_variable('color_name', 'A flower');</strong></span></pre>
</blockquote>
<p>Step over a few more times till the worker produces:</p>
<blockquote>
<pre><span style="color: #003300;"><em>+--------------------+</em></span>
<span style="color: #003300;"><em>| @review_message    |</em></span>
<span style="color: #003300;"><em>+--------------------+</em></span>
<span style="color: #003300;"><em>| A flower is pretty |</em></span>
<span style="color: #003300;"><em>+--------------------+</em></span></pre>
</blockquote>
<p>Continue playing with <strong>rdebug_step_into()</strong>, <strong>rdebug_step_over()</strong>, <strong>rdebug_step_out()</strong>.</p>
<p><strong>7. debugger session:</strong> setting a breakpoint</p>
<p>Based on the output of <strong>rdebug_show_routine(&#8216;test&#8217;, &#8216;review_colors&#8217;)</strong>, above, we now choose to set a non-conditional breakpoint, just before the statement <strong>call review_single_color(current_color)</strong>. That makes breakpoint ID <strong>145</strong>.</p>
<blockquote><p><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_set_breakpoint(&#8216;test&#8217;, &#8216;review_colors&#8217;, 145, NULL, true);</strong></span></p></blockquote>
<p><strong>8. debugger session:</strong> running up to a breakpoint<strong><br />
</strong></p>
<p>Now, let&#8217;s allow the worker to run until it reaches this breakpoint:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_run();</strong>
+-------------+----------------+---------------+--------------+---------------------+
| stack_level | routine_schema | routine_name  | statement_id | entry_time          |
+-------------+----------------+---------------+--------------+---------------------+
|           1 | test           | review_colors |          145 | 2013-04-08 15:41:28 |
+-------------+----------------+---------------+--------------+---------------------+

+----------------+---------------+---------------+---------------+----------------+
| routine_schema | routine_name  | variable_name | variable_type | variable_value |
+----------------+---------------+---------------+---------------+----------------+
| test           | review_colors | current_color | local         | white          |
| test           | review_colors | current_count | local         | 10             |
| test           | review_colors | done          | local         | 0              |
+----------------+---------------+---------------+---------------+----------------+

+----------------+---------------+--------------+-----------------------------------------+
| routine_schema | routine_name  | statement_id | statement                               |
+----------------+---------------+--------------+-----------------------------------------+
| test           | review_colors |          <strong>145</strong> | <strong>call review_single_color(current_color)</strong> |
+----------------+---------------+--------------+-----------------------------------------+</span></pre>
</blockquote>
<p>Run the above a few times: we always get back to the same statement. That is, until there&#8217;s nothing more to do and the routine leaves.</p>
<h4>Walk-through &#8211; stopping and cleanup</h4>
<p><strong>8. debugger session:</strong> Stop the debugging session:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_stop();</strong></span></pre>
</blockquote>
<p>You can start again via <strong>rdebug_start()</strong>. If, however, you&#8217;re no longer interested in debugging, you should remove debugging code from your routines:</p>
<blockquote>
<pre><span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_compile_routine('test', 'review_colors', false);</strong></span>
<span style="color: #000080;">mysql [debugger]&gt; <strong>call rdebug_compile_routine('test', 'review_single_color', false);</strong></span></pre>
</blockquote>
<h4>Conclusion</h4>
<p>This is most there is to it. Read the <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug_api.html"><strong>API</strong></a> for a complete list of functionality</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/taking-common_schemas-rdebug-to-a-test-drive/feed</wfw:commentRss>
		<slash:comments>0</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6211</post-id>	</item>
		<item>
		<title>common_schema 2.0.0-alpha: rdebug, GPL</title>
		<link>https://shlomi-noach.github.io/blog/mysql/common_schema-2-0-0-alpha-rdebug-gpl</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/common_schema-2-0-0-alpha-rdebug-gpl#comments</comments>
				<pubDate>Tue, 09 Apr 2013 06:03:06 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[Development]]></category>
		<category><![CDATA[Open Source]]></category>
		<category><![CDATA[rdebug]]></category>
		<category><![CDATA[Stored routines]]></category>
		<category><![CDATA[tools]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6203</guid>
				<description><![CDATA[A new release for common_schema: an alpha version of rdebug: MySQL Debugger and Debugging API is now included with common_schema. With a different license in mind for rdebug, common_schema changes license to GPL (2 or above). common_schema 2.0 is ready for download. All things rdebug, it is alpha &#8212; otherwise it&#8217;s a stable release. rdebug [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>A new release for <a href="https://code.google.com/p/common-schema/">common_schema</a>: an alpha version of <strong><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">rdebug</a>: MySQL Debugger and Debugging API</strong> is now included with <em>common_schema</em>.</p>
<p>With a different license in mind for <em>rdebug</em>, <em>common_schema</em> changes license to GPL (2 or above).</p>
<p><em>common_schema 2.0</em> is ready for <a href="http://code.google.com/p/common-schema/downloads/list">download</a>. All things <strong>rdebug</strong>, it is alpha &#8212; otherwise it&#8217;s a stable release.</p>
<h4>rdebug</h4>
<p>I&#8217;m very happy to release this alpha version of <em>rdebug</em>, and urge everyone to try it out.</p>
<p>The idea is to have an open, free, server side debugger and debugging API for MySQL stored routines. To elaborate:</p>
<ul>
<li>It&#8217;s server side by that it&#8217;s implemented by stored routines. Not by a connector; not an emulator; not a GUI tool hack. The entire functionality lies within common_schema, a schema in your server.</li>
<li>It&#8217;s a debugger: you can debug your own stored routines (with limitations)</li>
<li>It&#8217;s a <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug_api.html"><strong>debugging API</strong></a>: there&#8217;s a distinct specification and a set of calls which makes for a debugging process</li>
<li>It&#8217;s open since the source code is yours to browse.</li>
<li>It&#8217;s free as in free beer.</li>
<li>It&#8217;s free as it makes you independent of a specific debugger. It provides an API that anyone can use. You can run the API yourself from the command line; or plugins for your favorite GUI editor can be developed to use this API.</li>
</ul>
<p>On a separate blog post I will take you to a <em>rdebug</em> test drive.</p>
<p>As always, nothing is released before extensive <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/rdebug.html">documentation</a> is in place.</p>
<p>I&#8217;d love to get input on this.<span id="more-6203"></span></p>
<h4>GPL</h4>
<p><em>common_schema</em> &lt; <strong>2.0</strong> was released under the BSD license, which is less restrictive. I was pondering the BSD license for a couple years now, and with the arrival of <em>rdebug</em> have decided to switch to GPL. I&#8217;ve been through this thinking of change of license in other projects of mine; am generally agreeing that best not to change licensing throughout lifetime. I actually do see GPL as promoting open source software better than BSD, and with all the issues around GPL this actually means something to me. I write open source; I love people using it; I love people extending it; I want to be re-released as open source, or I want better control of the code.</p>
<p>So this turns out to be something that is important to me, and just before <em>common_schema</em> takes the world in storm (<strong>212</strong> downloads today, <strong>212,000,000</strong> tomorrow), I want to have this settled. If no storm comes, well, I&#8217;ll have up to <strong>212</strong> people banging on my door (I provide free coffee).</p>
<h4>Text routines</h4>
<p>Two text routines are added:</p>
<ul>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/replace_sections.html"><strong>replace_sections()</strong></a>: replace a text given a from-to combination, and a replacement string, which could include a back-reference. For example:</li>
</ul>
<blockquote>
<pre>mysql&gt; select replace_sections(<strong>'The <span style="color: #000080;">&lt;b&gt;</span>quick<span style="color: #000080;">&lt;/b&gt;</span> brown <span style="color: #000080;">&lt;b&gt;</span>fox<span style="color: #000080;">&lt;/b&gt;</span>'</strong>, 
        <strong>'<span style="color: #000080;">&lt;b&gt;</span>'</strong>, <span style="color: #000080;"><strong>'&lt;/b&gt;'</strong></span>, 
        <strong><span style="color: #800000;">'&lt;span&gt;\\0&lt;/span&gt;'</span></strong>) as result;
+-----------------------------------------------+
| result                                        |
+-----------------------------------------------+
| The <span style="color: #800000;">&lt;span&gt;quick&lt;/span&gt;</span> brown <span style="color: #800000;">&lt;span&gt;fox&lt;/span&gt;</span> |
+-----------------------------------------------+</pre>
</blockquote>
<ul>
<li><a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/hexcode_text.html"><strong>hexcode_text()</strong></a>: a convenience routine which shows a beautified hex-code of a given text. I get to need it when using UNICODE characters which are hard to detect, are visually identical to other characters, or are copied from MS Word.</li>
</ul>
<blockquote>
<pre>mysql&gt; <strong>call hexcode_text('the quick brown fox jumps over the lazy dog');</strong>
+-----------------------------------------------------------------------------------+
| &gt;0  1  2  3  4  5  6  7  8  9  a  b  c  d  e  f   0 1 2 3 4 5 6 7 8 9 a b c d e f |
+-----------------------------------------------------------------------------------+
| 74 68 65 20 71 75 69 63 6B 20 62 72 6F 77 6E 20   t h e   q u i c k   b r o w n   |
| 66 6F 78 20 6A 75 6D 70 73 20 6F 76 65 72 20 74   f o x   j u m p s   o v e r   t |
| 68 65 20 6C 61 7A 79 20 64 6F 67                  h e   l a z y   d o g           |
+-----------------------------------------------------------------------------------+</pre>
</blockquote>
<h4>Get it</h4>
<p><a href="https://code.google.com/p/common-schema/">Download <em>common_schema</em> here</a>.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/common_schema-2-0-0-alpha-rdebug-gpl/feed</wfw:commentRss>
		<slash:comments>1</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6203</post-id>	</item>
		<item>
		<title>MySQL Stored Routines Debugger &#038; Debugging API: sneak preview II, video</title>
		<link>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-ii-video</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-ii-video#comments</comments>
				<pubDate>Thu, 21 Mar 2013 09:15:03 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[debug]]></category>
		<category><![CDATA[rdebug]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6151</guid>
				<description><![CDATA[This is the 2nd sneak preview of common_schema&#8216;s rdebug: debugger &#38; debugging API for MySQL stored routines (see 1st preview here). rdebug will be released as part of common_schema, free and open sourced. In this sneak preview I present: Compiling multiple routines with debug info Starting/stopping a debug session Step-over, step-in, step-out Showing stack trace [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>This is the <strong>2nd</strong> sneak preview of <a href="http://code.google.com/p/common-schema">common_schema</a>&#8216;s <strong>rdebug</strong>: debugger &amp; debugging API for MySQL stored routines (<a href="https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-video">see <strong>1st</strong> preview here</a>).</p>
<p><em>rdebug</em> will be released as part of <em>common_schema</em>, free and open sourced.</p>
<p>In this sneak preview I present:</p>
<ul>
<li>Compiling multiple routines with debug info</li>
<li>Starting/stopping a debug session</li>
<li>Step-over, step-in, step-out</li>
<li>Showing stack trace</li>
<li>Showing the next-statement to execute</li>
<li>Viewing and manipulating local routine variables</li>
<li>Misc. meta routines</li>
</ul>
<h4>The quick technical overview</h4>
<p><em>rdebug</em> is a server-side mechanism, itself written in MySQL stored routines. It manipulates your routines by injecting debug code (easily removed afterwards).</p>
<p>To debug a routine you will need two connections: one is the debugging connection, and the other is the worker connection. The debugger connection attaches itself to the worker connection, where your routines execute.</p>
<p><em>rdebug</em> is controlled by an <strong>API</strong> of stored routines. This means any GUI tool may choose to use <em>rdebug</em> as its routine debugging mechanism. Your are not bound to a specific tool, a specific OS or framework. You may choose to invoke the API via command line, if you like; it&#8217;s all in your server.</p>
<h4>A video is worth a thousand blogs<span id="more-6151"></span></h4>
<p>The following video demonstrates the debugging process of two stored procedures, one invoking the other. This allows for step-in/over/out commands, stack trace analysis, and of course variable inspection and modification.</p>
<p>I can&#8217;t say I caught the hang of capturing my desktop and editing the movie (doing it one on Linux and once on Mac), so please excuse any poor quality video/sound.</p>
<div class="jetpack-video-wrapper"><iframe class='youtube-player' type='text/html' width='640' height='360' src='https://www.youtube.com/embed/ynqLmK77XjE?version=3&#038;rel=1&#038;fs=1&#038;autohide=2&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' allowfullscreen='true' style='border:0;'></iframe></div>
<p>The code is not yet released, but will be, shortly, under an open source license.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-ii-video/feed</wfw:commentRss>
		<slash:comments>3</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6151</post-id>	</item>
		<item>
		<title>MySQL Stored Routines Debugger &#038; Debugging API: sneak preview video</title>
		<link>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-video</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-video#comments</comments>
				<pubDate>Tue, 19 Feb 2013 09:32:27 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[debug]]></category>
		<category><![CDATA[Stored routines]]></category>
		<category><![CDATA[video]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=6086</guid>
				<description><![CDATA[This is a sneak peek video introduction/preview of an in-development free and open source server side debugger &#38; debugging API for MySQL stored routines. MySQL does not provide server side debugging capabilities for stored routines. Some tools exist, including MySQL&#8217;s own, that assist in stored routine debugging. These are all GUI based and, to the [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>This is a sneak peek video introduction/preview of an in-development free and open source server side debugger &amp; debugging API for MySQL stored routines.</p>
<p>MySQL does not provide server side debugging capabilities for stored routines. Some tools exist, including MySQL&#8217;s own, that assist in stored routine debugging. These are all GUI based and, to the best of my knowledge, MS Windows based. There is one solution in alpha stage that is developed for Java/eclipse; I did not look at the code. See discussion <a href="http://www.xaprb.com/blog/2012/11/01/stored-procedure-debugging-in-mysql/">here</a> and <a href="http://blog.webyog.com/2011/12/06/debugging-stored-programs-in-mysql/">here</a>.</p>
<p>An ideal solution would be to have debugging API in the server itself &#8211; independently of your client, programming language or operating system. To the best of my knowledge, nothing like that is being developed.</p>
<p>I&#8217;m now presenting a <strong>rdebug</strong>: a stored routines server-side debugger, Pure-SQL, based on stored routines. <em>rdebug</em> is developed as part of <a href="http://code.google.com/p/common-schema">common_schema,</a> and actually relies on some of its power.</p>
<p>Like some other tools, it uses code injection and manipulation: it injects debugging info into your stored routine. You need to &#8220;compile&#8221; your routine with debugging info.</p>
<p>Unlike some other tools, it actually runs your stored routines. It does not mimic or simulate them on client side. It does not break them into smaller routines, attempting to assemble the original behavior from lego bricks.</p>
<p><strong>The quick technical overview</strong> is that you use two processes (MySQL threads): the worker process running the routine (your natural <strong>call my_routine()</strong>), and the debugger process. The debugger process attaches itself to the worker process; it controls the worker by commands like <em>&#8220;step over&#8221;</em>; it gets data from the worker: what&#8217;s the current stack trace? What variables are now available and what are their values?; it manipulates the worker&#8217;s data: it can utilize breakpoints to modify worker&#8217;s local &amp; session variables.<span id="more-6086"></span></p>
<p>The debugger code is itself written with stored routines. Your own routines are analyzed by stored routine code. Stored routines inject code into your routine. Stored routines invoke and control the debugging progress. Stored routines manipulate your routine&#8217;s data. All access to the debugger is via (did I mention?) stored routines. This leads to <em>server-side</em> (alas not server-code) <em>debugger &amp; debugger API</em>: any tool, GUI or command line, can utilize these stored routine calls so as to implement a debugger.</p>
<p>Since the solution is written with stored routines &#8212; thus allowing you to debug your existing <strong>5.1</strong>, <strong>5.5</strong> &amp; <strong>5.6</strong> servers &#8212; it is also limited by what info can be retrieved by stored routines. One can view/modify local routine variables &amp; user defined variables, set breakpoints etc. One cannot get the &#8220;state of a cursor&#8221;, though, since no such info exists for a stored routine code.</p>
<p>having injected code operate from within your routine does mean a lot more actions are taken, like hidden <strong>INSERT</strong>s and <strong>UPDATE</strong>s. Calls to <strong>ROW_COUNT()</strong> and <strong>LAST_INSERT_ID()</strong> can be skewed. That&#8217;s a limitation I&#8217;m unsure as yet how to overcome; but not overcoming it won&#8217;t bring everything down as far as I&#8217;m concerned.</p>
<p>Some of the injected code calls upon dynamic SQL. This means at current stored functions are not possible to debug &#8211; just stored procedures. There&#8217;s a way around this for future development. There is no support for triggers, and I don&#8217;t expect there will be in the near future. No investigation into events as yet.<br />
<a name="video"></a></p>
<h4>A video is worth a thousand blogs</h4>
<p>Watch a live demo of debugging a simple routine; the demo presents a step-by-step debugging of a routine, listing, getting and setting variables.</p>
<div class="jetpack-video-wrapper"><iframe class='youtube-player' type='text/html' width='640' height='360' src='https://www.youtube.com/embed/yOCERssiHMA?version=3&#038;rel=1&#038;fs=1&#038;autohide=2&#038;showsearch=0&#038;showinfo=1&#038;iv_load_policy=1&#038;wmode=transparent' allowfullscreen='true' style='border:0;'></iframe></div>
<h4>What&#8217;s the status?</h4>
<p>What you&#8217;ve seen in the video is a first actual milestone &#8211; not a POC. Still need to implement nested stack level, step-in and step-out commands, conditional breakpoints, worker temporary table access from debugger process. Lot&#8217;s of stuff, but looking good.</p>
<p>This work is the result of a personal interest. All input, feedback, profound mistakes, feature requests, <em>&#8220;dude, there&#8217;s already a far better tool that does all that&#8221;</em> comments, questions &#8212; are welcome!</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/mysql-stored-routines-debugger-debugging-api-sneak-preview-video/feed</wfw:commentRss>
		<slash:comments>3</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">6086</post-id>	</item>
		<item>
		<title>common_schema over traditional scripts</title>
		<link>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts#comments</comments>
				<pubDate>Wed, 12 Dec 2012 11:55:44 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[openark kit]]></category>
		<category><![CDATA[python]]></category>
		<category><![CDATA[QueryScript]]></category>
		<category><![CDATA[scripts]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5509</guid>
				<description><![CDATA[If you are familiar with both openark kit and common_schema, you&#8217;ll notice I&#8217;ve incorporated some functionality already working in openark kit into common_schema, essentially rewriting what used to be a Python script into SQL/QueryScript. What was my reasoning for rewriting good code? I wish to explain that, and provide with a couple examples. I&#8217;m generally [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>If you are familiar with both <a href="http://code.openark.org/forge/openark-kit">openark kit</a> and <a href="http://code.google.com/p/common-schema">common_schema</a>, you&#8217;ll notice I&#8217;ve incorporated some functionality already working in <em>openark kit</em> into <em>common_schema</em>, essentially rewriting what used to be a Python script into SQL/<a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/query_script.html">QueryScript</a>.</p>
<p>What was my reasoning for rewriting good code? I wish to explain that, and provide with a couple examples.</p>
<p>I&#8217;m generally interested in pushing as much functionality into the MySQL server. When using an external script, one:</p>
<ul>
<li>Needs the right dependencies (OS, Perl/Python version, Perl/Python modules).</li>
<li>Needs to provide with connection params,</li>
<li>Needs to get acquainted with a lot of command line options,</li>
<li>Is limited by whatever command line options are provided.</li>
<li>Has to invoke that script (duh!) to get the work done.</li>
</ul>
<p>This last bullet is not so trivial: it means you can&#8217;t work some operation with your favorite GUI client, because it has no notion of your Perl script; does not run on the same machine where your Python code resides; simply can&#8217;t run those scripts for you.</p>
<p>With server-side code, functionality is accessible via any client. You run your operation via a query (e.g. <strong>CALL some_procedure</strong>). That can be done from your GUI client, your command line client, your event scheduler, your cronjob, all equally. You only need access to your MySQL server, which is trivial.</p>
<p>Of course, server side scripting is <a href="https://shlomi-noach.github.io/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine">limited</a>. Some stuff simply can&#8217;t be written solely on server side. If you want to consult your replicating slave; gracefully take action on user&#8217;s <strong>Ctrl+C</strong>, send data over the web, you&#8217;ll have to do it with an external tool. There are actually a lot of surprising limitations to things one would assume <em>are</em> possible on server side. You may already know how frustrated I am by the fact one can <a href="https://shlomi-noach.github.io/blog/mysql/reading-results-of-show-statements-on-server-side">hardly</a> get info from <strong>SHOW</strong> commands.</p>
<h4>But, when it works, it shines</h4>
<p>Let&#8217;s review a couple examples. The first one is nearly trivial. The second less so.<span id="more-5509"></span></p>
<h4>Example: getting AUTO_INCREMENT &#8220;free space&#8221;</h4>
<p><em>openark kit</em> offers <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-show-limits.html">oak-show-limits</a>. It&#8217;s a tool that tells you if any of your <strong>AUTO_INCREMENT</strong> columns are running out of space (and so you might want to <strong>ALTER</strong> that <strong>INT</strong> to <strong>BIGINT</strong>).</p>
<p>It&#8217;s a very simple Python script. It gets your <strong>MAX(auto_increment_column) FROM tables_with_auto_increment</strong>, and compares that <strong>MAX</strong> value to the column type. It pre-computes:</p>
<blockquote>
<pre>max_values['tinyint'] = 2**8
max_values['smallint'] = 2**16
max_values['mediumint'] = 2**24
max_values['int'] = 2**32
max_values['bigint'] = 2**64</pre>
</blockquote>
<p>takes care of <strong>SIGNED/UNSIGNED</strong>, and does the math. Why is this tool such a perfect candidate for <a href="http://common-schema.googlecode.com/svn/trunk/common_schema/doc/html/auto_increment_columns.html">replacement on server side</a>? For two reasons.</p>
<p>First, It turns out it takes very little effort to <a href="https://shlomi-noach.github.io/blog/mysql/checking-for-auto_increment-capacity-with-single-query">build a query</a> which does the same. In which case it is also easy to build a view which provides the same.</p>
<p>Second, there&#8217;s this thing with command line arguments. The <em>openark</em> tool provides with <strong>&#8211;threshold</strong> (only output those columns where capacity is larger than <strong>x%</strong>), <strong>&#8211;database</strong> (only scan given database), <strong>&#8211;table</strong> (only for tables matching name), <strong>&#8211;column</strong> (only for columns matching name).</p>
<p>I don&#8217;t like this. See, the above is essentially an extra layer for saying:</p>
<ul>
<li><strong>WHERE</strong> auto_increment_ratio &gt;= x</li>
<li><strong>WHERE</strong> table_schema = &#8230;</li>
<li><strong>WHERE</strong> table_name = &#8230;</li>
<li><strong>WHERE</strong> column_name = &#8230;</li>
</ul>
<p>The command line arguments each take the role of some <strong>WHERE/AND</strong> condition.Wow, what a <strong>1-1</strong> mapping. How about if I wanted the results sorted in some specific order? I would have to add a command line argument for that! How about only listing the <strong>SIGNED</strong> columns? I would have to add a command line argument for that, too! How about showing top <strong>10</strong>? Yes, another command line argument!</p>
<p>Some of the above can be solved via shell scripting (<strong>sort -k 3 -n</strong>, <strong>head -n 10</strong>, etc.). But, hey, we&#8217;re OK with SQL, aren&#8217;t we? Why add now these <em>two extra layers</em>? Get to know all the command line options, get to script it? I love scripting, but this is an abuse.</p>
<p>So it makes much more sense, in my opinion, to <strong>SELECT * FROM auto_increment_columns WHERE table_schema=&#8217;my_db&#8217; AND auto_increment_ratio &gt;= 0.8 ORDER BY auto_increment_ratio DESC LIMIT 10</strong>. It doesn&#8217;t require SQL-fu skills, just basic SQL skills which every DBA and DB user are expected to have. And it allows one to work from whatever environment one feels comfortable with. Heck, with your GUI editor you can probably get off with it by right-clicking and left-clicking your mouse buttons, never typing one character.</p>
<h4>Example: blocking user accounts</h4>
<p>The above mapped very easily to a query, and was just a read-only query. What if we had to modify data? <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-block-account.html">oak-block-accounts</a> is a tool which allows one to block grantees from logging in, then releasing them later on. <em>common_schema</em> offers <a href="common-schema.googlecode.com/svn/trunk/common_schema/doc/html/sql_accounts.html">sql_accounts</a> and <a href="file:///home/shlomi/workspace/common_schema/doc/html/eval.html">eval()</a>.</p>
<p>Let&#8217;s skip the command line arguments issue, as it is identical to the above. How should we best provide with &#8220;taking action&#8221; interface? A script would have no problem to first <strong>SELECT</strong> stuff, then <strong>UPDATE</strong>, or <strong>SET PASSWORD</strong>, or <strong>DROP</strong> etc. How easy is it to do the same on server side?</p>
<p>The immediate solution is to write a stored procedure to do that. I reject the idea. Why? Because the procedure would look like this:</p>
<blockquote>
<pre>PROCEDURE block_account(user VARCHAR(64), host VARCHAR(64), only_if_empty_password BOOL, ...);</pre>
</blockquote>
<p>Can you see where I&#8217;m getting at? Doing the above re-introduces command line options, this time disguised as procedure parameters. We would again have to list all available filtering methods, only this time things are worse: since stored procedures have no such notion as overloading, and change to the params will break compatibility. Once we introduce this routine, we&#8217;re stuck with it.</p>
<p><em>common_schema</em> tries to stay away as far as it can from this pitfall. It presents another solution: the <em>view</em> solution. Just as with <em>auto_increment_columns</em>, <strong>SELECT</strong> your way to get the right rows. But this time, the result is a SQL query:</p>
<blockquote>
<pre>mysql&gt; SELECT <strong>sql_block_account</strong> FROM <strong>sql_accounts</strong> <strong>WHERE USER = 'gromit'</strong>;
+-------------------------------------------------------------------------------------+
| sql_block_account                                                                   |
+-------------------------------------------------------------------------------------+
| SET PASSWORD FOR 'gromit'@'localhost' = '752AA50E562A6B40DE87DF0FA69FACADD908EA32*' |
+-------------------------------------------------------------------------------------+</pre>
</blockquote>
<p>Do your own <strong>WHERE</strong>/<strong>AND</strong> combination in SQL. But, how to take action? Our view cannot take the actual action for us!</p>
<p><em>eval()</em> is at the core of many common_schema operations, like this one:</p>
<blockquote>
<pre>CALL <strong>eval</strong>(<span style="color: #000080;">"SELECT <strong>sql_block_account</strong> FROM <strong>sql_accounts WHERE USER = 'gromit'</strong>"</span>);</pre>
</blockquote>
<p>The <strong>SET PASSWORD</strong> query just got evaluated. Meaning it was executed. <em>eval()</em> is a very powerful solution.</p>
<h4>Conclusion</h4>
<p>I prefer stuff on server side. It requires basic SQL skills (or a smart GUI editor), and allows you easy access to a lot of functionality, removing dependency requirements. It is not always possible, and external scripts can do miracles not possible on server side, but server side scripting has its own miracles.</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/common_schema-over-traditional-scripts/feed</wfw:commentRss>
		<slash:comments>2</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5509</post-id>	</item>
		<item>
		<title>Things that can&#8217;t (and some that can) be done from within a MySQL stored routine</title>
		<link>https://shlomi-noach.github.io/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine#comments</comments>
				<pubDate>Thu, 02 Aug 2012 04:32:57 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5163</guid>
				<description><![CDATA[I&#8217;m doing a lot of stored routine programming lately, working on common_schema. I&#8217;m in particular touching at the extremes of abilities. Some things just can&#8217;t be done from within a stored routine. Here&#8217;s a list of can&#8217;t be done: Cursor for SHOW statements: can&#8217;t be done &#8212; this is explicitly blocked from operating (it once [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>I&#8217;m doing a lot of stored routine programming lately, working on <a href="http://code.google.com/p/common-schema/">common_schema</a>. I&#8217;m in particular touching at the extremes of abilities. Some things just can&#8217;t be done from within a stored routine. Here&#8217;s a list of <strong>can&#8217;t be done</strong>:</p>
<ul>
<li>Cursor for <strong>SHOW</strong> statements: can&#8217;t be done &#8212; this is explicitly blocked from operating (it once used to work).</li>
<li>Get detailed error information on exceptions: apparently <strong>5.6</strong> has support for this. <strong>5.1</strong> and <strong>5.5</strong> <a href="https://shlomi-noach.github.io/blog/mysql/mysql-error-handling-on-server-side-a-no-go">do not</a>.</li>
<li>Change <strong>binlog_format</strong>: this is obvious, if you think about it. <strong>binlog_format</strong> dictates how the routine itself is replicated in the first place.</li>
<li>Set <strong>sql_log_bin</strong>. Again, this makes sense.</li>
<li>Work out different results depending on current machine. For example, you can&#8217;t have a routine that returns with <strong>&#8216;master&#8217;</strong> on the master and with <strong>&#8216;slave&#8217;</strong> on the slave. That is, not under <em>any condition</em>. Consider: if <em>Row Based Replication</em> is used, you don&#8217;t actually have a routine <em>executing</em> on the slave. I&#8217;m happy to be proven wrong on this.</li>
<li>Know what database was in use by calling code. The routine executes within the context of the database where it is defined. But you can&#8217;t tell what database was in use just a couple milliseconds before.</li>
<li>Likewise, know what <strong>sql_mode</strong> was in use by calling code. Stored routines have their own <strong>sql_mode</strong> &#8211; the one they were created with. No way to check up on the calling stack.</li>
<li>And you can&#8217;t <strong>USE</strong> another database (database as in <em>schema</em>). <strong>USE</strong> is a client command.</li>
<li>Reconnect after failure (kind of obvious, isn&#8217;t it?)</li>
<li>Connect to other servers (not so obvious to SQL Server DBAs). You can&#8217;t issue queries on other servers. Bummer.</li>
<li>Shutdown the server</li>
<li>Fork (you&#8217;re in a connection, you can&#8217;t issue a new connection from your own connection)</li>
</ul>
<p><span id="more-5163"></span>Well, some of the above can be solved using plugins or User Defined Functions, but I&#8217;m looking at standard servers.</p>
<h4>Things that can be done</h4>
<p>I can&#8217;t list anything that can be done from within a routine, but, to balance, here&#8217;s a brief list of things that <strong>can be done</strong>:</p>
<ul>
<li>Recover from errors (e.g. deadlocks) via <strong>DECLARE CONTINUE HANDLER</strong>.</li>
<li>Perform table operations (<strong>ANALYZE</strong>, <strong>OPTIMIZE</strong>, &#8230;) &#8211; though not read the results of these operations other than knowing they succeeded.</li>
<li>Perform all DDL statements (create/drop/modify views, routines, triggers, events, tables, users)</li>
<li>Modify session/global variables (<strong>group_concat_max_len</strong>, <strong>innodb_stats_on_metadata</strong>, &#8230;<code>)</code></li>
</ul>
<h4>You should be aware of</h4>
<ul>
<li><strong>max_sp_recursion_depth</strong>: the maximum recursion depth, if you&#8217;re thinking of recursions.</li>
<li><strong>thread_stack</strong>: I find that setting to <strong>256K</strong> makes a huge difference over the <strong>5.1</strong> default of <strong>192K</strong>. With <strong>192K</strong>, I frequently run into &#8220;out of stack space&#8221; problems. With <strong>256K</strong> &#8211; I have yet to encounter that. Dunno, some kind of magic number? This is my observation.</li>
</ul>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/things-that-cant-and-some-that-can-be-done-from-within-a-mysql-stored-routine/feed</wfw:commentRss>
		<slash:comments>9</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5163</post-id>	</item>
		<item>
		<title>MySQL error handling on server side: a NO GO!</title>
		<link>https://shlomi-noach.github.io/blog/mysql/mysql-error-handling-on-server-side-a-no-go</link>
				<comments>https://shlomi-noach.github.io/blog/mysql/mysql-error-handling-on-server-side-a-no-go#comments</comments>
				<pubDate>Wed, 18 Jul 2012 04:45:15 +0000</pubDate>
		<dc:creator><![CDATA[shlomi]]></dc:creator>
				<category><![CDATA[MySQL]]></category>
		<category><![CDATA[common_schema]]></category>
		<category><![CDATA[Errors]]></category>
		<category><![CDATA[information]]></category>
		<category><![CDATA[Stored routines]]></category>

		<guid isPermaLink="false">https://shlomi-noach.github.io/blog/?p=5082</guid>
				<description><![CDATA[There is no reasonable way to catch and diagnose errors on server side. It is nearly impossible to know exactly what went wrong. To illustrate, consider the following query: INSERT INTO my_table (my_column) VALUES (300); What could go wrong with this query? We might hit a UNIQUE KEY violation Or a FOREIGN KEY violation my_column [&#8230;]]]></description>
								<content:encoded><![CDATA[<p>There is no reasonable way to catch and diagnose errors on server side. It is nearly impossible to know exactly <em>what went wrong</em>.</p>
<p>To illustrate, consider the following query:</p>
<blockquote>
<pre>INSERT INTO my_table (my_column) VALUES (300);</pre>
</blockquote>
<p>What could go wrong with this query?</p>
<ul>
<li>We might hit a <strong>UNIQUE KEY</strong> violation</li>
<li>Or a <strong>FOREIGN KEY</strong> violation</li>
<li>my_column could be <strong>TINYINT UNSIGNED</strong>, and with strict <strong>sql_mode</strong> this makes for out-of-range</li>
<li>Or, similarly, it could be an <strong>ENUM (2,3,5,8)</strong></li>
</ul>
<p>Is that it? Not remotely:</p>
<ul>
<li>This could be a read-only <strong>MyISAM</strong> table</li>
<li>We may have issued a <strong>LOCK TABLES my_table READ</strong> &#8212; this violates our lock</li>
<li>Or this could be an <strong>InnoDB</strong> table, and this <strong>INSERT</strong> would make for a deadlock</li>
<li>Or we have <strong>read_only=1</strong> configuration</li>
<li>Or the user is not allowed access to this table</li>
<li>Or the table does not exist</li>
<li>Or the column does not exist</li>
</ul>
<p>Or&#8230; I&#8217;m pretty sure there could be many other issues.</p>
<p>Now, if I write a Java program, perhaps using Hibernate, I get the error nicely wrapped up in a SQLException object, with easy access to error code and error message.</p>
<p>But can I have the same on server side? <em>No</em>.</p>
<p>Take a look at the following code:<span id="more-5082"></span></p>
<blockquote>
<pre>CREATE PROCEDURE some_procedure ()
BEGIN
  DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET @error_found = 1;
  INSERT INTO my_table (my_column) VALUES (300);
  <strong>IF @error_found THEN -- Any what error exactly is this? What's the message? END IF;</strong>
END;</pre>
</blockquote>
<p>If I wanted to take specific action for specific errors, I would need to:</p>
<blockquote>
<pre>  DECLARE CONTINUE HANDLER FOR 1146 SET @error_found = 1146;
  DECLARE CONTINUE HANDLER FOR 1147 SET @error_found = 1147;
  DECLARE CONTINUE HANDLER FOR 1148 SET @error_found = 1148;
  DECLARE CONTINUE HANDLER FOR 1149 SET @error_found = 1149;
  ...</pre>
</blockquote>
<p>But if I can&#8217;t expect in advance the specific error, yet wish to note it down, that would mean defining hundreds and hundreds of HANDLERs, never being able to actually cover all cases since new codes are introduced in every version, sometimes in minor versions&#8230;</p>
<h4>Weren&#8217;t SINGAL and RESIGNAL introduced in 5.5?</h4>
<p>They were, but they do nothing to help here. You can <strong>RESIGNAL</strong> an error &#8211; but that doesn&#8217;t mean you get to be told what the error actually was!</p>
<h4>But, what&#8217;s the problem, anyway?</h4>
<p>There&#8217;s a variety of stuff I would like to do on server side, not via external Python/Perl/Java/Ruby/Shell scripts. Consider the <a href="http://dev.mysql.com/doc/refman/5.1/en/events.html">event scheduler</a>: I mean, what&#8217;s the point? It&#8217;s nearly useless if there&#8217;s so much that you cannot do on server side. You cannot recognize errors, you cannot get enough metadata (see below). It&#8217;s only good for a fraction of the jobs you would like to perform.</p>
<p>In <a href="http://code.google.com/p/common-schema/">common_schema/QueryScript</a> I provide with scripting capabilities. But how about error handling? I&#8217;ve written a completely different error handling approach in <em>common_schema</em> (this is not released yet, tons of documentation to produce). But since <em>common_schema</em> works on server side, it is limited to whatever server side programming allows. And this, as explained, is really very little to work with.</p>
<h4>What would have been nice</h4>
<p>There&#8217;s the <strong>error_count</strong> session variable. Doesn&#8217;t actually do anything useful. It would have been nice to have the following session STATUS VARIABLEs:</p>
<ul>
<li><strong>last_error_code</strong></li>
<li><strong>last_error_message</strong></li>
</ul>
<p>And if a query made for multiple errors, pick one (just make both variables consistent).</p>
<p>Or, <em>please</em>, make some way to parse <strong>SHOW</strong> commands on server side! (also refer to <a href="https://shlomi-noach.github.io/blog/mysql/reading-results-of-show-statements-on-server-side">this</a>). If only I could parse the <strong>SHOW ERRORS</strong> command, that would solve everything!</p>
<p>MySQL <strong>5.0</strong> introduced <strong>INFORMATION_SCHEMA</strong>, albeit an incomplete one. Shortly after, <strong>SHOW</strong> commands were excluded from server side cursors. But that left us with so many missing parts. I&#8217;ve opened a <a href="http://bugs.mysql.com/bug.php?id=65897">bug report/feature request</a>. Would you please support it?</p>
]]></content:encoded>
							<wfw:commentRss>https://shlomi-noach.github.io/blog/mysql/mysql-error-handling-on-server-side-a-no-go/feed</wfw:commentRss>
		<slash:comments>6</slash:comments>
						<post-id xmlns="com-wordpress:feed-additions:1">5082</post-id>	</item>
	</channel>
</rss>

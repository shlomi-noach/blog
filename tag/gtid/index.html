<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	

	<title>GTID – code.openark.org</title>
<link rel="dns-prefetch" href="//secure.gravatar.com">
<link rel="dns-prefetch" href="//s.w.org">



<link rel="stylesheet" id="wp-block-library-css" href="https://shlomi-noach.github.io/blog/wp-includes/css/dist/block-library/style.min.css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<link rel="stylesheet" id="wp-polls-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-css.css" media="all">
<style id="wp-polls-inline-css">
.wp-polls .pollbar {
	margin: 1px;
	font-size: 6px;
	line-height: 8px;
	height: 8px;
	background-image: url('https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/images/default/pollbg.gif');
	border: 1px solid #c8c8c8;
}

</style>
<link rel="stylesheet" id="openark-primer-style-css" href="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/style.css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/css/jetpack.css" media="all">
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery-migrate.min.js"></script>



<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<link rel="dns-prefetch" href="//v0.wordpress.com">


<meta property="og:type" content="website">
<meta property="og:title" content="GTID – code.openark.org">
<meta property="og:url" content="https://shlomi-noach.github.io/blog/tag/gtid">
<meta property="og:site_name" content="code.openark.org">
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg">
<meta property="og:locale" content="en_US">


<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(242,101,34,.88);}</style></head>

<body class="archive tag tag-gtid tag-113 hfeed no-sidebar">
<div id="page" class="site">
	<a class="skip-link screen-reader-text" href="#primary">Skip to content</a>

	<header id="masthead" class="site-header">
		<div class="site-branding">
							<p class="site-title"><a href="https://shlomi-noach.github.io/blog/" rel="home">code.openark.org</a></p>
								<p class="site-description">Blog by Shlomi Noach</p>
			
			<nav id="site-navigation" class="main-navigation">
				<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">primary-menu</button>
				<div class="menu-primary-menu-container"><ul id="menu-primary-menu" class="menu"><li id="menu-item-8109" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8109"><a href="https://shlomi-noach.github.io/blog/archives">archives</a></li>
<li id="menu-item-8050" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8050"><a href="https://shlomi-noach.github.io/blog/presentations">presentations</a></li>
<li id="menu-item-8055" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8055"><a href="https://shlomi-noach.github.io/blog/about">about</a></li>
<li id="menu-item-8071" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8071"><a href="https://github.com/shlomi-noach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li>
<li id="menu-item-8074" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8074"><a href="https://www.linkedin.com/in/shlominoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li>
<li id="menu-item-8072" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8072"><a href="https://twitter.com/ShlomiNoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a></li>
<li id="menu-item-8073" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8073"><a href="https://shlomi-noach.github.io/blog/feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-12.832 20c-1.197 0-2.168-.969-2.168-2.165s.971-2.165 2.168-2.165 2.167.969 2.167 2.165-.97 2.165-2.167 2.165zm5.18 0c-.041-4.029-3.314-7.298-7.348-7.339v-3.207c5.814.041 10.518 4.739 10.561 10.546h-3.213zm5.441 0c-.021-7.063-5.736-12.761-12.789-12.792v-3.208c8.83.031 15.98 7.179 16 16h-3.211z"></path></svg></a></li>
</ul></div>			</nav>
		</div>
	</header>

	<main id="primary" class="site-main">

		
			<header class="page-header">
				<h1 class="page-title">Tag: GTID</h1>			</header>

			
<article id="post-7974" class="post-7974 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/quick-hack-for-gtid_own-lack" rel="bookmark">Quick hack for GTID_OWN lack</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/quick-hack-for-gtid_own-lack" rel="bookmark"><time class="entry-date published updated" datetime="2019-12-11T10:00:00+02:00">December 11, 2019</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>One of the benefits of MySQL GTIDs is that each server remembers <em>all</em> GTID entries ever executed. Normally these would be ranges, e.g. <code>0041e600-f1be-11e9-9759-a0369f9435dc:1-3772242</code> or multi-ranges, e.g. <code>24a83cd3-e30c-11e9-b43d-121b89fcdde6:1-103775793, 2efbcca6-7ee1-11e8-b2d2-0270c2ed2e5a:1-356487160, 46346470-6561-11e9-9ab7-12aaa4484802:1-26301153, 757fdf0d-740e-11e8-b3f2-0a474bcf1734:1-192371670, d2f5e585-62f5-11e9-82a5-a0369f0ed504:1-10047</code>.</p>
<p>One of the common problems in asynchronous replication is the issue of consistent reads. I’ve just written to the <code>master</code>. Is the data available on a replica yet? We have iterated on this, from reading on <code>master</code>, to heuristically finding up-to-date replicas based on heartbeats (see <a href="https://www.youtube.com/watch?v=ZVBmTgIMOCA">presentation</a> and <a href="https://speakerdeck.com/shlominoach/monitoring-time-in-a-distributed-database-a-play-in-three-acts">slides</a>) via <a href="https://github.com/github/freno">freno</a>, and now settled, on some parts of our apps, to using GTID.</p>
<p>GTIDs are reliable as any replica can give you a definitive answer to the question: <em>have you applied a given transaction or not?</em>. Given a GTID entry, say <code>f7b781a9-cbbd-11e9-affb-008cfa542442:12345</code>, one may query for the following on a replica:</p>
<pre><code>mysql> select gtid_subset('f7b781a9-cbbd-11e9-affb-008cfa542442:12345', @@global.gtid_executed) as transaction_found;
+-------------------+
| transaction_found |
+-------------------+
|                 1 |
+-------------------+

mysql> select gtid_subset('f7b781a9-cbbd-11e9-affb-008cfa542442:123450000', @@global.gtid_executed) as transaction_found;
+-------------------+
| transaction_found |
+-------------------+
|                 0 |
+-------------------+
</code></pre>
<h3>Getting OWN_GTID</h3>
<p>This is all well, but, given some <code>INSERT</code> or <code>UPDATE</code> on the <code>master</code>, how can I tell what’s the GTID associated with that transaction? There\s good news and bad news.</p>
<ul>
<li>Good news is, you may <code>SET SESSION session_track_gtids = OWN_GTID</code>. This makes the MySQL protocol return the GTID generated by your transaction.</li>
<li>Bad news is, this isn’t a standard SQL response, and the common MySQL drivers offer you no way to get that information!</li>
</ul>
<p>At GitHub we author our own Ruby driver, and have implemented the functionality to extract <code>OWN_GTID</code>, much like you’d extract <code>LAST_INSERT_ID</code>. But, how does one solve that without modifying the drivers? Here’s a poor person’s solution which gives you an inexact, but good enough, info. Following a write (<code>insert</code>, <code>delete</code>, <code>create</code>, …), run:</p>
<pre><code>select gtid_subtract(concat(@@server_uuid, ':1-1000000000000000'), gtid_subtract(concat(@@server_uuid, ':1-1000000000000000'), @@global.gtid_executed)) as master_generated_gtid;
</code></pre>
<p>The idea is to “clean” the executed GTID set from irrelevant entries, by filtering out all ranges that do not belong to the server you’ve just written to (the <code>master</code>). The number <code>1000000000000000</code> stands for “high enough value that will never be reached in practice” – set to your own preferred value, but this value should take you beyond <code>300</code> years assuming <code>100,000</code> transactions per second.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/quick-hack-for-gtid_own-lack#more-7974" class="more-link">Continue reading »<span class="screen-reader-text"> “Quick hack for GTID_OWN lack”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/quick-hack-for-gtid_own-lack#respond">Leave a Comment<span class="screen-reader-text"> on Quick hack for GTID_OWN lack</span></a></span>	</footer>
</article>

<article id="post-7643" class="post-7643 post type-post status-publish format-standard hentry category-mysql tag-gh-ost tag-gtid tag-operations tag-opinions tag-replication tag-sql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/three-wishes-for-a-new-year-4" rel="bookmark">Three wishes for a new year</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gh-ost" rel="tag">gh-ost</a><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/operations" rel="tag">operations</a><a href="https://shlomi-noach.github.io/blog/tag/opinions" rel="tag">Opinions</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a><a href="https://shlomi-noach.github.io/blog/tag/sql" rel="tag">SQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/three-wishes-for-a-new-year-4" rel="bookmark"><time class="entry-date published updated" datetime="2016-09-28T16:20:54+02:00">September 28, 2016</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>(Almost) another new year by Jewish calendar. What do I wish for the following year?</p>
<ol>
<li>World peace</li>
<li>Good health to all</li>
<li>Relaxed GTID constraints</li>
</ol>
<p>I’m still not using GTID, and still see operational issues with working with GTID. As a latest example, our new schema migration solution, gh-ost, allows us to test migrations in production, on replicas. The GTID catch? <code>gh-ost</code> has to write something to the binary log. Thus, it “corrupts” the replica with a bogus GTID entry that will never be met in another server, thus making said replica unsafe to promote. We can work around this, but…</p>
<p>I understand the idea and need for the <code>Executed GTID Set</code>. It will certainly come in handy with multi-writer InnoDB Cluster. However for most use cases GTID poses a burden. The reason is that our topologies are imperfect, and we as humans are imperfect, and operations are most certainly imperfect. We may wish to operate on a replica: test something, by intention or mistake. We may wish to use a subchain as the seed for a new cluster split. We may wish to be able to write to downstream replicas. We may use a 3rd party tool that issues a <code>flush tables with read lock</code> without disabling <code>sql_log_bin</code>. Things just happen.</p>
<p>For that, I would like to suggest GTID control levels, such as:</p>
<ol>
<li><em>Strict</em>: same as Oracle’s existing implementation. Executed sets, purged sets, whatnot.</li>
<li><em>Last executed</em>: a mode where the only thing that counts is the last executed GTID value. If I repoint replica, all it needs to check is “hey this is my last executed GTID entry, give me the coordinates of yours. And, no, I don’t care about comparing executed and purged sets, I will trust you and keep running from that point on”</li>
<li><em>Declarative</em>: GTIDs are generated, are visible in each and every binary log entry, but are completely ignored.</li>
</ol>
<p>I realize Oracle MySQL GTID is out for some over 3 years now, but I’m sorry – I still have reservations and see use cases where I fear it will not serve me right.</p>
<p>How about my previous years wishes? World peace and good health never came through, however:</p>
<ul>
<li>My <a href="https://shlomi-noach.github.io/blog/mysql/three-wishes-for-a-new-year-2015">2015 wish</a> for “decent, operations friendly built in online table refactoring” was unmet, however <code>gh-ost</code> is a thing now and exceeds my expectations. No, really. Please come see <a href="https://www.percona.com/live/plam16/sessions/introducing-gh-ost-triggerless-painless-trusted-online-schema-migrations">Tom & myself present gh-ost</a> and how it changed our migration paradigm.</li>
<li>My <a href="https://shlomi-noach.github.io/blog/mysql/three-wishes-for-a-new-year-201">2012 wish</a> for “decent, long waited for, implementation of <a href="http://en.wikipedia.org/wiki/Window_function_%28SQL%29#Window_function">Window Functions</a> (aka Analytic Functions) for MySQL” was met by MariaDB’s <a href="https://mariadb.com/kb/en/mariadb/window-functions/">window functions</a>.<br>
Not strictly Window Functions, but Oracle MySQL 8.0 will <a href="http://mysqlserverteam.com/mysql-8-0-labs-recursive-common-table-expressions-in-mysql-ctes/">support CTE</a> (hierarchial/recursive), worth a mention.</li>
</ul>
<p>See you in Amsterdam!</p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/three-wishes-for-a-new-year-4#comments">2 Comments<span class="screen-reader-text"> on Three wishes for a new year</span></a></span>	</footer>
</article>

<article id="post-7046" class="post-7046 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-orchestrator tag-pseudo-gtid tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid" rel="bookmark">Refactoring replication topology with Pseudo GTID</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/pseudo-gtid" rel="tag">Pseudo GTID</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-23T12:37:17+02:00">October 23, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This post describes in detail the method of using Pseudo GTID to achieve unplanned replication topology changes, i.e. connecting two arbitrary slaves, or recovering from a master failure even as all its slaves are hanging in different positions.</p>
<p>Please read <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid">Pseudo GTID</a> and <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication">Pseudo GTID, RBR</a> as introduction.</p>
<p>Consider the following case: the master dies unexpectedly, and its three slaves are all hanging, not necessarily at same binary log file/position (network broke down while some slaves managed to salvage more entries into their relay logs than others)</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg"><img class="alignnone size-full wp-image-7059" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg" alt="orchestrator-failed-master" width="801" height="365" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg 801w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master-300x136.jpeg 300w" sizes="(max-width: 801px) 100vw, 801px"></a></p></blockquote>
<p>(Did you notice the <strong>“Candidate for master”</strong> message? To be discussed shortly)</p>
<h4>GTID</h4>
<p>With GTID each transaction (and entry in the binary log) is associated with a unique mark — the Global Transaction ID. Just pick the slave with the most advanced GTID to be the next master, and just <strong>CHANGE MASTER TO MASTER_HOST=’chosen_slave’</strong> on the other slaves, and everything magically works. A slave knows which GTID it has already processed, and can look that entry on its master’s binary logs, resuming replication on the one that follows.</p>
<p>How does that work? The master’s binary logs are searched for that GTID entry. I’m not sure how brute-force this is, since I’m aware of a subtlety which requires brute-force scan of all binary logs; I don’t actually know if it’s always like that.</p>
<h4>Pseudo GTID</h4>
<p>We can mimick that above, but our solution can’t be as fine grained. With the injection of Pseudo GTID we mark the binary log for unique entries. But instead of having a unique identifier for every entry, we have a unique identifier for every second, 10 seconds, or what have you, with otherwise normal, non-unique entries in between our Pseudo GTID entries.</p>
<h4>Recognizing which slave is more up to date</h4>
<p>Given two slaves, which is more up to date?</p>
<ul>
<li>If both replicate(d) from same master, a <strong>SHOW SLAVE STATUS</strong> comparison answers (safe method: wait till SQL thread catches up with broken IO thread, compare <strong>relay_master_log_file</strong>, <strong>exec_master_log_pos</strong> on both machines). This is the method by which the above “Candidate for master” message is produced.</li>
<li>If one is/was descendent of the other, then obviously it is less advanced or equals its ancestor.</li>
<li>Otherwise we’re unsure – still solvable via bi-directional trial & error, as explained later on.</li>
</ul>
<p>For now, let’s assume we know which slave is more up to date (has received and executed more relay logs). Let’s call it <strong>S1</strong>, whereas the less up-to-date will be <strong>S2</strong>. This will make our discussion simpler. <a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid#more-7046" class="more-link">Continue reading »<span class="screen-reader-text"> “Refactoring replication topology with Pseudo GTID”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid#comments">5 Comments<span class="screen-reader-text"> on Refactoring replication topology with Pseudo GTID</span></a></span>	</footer>
</article>

<article id="post-7043" class="post-7043 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication" rel="bookmark">Pseudo GTID, Row Based Replication</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-23T06:18:52+02:00">October 23, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This post continues <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid">Pseudo GTID</a>, in a series of posts describing an alternative to using MySQL GTIDs.</p>
<p>The solution offered in the last post does not work too well for row based replication. The binary log entries for the INSERT statement look like this:</p>
<blockquote>
<pre># at 1020
# at 1074
#141020 12:36:21 server id 1  end_log_pos 1074  Table_map: `test`.`pseudo_gtid` mapped to number 33
#141020 12:36:21 server id 1  end_log_pos 1196  Update_rows: table id 33 flags: STMT_END_F

BINLOG '
lddEVBMBAAAANgAAADIEAAAAACEAAAAAAAEABHRlc3QAC3BzZXVkb19ndGlkAAMDBw8CQAAE
lddEVBgBAAAAegAAAKwEAAAAACEAAAAAAAEAA///+AEAAACL10RUJDg2ZmRhMDk1LTU4M2MtMTFl
NC05NzYyLTNjOTcwZWEzMWVhOPgBAAAAlddEVCQ4Y2YzOWMyYy01ODNjLTExZTQtOTc2Mi0zYzk3
MGVhMzFlYTg=
'/*!*/;
</pre>
</blockquote>
<p>Where’s our unique value? Encoded within something that cannot be trusted to be unique. Issuing <strong>mysqlbinlog –verbose</strong> helps out:</p>
<blockquote>
<pre>BEGIN
/*!*/;
# at 183
# at 237
#141020 12:35:51 server id 1  end_log_pos 237   Table_map: `test`.`pseudo_gtid` mapped to number 33
#141020 12:35:51 server id 1  end_log_pos 359   Update_rows: table id 33 flags: STMT_END_F

BINLOG '
d9dEVBMBAAAANgAAAO0AAAAAACEAAAAAAAEABHRlc3QAC3BzZXVkb19ndGlkAAMDBw8CQAAE
d9dEVBgBAAAAegAAAGcBAAAAACEAAAAAAAEAA///+AEAAABt10RUJDc1MWJkYzEwLTU4M2MtMTFl
NC05NzYyLTNjOTcwZWEzMWVhOPgBAAAAd9dEVCQ3YjExZDQzYy01ODNjLTExZTQtOTc2Mi0zYzk3
MGVhMzFlYTg=
'/*!*/;
### UPDATE `test`.`pseudo_gtid`
### WHERE
###   @1=1
###   @2=1413797741
###   <strong>@3='751bdc10-583c-11e4-9762-3c970ea31ea8'</strong>
### SET
###   @1=1
###   @2=1413797751
###   @3='7b11d43c-583c-11e4-9762-3c970ea31ea8'</pre>
</blockquote>
<p>and that’s something we can work with. However, I like to do stuff from within MySQL, and rely as little as possible on external tools. How do the binary log entries look via <strong>SHOW BINLOG EVENTS</strong>? Not good.</p>
<blockquote>
<pre>master [localhost] {msandbox} (test) > show binlog events in 'mysql-bin.000058' limit 20;
+------------------+------+-------------+-----------+-------------+---------------------------------------+
| Log_name         | Pos  | Event_type  | Server_id | End_log_pos | Info                                  |
+------------------+------+-------------+-----------+-------------+---------------------------------------+
| mysql-bin.000058 |    4 | Format_desc |         1 |         107 | Server ver: 5.5.32-log, Binlog ver: 4 |
| mysql-bin.000058 |  107 | Query       |         1 |         183 | BEGIN                                 |
| mysql-bin.000058 |  183 | Table_map   |         1 |         237 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  237 | Update_rows |         1 |         359 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  359 | Xid         |         1 |         386 | COMMIT /* xid=5460 */                 |
| mysql-bin.000058 |  386 | Query       |         1 |         462 | BEGIN                                 |
| mysql-bin.000058 |  462 | Table_map   |         1 |         516 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  516 | Update_rows |         1 |         638 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  638 | Xid         |         1 |         665 | COMMIT /* xid=5471 */                 |
| mysql-bin.000058 |  665 | Query       |         1 |         741 | BEGIN                                 |
| mysql-bin.000058 |  741 | Table_map   |         1 |         795 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  795 | Update_rows |         1 |         917 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  917 | Xid         |         1 |         944 | COMMIT /* xid=5474 */                 |
| mysql-bin.000058 |  944 | Query       |         1 |        1020 | BEGIN                                 |
| mysql-bin.000058 | 1020 | Table_map   |         1 |        1074 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 | 1074 | Update_rows |         1 |        1196 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 | 1196 | Xid         |         1 |        1223 | COMMIT /* xid=5476 */                 |
| mysql-bin.000058 | 1223 | Query       |         1 |        1299 | BEGIN                                 |
| mysql-bin.000058 | 1299 | Table_map   |         1 |        1353 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 | 1353 | Update_rows |         1 |        1475 | table_id: 33 flags: STMT_END_F        |
+------------------+------+-------------+-----------+-------------+---------------------------------------+</pre>
</blockquote>
<p>The representation of row-format entries in the <strong>SHOW BINLOG EVENTS</strong> output is really poor. Why, there’s nothing to tell me at all about what’s been done, except that this is some operation on <strong>test.pseudo_gtid</strong>. Obviously I cannot find anything unique over here.</p>
<p>Not all is lost. How about DDL statements? Those are still written in SBR format (there’s no <em>rows</em> to log upon creating a table). A solution could be somehow manipulating a unique value in a DDL statement. There could be various such solutions, and I chose to use a <strong>CREATE VIEW</strong> statement, dynamically composed of a <strong>UUID()</strong>: <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication#more-7043" class="more-link">Continue reading »<span class="screen-reader-text"> “Pseudo GTID, Row Based Replication”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication#comments">2 Comments<span class="screen-reader-text"> on Pseudo GTID, Row Based Replication</span></a></span>	</footer>
</article>

<article id="post-7036" class="post-7036 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-orchestrator tag-pseudo-gtid tag-replic">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid" rel="bookmark">Pseudo GTID</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/pseudo-gtid" rel="tag">Pseudo GTID</a><a href="https://shlomi-noach.github.io/blog/tag/replic" rel="tag">replic</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid" rel="bookmark"><time class="entry-date published" datetime="2014-10-22T07:22:26+02:00">October 22, 2014</time><time class="updated" datetime="2015-08-20T10:39:26+02:00">August 20, 2015</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>Pseudo GTID is a method to implement a GTID-like solution where slaves are easily connected to one another. This blog post and the following ones will describe work in progress (some 80% completed), where simulation of GTID makes for a <em>good enough</em> basis for refactoring replication topologies. I’m coding this in <a href="https://github.com/outbrain/orchestrator">orchestrator</a>, which already provides a substantial infrastructure support for this.</p>
<p>The final goal: <em>orchestrator</em> will allow you to move a slave below another, using only the data available by those two slaves. The usage is obvious:</p>
<ul>
<li>Easy master failover (master dead? <em>Orchestrator</em> will choose the most advanced slave to promote <em>and</em> make it master of its siblings)</li>
<li>Slave promotion in complex topologies (with <a href="https://shlomi-noach.github.io/blog/mysql/using-deep-nested-replication-topologies">deep nested topologies</a>, be able to move a slave up the hierarchy even if its local master is corrupted).</li>
</ul>
<p>This can all happen with your normal, <em>non GTID</em>, MySQL replication, using your normal binary log files & positions.</p>
<p>This work in progress is inspired by <strong><a href="https://github.com/samlambert">Sam Lambert</a></strong> at GitHub, who has worked on a similar solution with different implementation. I also recall discussions with other DBAs having similar solution.</p>
<h4>Pseudo GTID</h4>
<p>First thing’s first, the basis for proposed solution is a <em>pseudo-GTID</em>. A unique entry in the binary logs (not necessarily sequential; not necessarily in ascending order). While in GTID implementations we have a unique identifier <em>for each entry</em> in the binary log, with pseudo-GTID we accept an <em>occasional</em> (or <em>frequent</em>) unique entry in the binary log.</p>
<p>There are many ways to do so. Certainly a client can generate a unique Id and invoke some statement on MySQL involving that ID. That would serve as valid grounds for the proposed solution. But I like things to be contained within MySQL. Consider, for example, the following event, which would be my preferred choice in Statement Based Replication (for RBR solution, see next post):</p>
<blockquote>
<pre>drop table if exists test.pseudo_gtid;
create table if not exists test.pseudo_gtid (
  id int unsigned not null primary key,
  ts timestamp,
  gtid varchar(64) charset ascii
);


drop event if exists test.update_pseudo_gtid_event;

delimiter ;;
create event if not exists
  test.update_pseudo_gtid_event
  on schedule every 10 second starts current_timestamp
  on completion preserve
  enable
  do
    begin
      set @pseudo_gtid := uuid();
      insert into test.pseudo_gtid (id, ts, gtid) values (1, NOW(), @pseudo_gtid) on duplicate key update ts=NOW(), gtid=VALUES(gtid);
    end
;;

delimiter ;</pre>
</blockquote>
<p>The above is based on <a title="Link to Making UUID() and RAND() replication safe" href="https://shlomi-noach.github.io/blog/mysql/making-uuid-and-rand-replication-safe" rel="bookmark">Making UUID() and RAND() replication safe</a>. What do we get? Once in 10 seconds (or what have you), a unique entry is written to the binary log.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid#more-7036" class="more-link">Continue reading »<span class="screen-reader-text"> “Pseudo GTID”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid#comments">1 Comment<span class="screen-reader-text"> on Pseudo GTID</span></a></span>	</footer>
</article>

	</main>


	<footer id="colophon" class="site-footer">
		<div class="site-info">
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
			<span class="sep"> | </span>
				Theme: <a href="http://openark.org">openark-primer</a> by <a href="http://underscores.me/">Underscores.me</a>.		</div>
	</footer>
</div>

	<div style="display:none">
	</div>
<script>
var pollsL10n = {"ajax_url":"https:\/\/shlomi-noach.github.io\/blog\/wp-admin\/admin-ajax.php","text_wait":"Your last request is still being processed. Please wait a while ...","text_valid":"Please choose a valid poll answer.","text_multiple":"Maximum number of choices allowed: ","show_loading":"1","show_fading":"1"};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-js.js"></script>
<script src="https://secure.gravatar.com/js/gprofiles.js?ver=2020Junaa"></script>
<script>
var WPGroHo = {"my_hash":""};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/modules/wpgroho.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/navigation.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/skip-link-focus-fix.js"></script>
<script type="text/javascript" src="https://stats.wp.com/e-202024.js" async="async" defer></script>
<script type="text/javascript">
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:8.2.1',blog:'32412571',post:'0',tz:'2',srv:'code.openark.org'} ]);
	_stq.push([ 'clickTrackerInit', '32412571', '0' ]);
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	

	<title>Replication – Page 4 – code.openark.org</title>
<link rel="dns-prefetch" href="//secure.gravatar.com">
<link rel="dns-prefetch" href="//s.w.org">



<link rel="stylesheet" id="wp-block-library-css" href="https://shlomi-noach.github.io/blog/wp-includes/css/dist/block-library/style.min.css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<link rel="stylesheet" id="wp-polls-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-css.css" media="all">
<style id="wp-polls-inline-css">
.wp-polls .pollbar {
	margin: 1px;
	font-size: 6px;
	line-height: 8px;
	height: 8px;
	background-image: url('https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/images/default/pollbg.gif');
	border: 1px solid #c8c8c8;
}

</style>
<link rel="stylesheet" id="openark-primer-style-css" href="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/style.css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/css/jetpack.css" media="all">
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery-migrate.min.js"></script>



<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<link rel="dns-prefetch" href="//v0.wordpress.com">


<meta property="og:type" content="website">
<meta property="og:title" content="Replication – Page 4 – code.openark.org">
<meta property="og:url" content="https://shlomi-noach.github.io/blog/tag/replication">
<meta property="og:site_name" content="code.openark.org">
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg">
<meta property="og:locale" content="en_US">


<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(242,101,34,.88);}</style></head>

<body class="archive paged tag tag-replication tag-8 paged-4 tag-paged-4 hfeed no-sidebar">
<div id="page" class="site">
	<a class="skip-link screen-reader-text" href="#primary">Skip to content</a>

	<header id="masthead" class="site-header">
		<div class="site-branding">
							<p class="site-title"><a href="https://shlomi-noach.github.io/blog/" rel="home">code.openark.org</a></p>
								<p class="site-description">Blog by Shlomi Noach</p>
			
			<nav id="site-navigation" class="main-navigation">
				<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">primary-menu</button>
				<div class="menu-primary-menu-container"><ul id="menu-primary-menu" class="menu"><li id="menu-item-8109" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8109"><a href="https://shlomi-noach.github.io/blog/archives">archives</a></li>
<li id="menu-item-8050" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8050"><a href="https://shlomi-noach.github.io/blog/presentations">presentations</a></li>
<li id="menu-item-8055" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8055"><a href="https://shlomi-noach.github.io/blog/about">about</a></li>
<li id="menu-item-8071" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8071"><a href="https://github.com/shlomi-noach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li>
<li id="menu-item-8074" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8074"><a href="https://www.linkedin.com/in/shlominoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li>
<li id="menu-item-8072" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8072"><a href="https://twitter.com/ShlomiNoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a></li>
<li id="menu-item-8073" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8073"><a href="https://shlomi-noach.github.io/blog/feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-12.832 20c-1.197 0-2.168-.969-2.168-2.165s.971-2.165 2.168-2.165 2.167.969 2.167 2.165-.97 2.165-2.167 2.165zm5.18 0c-.041-4.029-3.314-7.298-7.348-7.339v-3.207c5.814.041 10.518 4.739 10.561 10.546h-3.213zm5.441 0c-.021-7.063-5.736-12.761-12.789-12.792v-3.208c8.83.031 15.98 7.179 16 16h-3.211z"></path></svg></a></li>
</ul></div>			</nav>
		</div>
	</header>

	<main id="primary" class="site-main">

		
			<header class="page-header">
				<h1 class="page-title">Tag: Replication</h1>			</header>

			
<article id="post-7046" class="post-7046 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-orchestrator tag-pseudo-gtid tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid" rel="bookmark">Refactoring replication topology with Pseudo GTID</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/pseudo-gtid" rel="tag">Pseudo GTID</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-23T12:37:17+02:00">October 23, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This post describes in detail the method of using Pseudo GTID to achieve unplanned replication topology changes, i.e. connecting two arbitrary slaves, or recovering from a master failure even as all its slaves are hanging in different positions.</p>
<p>Please read <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid">Pseudo GTID</a> and <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication">Pseudo GTID, RBR</a> as introduction.</p>
<p>Consider the following case: the master dies unexpectedly, and its three slaves are all hanging, not necessarily at same binary log file/position (network broke down while some slaves managed to salvage more entries into their relay logs than others)</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg"><img class="alignnone size-full wp-image-7059" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg" alt="orchestrator-failed-master" width="801" height="365" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master.jpeg 801w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/10/orchestrator-failed-master-300x136.jpeg 300w" sizes="(max-width: 801px) 100vw, 801px"></a></p></blockquote>
<p>(Did you notice the <strong>“Candidate for master”</strong> message? To be discussed shortly)</p>
<h4>GTID</h4>
<p>With GTID each transaction (and entry in the binary log) is associated with a unique mark — the Global Transaction ID. Just pick the slave with the most advanced GTID to be the next master, and just <strong>CHANGE MASTER TO MASTER_HOST=’chosen_slave’</strong> on the other slaves, and everything magically works. A slave knows which GTID it has already processed, and can look that entry on its master’s binary logs, resuming replication on the one that follows.</p>
<p>How does that work? The master’s binary logs are searched for that GTID entry. I’m not sure how brute-force this is, since I’m aware of a subtlety which requires brute-force scan of all binary logs; I don’t actually know if it’s always like that.</p>
<h4>Pseudo GTID</h4>
<p>We can mimick that above, but our solution can’t be as fine grained. With the injection of Pseudo GTID we mark the binary log for unique entries. But instead of having a unique identifier for every entry, we have a unique identifier for every second, 10 seconds, or what have you, with otherwise normal, non-unique entries in between our Pseudo GTID entries.</p>
<h4>Recognizing which slave is more up to date</h4>
<p>Given two slaves, which is more up to date?</p>
<ul>
<li>If both replicate(d) from same master, a <strong>SHOW SLAVE STATUS</strong> comparison answers (safe method: wait till SQL thread catches up with broken IO thread, compare <strong>relay_master_log_file</strong>, <strong>exec_master_log_pos</strong> on both machines). This is the method by which the above “Candidate for master” message is produced.</li>
<li>If one is/was descendent of the other, then obviously it is less advanced or equals its ancestor.</li>
<li>Otherwise we’re unsure – still solvable via bi-directional trial & error, as explained later on.</li>
</ul>
<p>For now, let’s assume we know which slave is more up to date (has received and executed more relay logs). Let’s call it <strong>S1</strong>, whereas the less up-to-date will be <strong>S2</strong>. This will make our discussion simpler. <a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid#more-7046" class="more-link">Continue reading »<span class="screen-reader-text"> “Refactoring replication topology with Pseudo GTID”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/refactoring-replication-topology-with-pseudo-gtid#comments">5 Comments<span class="screen-reader-text"> on Refactoring replication topology with Pseudo GTID</span></a></span>	</footer>
</article>

<article id="post-7043" class="post-7043 post type-post status-publish format-standard hentry category-mysql tag-gtid tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication" rel="bookmark">Pseudo GTID, Row Based Replication</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/gtid" rel="tag">GTID</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-23T06:18:52+02:00">October 23, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>This post continues <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid">Pseudo GTID</a>, in a series of posts describing an alternative to using MySQL GTIDs.</p>
<p>The solution offered in the last post does not work too well for row based replication. The binary log entries for the INSERT statement look like this:</p>
<blockquote>
<pre># at 1020
# at 1074
#141020 12:36:21 server id 1  end_log_pos 1074  Table_map: `test`.`pseudo_gtid` mapped to number 33
#141020 12:36:21 server id 1  end_log_pos 1196  Update_rows: table id 33 flags: STMT_END_F

BINLOG '
lddEVBMBAAAANgAAADIEAAAAACEAAAAAAAEABHRlc3QAC3BzZXVkb19ndGlkAAMDBw8CQAAE
lddEVBgBAAAAegAAAKwEAAAAACEAAAAAAAEAA///+AEAAACL10RUJDg2ZmRhMDk1LTU4M2MtMTFl
NC05NzYyLTNjOTcwZWEzMWVhOPgBAAAAlddEVCQ4Y2YzOWMyYy01ODNjLTExZTQtOTc2Mi0zYzk3
MGVhMzFlYTg=
'/*!*/;
</pre>
</blockquote>
<p>Where’s our unique value? Encoded within something that cannot be trusted to be unique. Issuing <strong>mysqlbinlog –verbose</strong> helps out:</p>
<blockquote>
<pre>BEGIN
/*!*/;
# at 183
# at 237
#141020 12:35:51 server id 1  end_log_pos 237   Table_map: `test`.`pseudo_gtid` mapped to number 33
#141020 12:35:51 server id 1  end_log_pos 359   Update_rows: table id 33 flags: STMT_END_F

BINLOG '
d9dEVBMBAAAANgAAAO0AAAAAACEAAAAAAAEABHRlc3QAC3BzZXVkb19ndGlkAAMDBw8CQAAE
d9dEVBgBAAAAegAAAGcBAAAAACEAAAAAAAEAA///+AEAAABt10RUJDc1MWJkYzEwLTU4M2MtMTFl
NC05NzYyLTNjOTcwZWEzMWVhOPgBAAAAd9dEVCQ3YjExZDQzYy01ODNjLTExZTQtOTc2Mi0zYzk3
MGVhMzFlYTg=
'/*!*/;
### UPDATE `test`.`pseudo_gtid`
### WHERE
###   @1=1
###   @2=1413797741
###   <strong>@3='751bdc10-583c-11e4-9762-3c970ea31ea8'</strong>
### SET
###   @1=1
###   @2=1413797751
###   @3='7b11d43c-583c-11e4-9762-3c970ea31ea8'</pre>
</blockquote>
<p>and that’s something we can work with. However, I like to do stuff from within MySQL, and rely as little as possible on external tools. How do the binary log entries look via <strong>SHOW BINLOG EVENTS</strong>? Not good.</p>
<blockquote>
<pre>master [localhost] {msandbox} (test) > show binlog events in 'mysql-bin.000058' limit 20;
+------------------+------+-------------+-----------+-------------+---------------------------------------+
| Log_name         | Pos  | Event_type  | Server_id | End_log_pos | Info                                  |
+------------------+------+-------------+-----------+-------------+---------------------------------------+
| mysql-bin.000058 |    4 | Format_desc |         1 |         107 | Server ver: 5.5.32-log, Binlog ver: 4 |
| mysql-bin.000058 |  107 | Query       |         1 |         183 | BEGIN                                 |
| mysql-bin.000058 |  183 | Table_map   |         1 |         237 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  237 | Update_rows |         1 |         359 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  359 | Xid         |         1 |         386 | COMMIT /* xid=5460 */                 |
| mysql-bin.000058 |  386 | Query       |         1 |         462 | BEGIN                                 |
| mysql-bin.000058 |  462 | Table_map   |         1 |         516 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  516 | Update_rows |         1 |         638 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  638 | Xid         |         1 |         665 | COMMIT /* xid=5471 */                 |
| mysql-bin.000058 |  665 | Query       |         1 |         741 | BEGIN                                 |
| mysql-bin.000058 |  741 | Table_map   |         1 |         795 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 |  795 | Update_rows |         1 |         917 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 |  917 | Xid         |         1 |         944 | COMMIT /* xid=5474 */                 |
| mysql-bin.000058 |  944 | Query       |         1 |        1020 | BEGIN                                 |
| mysql-bin.000058 | 1020 | Table_map   |         1 |        1074 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 | 1074 | Update_rows |         1 |        1196 | table_id: 33 flags: STMT_END_F        |
| mysql-bin.000058 | 1196 | Xid         |         1 |        1223 | COMMIT /* xid=5476 */                 |
| mysql-bin.000058 | 1223 | Query       |         1 |        1299 | BEGIN                                 |
| mysql-bin.000058 | 1299 | Table_map   |         1 |        1353 | table_id: 33 (test.pseudo_gtid)       |
| mysql-bin.000058 | 1353 | Update_rows |         1 |        1475 | table_id: 33 flags: STMT_END_F        |
+------------------+------+-------------+-----------+-------------+---------------------------------------+</pre>
</blockquote>
<p>The representation of row-format entries in the <strong>SHOW BINLOG EVENTS</strong> output is really poor. Why, there’s nothing to tell me at all about what’s been done, except that this is some operation on <strong>test.pseudo_gtid</strong>. Obviously I cannot find anything unique over here.</p>
<p>Not all is lost. How about DDL statements? Those are still written in SBR format (there’s no <em>rows</em> to log upon creating a table). A solution could be somehow manipulating a unique value in a DDL statement. There could be various such solutions, and I chose to use a <strong>CREATE VIEW</strong> statement, dynamically composed of a <strong>UUID()</strong>: <a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication#more-7043" class="more-link">Continue reading »<span class="screen-reader-text"> “Pseudo GTID, Row Based Replication”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/pseudo-gtid-row-based-replication#comments">2 Comments<span class="screen-reader-text"> on Pseudo GTID, Row Based Replication</span></a></span>	</footer>
</article>

<article id="post-7034" class="post-7034 post type-post status-publish format-standard hentry category-mysql tag-hack tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/making-uuid-and-rand-replication-safe" rel="bookmark">Making UUID() and RAND() replication safe</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/hack" rel="tag">Hack</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/making-uuid-and-rand-replication-safe" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-20T08:40:04+02:00">October 20, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>MySQL’s <a href="http://dev.mysql.com/doc/refman/5.5/en/miscellaneous-functions.html#function_uuid"><strong>UUID()</strong></a> and <a href="http://dev.mysql.com/doc/refman/5.5/en/mathematical-functions.html#function_rand"><strong>RAND()</strong></a> functions both provide with (pseudo) indeterministic result. <strong>UUID()</strong>‘s result is moreover bound to the host on which it executes. For this reason, both are unsafe to replicate with <strong>STATEMENT</strong> binlog format. As an example, consider:</p>
<blockquote>
<pre><strong>master></strong> create table test.uuid_test (id int, u varchar(64));

<strong>master></strong> insert into test.uuid_test values (1, UUID());
Query OK, 1 row affected, 1 warning (0.03 sec)

<strong>master></strong> select * from test.uuid_test;
+------+--------------------------------------+
| id   | u                                    |
+------+--------------------------------------+
|    1 | 7e3596d8-56ac-11e4-b284-3c970ea31ea8 |
+------+--------------------------------------+</pre>
</blockquote>
<p>The warning we got on the insert directly relates to the following inconsistency on a slave:</p>
<blockquote>
<pre><strong>slave1></strong> select * from test.uuid_test;
+------+--------------------------------------+
| id   | u                                    |
+------+--------------------------------------+
|    1 | 7e379d63-56ac-11e4-8477-3c970ea31ea8 |
+------+--------------------------------------+</pre>
</blockquote>
<p>The data on the slave is clearly inconsistent with the master’s. The slave, replicating via <strong>STATEMENT</strong> binlog format, re-executes the <strong>INSERT</strong> command and gets a different UUID value.</p>
<h4>External</h4>
<p>One solution to the above is to generate the UUID value from your application. By the time MySQL gets the <strong>INSERT</strong> statement, the UUID value is a constant string, as far as MySQL is concerned.</p>
<h4>Internal</h4>
<p>However there’s a way to do it from within MySQL, by decoupling the <strong>UUID()</strong> function from the <strong>INSERT</strong> statement. It takes a session variable. Consider: <a href="https://shlomi-noach.github.io/blog/mysql/making-uuid-and-rand-replication-safe#more-7034" class="more-link">Continue reading »<span class="screen-reader-text"> “Making UUID() and RAND() replication safe”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/making-uuid-and-rand-replication-safe#comments">5 Comments<span class="screen-reader-text"> on Making UUID() and RAND() replication safe</span></a></span>	</footer>
</article>

<article id="post-7026" class="post-7026 post type-post status-publish format-standard hentry category-mysql tag-open-source tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-1-18-new-features-support-for-orchestrator-agent" rel="bookmark">orchestrator 1.1.18: new features, support for orchestrator-agent</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-1-18-new-features-support-for-orchestrator-agent" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-13T15:00:35+02:00">October 13, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p><a href="https://github.com/outbrain">Outbrain</a>‘s <a href="https://github.com/outbrain/orchestrator"><strong>orchestrator 1.1.18</strong></a> is released:</p>
<ul>
<li>Support for <a href="https://github.com/outbrain/orchestrator-agent"><strong>orchestrator-agent</strong></a> (see <a href="https://shlomi-noach.github.io/blog/mysql/announcing-orchestrator-agent">announcement</a>): agent pages, support for agent actions, initiation of seeds (provisioning of new/corrupted servers), auditing of seeds.</li>
<li>Clusters dashboard</li>
<li>Support for long query auditing</li>
<li>SSL</li>
<li>Proxy authentication (e.g. apache2 serving as reverse-proxy with LDAP)</li>
<li>User control</li>
<li>Better slave moving rules.</li>
</ul>
<p>Quick links:</p>
<ul>
<li>Get <a href="https://github.com/outbrain/orchestrator/releases/tag/v1.1.18"><strong>orchestrator 1.1.18</strong></a></li>
<li>Read the <strong><a href="https://github.com/outbrain/orchestrator/wiki/Orchestrator-Manual">orchestrator manual</a></strong></li>
<li>Check out <strong><a href="https://github.com/outbrain/orchestrator-agent">orchestrator-agent</a></strong></li>
</ul>
<p><em>orchestrator</em> now allows for seeding/provisioning of servers via <em>orchestrator-agent</em>. It communicates with agents executing on the MySQL hosts and coordinate transfer of data between them. orchestrator now supports invocation and auditing of seeding operations, and protects you from breaking your seeds. The <em>orchestrator-agent</em> is a solution to Outbrain’s specific use case, and may not appeal to the greater crowd. Nonetheless it is extendible and is released as open source. <a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-1-18-new-features-support-for-orchestrator-agent#more-7026" class="more-link">Continue reading »<span class="screen-reader-text"> “orchestrator 1.1.18: new features, support for orchestrator-agent”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-1-18-new-features-support-for-orchestrator-agent#respond">Leave a Comment<span class="screen-reader-text"> on orchestrator 1.1.18: new features, support for orchestrator-agent</span></a></span>	</footer>
</article>

<article id="post-7019" class="post-7019 post type-post status-publish format-standard hentry category-mysql tag-backup tag-open-source tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/announcing-orchestrator-agent" rel="bookmark">Announcing orchestrator-agent</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/backup" rel="tag">Backup</a><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/announcing-orchestrator-agent" rel="bookmark"><time class="entry-date published updated" datetime="2014-10-13T14:59:24+02:00">October 13, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p><strong><a href="https://github.com/outbrain/orchestrator-agent">orchestrator-agent</a></strong> is a side-kick, complementary project of <strong><a href="https://github.com/outbrain/orchestrator">orchestrator</a></strong>, implementing a daemon service on one’s MySQL hosts which communicates with and accepts commands from <em>orchestrator</em>, built with the original purpose of providing an automated solution for provisioning new or corrupted slaves.</p>
<p>It was built by <a href="https://github.com/outbrain">Outbrain</a>, with Outbrain’s specific use case in mind. While we release it as open source, only a small part of its functionality will appeal to the public (this is why it’s not strictly part of the <em>orchestrator</em> project, which is a general purpose, wide-audience solution). Nevertheless, it is a simple implementation of a daemon, such that can be easily extended by the community. The project is open for pull-requests!</p>
<p>A quick breakdown of <em>orchestrator-agent</em> is as follows:</p>
<ul>
<li>Executes as a daemon on linux hosts</li>
<li>Interacts and invokes OS commands (via <em>bash</em>)</li>
<li>Does not directly interact with a MySQL server running on that host (does not connect via mysql credentials)</li>
<li>Expects a single MySQL service on host</li>
<li>Can control the MySQL service (e.g. stop, start)</li>
<li>Is familiar with LVM layer on host</li>
<li>Can take LVM snapshots, mount snapshots, remove snapshots</li>
<li>Is familiar with the MySQL data directory, disk usage, file system</li>
<li>Can send snapshot data from a mounted snapshot on a running MySQL host</li>
<li>Can prepare data directory and receive snapshot data from another host</li>
<li>Recognizes local/remote datacenters</li>
<li>Controlled by <em>orchestrator,</em> two <em>orchestrator-agents</em> implement an automated and audited solution for seeding a new/corrupted MySQL host based on a running server.</li>
</ul>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/announcing-orchestrator-agent#more-7019" class="more-link">Continue reading »<span class="screen-reader-text"> “Announcing orchestrator-agent”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/announcing-orchestrator-agent#comments">1 Comment<span class="screen-reader-text"> on Announcing orchestrator-agent</span></a></span>	</footer>
</article>

<article id="post-6964" class="post-6964 post type-post status-publish format-standard hentry category-mysql tag-open-source tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-5-refactoring-masters-multi-master-replication" rel="bookmark">Orchestrator 1.0.5: refactoring masters, multi-master replication</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-5-refactoring-masters-multi-master-replication" rel="bookmark"><time class="entry-date published updated" datetime="2014-08-06T14:14:39+02:00">August 6, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>Outbrain’s <em>orchestrator</em> Version <strong>1.0.5</strong> <a href="https://github.com/outbrain/orchestrator/releases/tag/v1.0.5">is released</a>.</p>
<blockquote><p>Quick links: <strong><a href="https://github.com/outbrain/orchestrator/wiki/Orchestrator-Manual">Orchestrator Manual</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/wiki/FAQ">FAQ</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/releases">Downloads</a></strong></p></blockquote>
<p><em>Orchestrator</em> now supports refactoring of masters via master-master topologies. It now allows promoting slaves as co-masters and detachment of instances from a co-master topology, effectively allowing for replacing an active master.</p>
<h4>Like this</h4>
<p>Drag a master:</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/08/orchestator-cm-simple-drag-master-01.png"><img class="alignnone size-full wp-image-6965" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/08/orchestator-cm-simple-drag-master-01.png" alt="orchestator-cm-simple-drag-master-01" width="804" height="340" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/08/orchestator-cm-simple-drag-master-01.png 804w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/08/orchestator-cm-simple-drag-master-01-300x126.png 300w" sizes="(max-width: 804px) 100vw, 804px"></a></p></blockquote>
<p>Onto one of its slaves: <a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-5-refactoring-masters-multi-master-replication#more-6964" class="more-link">Continue reading »<span class="screen-reader-text"> “Orchestrator 1.0.5: refactoring masters, multi-master replication”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-5-refactoring-masters-multi-master-replication#respond">Leave a Comment<span class="screen-reader-text"> on Orchestrator 1.0.5: refactoring masters, multi-master replication</span></a></span>	</footer>
</article>

<article id="post-6945" class="post-6945 post type-post status-publish format-standard hentry category-mysql tag-open-source tag-orchestrator tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-4-released" rel="bookmark">Orchestrator 1.0.4 released</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-4-released" rel="bookmark"><time class="entry-date published updated" datetime="2014-07-29T13:42:06+02:00">July 29, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>Outbrain’s <em>orchestrator</em> Version <strong>1.0.4</strong> <a href="https://github.com/outbrain/orchestrator/releases/tag/v1.0.4">is released</a>.</p>
<blockquote><p>Quick links: <strong><a href="https://github.com/outbrain/orchestrator/wiki/Orchestrator-Manual">Orchestrator Manual</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/wiki/FAQ">FAQ</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/releases">Downloads</a></strong></p></blockquote>
<p>What’s new?</p>
<h4>Co-masters</h4>
<p>orchestrator now does a much better visualization of Master-Master replication:</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/07/orchestrator-co-masters.png"><img class="alignnone size-full wp-image-6946" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/07/orchestrator-co-masters.png" alt="orchestrator-co-masters" width="783" height="357" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/07/orchestrator-co-masters.png 783w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/07/orchestrator-co-masters-300x136.png 300w" sizes="(max-width: 783px) 100vw, 783px"></a></p></blockquote>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-4-released#more-6945" class="more-link">Continue reading »<span class="screen-reader-text"> “Orchestrator 1.0.4 released”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/orchestrator-1-0-4-released#respond">Leave a Comment<span class="screen-reader-text"> on Orchestrator 1.0.4 released</span></a></span>	</footer>
</article>

<article id="post-6867" class="post-6867 post type-post status-publish format-standard hentry category-mysql tag-open-source tag-orchestrator tag-replication tag-tools">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/introducing-orchestrator-manage-and-visualize-your-mysql-replication-topologies-and-get-home-for-dinner" rel="bookmark">Introducing Orchestrator: manage and visualize your MySQL replication topologies and get home for dinner</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/orchestrator" rel="tag">orchestrator</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a><a href="https://shlomi-noach.github.io/blog/tag/tools" rel="tag">tools</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/introducing-orchestrator-manage-and-visualize-your-mysql-replication-topologies-and-get-home-for-dinner" rel="bookmark"><time class="entry-date published updated" datetime="2014-06-09T09:02:26+02:00">June 9, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>I’m happy to announce the availability of <a href="http://www.outbrain.com/">Outbrain</a>‘s <strong><a href="https://github.com/outbrain/orchestrator">Orchestrator</a></strong>: MySQL replication management & visualization tool.</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/orchestrator-simple.png"><img class="alignnone size-full wp-image-6898" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/orchestrator-simple.png" alt="orchestrator - simple topology" width="785" height="353" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/orchestrator-simple.png 785w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/orchestrator-simple-300x134.png 300w" sizes="(max-width: 785px) 100vw, 785px"></a></p></blockquote>
<ul>
<li>Orchestrator reads your replication topologies (give it one server – be it master or slave – in each topology, and it will reveal the rest).</li>
<li>It keeps a state of this topology.</li>
<li>It can continuously poll your servers to get an up to date topology map.</li>
<li>It visualizes the topology in a clear and slick D3 tree.</li>
<li>It allows you to <em>modify your topology;</em> move slaves around. You can use the command line variation, the JSON API, or you can use the web interface.</li>
</ul>
<p>Quick links: <strong><a href="https://github.com/outbrain/orchestrator/wiki/Orchestrator-Manual">Orchestrator Manual</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/wiki/FAQ">FAQ</a></strong>, <strong><a href="https://github.com/outbrain/orchestrator/releases">Downloads</a></strong></p>
<h4>Nothing like nice screenshots</h4>
<p>To move slaves around the topology (repoint a slave to a different master) through <em>orchestrator</em>‘s web interface, we use <em>Drag and Drop</em>, <a href="https://shlomi-noach.github.io/blog/mysql/introducing-orchestrator-manage-and-visualize-your-mysql-replication-topologies-and-get-home-for-dinner#more-6867" class="more-link">Continue reading »<span class="screen-reader-text"> “Introducing Orchestrator: manage and visualize your MySQL replication topologies and get home for dinner”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/introducing-orchestrator-manage-and-visualize-your-mysql-replication-topologies-and-get-home-for-dinner#comments">6 Comments<span class="screen-reader-text"> on Introducing Orchestrator: manage and visualize your MySQL replication topologies and get home for dinner</span></a></span>	</footer>
</article>

<article id="post-6865" class="post-6865 post type-post status-publish format-standard hentry category-mysql tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/using-deep-nested-replication-topologies" rel="bookmark">Using deep nested replication topologies</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/using-deep-nested-replication-topologies" rel="bookmark"><time class="entry-date published updated" datetime="2014-06-02T10:04:09+02:00">June 2, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>If you’re running more than a few slaves in a replication topology, you might choose to use deeply nested replication: slaves replicating from other slaves at 2, 3 or even 4 levels. There are pros and cons to such topologies, discussed below.</p>
<p>A simple, small deep nested topology is depicted below (it is also a real production topology of ours):</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/topology-sample-02.png"><img class="alignnone size-full wp-image-6878" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/topology-sample-02.png" alt="topology-sample-02" width="736" height="309" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/topology-sample-02.png 736w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/topology-sample-02-300x125.png 300w" sizes="(max-width: 736px) 100vw, 736px"></a></p></blockquote>
<p>Two slaves, <strong>srv-4</strong> and <strong>srv-8</strong> act as local masters to yet other slaves. Why would we want to have this complexity?</p>
<h4>Pros</h4>
<ul>
<li>Reduce load on master: too many slaves replicating from single master means the master becomes loaded with serving the binary logs. Typically, when all slaves are up to date, this isn’t a big deal, since they all get served roughly the same entries, and caching works great. If not all are in sync, the master needs to look up different log entries and pays with more disk I/O.</li>
<li>Reduce network load. We serve from three different data centres. Our master is in one DC, and our slaves are spread through all three. Inter-DC network is naturally slower; it is also more expensive, hence more easily saturated. Reducing cross-DC network is done across all our systems, including MySQL. <strong>srv-4</strong>, for example, could depict a slave that is a local master in its own DC, serving <strong>srv-5</strong>, <strong>srv-6</strong>, <strong>srv-7</strong> all in the same DC, hence only using cross-DC network for one slave instead of four. A bit over-simplistic example but true.</li>
<li>Failover. <a href="http://code.google.com/p/mysql-master-ha/">MHA</a> does a good job at synchronizing slaves of same master by figuring out the missing binary log entries for each slave. It should do well within a single region, but I do not know that it would do the same cross region (I’m assuming the binlog entries copy should work, but I haven’t tried it cross region). In case of a disaster such as an entire DC going down (we actually had such a case a couple weeks ago; power went out for the entire DC), we have a designated master into which we can fail over in each other DC, and which contains enough slaves (from each remaining DCs) to keep serving. That it, we’re willing to skip the fancy syncing and just point to a newly promoted master, with the benefit that the entire replication topology under it is intact.</li>
<li>Testing & upgrades. For example, I might want to upgrade to <strong>5.6</strong>. Upgrading a slave from <strong>5.5</strong> to <strong>5.6</strong> is a good start; we look at replication and see that nothing gets broken. But how will our production master behave with <strong>5.6</strong>? Put some more slaves under your newly upgraded <strong>5.6</strong> server and get a clearer picture. At some stage you might just promote this entire subtree as the new topology.</li>
</ul>
<p>Here’s another topology; DC info is not depicted in this image, but you can guess what designated masters we have: <a href="https://shlomi-noach.github.io/blog/mysql/using-deep-nested-replication-topologies#more-6865" class="more-link">Continue reading »<span class="screen-reader-text"> “Using deep nested replication topologies”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/using-deep-nested-replication-topologies#comments">5 Comments<span class="screen-reader-text"> on Using deep nested replication topologies</span></a></span>	</footer>
</article>

<article id="post-6861" class="post-6861 post type-post status-publish format-standard hentry category-mysql tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/from-percona-server-to-mysql-and-back-to-percona-server-beware-of-crash-safe-replication-info" rel="bookmark">From Percona Server to MySQL and back to Percona Server: beware of crash safe replication info</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/from-percona-server-to-mysql-and-back-to-percona-server-beware-of-crash-safe-replication-info" rel="bookmark"><time class="entry-date published" datetime="2014-05-27T07:50:55+02:00">May 27, 2014</time><time class="updated" datetime="2014-05-27T07:52:29+02:00">May 27, 2014</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>We’re migrating some of our “vanilla” MySQL 5.5 servers to Percona Server 5.5. One of the major incentives is the <a href="http://www.percona.com/doc/percona-server/5.5/reliability/crash_resistant_replication.html">crash-safe replication</a> feature, allowing slaves to die (power failure) and resume replication without losing position in relay logs.</p>
<p>Whether or not we will migrate all our servers depends on further benchmarking; so far we’ve noticed unexpected results, but these are still premature to publish.</p>
<p>However the fact that we are using both MySQL & Percona Server has led us into a peculiar situation which I’d like to share. We reseed our servers via LVM snapshots. If we need a new machine, or have a corrupted slave, we capture an image of a running slave and duplicate it, a process which takes the better part of a day. This duplicates not only the data, of course, but also the relay logs, the <strong>relay-log.info</strong> file, <strong>master.info</strong> file, implying the <em>position within the topology</em>.</p>
<p>With crash safe replication this also means the transactional relay log position. Recap: crash safe replication writes, per transaction, the relay log status into <strong>ibdata1</strong> file. So the relay log info in <strong>ibdata1</strong> is in perfect alignment with your committed transactions. Upon server startup, Percona Server reads the info from <strong>ibdata1</strong> and overwrites <strong>relay-log.info</strong> file (it completely disregards whatever was in that file prior to startup).</p>
<p>Can you guess what could get wrong here? Here’s the scenario we had; the same problem can unfold in different scenarios.</p>
<p>Take a look at the following topology:</p>
<blockquote><p><a href="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/simple-topology.png"><img class="alignnone size-full wp-image-6869" src="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/simple-topology.png" alt="simple topology" width="701" height="297" srcset="https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/simple-topology.png 701w,https://shlomi-noach.github.io/blog/wp-content/uploads/2014/05/simple-topology-300x127.png 300w" sizes="(max-width: 701px) 100vw, 701px"></a></p></blockquote>
<p>(this image is an actual online visualization of a replication topology; for purposes of this blog it’s a sandbox topology on my laptop. Please stand by for some very cool open source release announcement shortly)</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/from-percona-server-to-mysql-and-back-to-percona-server-beware-of-crash-safe-replication-info#more-6861" class="more-link">Continue reading »<span class="screen-reader-text"> “From Percona Server to MySQL and back to Percona Server: beware of crash safe replication info”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/from-percona-server-to-mysql-and-back-to-percona-server-beware-of-crash-safe-replication-info#respond">Leave a Comment<span class="screen-reader-text"> on From Percona Server to MySQL and back to Percona Server: beware of crash safe replication info</span></a></span>	</footer>
</article>

	<nav class="navigation posts-navigation" role="navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://shlomi-noach.github.io/blog/tag/replication/page/5">Older posts</a></div><div class="nav-next"><a href="https://shlomi-noach.github.io/blog/tag/replication/page/3">Newer posts</a></div></div>
	</nav>
	</main>


	<footer id="colophon" class="site-footer">
		<div class="site-info">
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
			<span class="sep"> | </span>
				Theme: <a href="http://openark.org">openark-primer</a> by <a href="http://underscores.me/">Underscores.me</a>.		</div>
	</footer>
</div>

	<div style="display:none">
	</div>
<script>
var pollsL10n = {"ajax_url":"https:\/\/shlomi-noach.github.io\/blog\/wp-admin\/admin-ajax.php","text_wait":"Your last request is still being processed. Please wait a while ...","text_valid":"Please choose a valid poll answer.","text_multiple":"Maximum number of choices allowed: ","show_loading":"1","show_fading":"1"};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-js.js"></script>
<script src="https://secure.gravatar.com/js/gprofiles.js?ver=2020Junaa"></script>
<script>
var WPGroHo = {"my_hash":""};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/modules/wpgroho.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/navigation.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/skip-link-focus-fix.js"></script>
<script type="text/javascript" src="https://stats.wp.com/e-202024.js" async="async" defer></script>
<script type="text/javascript">
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:8.2.1',blog:'32412571',post:'0',tz:'2',srv:'code.openark.org'} ]);
	_stq.push([ 'clickTrackerInit', '32412571', '0' ]);
</script>

</body>
</html>

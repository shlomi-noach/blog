<!DOCTYPE html>
<html lang="en-US">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	

	<title>code.openark.org – Page 27 – Blog by Shlomi Noach</title>
<link rel="dns-prefetch" href="//secure.gravatar.com">
<link rel="dns-prefetch" href="//s.w.org">


<link rel="stylesheet" id="wp-block-library-css" href="https://shlomi-noach.github.io/blog/wp-includes/css/dist/block-library/style.min.css" media="all">
<style id="wp-block-library-inline-css">
.has-text-align-justify{text-align:justify;}
</style>
<link rel="stylesheet" id="wp-polls-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-css.css" media="all">
<style id="wp-polls-inline-css">
.wp-polls .pollbar {
	margin: 1px;
	font-size: 6px;
	line-height: 8px;
	height: 8px;
	background-image: url('https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/images/default/pollbg.gif');
	border: 1px solid #c8c8c8;
}

</style>
<link rel="stylesheet" id="openark-primer-style-css" href="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/style.css" media="all">
<link rel="stylesheet" id="jetpack_css-css" href="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/css/jetpack.css" media="all">
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-includes/js/jquery/jquery-migrate.min.js"></script>




<style data-context="foundation-flickity-css">/*! Flickity v2.0.2
http://flickity.metafizzy.co
---------------------------------------------- */.flickity-enabled{position:relative}.flickity-enabled:focus{outline:0}.flickity-viewport{overflow:hidden;position:relative;height:100%}.flickity-slider{position:absolute;width:100%;height:100%}.flickity-enabled.is-draggable{-webkit-tap-highlight-color:transparent;tap-highlight-color:transparent;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.flickity-enabled.is-draggable .flickity-viewport{cursor:move;cursor:-webkit-grab;cursor:grab}.flickity-enabled.is-draggable .flickity-viewport.is-pointer-down{cursor:-webkit-grabbing;cursor:grabbing}.flickity-prev-next-button{position:absolute;top:50%;width:44px;height:44px;border:none;border-radius:50%;background:#fff;background:hsla(0,0%,100%,.75);cursor:pointer;-webkit-transform:translateY(-50%);transform:translateY(-50%)}.flickity-prev-next-button:hover{background:#fff}.flickity-prev-next-button:focus{outline:0;box-shadow:0 0 0 5px #09f}.flickity-prev-next-button:active{opacity:.6}.flickity-prev-next-button.previous{left:10px}.flickity-prev-next-button.next{right:10px}.flickity-rtl .flickity-prev-next-button.previous{left:auto;right:10px}.flickity-rtl .flickity-prev-next-button.next{right:auto;left:10px}.flickity-prev-next-button:disabled{opacity:.3;cursor:auto}.flickity-prev-next-button svg{position:absolute;left:20%;top:20%;width:60%;height:60%}.flickity-prev-next-button .arrow{fill:#333}.flickity-page-dots{position:absolute;width:100%;bottom:-25px;padding:0;margin:0;list-style:none;text-align:center;line-height:1}.flickity-rtl .flickity-page-dots{direction:rtl}.flickity-page-dots .dot{display:inline-block;width:10px;height:10px;margin:0 8px;background:#333;border-radius:50%;opacity:.25;cursor:pointer}.flickity-page-dots .dot.is-selected{opacity:1}</style><style data-context="foundation-slideout-css">.slideout-menu{position:fixed;left:0;top:0;bottom:0;right:auto;z-index:0;width:256px;overflow-y:auto;-webkit-overflow-scrolling:touch;display:none}.slideout-menu.pushit-right{left:auto;right:0}.slideout-panel{position:relative;z-index:1;will-change:transform}.slideout-open,.slideout-open .slideout-panel,.slideout-open body{overflow:hidden}.slideout-open .slideout-menu{display:block}.pushit{display:none}</style>
<link rel="dns-prefetch" href="//v0.wordpress.com">


<meta property="og:type" content="website">
<meta property="og:title" content="code.openark.org">
<meta property="og:description" content="Blog by Shlomi Noach">
<meta property="og:url" content="https://shlomi-noach.github.io/blog/">
<meta property="og:site_name" content="code.openark.org">
<meta property="og:image" content="https://s0.wp.com/i/blank.jpg">
<meta property="og:locale" content="en_US">


<style>.ios7.web-app-mode.has-fixed header{ background-color: rgba(242,101,34,.88);}</style></head>

<body class="home blog paged paged-27 hfeed no-sidebar">
<div id="page" class="site">
	<a class="skip-link screen-reader-text" href="#primary">Skip to content</a>

	<header id="masthead" class="site-header">
		<div class="site-branding">
							<h1 class="site-title"><a href="https://shlomi-noach.github.io/blog/" rel="home">code.openark.org</a></h1>
								<p class="site-description">Blog by Shlomi Noach</p>
			
			<nav id="site-navigation" class="main-navigation">
				<button class="menu-toggle" aria-controls="primary-menu" aria-expanded="false">primary-menu</button>
				<div class="menu-primary-menu-container"><ul id="menu-primary-menu" class="menu"><li id="menu-item-8109" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8109"><a href="https://shlomi-noach.github.io/blog/archives">archives</a></li>
<li id="menu-item-8050" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8050"><a href="https://shlomi-noach.github.io/blog/presentations">presentations</a></li>
<li id="menu-item-8055" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-8055"><a href="https://shlomi-noach.github.io/blog/about">about</a></li>
<li id="menu-item-8071" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8071"><a href="https://github.com/shlomi-noach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"></path></svg></a></li>
<li id="menu-item-8074" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8074"><a href="https://www.linkedin.com/in/shlominoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"></path></svg></a></li>
<li id="menu-item-8072" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8072"><a href="https://twitter.com/ShlomiNoach"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M12 0c-6.627 0-12 5.373-12 12s5.373 12 12 12 12-5.373 12-12-5.373-12-12-12zm6.066 9.645c.183 4.04-2.83 8.544-8.164 8.544-1.622 0-3.131-.476-4.402-1.291 1.524.18 3.045-.244 4.252-1.189-1.256-.023-2.317-.854-2.684-1.995.451.086.895.061 1.298-.049-1.381-.278-2.335-1.522-2.304-2.853.388.215.83.344 1.301.359-1.279-.855-1.641-2.544-.889-3.835 1.416 1.738 3.533 2.881 5.92 3.001-.419-1.796.944-3.527 2.799-3.527.825 0 1.572.349 2.096.907.654-.128 1.27-.368 1.824-.697-.215.671-.67 1.233-1.263 1.589.581-.07 1.135-.224 1.649-.453-.384.578-.87 1.084-1.433 1.489z"></path></svg></a></li>
<li id="menu-item-8073" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-8073"><a href="https://shlomi-noach.github.io/blog/feed"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewbox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-12.832 20c-1.197 0-2.168-.969-2.168-2.165s.971-2.165 2.168-2.165 2.167.969 2.167 2.165-.97 2.165-2.167 2.165zm5.18 0c-.041-4.029-3.314-7.298-7.348-7.339v-3.207c5.814.041 10.518 4.739 10.561 10.546h-3.213zm5.441 0c-.021-7.063-5.736-12.761-12.789-12.792v-3.208c8.83.031 15.98 7.179 16 16h-3.211z"></path></svg></a></li>
</ul></div>			</nav>
		</div>
	</header>

	<main id="primary" class="site-main">

		
<article id="post-3304" class="post-3304 post type-post status-publish format-standard hentry category-mysql tag-backup tag-configuration tag-innodb tag-mysqldump tag-replication">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/upgrading-to-barracuda-getting-rid-of-huge-ibdata1-file" rel="bookmark">Upgrading to Barracuda & getting rid of huge ibdata1 file</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/backup" rel="tag">Backup</a><a href="https://shlomi-noach.github.io/blog/tag/configuration" rel="tag">Configuration</a><a href="https://shlomi-noach.github.io/blog/tag/innodb" rel="tag">InnoDB</a><a href="https://shlomi-noach.github.io/blog/tag/mysqldump" rel="tag">mysqldump</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/upgrading-to-barracuda-getting-rid-of-huge-ibdata1-file" rel="bookmark"><time class="entry-date published updated" datetime="2011-02-15T10:01:15+02:00">February 15, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>Some of this is old stuff, but more people are now converting to InnoDB plugin, so as to enjoy table compression, performance boosts. Same holds for people converting to Percona’s XtraDB. InnoDB plugin requires <strong>innodb_file_per_table</strong>. No more shared tablespace file.</p>
<p>So your <strong>ibdata1</strong> file is some <strong>150GB</strong>, and it won’t reduce. Really, it won’t reduce. You set <strong>innodb_file_per_table=1</strong>, do <strong>ALTER TABLE t ENGINE=InnoDB</strong> (optionally <strong>ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=8</strong>), and you get all your tables in file-per-table <strong>.ibd</strong> files.</p>
<p>But the original <strong>ibdata1</strong> file is still there. It has to be there, don’t delete it! It contains more than your old data.</p>
<p>InnoDB tablespace files never reduce in size, it’s an old-time annoyance. The only way to go round it, if you need the space, is to completely drop them and start afresh. That’s one of the things so nice about file-per-table: an <strong>ALTER TABLE</strong> actually creates a new tablespace file and drops the original one.</p>
<h4>The procedure</h4>
<p>The procedure is somewhat painful:</p>
<ul>
<li>Dump everything logically (either use <em>mysqldump</em>, <a href="http://www.maatkit.org/doc/mk-parallel-dump.html">mk-parallel-dump</a>, or do it your own way)</li>
<li>Erase your data (literally, delete everything under your <strong>datadir</strong>)</li>
<li>Generate a new empty database</li>
<li>Load your dumped data. <a href="https://shlomi-noach.github.io/blog/mysql/upgrading-to-barracuda-getting-rid-of-huge-ibdata1-file#more-3304" class="more-link">Continue reading »<span class="screen-reader-text"> “Upgrading to Barracuda & getting rid of huge ibdata1 file”</span></a></li>
</ul>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/upgrading-to-barracuda-getting-rid-of-huge-ibdata1-file#comments">16 Comments<span class="screen-reader-text"> on Upgrading to Barracuda & getting rid of huge ibdata1 file</span></a></span>	</footer>
</article>

<article id="post-3283" class="post-3283 post type-post status-publish format-standard hentry category-mysql tag-memcached tag-nosql tag-performance tag-query-cache">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/on-generating-unique-ids-using-last_insert_id-and-other-tools" rel="bookmark">On generating unique IDs using LAST_INSERT_ID() and other tools</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/memcached" rel="tag">memcached</a><a href="https://shlomi-noach.github.io/blog/tag/nosql" rel="tag">NoSQL</a><a href="https://shlomi-noach.github.io/blog/tag/performance" rel="tag">Performance</a><a href="https://shlomi-noach.github.io/blog/tag/query-cache" rel="tag">Query Cache</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/on-generating-unique-ids-using-last_insert_id-and-other-tools" rel="bookmark"><time class="entry-date published" datetime="2011-02-02T08:50:02+02:00">February 2, 2011</time><time class="updated" datetime="2011-02-02T10:15:11+02:00">February 2, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>There’s a <a href="http://dev.mysql.com/doc/refman/5.1/en/information-functions.html#function_last-insert-id">trick</a> for using <strong>LAST_INSERT_ID()</strong> to generate sequences in MySQL. Quoting from the Manual:</p>
<blockquote>
<ol type="1">
<li>Create a table to hold the sequence counter and initialize               it:
<pre>mysql> <strong><code>CREATE TABLE sequence (id INT NOT NULL);</code></strong>
mysql> <strong><code>INSERT INTO sequence VALUES (0);</code></strong>
</pre>
</li>
<li>Use the table to generate sequence numbers like this:
<pre>mysql> <strong><code>UPDATE sequence SET id=LAST_INSERT_ID(id+1);</code></strong>
mysql> <strong><code>SELECT LAST_INSERT_ID();</code></strong>
</pre>
</li>
</ol>
</blockquote>
<p>This trick calls for trouble.</p>
<h4>Contention</h4>
<p>A customer was using this trick to generate unique session IDs for his JBoss sessions. These IDs would eventually be written back to the database in the form of log events. Business go well, and one day the customer adds three new JBoss servers (doubling the amount of webapps). All of a sudden, nothing works quite as it used to. All kinds of queries take long seconds to complete; load average becomes very high. <a href="https://shlomi-noach.github.io/blog/mysql/on-generating-unique-ids-using-last_insert_id-and-other-tools#more-3283" class="more-link">Continue reading »<span class="screen-reader-text"> “On generating unique IDs using LAST_INSERT_ID() and other tools”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/on-generating-unique-ids-using-last_insert_id-and-other-tools#comments">7 Comments<span class="screen-reader-text"> on On generating unique IDs using LAST_INSERT_ID() and other tools</span></a></span>	</footer>
</article>

<article id="post-1468" class="post-1468 post type-post status-publish format-standard hentry category-mysql tag-graphs tag-mycheckpoint tag-sql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/generating-google-line-charts-with-sql-part-i" rel="bookmark">Generating Google line charts with SQL, part I</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/graphs" rel="tag">Graphs</a><a href="https://shlomi-noach.github.io/blog/tag/mycheckpoint" rel="tag">mycheckpoint</a><a href="https://shlomi-noach.github.io/blog/tag/sql" rel="tag">SQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/generating-google-line-charts-with-sql-part-i" rel="bookmark"><time class="entry-date published" datetime="2011-02-01T10:29:31+02:00">February 1, 2011</time><time class="updated" datetime="2011-03-03T09:39:51+02:00">March 3, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>In this series of posts I wish to show how <a href="http://code.google.com/apis/chart/image_charts.html">Google Charts</a> can be generated via SQL. We discuss the Google Charts limitations which must be challenged, and work towards a simple chart.</p>
<p>I’m going to present the algorithm I use in <a href="http://code.openark.org/forge/mycheckpoint">mycheckpoint</a>, a MySQL monitoring utility, which generates Google charts by raw data using views. An example of such chart follows:</p>
<blockquote>
<pre><img class="alignnone" title="Sample Google Chart" src="http://chart.apis.google.com/chart?cht=lc&chs=370x180&chts=303030,12&chtt=Latest+24+hours:+Nov+9,+05:50++-++Nov+10,+05:50&chf=c,s,ffffff&chdl=Rentals+rate:+custom_1_psec&chdlp=b&chco=ff8c00&chd=s:GDGKGFLFGMJHRLMPPNULJRPLTOPRUMYPPVRNbQUSUSbSNWUOfSWTObVSUVWSVYVPbTPjfTbRTdXReUWhcTQRQZbTWYVYPaVZXdYYWPTabYUTbW99QLgLNIOIRNNMIKRJEHGFHGJGGFIFDFGDK&chxt=x,y&chxr=1,0,8.720000&chxl=0:%7C+%7C%7C08:00%7C%7C+%7C%7C12:00%7C%7C+%7C%7C16:00%7C%7C+%7C%7C20:00%7C%7C+%7C%7C00:00%7C%7C+%7C%7C04:00%7C%7C&chxs=0,505050,10,0,lt&chg=4.17,25,1,2,0.69,0&chxp=0,0.69,4.86,9.03,13.20,17.37,21.54,25.71,29.88,34.05,38.22,42.39,46.56,50.73,54.90,59.07,63.24,67.41,71.58,75.75,79.92,84.09,88.26,92.43,96.60&tsstart=2010-11-09+05:50:00&tsstep=600" alt="" width="370" height="180">
http://chart.apis.google.com/chart?cht=lc&chs=370x180&chts=303030,12&chtt=Latest+24+hours:+Nov+9,+05:50++-++Nov+10,+05:50&chf=c,s,ffffff&chdl=Rentals+rate:+custom_1_psec&chdlp=b&chco=ff8c00&chd=s:GDGKGFLFGMJHRLMPPNULJRPLTOPRUMYPPVRNbQUSUSbSNWUOfSWTObVSUVWSVYVPbTPjfTbRTdXReUWhcTQRQZbTWYVYPaVZXdYYWPTabYUTbW99QLgLNIOIRNNMIKRJEHGFHGJGGFIFDFGDK&chxt=x,y&chxr=1,0,8.720000&chxl=0:|+||08:00||+||12:00||+||16:00||+||20:00||+||00:00||+||04:00||&chxs=0,505050,10,0,lt&chg=4.17,25,1,2,0.69,0&chxp=0,0.69,4.86,9.03,13.20,17.37,21.54,25.71,29.88,34.05,38.22,42.39,46.56,50.73,54.90,59.07,63.24,67.41,71.58,75.75,79.92,84.09,88.26,92.43,96.60&tsstart=2010-11-09+05:50:00&tsstep=600</pre>
</blockquote>
<p><em>mycheckpoint</em> does not actually call on Google to do the chart rendering, but invokes its own JavaScript code to visualize the URL locally.</p>
<p>Here are some downsides for using Google charts:</p>
<ul>
<li>The URL cannot be as long as you like. 2048 characters is an upper bound you’ll want to keep behind. <em>[Google charts POST method calls are available, which leads to 16K equivalent of URL length — this is still not too helpful due to the nature of POST calls]</em></li>
<li>Features are inconsistent. To specify label or tick positions, one must specify exact positions. To specify grid positions, one must supply with step, offset, etc. There are more such inconsistencies.</li>
<li>Google charts are not too friendly. Taking the ticks and grids example from above, there really shouldn’t be a reason why grids would not be automatically generated according to ticks definitions. But we are required to specify positions for the ticks as well as for the grids.</li>
<li>There is no support for time-series. One must translate time as x-axis values.</li>
<li>Perhaps most intimidating to many people: to generate a Google chart, once must send data to Google. Which is the main reason I used local JavaScript rendering.</li>
</ul>
<p>Anyway, let’s build a very simple chart. Since I will not cover everything in this post, we make for some relaxed conditions. <a href="https://shlomi-noach.github.io/blog/mysql/generating-google-line-charts-with-sql-part-i#more-1468" class="more-link">Continue reading »<span class="screen-reader-text"> “Generating Google line charts with SQL, part I”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/generating-google-line-charts-with-sql-part-i#comments">3 Comments<span class="screen-reader-text"> on Generating Google line charts with SQL, part I</span></a></span>	</footer>
</article>

<article id="post-2401" class="post-2401 post type-post status-publish format-standard hentry category-mysql tag-indexing tag-sql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/multi-condition-update-query" rel="bookmark">Multi condition UPDATE query</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/indexing" rel="tag">Indexing</a><a href="https://shlomi-noach.github.io/blog/tag/sql" rel="tag">SQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/multi-condition-update-query" rel="bookmark"><time class="entry-date published updated" datetime="2011-01-27T10:30:24+02:00">January 27, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>A simple question I’ve been asked:</p>
<p>Is it possible to merge two <strong>UPDATE</strong> queries, each on different <strong>WHERE</strong> conditions, into a single query?</p>
<p>For example, is it possible to merge the following two <strong>UPDATE</strong> statements into one?</p>
<blockquote>
<pre>mysql> <strong>UPDATE</strong> film <strong>SET</strong> rental_duration=rental_duration+1 <strong>WHERE</strong> rating = 'G';
Query OK, 178 rows affected (0.01 sec)

mysql> <strong>UPDATE</strong> film <strong>SET</strong> rental_rate=rental_rate-0.5 <strong>WHERE</strong> length < 90;
Query OK, 320 rows affected (0.01 sec)
</pre>
</blockquote>
<p>To verify our tests, we take a checksum:</p>
<blockquote>
<pre>mysql> pager md5sum
PAGER set to 'md5sum'
mysql> <strong>SELECT</strong> film_id, title, rental_duration, rental_rate <strong>FROM</strong> film <strong>ORDER BY</strong> film_id;
c2d253c3919efaa6d11487b1fd5061f3  -
</pre>
</blockquote>
<p>Obviously, the following query is <strong>incorrect</strong>: <a href="https://shlomi-noach.github.io/blog/mysql/multi-condition-update-query#more-2401" class="more-link">Continue reading »<span class="screen-reader-text"> “Multi condition UPDATE query”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/multi-condition-update-query#comments">8 Comments<span class="screen-reader-text"> on Multi condition UPDATE query</span></a></span>	</footer>
</article>

<article id="post-3206" class="post-3206 post type-post status-publish format-standard hentry category-mysql tag-sql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/another-use-for-top-n-records-per-group-query" rel="bookmark">Another use for “top N records per group” query</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/sql" rel="tag">SQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/another-use-for-top-n-records-per-group-query" rel="bookmark"><time class="entry-date published" datetime="2011-01-10T10:24:44+02:00">January 10, 2011</time><time class="updated" datetime="2011-01-10T12:59:11+02:00">January 10, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>A few days ago I published <a href="https://shlomi-noach.github.io/blog/mysql/sql-selecting-top-n-records-per-group">SQL: selecting top N records per group</a>. It just dawned on me that the very same query solved another type of problem I was having a couple years ago.</p>
<blockquote><p>BTW, for reference, Baron Schwartz posted <a href="http://www.xaprb.com/blog/2006/12/07/how-to-select-the-firstleastmax-row-per-group-in-sql/">this</a> 4 years ago. There are very interesting approaches in text and in comments. Good to see the ancients already knew of such problems, I should study my history better.</p>
<p>(Kidding, kidding! This is self criticism of course)</p></blockquote>
<p>In this case I present now I have a table with recurring data, which, to some extent, represents revision of data. For the sake of simplicity let’s describe it as a simple simulation of a revision system:</p>
<ul>
<li>I have text files, whose content I store within a row</li>
<li>Each text file uses at least one row in the table</li>
<li>Text files can be edited, whereas an edited file is written in a new row (never UPDATEd).</li>
</ul>
<p>Hold your horses: I’m not really implementing a revision system, I just can’t get into the actual details here.</p>
<p>The table becomes large quickly, and it’s desired to purge rows from the table. The rule is: we must obtain the most recent two versions for each file (if there are indeed more than one). All others can be purged. So the question is: <a href="https://shlomi-noach.github.io/blog/mysql/another-use-for-top-n-records-per-group-query#more-3206" class="more-link">Continue reading »<span class="screen-reader-text"> “Another use for “top N records per group” query”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/another-use-for-top-n-records-per-group-query#respond">Leave a Comment<span class="screen-reader-text"> on Another use for “top N records per group” query</span></a></span>	</footer>
</article>

<article id="post-3164" class="post-3164 post type-post status-publish format-standard hentry category-mysql tag-sql">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/sql-selecting-top-n-records-per-group" rel="bookmark">SQL: selecting top N records per group</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/sql" rel="tag">SQL</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/sql-selecting-top-n-records-per-group" rel="bookmark"><time class="entry-date published" datetime="2011-01-06T12:49:05+02:00">January 6, 2011</time><time class="updated" datetime="2012-08-21T06:58:59+02:00">August 21, 2012</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>A while back I <a href="https://shlomi-noach.github.io/blog/mysql/selecting-a-specific-non-aggregated-column-data-in-group-by">presented</a>(*) an SQL trick to present with non-aggregated column on a GROUP BY query, without use of subquery or derived tables.</p>
<p>Based on a similar concept, combined with string walking, I now present a query which selects top-n records for each group, ordered by <em>some condition</em>. It will require no subqueries. It executes faster than its more conventional alternatives.</p>
<p>[UPDATE: this is MySQL only. Others can use Window Functions where available]</p>
<p>Using the simple <a href="http://dev.mysql.com/doc/index-other.html">world database</a>, we answer the following question:</p>
<blockquote><p>What are the top 5 largest (by area) countries for each continent? What are their names, surface area and population?</p></blockquote>
<p>Similar questions would be:</p>
<blockquote><p>What were the latest 5 films rented by each customer?</p>
<p>What were the most presented advertisements for each user?</p></blockquote>
<p>etc.</p>
<h4>Step 1: getting the top</h4>
<p>We already know how to get a single column’s value for the top country, as presented in the aforementioned post: <a href="https://shlomi-noach.github.io/blog/mysql/sql-selecting-top-n-records-per-group#more-3164" class="more-link">Continue reading »<span class="screen-reader-text"> “SQL: selecting top N records per group”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/sql-selecting-top-n-records-per-group#comments">27 Comments<span class="screen-reader-text"> on SQL: selecting top N records per group</span></a></span>	</footer>
</article>

<article id="post-3145" class="post-3145 post type-post status-publish format-standard hentry category-mysql tag-mysqlconf tag-openark-kit">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/speaking-at-the-oreilly-mysql-conference-2011" rel="bookmark">Speaking at the O’Reilly MySQL Conference 2011</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/mysqlconf" rel="tag">mysqlconf</a><a href="https://shlomi-noach.github.io/blog/tag/openark-kit" rel="tag">openark kit</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/speaking-at-the-oreilly-mysql-conference-2011" rel="bookmark"><time class="entry-date published" datetime="2011-01-03T18:53:20+02:00">January 3, 2011</time><time class="updated" datetime="2011-01-03T19:41:51+02:00">January 3, 2011</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>I’m very pleased and humbled to announce that my submission to the upcoming O’Reilly MySQL Conference, April 2011, has been accepted.</p>
<p>I will present a 45 minute session titled <a href="http://en.oreilly.com/mysql2011/public/schedule/detail/17155"><strong>openark-kit: MySQL utilities for everyday use</strong></a>.</p>
<p>In this session, I will present some of the tools in the <em>openark kit</em>. We’ll discuss some limitations of the MySQL server, and how openark kit tools overcome those limitations and provide with solutions to common maintenance and audit problems.</p>
<p>This will be a technical session and will discuss various topics of the MySQL server: security, execution plans, replication, triggers and more. I do not intend to discuss all tools, nor to cover the various options. Instead, I’ll present the “<em>behind the scenes</em>“, show <em>why the tools work</em>, present common problems and typical use case.</p>
<p>This will be the first time I present at the MySQL Conference (or any conference outside Israel, for that matter). I hope to have a good session. As extra measure of safety, I’ll bring along a couple basketballs; if the sun shines, we can all go outside and have a good time!</p>
<p>The idea to submit this talk (credit Roland Bouman) has given me the inspiration to put effort in making a new release with new and updated tools. So this talk is already a success as far as I’m concerned.</p>
<p>Hope to see you there!</p>
<p>[<strong>PS</strong> shameless plug: <a href="http://code.openark.org/forge/openark-kit">openark kit</a>.]</p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/speaking-at-the-oreilly-mysql-conference-2011#comments">3 Comments<span class="screen-reader-text"> on Speaking at the O’Reilly MySQL Conference 2011</span></a></span>	</footer>
</article>

<article id="post-3032" class="post-3032 post type-post status-publish format-standard hentry category-development category-mysql tag-analysis tag-logs tag-open-source tag-openark-kit tag-python tag-scripts">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/oak-hook-general-log-your-poor-mans-query-analyzer" rel="bookmark">oak-hook-general-log: your poor man’s Query Analyzer</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/development" rel="category tag">Development</a> <a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/analysis" rel="tag">Analysis</a><a href="https://shlomi-noach.github.io/blog/tag/logs" rel="tag">logs</a><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/openark-kit" rel="tag">openark kit</a><a href="https://shlomi-noach.github.io/blog/tag/python" rel="tag">python</a><a href="https://shlomi-noach.github.io/blog/tag/scripts" rel="tag">scripts</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/oak-hook-general-log-your-poor-mans-query-analyzer" rel="bookmark"><time class="entry-date published updated" datetime="2010-12-15T19:46:06+02:00">December 15, 2010</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>The latest release of <a href="http://code.openark.org/forge/openark-kit">openark kit</a> introduces <a href="http://openarkkit.googlecode.com/svn/trunk/openarkkit/doc/html/oak-hook-general-log.html">oak-hook-general-log</a>, a handy tool which allows for some analysis of executing queries.</p>
<p>Initially I just intended for the tool to be able to dump the general log to standard output, from any machine capable to connect to MySQL. Quick enough, I realized the power it brings.</p>
<p>With this tool, one can dump to standard output all queries using temporary tables; or using a specific index; or doing a full index scan; or just follow up on connections; or… For example, the following execution will only log queries which make for filesort:</p>
<blockquote>
<pre>oak-hook-general-log --user=root --host=localhost --password=123456 --filter-explain-filesort</pre>
</blockquote>
<h4>The problem with using the standard logs</h4>
<p>So you have the <em>general log</em>, which you don’t often enable, since it tends to grow huge within moments. You then have the <em>slow log</em>. Slow log is great, and is among the top tools for MySQL diagnosis.</p>
<p>The slow log allows for <strong>log-queries-not-using-indexes</strong>, which is yet another nice feature. Not only should you log any query running for over <strong>X</strong> seconds, but also log any query which does not use an index.</p>
<p>Wait. This logs all single-row tables (no single row table will use an index), as well as very small tables (a common <strong>20</strong> rows lookup table will most often be scanned). These are OK scans. This makes for some noise in the slow log.</p>
<p>And how about queries which do use an index, but do so poorly? They use an index, but retrieve some <strong>12,500,000</strong> rows, <em>using temporary</em> table & <em>filesort</em>?</p>
<h4>What oak-hook-general-log does for you</h4>
<p>This tool streams out the general log, and filters out queries based on their <em>role</em> or on their <em>execution plan</em>.</p>
<p>To work at all, it must enable the general log. Moreover, it directs the general log to log table. Mind that this makes for a performance impact, which is why the tool auto-terminates and restores original log settings (default is <strong>1</strong> minute, configurable). It’s really not a tool you should keep running for days. But during the few moments it runs, it will:</p>
<ul>
<li>Routinely rotate the <strong>mysql.general_log</strong> table so that it doesn’t fill up</li>
<li>Examine entries found in the general log</li>
<li>Cross reference entries to the PROCESSLIST so as to deduce database context (<a href="http://bugs.mysql.com/bug.php?id=52554">bug #52554</a>)</li>
<li>If required and appropriate, evaluate a query’s execution plan</li>
<li>Decide whether to dump each entry based on filtering rules</li>
</ul>
<h4>Filtering rules</h4>
<p>Filtering rules are passed as command line options. At current, only one filtering rule applies (if more than one specified only one is used, so no point in passing more than one). Some of the rules are: <a href="https://shlomi-noach.github.io/blog/mysql/oak-hook-general-log-your-poor-mans-query-analyzer#more-3032" class="more-link">Continue reading »<span class="screen-reader-text"> “oak-hook-general-log: your poor man’s Query Analyzer”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/oak-hook-general-log-your-poor-mans-query-analyzer#respond">Leave a Comment<span class="screen-reader-text"> on oak-hook-general-log: your poor man’s Query Analyzer</span></a></span>	</footer>
</article>

<article id="post-3124" class="post-3124 post type-post status-publish format-standard hentry category-development category-mysql tag-analysis tag-open-source tag-openark-kit tag-python tag-replication tag-scripts">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/openark-kit-rev-170-new-tools-new-functionality" rel="bookmark">openark-kit (rev. 170): new tools, new functionality</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/development" rel="category tag">Development</a> <a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/analysis" rel="tag">Analysis</a><a href="https://shlomi-noach.github.io/blog/tag/open-source" rel="tag">Open Source</a><a href="https://shlomi-noach.github.io/blog/tag/openark-kit" rel="tag">openark kit</a><a href="https://shlomi-noach.github.io/blog/tag/python" rel="tag">python</a><a href="https://shlomi-noach.github.io/blog/tag/replication" rel="tag">Replication</a><a href="https://shlomi-noach.github.io/blog/tag/scripts" rel="tag">scripts</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/openark-kit-rev-170-new-tools-new-functionality" rel="bookmark"><time class="entry-date published" datetime="2010-12-15T08:31:24+02:00">December 15, 2010</time><time class="updated" datetime="2010-12-15T13:02:08+02:00">December 15, 2010</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>I’m pleased to announce a new release of the <a href="http://code.openark.org/forge/openark-kit">openark kit</a>. There’s a lot of new functionality inside; following is a brief overview.</p>
<p>The <em>openark kit</em> is a set of utilities for MySQL. They  solve everyday maintenance tasks, which may be complicated or time  consuming to work by hand.</p>
<p>It’s been a while since the last announced release. Most of my attention was on <a href="http://code.openark.org/forge/mycheckpoint">mycheckpoint</a>, building new features, writing documentation etc. However my own use of <em>openark kit</em> has only increased in the past few months, and there’s new useful solutions to common problems that have been developed.</p>
<p>I’ve used and improved many tools over this time, but doing the final cut, along with proper documentation, took some time. Anyway, here are the highlights:</p>
<h4>New tool: oak-hook-general-log</h4>
<p><em>oak-hook-general-log</em> hooks up a MySQL server and dumps the general log based on filtering rules, applying to query role or execution plan. It is possible to only dump connect/disconnect entries, queries which make a full table scan, or use temporary tables, or scan more than X number of rows, or…</p>
<p>I’ll write more on this tool shortly.</p>
<h4>New tool: oak-prepare-shutdown</h4>
<p>This tool makes for an orderly and faster shutdown by safely stopping replication, and flushing InnoDB pages to disk prior to shutting down (keeping server available for connections even while attempting to flush dirty pages to disk). A typical use case would be:</p>
<blockquote>
<pre>oak-prepare-shutdown --user=root --ask-pass --socket=/tmp/mysql.sock && /etc/init.d/mysql stop</pre>
</blockquote>
<h4>New tool: oak-repeat query</h4>
<p><em>oak-repeat-query</em> repeats executing a given query until some condition holds. The condition can be:</p>
<ul>
<li>Number of given iterations has been reached</li>
<li>Given time has elapsed</li>
<li>No rows have been affected by query</li>
</ul>
<p>The tool comes in handy for cleanup jobs, warming up caches, etc. <a href="https://shlomi-noach.github.io/blog/mysql/openark-kit-rev-170-new-tools-new-functionality#more-3124" class="more-link">Continue reading »<span class="screen-reader-text"> “openark-kit (rev. 170): new tools, new functionality”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/openark-kit-rev-170-new-tools-new-functionality#comments">3 Comments<span class="screen-reader-text"> on openark-kit (rev. 170): new tools, new functionality</span></a></span>	</footer>
</article>

<article id="post-2981" class="post-2981 post type-post status-publish format-standard hentry category-mysql tag-configuration tag-linux">
	<header class="entry-header">
		<h2 class="entry-title"><a href="https://shlomi-noach.github.io/blog/mysql/wheres-my-cnf-file" rel="bookmark">Where’s my cnf file?</a></h2>			<div class="entry-meta">
				<span class="cat-links"><a href="https://shlomi-noach.github.io/blog/category/mysql" rel="category tag">MySQL</a></span><span class="tags-links"><a href="https://shlomi-noach.github.io/blog/tag/configuration" rel="tag">Configuration</a><a href="https://shlomi-noach.github.io/blog/tag/linux" rel="tag">Linux</a></span><span class="posted-on alignright"><a href="https://shlomi-noach.github.io/blog/mysql/wheres-my-cnf-file" rel="bookmark"><time class="entry-date published updated" datetime="2010-12-07T12:24:44+02:00">December 7, 2010</time></a></span>			</div>
			</header>

	
	<div class="entry-content">
		<p>So you have a running MySQL server, it’s working well and everyone’s happy. You want to make a minor change to the configuration file, so you edit the file, restart MySQL – but the change doesn’t catch!</p>
<p>Or maybe you want to check that some global variable has not been dynamically changed without an update to the configuration file. But the configuration file doesn’t make any sense — it looks like nothing is common between the file and the server.</p>
<p>Wait, which <strong>my.cnf</strong> file does MySQL read? Rather, which <strong>my.cnf</strong> <em>files</em>?</p>
<p>Ever happened to you? If you’re well organized, and only keep a single <strong>/etc/my.cnf</strong> file, you know exactly where everything is. But some systems are messier, with <em>lots</em> of configuration files hanging around. Which ones apply?</p>
<p>Let’s find out which configuration files apply.</p>
<h4>No direct information</h4>
<p>It would all be easier if we could just <strong>SHOW GLOBAL VARIABLES LIKE ‘configuration_files_that_this_server_has_read_list’</strong>. There isn’t such an option.</p>
<p> <a href="https://shlomi-noach.github.io/blog/mysql/wheres-my-cnf-file#more-2981" class="more-link">Continue reading »<span class="screen-reader-text"> “Where’s my cnf file?”</span></a></p>
	</div>

	<footer class="entry-footer">
		<span class="comments-link"><a href="https://shlomi-noach.github.io/blog/mysql/wheres-my-cnf-file#comments">1 Comment<span class="screen-reader-text"> on Where’s my cnf file?</span></a></span>	</footer>
</article>

	<nav class="navigation posts-navigation" role="navigation" aria-label="Posts">
		<h2 class="screen-reader-text">Posts navigation</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://shlomi-noach.github.io/blog/page/28">Older posts</a></div><div class="nav-next"><a href="https://shlomi-noach.github.io/blog/page/26">Newer posts</a></div></div>
	</nav>
	</main>


	<footer id="colophon" class="site-footer">
		<div class="site-info">
			<a href="https://wordpress.org/">
				Powered by WordPress			</a>
			<span class="sep"> | </span>
				Theme: <a href="http://openark.org">openark-primer</a> by <a href="http://underscores.me/">Underscores.me</a>.		</div>
	</footer>
</div>

	<div style="display:none">
	</div>
<script>
var pollsL10n = {"ajax_url":"https:\/\/shlomi-noach.github.io\/blog\/wp-admin\/admin-ajax.php","text_wait":"Your last request is still being processed. Please wait a while ...","text_valid":"Please choose a valid poll answer.","text_multiple":"Maximum number of choices allowed: ","show_loading":"1","show_fading":"1"};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/wp-polls/polls-js.js"></script>
<script src="https://secure.gravatar.com/js/gprofiles.js?ver=2020Junaa"></script>
<script>
var WPGroHo = {"my_hash":""};
</script>
<script src="https://shlomi-noach.github.io/blog/wp-content/plugins/jetpack/modules/wpgroho.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/navigation.js"></script>
<script src="https://shlomi-noach.github.io/blog/wp-content/themes/openark-primer/js/skip-link-focus-fix.js"></script>
<script type="text/javascript" src="https://stats.wp.com/e-202024.js" async="async" defer></script>
<script type="text/javascript">
	_stq = window._stq || [];
	_stq.push([ 'view', {v:'ext',j:'1:8.2.1',blog:'32412571',post:'0',tz:'2',srv:'code.openark.org'} ]);
	_stq.push([ 'clickTrackerInit', '32412571', '0' ]);
</script>

</body>
</html>
